<!DOCTYPE html>
<html lang="ru" data-vue-meta="%7B%22lang%22:%7B%22ssr%22:%22ru%22%7D%7D">
<head >
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover">
  <meta name="referrer" content="unsafe-url">
  <title>&#x27;Hello World&#x27; вам в облако / Хабр</title>
  <style>
    /* cyrillic-ext */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveSxf6TF0.woff2) format('woff2');
      unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
    }

    /* cyrillic */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveQhf6TF0.woff2) format('woff2');
      unicode-range: U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
    }

    /* latin-ext */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveSBf6TF0.woff2) format('woff2');
      unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
    }

    /* latin */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveRhf6.woff2) format('woff2');
      unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
    }

    /* non-breaking hyphen */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/l/font?kit=KFOlCnqEu92Fr1MmEU9vBh0_IsHAlmrO6g&skey=ee881451c540fdec&v=v29) format('woff2');
      unicode-range: U+02011;
    }
  </style>
  <link rel="preload" href="https://assets.habr.com/habr-web/css/chunk-vendors.e7843cc0.css" as="style"><link rel="preload" href="https://assets.habr.com/habr-web/js/chunk-vendors.da6c6b36.js" as="script"><link rel="preload" href="https://assets.habr.com/habr-web/css/app.4de4e95a.css" as="style"><link rel="preload" href="https://assets.habr.com/habr-web/js/app.92df6f6d.js" as="script">
  <link rel="stylesheet" href="https://assets.habr.com/habr-web/css/chunk-vendors.e7843cc0.css"><link rel="stylesheet" href="https://assets.habr.com/habr-web/css/app.4de4e95a.css">
  <script>window.i18nFetch = new Promise((res, rej) => {
          const xhr = new XMLHttpRequest();
          xhr.open('GET', '/js/i18n/ru-compiled.2822d469ec31a56409ac330bbcf7fcbf.json');
          xhr.responseType = 'json';
          xhr.onload = function(e) {
            if (this.status === 200) {
              res({ru: xhr.response});
            } else {
              rej(e);
            }
          };
          xhr.send();
        });</script>
  
  <script data-vue-meta="ssr" type="application/ld+json" data-vmid="ldjson-schema">{"@context":"http:\/\/schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/habr.com\/ru\/post\/465149\/"},"headline":"'Hello World' вам в облако","datePublished":"2019-12-14T17:10:13+03:00","dateModified":"2019-12-15T10:28:37+03:00","author":{"@type":"Person","name":"Вячеслав Тутринов"},"publisher":{"@type":"Organization","name":"Habr","logo":{"@type":"ImageObject","url":"https:\/\/habrastorage.org\/webt\/a_\/lk\/9m\/a_lk9mjkccjox-zccjrpfolmkmq.png"}},"description":"Мир сходит с ума, заталкивая калькулятор для 2+2 в облака. Чем мы хуже? Давайте Hello World затолкаем в три микросервиса, напишем пару-тройку тестов, обеспечим п...","url":"https:\/\/habr.com\/ru\/post\/465149\/#post-content-body","about":["h_java","h_devops","f_develop","f_admin"],"image":["https:\/\/habrastorage.org\/webt\/n_\/mu\/7h\/n_mu7ht4nkqya165lkl7b44ii1w.png","https:\/\/habrastorage.org\/webt\/3l\/s3\/dk\/3ls3dkohbjzzlfj1rruhtvtxjzs.png","https:\/\/habrastorage.org\/webt\/up\/uu\/mh\/upuumhgqijpejz-jgu9n8zc_ds4.png","https:\/\/habrastorage.org\/webt\/dv\/31\/8n\/dv318n2kmrvhua0bbv63togmivs.png","https:\/\/habrastorage.org\/webt\/to\/1r\/fy\/to1rfysgzpxwi3zp6jlaffswra4.png","https:\/\/habrastorage.org\/webt\/o2\/np\/m4\/o2npm4hdhucyueujgknmuqitfny.png","https:\/\/habrastorage.org\/webt\/fy\/kf\/kn\/fykfkndjy0qzvl79t1_s9_ka6wg.png","https:\/\/habrastorage.org\/webt\/nh\/bu\/xw\/nhbuxw6mlng--ctknv2y2hh7p5q.png","https:\/\/habrastorage.org\/webt\/v9\/py\/vo\/v9pyvoi2szjw9g7h4v_57mf74ei.png","https:\/\/habrastorage.org\/webt\/pq\/zx\/xf\/pqzxxfn_dhfqnj6cxgxlcrkb6w0.png","https:\/\/habrastorage.org\/webt\/d_\/s5\/ev\/d_s5evcbp9k24rddt1ffweipux8.png","https:\/\/habrastorage.org\/webt\/yb\/h-\/hr\/ybh-hrr4ommmlrsqh4inb4_nii4.png"]}</script>
  <script src="https://www.googletagservices.com/tag/js/gpt.js" async></script>
  <style>.grecaptcha-badge{visibility: hidden;}</style>
  <meta name="habr-version" content="2.64.0">
  
  <meta data-vue-meta="ssr" property="fb:app_id" content="444736788986613"><meta data-vue-meta="ssr" property="fb:pages" content="472597926099084"><meta data-vue-meta="ssr" name="twitter:card" content="summary_large_image"><meta data-vue-meta="ssr" name="twitter:site" content="@habr_com"><meta data-vue-meta="ssr" property="og:site_name" content="Хабр" data-vmid="og:site_name"><meta data-vue-meta="ssr" property="og:title" content="&#x27;Hello World&#x27; вам в облако" data-vmid="og:title"><meta data-vue-meta="ssr" name="twitter:title" content="&#x27;Hello World&#x27; вам в облако" data-vmid="twitter:title"><meta data-vue-meta="ssr" name="aiturec:title" content="&#x27;Hello World&#x27; вам в облако" data-vmid="aiturec:title"><meta data-vue-meta="ssr" name="description" content="Мир сходит с ума, заталкивая калькулятор для 2+2 в облака. Чем мы хуже? Давайте Hello World затолкаем в три микросервиса, напишем пару-тройку тестов, обеспечим пользователей документацией, нарисуем..." data-vmid="description"><meta data-vue-meta="ssr" itemprop="description" content="Мир сходит с ума, заталкивая калькулятор для 2+2 в облака. Чем мы хуже? Давайте Hello World затолкаем в три микросервиса, напишем пару-тройку тестов, обеспечим пользователей документацией, нарисуем..." data-vmid="description:itemprop"><meta data-vue-meta="ssr" property="og:description" content="Мир сходит с ума, заталкивая калькулятор для 2+2 в облака. Чем мы хуже? Давайте Hello World затолкаем в три микросервиса, напишем пару-тройку тестов, обеспечим пользователей документацией, нарисуем..." data-vmid="og:description"><meta data-vue-meta="ssr" name="twitter:description" content="Мир сходит с ума, заталкивая калькулятор для 2+2 в облака. Чем мы хуже? Давайте Hello World затолкаем в три микросервиса, напишем пару-тройку тестов, обеспечим пользователей документацией, нарисуем..." data-vmid="twitter:description"><meta data-vue-meta="ssr" property="aiturec:description" content="Мир сходит с ума, заталкивая калькулятор для 2+2 в облака. Чем мы хуже? Давайте Hello World затолкаем в три микросервиса, напишем пару-тройку тестов, обеспечим пользователей документацией, нарисуем..." data-vmid="aiturec:description"><meta data-vue-meta="ssr" itemprop="image" content="https://habr.com/share/publication/465149/f5b6d5bdf8da77d9adfed77a9f21a964/" data-vmid="image:itemprop"><meta data-vue-meta="ssr" property="og:image" content="https://habr.com/share/publication/465149/f5b6d5bdf8da77d9adfed77a9f21a964/" data-vmid="og:image"><meta data-vue-meta="ssr" property="og:image:width" content="1200" data-vmid="og:image:width"><meta data-vue-meta="ssr" property="og:image:height" content="630" data-vmid="og:image:height"><meta data-vue-meta="ssr" property="aiturec:image" content="https://habr.com/share/publication/465149/f5b6d5bdf8da77d9adfed77a9f21a964/" data-vmid="aiturec:image"><meta data-vue-meta="ssr" name="twitter:image" content="https://habr.com/share/publication/465149/f5b6d5bdf8da77d9adfed77a9f21a964/" data-vmid="twitter:image"><meta data-vue-meta="ssr" property="vk:image" content="https://habr.com/share/publication/465149/f5b6d5bdf8da77d9adfed77a9f21a964/?format=vk" data-vmid="vk:image"><meta data-vue-meta="ssr" property="aiturec:item_id" content="465149" data-vmid="aiturec:item_id"><meta data-vue-meta="ssr" property="aiturec:datetime" content="2019-12-14T14:10:13.000Z" data-vmid="aiturec:datetime"><meta data-vue-meta="ssr" content="https://habr.com/ru/post/465149/" property="og:url" data-vmid="og:url"><meta data-vue-meta="ssr" property="og:type" content="article" data-vmid="og:type"><meta data-vue-meta="ssr" property="og:locale" content="ru_RU" data-vmid="og:locale"><meta data-vue-meta="ssr" name="keywords" content="devops, ci/cd, java, vertx, junit5, testcontainers">
  <link data-vue-meta="ssr" href="https://habr.com/ru/rss/post/465149/?fl=ru" type="application/rss+xml" title="" rel="alternate" name="rss"><link data-vue-meta="ssr" href="index.html.1.132.html" rel="canonical" data-vmid="canonical"><link data-vue-meta="ssr" data-vmid="hreflang"><link data-vue-meta="ssr" image_src="image" href="https://habr.com/share/publication/465149/f5b6d5bdf8da77d9adfed77a9f21a964/" data-vmid="image:href">
  <meta name="apple-mobile-web-app-status-bar-style" content="#303b44">
  <meta name="msapplication-TileColor" content="#629FBC">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <link
    rel="shortcut icon"
    type="image/png"
    sizes="16x16"
    href="https://assets.habr.com/habr-web/img/favicons/favicon-16.png"
  >
  <link
    rel="shortcut icon"
    type="image/png"
    sizes="32x32"
    href="https://assets.habr.com/habr-web/img/favicons/favicon-32.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="76x76"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-76.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="120x120"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-120.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="152x152"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-152.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="180x180"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-180.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="256x256"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-256.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1136x640.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2436x1125.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1792x828.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_828x1792.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1334x750.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1242x2668.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2208x1242.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1125x2436.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1242x2208.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2732x2048.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2688x1242.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2224x1668.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_750x1334.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2048x2732.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2388x1668.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1668x2224.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_640x1136.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1668x2388.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2048x1536.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1536x2048.png"
  >
  <link
    rel="mask-icon"
    color="#77a2b6"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-120.svg"
  >
  <link
    crossorigin="use-credentials"
    href="https://habr.com/manifest.webmanifest"
    rel="manifest"
  >
</head>
<body>


<div id="app" data-server-rendered="true" data-async-called="true"><div class="tm-layout__wrapper"><!----> <div></div> <!----> <header class="tm-header"><div class="tm-page-width"><div class="tm-header__container"><!----> <span class="tm-header__logo-wrap"><a href="https://habr.com/ru/" class="tm-header__logo tm-header__logo_ru"><svg height="16" width="16" class="tm-svg-img tm-header__icon"><title>Хабр</title> <use xlink:href="/img/habr-logo-ru.svg#logo"></use></svg></a> <span class="tm-header__beta-sign" style="display:none;">β</span></span> <div class="tm-dropdown tm-header__projects"><div class="tm-dropdown__head"><button class="tm-header__dropdown-toggle"><svg height="16" width="16" class="tm-svg-img tm-header__icon tm-header__icon_dropdown"><title>Открыть список</title> <use xlink:href="/img/megazord-v25.4b679db1.svg#arrow-down"></use></svg></button></div> <!----></div> <a href="https://habr.com/ru/sandbox/start/" class="tm-header__become-author-btn">
            Как стать автором
          </a> <div class="tm-feature tm-header__feature tm-feature_variant-inline"><!----></div> <!----> <!----></div></div></header> <div class="tm-layout"><div class="tm-page-progress-bar"></div> <div data-menu-sticky="true" class="tm-base-layout__header tm-base-layout__header_is-sticky"><div class="tm-page-width"><div class="tm-base-layout__header-wrapper"><div class="tm-main-menu"><div class="tm-main-menu__section"><nav class="tm-main-menu__section-content"><!----> <a href="https://habr.com/ru/flows/all" class="tm-main-menu__item">
        Все потоки
      </a> <a href="https://habr.com/ru/flows/develop/" class="tm-main-menu__item">
          Разработка
        </a><a href="https://habr.com/ru/flows/admin/" class="tm-main-menu__item">
          Администрирование
        </a><a href="https://habr.com/ru/flows/design/" class="tm-main-menu__item">
          Дизайн
        </a><a href="https://habr.com/ru/flows/management/" class="tm-main-menu__item">
          Менеджмент
        </a><a href="https://habr.com/ru/flows/marketing/" class="tm-main-menu__item">
          Маркетинг
        </a><a href="https://habr.com/ru/flows/popsci/" class="tm-main-menu__item">
          Научпоп
        </a></nav></div></div> <div class="tm-header-user-menu tm-base-layout__user-menu"><a href="https://habr.com/ru/search/" class="tm-header-user-menu__item tm-header-user-menu__search"><svg height="24" width="24" class="tm-svg-img tm-header-user-menu__icon tm-header-user-menu__icon_search tm-header-user-menu__icon_dark"><title>Поиск</title> <use xlink:href="/img/megazord-v25.4b679db1.svg#search"></use></svg></a> <!----> <!----> <!----> <div class="tm-header-user-menu__item tm-header-user-menu__user_desktop"><div class="tm-dropdown"><div class="tm-dropdown__head"><svg height="24" width="24" data-test-id="menu-toggle-guest" class="tm-svg-img tm-header-user-menu__icon"><title>Профиль</title> <use xlink:href="/img/megazord-v25.4b679db1.svg#header-user"></use></svg> <!----></div> <!----></div> <!----></div> <!----></div></div></div></div> <!----> <div class="tm-page-width"></div> <main class="tm-layout__container"><div hl="ru" data-async-called="true" class="tm-page"><div class="tm-page-width"><!----> <div class="tm-page__wrapper"><div class="tm-page__main tm-page__main_has-sidebar"><div class="pull-down"><div class="pull-down__header" style="height:0px;"><div class="pull-down__content" style="bottom:10px;"><svg height="24" width="24" class="tm-svg-img pull-down__arrow"><title>Обновить</title> <use xlink:href="/img/megazord-v25.4b679db1.svg#pull-arrow"></use></svg></div></div> <div class="tm-article-presenter"> <div class="tm-article-presenter__body"><div class="tm-misprint-area"><div class="tm-misprint-area__wrapper"><article class="tm-article-presenter__content tm-article-presenter__content_narrow"><div class="tm-article-presenter__header"> <div class="tm-article-snippet tm-article-presenter__snippet"><div class="tm-article-snippet__meta-container"><div class="tm-article-snippet__meta"><span class="tm-user-info tm-article-snippet__author"><a href="https://habr.com/ru/users/zhulikovatyi/" title="zhulikovatyi" class="tm-user-info__userpic"><div class="tm-entity-image"><svg height="24" width="24" class="tm-svg-img tm-image-placeholder tm-image-placeholder_green"><!----> <use xlink:href="/img/megazord-v25.4b679db1.svg#placeholder-user"></use></svg></div></a> <span class="tm-user-info__user"><a href="https://habr.com/ru/users/zhulikovatyi/" class="tm-user-info__username">
      zhulikovatyi
    </a> </span></span> <span class="tm-article-snippet__datetime-published"><time datetime="2019-12-14T14:10:13.000Z" title="2019-12-14, 17:10">14  декабря  2019 в 17:10</time></span></div> <!----></div> <h1 lang="ru" class="tm-article-snippet__title tm-article-snippet__title_h1"><span>'Hello World' вам в облако</span></h1> <div class="tm-article-snippet__hubs"><span class="tm-article-snippet__hubs-item"><a href="https://habr.com/ru/hub/java/" class="tm-article-snippet__hubs-item-link"><span>Java</span> <span title="Профильный хаб" class="tm-article-snippet__profiled-hub">*</span></a></span><span class="tm-article-snippet__hubs-item"><a href="https://habr.com/ru/hub/devops/" class="tm-article-snippet__hubs-item-link"><span>DevOps</span> <span title="Профильный хаб" class="tm-article-snippet__profiled-hub">*</span></a></span></div> <div class="tm-article-snippet__labels"><div class="tm-article-snippet__label tm-article-snippet__label_variant-tutorial"><span>
        Tutorial
      </span></div></div> <!----> <!----></div></div> <!----> <div data-gallery-root="" lang="ru" class="tm-article-body"><div></div> <div id="post-content-body"><div><div class="article-formatted-body article-formatted-body_version-1"><div xmlns="http://www.w3.org/1999/xhtml"><p>Мир сходит с ума, заталкивая калькулятор для 2+2 в облака. Чем мы хуже? Давайте Hello World затолкаем в три микросервиса, напишем пару-тройку тестов, обеспечим пользователей документацией, нарисуем красивый пайплайн сборки и обеспечим деплой в условный облачный прод при успешном прохождении тестов. Итак, в данной статье будет показан пример того, как может быть построен процесс разработки продукта от спецификации до деплоя в прод. Инетересно? тогда прошу под кат<a name="habracut"></a></p><br/>
<h2>С чегоооооо начинается Роооо… ?</h2><br/>
<p>Нет не Родина, а продукт. Правильно, продукт начинается c идеи. Итак, идея такова: </p><br/>
<ul>
<li>нужен сервис, который отдаёт 'Hello World' по REST API</li>
<li>cлово <strong>'Hello'</strong> отдаёт один микросервис, проектируемый, создаваемый и тестируемый командой_1</li>
<li>cлово <strong>'World'</strong> отдаёт второй, который находится в ведении команды_2</li>
<li>команда_3 пишет интеграционный сервис для склеивания 'Hello' и 'World'</li>
</ul><br/>
<h3>Toolset</h3><br/>
<ul>
<li>OS (desktop) — Debian 9 Stretch</li>
<li>IDE — IntelliJ IDEA 2019.1</li>
<li>Git Repo — GitHub</li>
<li>CI — Concourse 5.4.0</li>
<li>Maven Repo — Nexus</li>
<li>OpenJDK 11</li>
<li>Maven 3.6.0</li>
<li>Kubernetes 1.14 (1 master + 1 worker): calico network, nginx-ingress-controller</li>
</ul><br/>
<blockquote><strong>Важная заметка:</strong> статья не о красивом коде (codestyle, checkstyle, javadocs, SOLID и прочие умные слова) и вылизанных до идеала решениях (холиварить про идеальный Hello World можно бесконечно). Она о том, как собрать воедино код, спецификациии, пайплайн сборки и доставки всего собранного в прод, а вместо HelloWorld в реальности у вас может быть какой-нибудь высоконагруженный продукт с кучей сложных и крутых микросервисов, и описанный процесс можно применить к нему.</blockquote><br/>
<h3>Из чего состоит сервис?</h3><br/>
<p>Сервис в виде конечного продукта должен содержать в себе:</p><br/>
<ul>
<li>спецификацию в виде yaml-документа стандарта OpenAPI и уметь отдавать её по запросу (GET /doc)</li>
<li>методы API в соответствии со спецификацией из первого пункта</li>
<li>README.md с примерами запуска и конфигурирования сервиса</li>
</ul><br/>
<p>Будем разбирать сервисы по порядку. Поехали!</p><br/>
<h2>'Hello' microservice</h2><br/>
<h3>Specification</h3><br/>
<p>Спеки пишем в Swagger Editor'е и конвертируем им же в OpenAPI спеку. Swagger Editor запускается в докере одной командой, конвертация swagger-доки в openapi-доку делается нажатием одной кнопки в UI эдитора, которая шлёт запрос <strong>POST /api/convert</strong> на <strong><a href="http://converter.swagger.io">http://converter.swagger.io</a></strong>. Итоговая спецификация hello сервиса:</p><br/>
<pre><code class="plaintext">openapi: 3.0.1
info:
  title: Hello ;)
  description: Hello microservice
  version: 1.0.0
servers:
  - url: https://demo1.bihero.io/api/hello
tags:
  - name: hello
    description: Everything about saying 'Hello'
paths:
  /:
    x-vertx-event-bus:
      address: service.hello
      timeout: 1000c
    get:
      tags:
        - hello
      summary: Get 'Hello' word
      operationId: getHelloWord
      responses:
        200:
          description: OK
  /doc:
    x-vertx-event-bus:
      address: service.hello
      timeout: 1000c
    get:
      tags:
        - hello_doc
      summary: Get 'Hello' microservice documentation
      operationId: getDoc
      responses:
        200:
          description: OK
components: {}</code></pre><br/>
<h3>Implementation</h3><br/>
<p>Сервис с точки зрения кода, который надо писать, состоит из 3-х классов:</p><br/>
<ul>
<li>интерфейс с методами сервиса (названия методов указаны в спеке как <strong>operationId</strong>)</li>
<li>реализация интерфейса</li>
<li>vertx verticle для биндинга сервиса со спекой (методы api -> методы интерфейса из первого пункта) и для старта http-сервера</li>
</ul><br/>
<p>Структура файлов в src выглядит примерно так:<br/>
<img src="https://habrastorage.org/r/w1560/webt/n_/mu/7h/n_mu7ht4nkqya165lkl7b44ii1w.png" data-src="https://habrastorage.org/webt/n_/mu/7h/n_mu7ht4nkqya165lkl7b44ii1w.png"/></p><br/>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">pom.xml</b>
                        <div class="spoiler_text"><pre><code class="xml">&lt;?xml version="1.0" encoding="UTF-8"?>
&lt;project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    &lt;modelVersion>4.0.0&lt;/modelVersion>

    &lt;properties>
        &lt;main.verticle>io.bihero.hello.HelloVerticle&lt;/main.verticle>
        &lt;vertx.version>3.8.1&lt;/vertx.version>
        &lt;logback.version>1.2.3&lt;/logback.version>
        &lt;junit-jupiter.version>5.3.1&lt;/junit-jupiter.version>
        &lt;maven-surefire-plugin.version>2.19.1&lt;/maven-surefire-plugin.version>
        &lt;junit-platform-surefire-provider.version>1.1.0&lt;/junit-platform-surefire-provider.version>
        &lt;assertj-core.version>3.8.0&lt;/assertj-core.version>
        &lt;allure.version>2.8.1&lt;/allure.version>
        &lt;allure-maven.version>2.10.0&lt;/allure-maven.version>
        &lt;aspectj.version>1.9.2&lt;/aspectj.version>
        &lt;mockito.version>2.21.0&lt;/mockito.version>
        &lt;rest-assured.version>3.0.0&lt;/rest-assured.version>
    &lt;/properties>

    &lt;groupId>io.bihero&lt;/groupId>
    &lt;artifactId>hello-microservice&lt;/artifactId>
    &lt;version>1.0.0-SNAPSHOT&lt;/version>
    &lt;build>
        &lt;plugins>
            &lt;plugin>
                &lt;artifactId>maven-compiler-plugin&lt;/artifactId>
                &lt;configuration>
```1.8&lt;/source>
                    &lt;target>1.8&lt;/target>
                &lt;/configuration>
                &lt;executions>
                    &lt;execution>
                        &lt;id>default-compile&lt;/id>
                        &lt;configuration>
                            &lt;annotationProcessors>
                                &lt;annotationProcessor>io.vertx.codegen.CodeGenProcessor&lt;/annotationProcessor>
                            &lt;/annotationProcessors>
                            &lt;generatedSourcesDirectory>src/main/generated&lt;/generatedSourcesDirectory>
                            &lt;compilerArgs>
                                &lt;arg>-Acodegen.output=${project.basedir}/src/main&lt;/arg>
                            &lt;/compilerArgs>
                        &lt;/configuration>
                    &lt;/execution>
                    &lt;execution>
                        &lt;id>default-testCompile&lt;/id>
                        &lt;configuration>
                            &lt;annotationProcessors>
                                &lt;annotationProcessor>io.vertx.codegen.CodeGenProcessor&lt;/annotationProcessor>
                            &lt;/annotationProcessors>
                            &lt;generatedTestSourcesDirectory>src/test/generated&lt;/generatedTestSourcesDirectory>
                            &lt;compilerArgs>
                                &lt;arg>-Acodegen.output=${project.basedir}/src/test&lt;/arg>
                            &lt;/compilerArgs>
                        &lt;/configuration>
                    &lt;/execution>
                &lt;/executions>
            &lt;/plugin>
            &lt;plugin>
                &lt;groupId>org.apache.maven.plugins&lt;/groupId>
                &lt;artifactId>maven-surefire-plugin&lt;/artifactId>
                &lt;version>${maven-surefire-plugin.version}&lt;/version>
                &lt;configuration>
                    &lt;properties>
                        &lt;property>
                            &lt;name>listener&lt;/name>
                            &lt;value>io.qameta.allure.junit5.AllureJunit5&lt;/value>
                        &lt;/property>
                    &lt;/properties>
                    &lt;includes>
                        &lt;include>**/*Test*.java&lt;/include>
                    &lt;/includes>
                    &lt;argLine>
                        -javaagent:"${settings.localRepository}/org/aspectj/aspectjweaver/${aspectj.version}/aspectjweaver-${aspectj.version}.jar" -Djdk.net.URLClassPath.disableClassPathURLCheck=true
                    &lt;/argLine>
                    &lt;systemProperties>
                        &lt;property>
                            &lt;name>allure.results.directory&lt;/name>
                            &lt;value>${project.basedir}/target/allure-results&lt;/value>
                        &lt;/property>
                        &lt;property>
                            &lt;name>junit.jupiter.extensions.autodetection.enabled&lt;/name>
                            &lt;value>true&lt;/value>
                        &lt;/property>
                    &lt;/systemProperties>
                    &lt;reportFormat>plain&lt;/reportFormat>
                &lt;/configuration>
                &lt;dependencies>
                    &lt;dependency>
                        &lt;groupId>org.aspectj&lt;/groupId>
                        &lt;artifactId>aspectjweaver&lt;/artifactId>
                        &lt;version>${aspectj.version}&lt;/version>
                    &lt;/dependency>
                    &lt;dependency>
                        &lt;groupId>org.junit.platform&lt;/groupId>
                        &lt;artifactId>junit-platform-surefire-provider&lt;/artifactId>
                        &lt;version>${junit-platform-surefire-provider.version}&lt;/version>
                    &lt;/dependency>
                    &lt;dependency>
                        &lt;groupId>org.junit.jupiter&lt;/groupId>
                        &lt;artifactId>junit-jupiter-engine&lt;/artifactId>
                        &lt;version>${junit-jupiter.version}&lt;/version>
                    &lt;/dependency>
                &lt;/dependencies>
            &lt;/plugin>
            &lt;plugin>
                &lt;groupId>io.qameta.allure&lt;/groupId>
                &lt;artifactId>allure-maven&lt;/artifactId>
                &lt;version>${allure-maven.version}&lt;/version>
            &lt;/plugin>
            &lt;plugin>
                &lt;groupId>org.apache.maven.plugins&lt;/groupId>
                &lt;artifactId>maven-site-plugin&lt;/artifactId>
                &lt;version>3.7.1&lt;/version>
                &lt;dependencies>
                    &lt;dependency>
                        &lt;groupId>org.apache.maven.wagon&lt;/groupId>
                        &lt;artifactId>wagon-webdav-jackrabbit&lt;/artifactId>
                        &lt;version>2.8&lt;/version>
                    &lt;/dependency>
                &lt;/dependencies>
            &lt;/plugin>

            &lt;plugin>
                &lt;groupId>org.apache.maven.plugins&lt;/groupId>
                &lt;artifactId>maven-project-info-reports-plugin&lt;/artifactId>
                &lt;version>3.0.0&lt;/version>
            &lt;/plugin>
            &lt;plugin>
                &lt;groupId>org.apache.maven.plugins&lt;/groupId>
                &lt;artifactId>maven-shade-plugin&lt;/artifactId>
                &lt;version>2.3&lt;/version>
                &lt;executions>
                    &lt;execution>
                        &lt;phase>package&lt;/phase>
                        &lt;goals>
                            &lt;goal>shade&lt;/goal>
                        &lt;/goals>
                        &lt;configuration>
                            &lt;transformers>
                                &lt;transformer implementation="org.apache.maven.plugins.shade.resource.ManifestResourceTransformer">
                                    &lt;manifestEntries>
                                        &lt;Main-Class>io.vertx.core.Launcher&lt;/Main-Class>
                                        &lt;Main-Verticle>${main.verticle}&lt;/Main-Verticle>
                                    &lt;/manifestEntries>
                                &lt;/transformer>
                                &lt;transformer implementation="org.apache.maven.plugins.shade.resource.AppendingTransformer">
                                    &lt;resource>META-INF/services/io.vertx.core.spi.VerticleFactory&lt;/resource>
                                &lt;/transformer>
                            &lt;/transformers>
                            &lt;artifactSet>
                            &lt;/artifactSet>
                            &lt;outputFile>${project.build.directory}/${project.artifactId}-fat.jar&lt;/outputFile>
                        &lt;/configuration>
                    &lt;/execution>
                &lt;/executions>
            &lt;/plugin>
        &lt;/plugins>
        &lt;resources>
            &lt;resource>
                &lt;directory>src/main/resources&lt;/directory>
                &lt;filtering>true&lt;/filtering>
                &lt;includes>
                    &lt;include>**/version.txt&lt;/include>
                &lt;/includes>
            &lt;/resource>
            &lt;resource>
                &lt;directory>src/main/resources&lt;/directory>
                &lt;filtering>false&lt;/filtering>
                &lt;excludes>
                    &lt;exclude>**/version.txt&lt;/exclude>
                &lt;/excludes>
            &lt;/resource>
        &lt;/resources>
    &lt;/build>
    &lt;distributionManagement>
        &lt;site>
            &lt;id>reports&lt;/id>
            &lt;url>dav:https://nexus.dev.techedge.pro:8443/repository/reports/${project.artifactId}/&lt;/url>
        &lt;/site>
    &lt;/distributionManagement>
    &lt;reporting>
        &lt;excludeDefaults>true&lt;/excludeDefaults>
        &lt;plugins>
            &lt;plugin>
                &lt;groupId>io.qameta.allure&lt;/groupId>
                &lt;artifactId>allure-maven&lt;/artifactId>
                &lt;configuration>
                    &lt;resultsDirectory>${project.build.directory}/allure-results&lt;/resultsDirectory>
                    &lt;reportDirectory>${project.reporting.outputDirectory}/${project.version}/allure&lt;/reportDirectory>
                &lt;/configuration>
            &lt;/plugin>
        &lt;/plugins>
    &lt;/reporting>

    &lt;dependencies>
        &lt;dependency>
            &lt;groupId>io.vertx&lt;/groupId>
            &lt;artifactId>vertx-web-api-service&lt;/artifactId>
            &lt;version>${vertx.version}&lt;/version>
        &lt;/dependency>
        &lt;dependency>
            &lt;groupId>io.vertx&lt;/groupId>
            &lt;artifactId>vertx-codegen&lt;/artifactId>
            &lt;version>${vertx.version}&lt;/version>
            &lt;scope>provided&lt;/scope>
        &lt;/dependency>
        &lt;dependency>
            &lt;groupId>ch.qos.logback&lt;/groupId>
            &lt;artifactId>logback-classic&lt;/artifactId>
            &lt;version>${logback.version}&lt;/version>
        &lt;/dependency>

        &lt;!-- test &amp;ndash;&amp;gt;-->
        &lt;dependency>
            &lt;groupId>io.vertx&lt;/groupId>
            &lt;artifactId>vertx-unit&lt;/artifactId>
            &lt;version>${vertx.version}&lt;/version>
            &lt;scope>test&lt;/scope>
        &lt;/dependency>
        &lt;dependency>
            &lt;groupId>io.vertx&lt;/groupId>
            &lt;artifactId>vertx-junit5&lt;/artifactId>
            &lt;version>${vertx.version}&lt;/version>
            &lt;scope>test&lt;/scope>
        &lt;/dependency>
        &lt;dependency>
            &lt;groupId>org.junit.jupiter&lt;/groupId>
            &lt;artifactId>junit-jupiter-api&lt;/artifactId>
            &lt;version>${junit-jupiter.version}&lt;/version>
            &lt;scope>test&lt;/scope>
        &lt;/dependency>
        &lt;dependency>
            &lt;groupId>org.junit.jupiter&lt;/groupId>
            &lt;artifactId>junit-jupiter-engine&lt;/artifactId>
            &lt;version>${junit-jupiter.version}&lt;/version>
            &lt;scope>test&lt;/scope>
        &lt;/dependency>
        &lt;dependency>
            &lt;groupId>org.assertj&lt;/groupId>
            &lt;artifactId>assertj-core&lt;/artifactId>
            &lt;version>${assertj-core.version}&lt;/version>
            &lt;scope>test&lt;/scope>
        &lt;/dependency>
        &lt;dependency>
            &lt;groupId>org.mockito&lt;/groupId>
            &lt;artifactId>mockito-core&lt;/artifactId>
            &lt;version>${mockito.version}&lt;/version>
            &lt;scope>test&lt;/scope>
        &lt;/dependency>
        &lt;dependency>
            &lt;groupId>io.qameta.allure&lt;/groupId>
            &lt;artifactId>allure-junit5&lt;/artifactId>
            &lt;version>${allure.version}&lt;/version>
            &lt;scope>test&lt;/scope>
        &lt;/dependency>
        &lt;dependency>
            &lt;groupId>io.vertx&lt;/groupId>
            &lt;artifactId>vertx-web-client&lt;/artifactId>
            &lt;version>${vertx.version}&lt;/version>
            &lt;scope>test&lt;/scope>
        &lt;/dependency>
    &lt;/dependencies>

&lt;/project></code></pre></div>
                    </div><br/>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">HelloService.java</b>
                        <div class="spoiler_text"><pre><code class="java">package io.bihero.hello;

import io.vertx.core.AsyncResult;
import io.vertx.core.Handler;
import io.vertx.core.Vertx;
import io.vertx.ext.web.api.OperationRequest;
import io.vertx.ext.web.api.OperationResponse;
import io.vertx.ext.web.api.generator.WebApiServiceGen;

@WebApiServiceGen
public interface HelloService {

    static HelloService create(Vertx vertx) {
        return new DefaultHelloService(vertx);
    }

    void getHelloWord(OperationRequest context, Handler&lt;AsyncResult&lt;OperationResponse>> resultHandler);

    void getDoc(OperationRequest context, Handler&lt;AsyncResult&lt;OperationResponse>> resultHandler);

}
</code></pre></div>
                    </div><br/>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">DefaultHelloService.java</b>
                        <div class="spoiler_text"><pre><code class="java">package io.bihero.hello;

import io.vertx.core.AsyncResult;
import io.vertx.core.Future;
import io.vertx.core.Handler;
import io.vertx.core.Vertx;
import io.vertx.core.buffer.Buffer;
import io.vertx.ext.web.api.OperationRequest;
import io.vertx.ext.web.api.OperationResponse;

public class DefaultHelloService implements HelloService {

    private final Vertx vertx;

    public DefaultHelloService(Vertx vertx) {
        this.vertx = vertx;
    }

    @Override
    public void getHelloWord(OperationRequest context, Handler&lt;AsyncResult&lt;OperationResponse>> resultHandler) {
        resultHandler.handle(Future.succeededFuture(OperationResponse.completedWithPlainText(Buffer.buffer("Hello"))));
    }

    @Override
    public void getDoc(OperationRequest context, Handler&lt;AsyncResult&lt;OperationResponse>> resultHandler) {
        vertx.fileSystem().readFile("doc.yaml", buffResult ->
                resultHandler.handle(Future.succeededFuture(
                        OperationResponse.completedWithPlainText(buffResult.result()))
                ));
    }

}</code></pre></div>
                    </div><br/>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">HelloVerticle.java</b>
                        <div class="spoiler_text"><pre><code class="java">package io.bihero.hello;

import io.vertx.core.AbstractVerticle;
import io.vertx.core.Promise;
import io.vertx.core.eventbus.MessageConsumer;
import io.vertx.core.http.HttpServer;
import io.vertx.core.http.HttpServerOptions;
import io.vertx.core.json.JsonObject;
import io.vertx.ext.web.Router;
import io.vertx.ext.web.api.contract.openapi3.OpenAPI3RouterFactory;
import io.vertx.serviceproxy.ServiceBinder;

public class HelloVerticle extends AbstractVerticle {

    private HttpServer server;
    private MessageConsumer&lt;JsonObject> consumer;

    @Override
    public void start(Promise&lt;Void> promise) {
        startHelloService();
        startHttpServer().future().setHandler(promise);
    }

    /**
     * This method closes the http server and unregister all services loaded to Event Bus
     */
    @Override
    public void stop(){
        this.server.close();
        consumer.unregister();
    }

    private void startHelloService() {
        consumer = new ServiceBinder(vertx).setAddress("service.hello")
                .register(HelloService.class, HelloService.create(getVertx()));
    }

    /**
     * This method constructs the router factory, mounts services and handlers and starts the http server
     * with built router
     * @return
     */
    private Promise&lt;Void> startHttpServer() {
        Promise&lt;Void> promise = Promise.promise();
        OpenAPI3RouterFactory.create(this.vertx, "/doc.yaml", openAPI3RouterFactoryAsyncResult -> {
            if (openAPI3RouterFactoryAsyncResult.succeeded()) {
                OpenAPI3RouterFactory routerFactory = openAPI3RouterFactoryAsyncResult.result();

                // Mount services on event bus based on extensions
                routerFactory.mountServicesFromExtensions();

                // Generate the router
                Router router = routerFactory.getRouter();

                int port = config().getInteger("serverPort", 8080);
                String host = config().getString("serverHost", "localhost");

                server = vertx.createHttpServer(new HttpServerOptions().setPort(port).setHost(host));
                server.requestHandler(router).listen(ar -> {
                    // Error starting the HttpServer
                    if (ar.succeeded()) promise.complete();
                    else promise.fail(ar.cause());
                });
            } else {
                // Something went wrong during router factory initialization
                promise.fail(openAPI3RouterFactoryAsyncResult.cause());
            }
        });
        return promise;
    }

}
</code></pre></div>
                    </div><br/>
<p>В интерфейсе сервиса и его имплементации нет ничего необычного (за исключением аннотации @WebApiServiceGen, но про него можно почитать в <a href="https://vertx.io/docs/vertx-web-api-service/java/#_using_vert_x_api_service">документации</a>), а вот код verticle-класса рассмотрим подробнее.</p><br/>
<p>Интересны два метода, которые вызываются на старта вертикла:</p><br/>
<ul>
<li><strong>startHelloService</strong> создает объект с имплеменатацией нашего сервиса и биндит его на адрес в event bus (вспомним параметр <em>x-vertx-event-bus.address</em> из спецификации выше)</li>
<li><strong>startHttpServer</strong> создаёт router factory на основе спецификации сервиса, создаёт http-сервер и прицепляет созданный router к хэндлеру всех входящих http-запросов (если гурбо, то запрос <strong>GET /</strong> будет падать в event bus vertex'а с адресом <strong>service.hello</strong> (а туда мы забиндили реализацию сервиса <em>io.bihero.hello.HelloService</em>) и с именем метода сервиса <strong>getHelloWord</strong>)</li>
</ul><br/>
<p>Пора собрать джарник и пробовать запускать:</p><br/>
<pre><code class="bash">mvn clean package # собираем джарник
java -Dlogback.configurationFile=./src/conf/logback-console.xml -jar target/hello-microservice-fat.jar  -conf ./src/conf/config.json # запускаем сервис</code></pre><br/>
<p>В строке запуска интересны два параметра:</p><br/>
<ul>
<li>-Dlogback.configurationFile=./src/conf/logback-console.xml — путь до конфиг-файла для logback (в зависимостях проекта должны быть slf4j и logback как имплементация slf4j-api)</li>
<li>-conf ./src/conf/config.json — конфиг сервиса, там для нас важен порт, на котором будет открыт http REST API:<br/>
<pre><code class="json">{
"type": "file",
"format": "json",
"scanPeriod": 5000,
"config": {
"path": "/home/slava/JavaProjects/hello-world-to-cloud/hellomicroservice/src/conf/config.json"
},
"serverPort": 8081,
"serverHost": "0.0.0.0"
}</code></pre></li>
</ul><br/>
<p>Вывод maven'а нам особо не интересен, а вот как стартанул сервис, можно посмотреть (в настройках логгера для пакета <strong>io.netty</strong> выставлен <strong>level="INFO"</strong>)</p><br/>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">Как стартанул сервис</b>
                        <div class="spoiler_text"><pre><code class="bash">2019-10-03 20:52:45,159 [vert.x-worker-thread-0] DEBUG i.s.v.p.OpenAPIV3Parser: Loaded raw data: openapi: 3.0.1
info:
  title: Hello ;)
  description: Hello microservice
  version: 1.0.0
servers:
  - url: https://demo1.bihero.io/api/hello
tags:
  - name: hello
    description: Everything about saying 'Hello'
paths:
  /:
    x-vertx-event-bus:
      address: service.hello
      timeout: 1000c
    get:
      tags:
        - hello
      summary: Get 'Hello' word
      operationId: getHelloWord
      responses:
        200:
          description: OK
  /doc:
    x-vertx-event-bus:
      address: service.hello
      timeout: 1000c
    get:
      tags:
        - hello_doc
      summary: Get 'Hello' microservice documentation
      operationId: getDoc
      responses:
        200:
          description: OK
components: {}
2019-10-03 20:52:45,195 [vert.x-worker-thread-0] DEBUG i.s.v.p.OpenAPIV3Parser: Parsed rootNode: {"openapi":"3.0.1","info":{"title":"Hello ;)","description":"Hello microservice","version":"1.0.0"},"servers":[{"url":"https://demo1.bihero.io/api/hello"}],"tags":[{"name":"hello","description":"Everything about saying 'Hello'"}],"paths":{"/":{"x-vertx-event-bus":{"address":"service.hello","timeout":"1000c"},"get":{"tags":["hello"],"summary":"Get 'Hello' word","operationId":"getHelloWord","responses":{"200":{"description":"OK"}}}},"/doc":{"x-vertx-event-bus":{"address":"service.hello","timeout":"1000c"},"get":{"tags":["hello_doc"],"summary":"Get 'Hello' microservice documentation","operationId":"getDoc","responses":{"200":{"description":"OK"}}}}},"components":{}}
Oct 03, 2019 8:52:45 PM io.vertx.core.impl.launcher.commands.VertxIsolatedDeployer
INFO: Succeeded in deploying verticle
</code></pre></div>
                    </div><br/>
<p>Ура! Сервис заработал, можно проверять:</p><br/>
<pre><code class="bash">curl http://127.0.0.1:8081/
Hello
curl -v http://127.0.0.1:8081/doc
openapi: 3.0.1
info:
  title: Hello ;)
  description: Hello microservice
  version: 1.0.0
servers:
  - url: https://demo1.bihero.io/api/hello
tags:
  - name: hello
    description: Everything about saying 'Hello'
paths:
  /:
    x-vertx-event-bus:
      address: service.hello
      timeout: 1000c
    get:
      tags:
        - hello
      summary: Get 'Hello' word
      operationId: getHelloWord
      responses:
        200:
          description: OK
  /doc:
    x-vertx-event-bus:
      address: service.hello
      timeout: 1000c
    get:
      tags:
        - hello_doc
      summary: Get 'Hello' microservice documentation
      operationId: getDoc
      responses:
        200:
          description: OK
components: {}</code></pre><br/>
<p>Сервис отвечает словом <strong>Hello</strong> на запрос <strong>GET /</strong>, что соответствует спецификации, и умеет говорить о том, что он умеет делать, отдавая специфкацию по запросу <strong>GET /doc</strong>. Круто, идём в прод!</p><br/>
<h3>Что-то тут не так ...</h3><br/>
<p>Ранее я писал, что нам не особо важен вывод maven'а при сборке. Я наврал, вывод важен и очень. Нам нужно, чтобы maven запускал тесты и при падении тестов сборка падала. Сборка выше прошла, и это говорит о том, что либо тесты прошли, либо их нет. Тестов у нас, конечно же, нет, настала пора их написать (тут можно поспорить о методологиях, о том когда и как писать тесты, до или после имплементации, но мы вспомним про важную заметку вначала статьи и пойдём дальше — напишем парочку тестов).<br/>
Первый тест-класс является по своей природе юнит-тестом, проверяющим два конкретных метода нашего сервиса:</p><br/>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">HelloServiceTest.java</b>
                        <div class="spoiler_text"><pre><code class="java">package io.bihero.hello;

import io.vertx.core.Vertx;
import io.vertx.core.json.JsonObject;
import io.vertx.ext.web.api.OperationRequest;
import io.vertx.junit5.VertxExtension;
import io.vertx.junit5.VertxTestContext;
import org.apache.commons.io.IOUtils;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;

import java.io.IOException;

import static org.assertj.core.api.Assertions.assertThat;

@ExtendWith(VertxExtension.class)
public class HelloServiceTest {

    private HelloService helloService = HelloService.create(Vertx.vertx());

    @Test
    @DisplayName("Test 'getHelloWord' method returns 'Hello' word")
    public void testHelloMethod(VertxTestContext testContext) {
        helloService.getHelloWord(new OperationRequest(new JsonObject()), testContext.succeeding(it -> {
            assertThat(it.getStatusCode()).isEqualTo(200);
            assertThat(it.getPayload().toString()).isEqualTo("Hello");
            testContext.completeNow();
        }));
    }

    @Test
    @DisplayName("Test 'getDoc' method returns service documentation in OpenAPI format")
    public void testDocMethod(VertxTestContext testContext) {
        helloService.getDoc(new OperationRequest(new JsonObject()), testContext.succeeding(it -> {
            try {
                assertThat(it.getStatusCode()).isEqualTo(200);
                assertThat(it.getPayload().toString()).isEqualTo(IOUtils.toString(this.getClass()
                        .getResourceAsStream("../../../doc.yaml"), "UTF-8"));
                testContext.completeNow();
            } catch (IOException e) {
                testContext.failNow(e);
            }
        }));
    }

}</code></pre></div>
                    </div><br/>
<p>Второй тест — недоинтеграционный тест, проверяющий, что вертикл поднимается и отвечает на соответствующие http запросы ожидаемыми статусами и текстом:</p><br/>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">HelloVerticleTest.java</b>
                        <div class="spoiler_text"><pre><code class="java">package io.bihero.hello;

import io.vertx.core.Vertx;
import io.vertx.core.json.JsonObject;
import io.vertx.ext.web.client.WebClient;
import io.vertx.ext.web.codec.BodyCodec;
import io.vertx.junit5.Checkpoint;
import io.vertx.junit5.VertxExtension;
import io.vertx.junit5.VertxTestContext;
import org.apache.commons.io.IOUtils;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;

import static org.assertj.core.api.Assertions.assertThat;
import static org.mockito.Mockito.doReturn;
import static org.mockito.Mockito.spy;

@ExtendWith(VertxExtension.class)
public class HelloVerticleTest {

    @Test
    @DisplayName("Test that verticle is up and respond me by 'Hello' word and doc in OpenAPI format")
    public void testHelloVerticle(Vertx vertx, VertxTestContext testContext) {
        WebClient webClient = WebClient.create(vertx);

        Checkpoint deploymentCheckpoint = testContext.checkpoint();
        Checkpoint requestCheckpoint = testContext.checkpoint(2);

        HelloVerticle verticle = spy(new HelloVerticle());
        JsonObject config = new JsonObject().put("serverPort", 8081).put("serverHost", "0.0.0.0");
        doReturn(config).when(verticle).config();
        vertx.deployVerticle(verticle, testContext.succeeding(id -> {
            deploymentCheckpoint.flag();
            // test GET /
            webClient.get(8081, "localhost", "/")
                    .as(BodyCodec.string())
                    .send(testContext.succeeding(resp -> {
                        assertThat(resp.body()).isEqualTo("Hello");
                        assertThat(resp.statusCode()).isEqualTo(200);
                        requestCheckpoint.flag();
                    }));
            // test GET /doc
            webClient.get(8081, "localhost", "/doc")
                    .as(BodyCodec.string())
                    .send(testContext.succeeding(resp -> {
                        try {
                            assertThat(resp.body()).isEqualTo(IOUtils.toString(this.getClass()
                                    .getResourceAsStream("../../../doc.yaml"), "UTF-8"));
                            assertThat(resp.statusCode()).isEqualTo(200);
                            requestCheckpoint.flag();
                        } catch (Exception e) {
                            requestCheckpoint.flag();
                            testContext.failNow(e);
                        }
                    }));
        }));
    }

}</code></pre></div>
                    </div><br/>
<p>Пора собирать сервис вместе с тестами:</p><br/>
<pre><code class="bash">mvn clean package</code></pre><br/>
<p>Нас очень интересует лог плагина surefire, выглядеть он будет примерно так (картинка кликабельна):</p><br/>
<p><a href="https://habrastorage.org/webt/3l/s3/dk/3ls3dkohbjzzlfj1rruhtvtxjzs.png"><img src="https://habrastorage.org/r/w1560/webt/3l/s3/dk/3ls3dkohbjzzlfj1rruhtvtxjzs.png" data-src="https://habrastorage.org/webt/3l/s3/dk/3ls3dkohbjzzlfj1rruhtvtxjzs.png"/></a></p><br/>
<p>Здорово! Сервис собирается, тесты бегут и не падают (чуть позже поговорим о красоте того, как результаты тестов показывать начальству), пора задуматься о том, как мы будем его доставлять до пользователей (то есть до серверов). На дворе конец 2019-го, и, конечно же, бандлить приложение мы будем в виде docker-образа. Поехали!</p><br/>
<h2>Docker и все все все</h2><br/>
<p>Docker image для нашего первого сервиса будем собирать на основе <code>adoptopenjdk/openjdk11</code>. Добавим в образ наш собранный джарник со всеми необходимыми конфигами и пропишем в докерфайле команду для старта приложения в контейнере. Итоговый <strong>Dockerfile</strong> будет выглядеть так:</p><br/>
<pre><code class="bash">FROM adoptopenjdk/openjdk11:alpine-jre
COPY target/hello-microservice-fat.jar app.jar
COPY src/conf/config.json .
COPY src/conf/logback-console.xml .
COPY run.sh .
RUN chmod +x run.sh
CMD ["./run.sh"]</code></pre><br/>
<p>Скрипт <strong>run.sh</strong> выглядит так:</p><br/>
<pre><code class="bash">#!/bin/sh
java ${JVM_OPTS} -Dlogback.configurationFile=./logback-console.xml -jar app.jar -conf config.json</code></pre><br/>
<p>Переменная окружения <strong>JVM_OPTS</strong> нам на этом этапе пока не особо нужна, но чуть позже мы будем её активно менять и тюнить параметры виртуальной машины и наших сервисов. Пора собрать образ и запустить приложение в контейнере:</p><br/>
<pre><code class="bash">docker build -t="hellomicroservice" .
docker run -dit --name helloms hellomicroservice
# посмотрим в логи контейнера, что он там нам позапускал
docker logs -f helloms

# вывод docker logs
2019-10-05 14:55:46,059 [vert.x-worker-thread-0] DEBUG i.s.v.p.OpenAPIV3Parser: Loaded raw data: openapi: 3.0.1
info:
  title: Hello ;)
  description: Hello microservice
  version: 1.0.0
servers:
  - url: https://demo1.bihero.io/api/hello
tags:
  - name: hello
    description: Everything about saying 'Hello'
paths:
  /:
    x-vertx-event-bus:
      address: service.hello
      timeout: 1000c
    get:
      tags:
        - hello
      summary: Get 'Hello' word
      operationId: getHelloWord
      responses:
        200:
          description: OK
  /doc:
    x-vertx-event-bus:
      address: service.hello
      timeout: 1000c
    get:
      tags:
        - hello_doc
      summary: Get 'Hello' microservice documentation
      operationId: getDoc
      responses:
        200:
          description: OK
components: {}
2019-10-05 14:55:46,098 [vert.x-worker-thread-0] DEBUG i.s.v.p.OpenAPIV3Parser: Parsed rootNode: {"openapi":"3.0.1","info":{"title":"Hello ;)","description":"Hello microservice","version":"1.0.0"},"servers":[{"url":"https://demo1.bihero.io/api/hello"}],"tags":[{"name":"hello","description":"Everything about saying 'Hello'"}],"paths":{"/":{"x-vertx-event-bus":{"address":"service.hello","timeout":"1000c"},"get":{"tags":["hello"],"summary":"Get 'Hello' word","operationId":"getHelloWord","responses":{"200":{"description":"OK"}}}},"/doc":{"x-vertx-event-bus":{"address":"service.hello","timeout":"1000c"},"get":{"tags":["hello_doc"],"summary":"Get 'Hello' microservice documentation","operationId":"getDoc","responses":{"200":{"description":"OK"}}}}},"components":{}}
Oct 05, 2019 2:55:46 PM io.vertx.core.impl.launcher.commands.VertxIsolatedDeployer
INFO: Succeeded in deploying verticle</code></pre><br/>
<p>Достанем ip-адрес контейнера и проверим работу сервиса внутри контейнера:</p><br/>
<pre><code class="bash">docker inspect helloms | grep IPAddress
 "SecondaryIPAddresses": null,
            "IPAddress": "172.17.0.2",
                    "IPAddress": "172.17.0.2",</code></pre><br/>
<pre><code class="bash">curl http://172.17.0.2:8081/ # тут ожидаем увидеть слово 'Hello' в ответе
curl http://172.17.0.2:8081/doc # тут ждём описание сервиса в формате OpenAPI</code></pre><br/>
<p>Итак, сервис запускается в контейнере. Но мы же не будем его руками вот так (docker run) запускать в production-окружении, для этого у нас есть прекрасный kubernetes. Чтобы запустить приложение в kubernetes, нам нужен шаблон, yml-файл, с описанием того, какие ресурсы (deployment, service, ingress, etc) мы будем запускать и на основе какого контейнера. Но, прежде чем мы начнём описывать темплейт для запуска приложения в k8s, пушнем ка собранный ранее образ на докерхаб:</p><br/>
<pre><code class="bash">docker tag hello bihero/hello
docker push bihero/hello</code></pre><br/>
<p>Пишем темплейт для запуска приложения в kubernetes (в рамках статьи мы не настоящие сварщики и не претендуем на "кошерность" темплейта):</p><br/>
<pre><code class="plaintext">apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  labels:
    io.bihero.hello.service: bihero-hello
  name: bihero-hello
spec:
  replicas: 3
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 1
  template:
    metadata:
      labels:
        io.bihero.hello.service: bihero-hello
    spec:
      containers:
        - image: bihero/hello:${HELLO_SERVICE_IMAGE_VERSION}
          name: bihero-hello
          ports:
            - containerPort: 8081
          imagePullPolicy: Always
          resources: {}
      restartPolicy: Always
---
apiVersion: v1
kind: Service
metadata:
  labels:
    io.bihero.hello.service: bihero-hello
  name: bihero-hello
spec:
  ports:
    - name: "8081"
      port: 8081
      targetPort: 8081
  selector:
    io.bihero.hello.service: bihero-hello
status:
  loadBalancer: {}
---
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: bihero-hello
  annotations:
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/secure-backends: "false"
    nginx.ingress.kubernetes.io/ssl-passthrough: "false"
    nginx.ingress.kubernetes.io/rewrite-target: /$2
    kubernetes.io/tls-acme: "true"
  namespace: default
spec:
  tls:
    - hosts:
        - ${ID_DOMAIN}
      secretName: bihero
  rules:
    - host: ${ID_DOMAIN}
      http:
        paths:
          - path: /api/hello(/|$)(.*)
            backend:
              serviceName: bihero-hello
              servicePort: 8081</code></pre><br/>
<p>Кратко о том, что мы видим в шаблоне:</p><br/>
<ul>
<li><strong>Deployment</strong>: тут описываем, из какого образа деплоимся и из какого количества инстансов создаём репликасет для нашего сервиса. Также важно обратить внимание на <em>metadata.labels</em> — по ним будем привязывать <strong>Service</strong> к <strong>Deployment</strong></li>
<li><strong>Service</strong>: привязываем сервис к деплойменту/репликасету. По сути сервис в k8s — это то, к чему уже можно слать http-запроcы <strong>внутри</strong> кластера (и да — обращаем внимание на <strong>selector</strong>)</li>
<li><strong>Ingress</strong>: ингресс нужен для того, чтобы сервис выставить наружу, во внешний мир. Все запросы начинающиеся с <strong>/api/hello</strong> будем заворачивать на наш hello-сервис (<a href="https://domain.com/api/hello">https://domain.com/api/hello</a> -> <a href="http://bihero-hello.service.internal.domain.local:8081/">http://bihero-hello.service.internal.domain.local:8081/</a>)</li>
</ul><br/>
<p>Также в шаблоне фигурируют два переменных окружения:</p><br/>
<ul>
<li>${HELLO_SERVICE_IMAGE_VERSION} — тег docker-образа с сервисом, из которого будем собирать наш первый deployment</li>
<li>${ID_DOMAIN} — домен, на котором развернём наши сервисы</li>
</ul><br/>
<blockquote><strong>Важное про https</strong><br/>
В тестовом кластере уже имеется secret с именем <strong>bihero</strong>, созданный на основе wildcard-сертификата от LetsEncrypt. Если кратко, то команды выглядит так<br/>
<pre><code class="bash">kubectl create secret tls bihero --key keys/privkey.pem --cert keys/fullchain.pem</code></pre><br/>
<br/>
где privkey.pem и fullchain.pem — файлы, генерируемые letsencrypt'ом<br/>
Подробнее про создание secret'а для tls в k8s можно почитать пройдя по <a href="https://kubernetes.io/docs/concepts/services-networking/ingress/#tls">ссылке</a> </blockquote><br/>
<p>Настала пора пробовать деплоиться в k8s :) Поехали!</p><br/>
<pre><code class="bash">export HELLO_SERVICE_IMAGE_VERSION=latest
export ID_DOMAIN=demo1.bihero.io
cat k8s.yaml | envsubst | kubectl apply -f -</code></pre><br/>
<p>В stdout должны увидеть вот это:</p><br/>
<pre><code class="bash">deployment.extensions/bihero-hello created
service/bihero-hello created
ingress.extensions/bihero-hello created</code></pre><br/>
<p>Ну что ж, проверим, что там нам kubernetes наворотил:</p><br/>
<pre><code class="bash">kubectl get po # да, вместо pod можно писать po, k8s вас поймёт</code></pre><br/>
<p><a href="https://habrastorage.org/webt/up/uu/mh/upuumhgqijpejz-jgu9n8zc_ds4.png"><img src="https://habrastorage.org/r/w1560/webt/up/uu/mh/upuumhgqijpejz-jgu9n8zc_ds4.png" data-src="https://habrastorage.org/webt/up/uu/mh/upuumhgqijpejz-jgu9n8zc_ds4.png"/></a><br/>
Как и полагается — 3 пода</p><br/>
<p>Посмотрим подробности одного пода</p><br/>
<pre><code class="bash">kubectl describe po bihero-hello-5b4759d55b-bf4qc</code></pre><br/>
<p><a href="https://habrastorage.org/webt/dv/31/8n/dv318n2kmrvhua0bbv63togmivs.png"><img src="https://habrastorage.org/r/w1560/webt/dv/31/8n/dv318n2kmrvhua0bbv63togmivs.png" data-src="https://habrastorage.org/webt/dv/31/8n/dv318n2kmrvhua0bbv63togmivs.png"/></a></p><br/>
<p>Как там сервис поживает?</p><br/>
<pre><code class="bash">kubectl describe service bihero-hello</code></pre><br/>
<p><a href="https://habrastorage.org/webt/to/1r/fy/to1rfysgzpxwi3zp6jlaffswra4.png"><img src="https://habrastorage.org/r/w1560/webt/to/1r/fy/to1rfysgzpxwi3zp6jlaffswra4.png" data-src="https://habrastorage.org/webt/to/1r/fy/to1rfysgzpxwi3zp6jlaffswra4.png"/></a></p><br/>
<p>А ингресс?</p><br/>
<pre><code class="bash">kubectl describe ing bihero-hello</code></pre><br/>
<p><a href="https://habrastorage.org/webt/o2/np/m4/o2npm4hdhucyueujgknmuqitfny.png"><img src="https://habrastorage.org/r/w1560/webt/o2/np/m4/o2npm4hdhucyueujgknmuqitfny.png" data-src="https://habrastorage.org/webt/o2/np/m4/o2npm4hdhucyueujgknmuqitfny.png"/></a></p><br/>
<p>Здорово! Сервис бегает в k8s и так просится, чтобы его проверили парочкой запросов, согласно спеке.</p><br/>
<pre><code class="bash">curl https://demo1.bihero.io/api/hello
Hello</code></pre><br/>
<pre><code class="bash">curl https://demo1.bihero.io/api/hello/doc
openapi: 3.0.1
info:
  title: Hello ;)
  description: Hello microservice
  version: 1.0.0
servers:
  - url: https://demo1.bihero.io/api/hello
tags:
  - name: hello
    description: Everything about saying 'Hello'
paths:
  /:
    x-vertx-event-bus:
      address: service.hello
      timeout: 1000c
    get:
      tags:
        - hello
      summary: Get 'Hello' word
      operationId: getHelloWord
      responses:
        200:
          description: OK
  /doc:
    x-vertx-event-bus:
      address: service.hello
      timeout: 1000c
    get:
      tags:
        - hello_doc
      summary: Get 'Hello' microservice documentation
      operationId: getDoc
      responses:
        200:
          description: OK
components: {}</code></pre><br/>
<h2>А — Автоматизация</h2><br/>
<p>Фух… Дошли до самого вкусного и волнительного. Было сделано немало работы и каждый шаг сопровождался ручным запуском каких-то тулов, на каждом этапе своих. Пора задуматься о том, чтобы все шаги запускались автоматически и триггерили своим завершением следующий шаг паплайна, а на финише был ровный и бесшовный апгрейд нашего сервиса в k8s кластере. Сказано, сделано!</p><br/>
<p>Перед тем как начать пилить автоматизацию, давайте разложим всё по полочкам и нарисуем схему того, как будет бежать пайплайн на CI-сервере.</p><br/>
<h3>Что было сделано руками?</h3><br/>
<ol>
<li>Написали код, написали тесты к коду, прошли всё чеки (кодревью и прочее), закоммитили в git-репозиторий</li>
<li>Запуск сборки (mvn), прогон тестов (surefire, allure) — на выходе получаем fat-jar с сервисом</li>
<li>Сборка docker-образа (docker build)</li>
<li>Push docker-образа на докерхаб (или корпоративный приватный docker registry) (docker push)</li>
<li>Деплой сервиса в k8s (kubectl apply)</li>
</ol><br/>
<h3>Что будет делать CI-сервер ?</h3><br/>
<p>Да всё то же самое, что и мы ручками делали (кроме написания кода и тестов), только по пути будет уведомлять нас о своих действиях и отчёты деплоить в нужные места. Алгоритм выглядит примерно так:<br/>
<a href="https://habrastorage.org/webt/fy/kf/kn/fykfkndjy0qzvl79t1_s9_ka6wg.png"><img src="https://habrastorage.org/r/w1560/webt/fy/kf/kn/fykfkndjy0qzvl79t1_s9_ka6wg.png" data-src="https://habrastorage.org/webt/fy/kf/kn/fykfkndjy0qzvl79t1_s9_ka6wg.png"/></a><br/>
Опишем пайплайн по шагам:</p><br/>
<ol>
<li>Пайплайн будет триггерить джобу сборки по коммиту в определенную ветку проекта, пусть это будет ветка <strong>master</strong> (напрямую в master мы, конечно же, не коммитим, туда коммиты попадают при merge'ах после merge request'ов и тщательного ревью)</li>
<li>Уведомление команды разработчиков о том, что началась сборка сервиса из вышеуказанной dev-ветки (telegram-bot)</li>
<li>Прогон тестов</li>
<li>Проверяем, как поршли тесты</li>
<li>Тесты прошли успешно — деплоим результат прогона тестов в maven repository (конкретно в нашем кейсе используется <a href="https://help.sonatype.com/repomanager3/high-availability/configuring-blob-stores">nexus blob store</a>)</li>
<li>Собираем fat-jar (mvn package, но с маленьким хаком, чтобы не компилить по новой код — мы это уже сделали на этапе прогона тестов)</li>
<li>Собираем docker image из собранного джарника и необходимых конфигов. Тут стоить отметить, что данный шаг делает не только сборку образа, но и пушит его в репозиторий, на который ссылается наш образ как ресурс пайплайна (о ресурсах скоро узнаете). Пуш образа в registry триггерит деплой новой версии сервиса в k8s кластер</li>
<li>Деплой новой версии сервиса в k8s кластер</li>
<li>Уведомление команды сервиса о том, что сборка прошла и новая версия сервиса ушла в требуемый k8s кластер. Уведомление содержит ссылку на джобу с логами сборки и ссылку на результат прогона тестов</li>
<li>Если на 4-м шаге мы понимаем, что тесты не прошли, то деплоим результаты прогона тестов в maven repository</li>
<li>И уведомляем команду о том, что сборка новой версии сервиса упала со всеми необходимыми ссылками в уведомлении</li>
</ol><br/>
<h5>Concourse CI</h5><br/>
<p>Вышеописанный пайплайн мы будем писать под CI-сервер <a href="https://concourse-ci.org/">Concourse</a>. Особенности Concourse CI:</p><br/>
<ul>
<li>минималистичный UI (всё управление составом пайплайна через yaml-конфиги, которые могут лежать рядом с кодом, и через консольный тул под название <strong>fly</strong>): это и плюс и минус одновременно — очень удобно и гибко для разработчиков, которые всегда работают с консолью (mvn, docker, fly, kubectl), но неудобно для менеджерского состава, который хочет потыкать в кнопочки (но для них мы будем отчёты писать в tg-группу со ссылками на все необходимые для них ресурсы)</li>
<li>каждый степ сборки проходит в docker container'е, что даёт гибкость в настройке окружения для каждого степа (не надо на каждой worker-ноде шаманить с настройками, если что-то environment-зависимое захотели поменять в одном из шагов пайплайна) — собрал образ один раз, степ пайплайна подтянет его в момент старта, и дело в шляпе.</li>
</ul><br/>
<p>Итак, встречайте, пайплайн сбрки:</p><br/>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">pipeline.yaml</b>
                        <div class="spoiler_text"><pre><code class="plaintext">resource_types:
  - name: telegram
    type: docker-image
    source:
      repository: vtutrinov/concourse-telegram-resource
      tag: latest
  - name: kubernetes
    type: docker-image
    source:
      repository: zlabjp/kubernetes-resource
      tag: 1.16
  - name: metadata
    type: docker-image
    source:
      repository: olhtbr/metadata-resource
      tag: 2.0.1
resources:
  - name: metadata
    type: metadata
  - name: sources
    type: git
    source:
      branch: master
      uri: git@github.com:bihero-io/hello-microservice.git
      private_key: ((deployer-private-key))
  - name: docker-image
    type: docker-image
    source:
      repository: bihero/hello
      username: ((docker-registry-user))
      password: ((docker-registry-password))
  - name: telegram
    type: telegram
    source:
      bot_token: ((telegram-ci-bot-token))
      chat_id: ((telegram-group-to-report-build))
      ci_url: ((ci_url))
      command: "/build_hello_ms"
  - name: kubernetes-demo
    type: kubernetes
    source:
      server: https://178.63.194.241:6443
      namespace: default
      kubeconfig: ((kubeconfig-demo))
jobs:
  - name: build-hello-microservice
    serial: true
    public: true
    plan:
      - in_parallel:
          - get: sources
            trigger: true
          - get: telegram
            trigger: true
          - put: metadata
      - put: telegram
        params:
          status: Build In Progress
      - task: unit-tests
        config:
          platform: linux
          image_resource:
            type: docker-image
            source:
              repository: ((docker-registry-uri))/bih/maven
              tag: 3-jdk-11
              username: ((docker-private-registry-user))
              password: ((docker-private-registry-password))
          inputs:
            - name: sources
          outputs:
            - name: tested-workspace
          run:
            path: /bin/sh
            args:
              - -c
              - |
                output_dir=tested-workspace
                cp -R ./sources/* "${output_dir}/"
                mvn -f "${output_dir}/pom.xml" clean test
          caches:
            - path: ~/.m2/
        on_failure:
          do:
            - task: tests-report
              config:
                platform: linux
                image_resource:
                  type: docker-image
                  source:
                    repository: ((docker-registry-uri))/bih/maven
                    tag: 3-jdk-11
                    username: ((docker-private-registry-user))
                    password: ((docker-private-registry-password))
                inputs:
                  - name: tested-workspace
                outputs:
                  - name: message
                run:
                  path: /bin/sh
                  args:
                    - -c
                    - |
                      output_dir=tested-workspace
                      mvn -Dmaven.wagon.http.ssl.insecure=true -Dmaven.wagon.http.ssl.allowall=true -f "${output_dir}/pom.xml" site-deploy
                      version=$(cat $output_dir/target/classes/version.txt)
                      cat >message/msg &lt;&lt;EOL
                      &lt;a href="https://nexus.dev.techedge.pro:8443/repository/reports/hello-microservice/${version}/allure/">Allure report&lt;/a>
                      EOL
                caches:
                  - path: ~/.m2/
            - put: telegram
              params:
                status: Build Failed (unit-tests)
                message_file: message/msg
      - task: tests-report
        config:
          platform: linux
          image_resource:
            type: docker-image
            source:
              repository: ((docker-registry-uri))/bih/maven
              tag: 3-jdk-11
              username: ((docker-private-registry-user))
              password: ((docker-private-registry-password))
          inputs:
            - name: tested-workspace
          outputs:
            - name: message
            - name: tested-workspace
          run:
            path: /bin/sh
            args:
              - -c
              - |
                work_dir=tested-workspace
                mvn -Dmaven.wagon.http.ssl.insecure=true -Dmaven.wagon.http.ssl.allowall=true -f "${work_dir}/pom.xml" site-deploy
                version=$(cat $work_dir/target/classes/version.txt)
                cat >message/msg &lt;&lt;EOL
                &lt;a href="https://nexus.dev.techedge.pro:8443/repository/reports/hello-microservice/${version}/allure/">Allure report&lt;/a>
                EOL
          caches:
            - path: ~/.m2/
      - task: package
        config:
          platform: linux
          image_resource:
            type: docker-image
            source:
              repository: ((docker-registry-uri))/bih/maven
              tag: 3-jdk-11
              username: ((docker-private-registry-user))
              password: ((docker-private-registry-password))
          inputs:
            - name: tested-workspace
            - name: metadata
          outputs:
            - name: app-packaged-workspace
            - name: metadata
          run:
            path: /bin/sh
            args:
              - -c
              - |
                output_dir=app-packaged-workspace
                cp -R ./tested-workspace/* "${output_dir}/"
                mvn -f "${output_dir}/pom.xml" package -Dmaven.main.skip -DskipTests
                env
                tag="-"$(cat metadata/build_name)
                echo $tag >> ${output_dir}/target/classes/version.txt
                cat ${output_dir}/target/classes/version.txt > metadata/version
          caches:
            - path: ~/.m2/
        on_failure:
          do:
            - put: telegram
              params:
                status: Build Failed (package)
      - put: docker-image
        params:
          build: app-packaged-workspace
          tag_file: app-packaged-workspace/target/classes/version.txt
          tag_as_latest: true
        get_params:
          skip_download: true
      - task: make-k8s-app-template
        config:
          platform: linux
          image_resource:
            type: docker-image
            source:
              repository: bhgedigital/envsubst
          inputs:
            - name: sources
            - name: metadata
          outputs:
            - name: k8s
          run:
            path: /bin/sh
            args:
              - -c
              - |
                export DOMAIN=demo1.bihero.io
                export HELLO_SERVICE_IMAGE_VERSION=$(cat metadata/version)
                cat sources/k8s.yaml | envsubst > k8s/hello_app_template.yaml
                cat k8s/hello_app_template.yaml
      - put: kubernetes-demo
        params:
          kubectl: apply -f k8s/hello_app_template.yaml
      - put: telegram
        params:
          status: Build Success
          message_file: message/msg</code></pre></div>
                    </div><br/>
<p>Рассмотрим кратко содержимое пайплайна:</p><br/>
<ol>
<li>Секция <a href="https://concourse-ci.org/resource-types.html">resource_types</a> нужна для объявления кастомных типов ресурсов, с которыми мы хотим работать, собирая наш проект. В нашем кейсе это три типа (имена типов можно задавать любые, сама суть типа закладывается в docker-образе, которым описывается тип): telegram для отправки уведомлений в tg-группу и для триггера джобы по сборке по определённой команде, kubernetes для деплоя новой версии сервиса в k8s-кластер и metadata для обеспечения данных по билду (номер билда, дата сборки и т.д.) в тасках пайплайна</li>
<li>Секция resources нужна для объявления ресурсов, с которыми мы будем работать в процессе билда. Это то самое место в пайплайне, где описываются репозитории с исходниками, docker-registry для деплоя собираемых docker-образов и другие ресурсы, необходимые для выполнения степов сборки проекта. Каждый ресурс может быть использован на каждом степе пайплайна как input-ресурс в соответствующем блоке, описывающем таск пайплайна</li>
<li>Секция jobs описывает набор джоб, которые нужно выполнить для сборки проекта. У нас это одна джоба с набором тасков и put-инструкций для деплоя результатов сборки и уведомлений в tg-группу. Иструкциями <strong> — get</strong> объявляем входные ресурсы для билда (например, git-репозиторий), <strong> — put</strong> — выходные ресурсы (docker image) или ресурсы, генерируемые на первых шагах сборки проекта и используемые на последующих (metadata). Каждый task в джобе — команды внутри docker-контейнера на основе docker-image'а, конфигурируемого параметром <strong>image_resource</strong> таски</li>
<li>Строки вида <strong>((parameter-name))</strong> — ссылки на параметры в отдельном файле, обычно в этом файле лежат секреты, явки пароли к ресурсам и прочие параметры, универсальные для всех имеющихся пайплайнов (например ссылка до docker-registry).</li>
</ol><br/>
<p>Деплой пайплайна с файлом параметров выглядит так:</p><br/>
<pre><code class="bash">fly -t bih sp -p hello-microservice -c pipeline.yaml -l credentials.yaml
# -t - target name
# sp - alias to set-pipeline
# -p - pipeline name
# -c - pipeline config file
# -l - file with parameters and credentials</code></pre><br/>
<p>Файл <strong>credentials.yaml</strong> может выглядеть так:</p><br/>
<pre><code class="plaintext">docker-registry-user: &lt;dockerhub-user>
docker-registry-password: &lt;dockerhub-password>
docker-registry-uri: &lt;private-docker-registry-url>
docker-private-registry-user: &lt;private-docker-registry-user>
docker-private-registry-password: &lt;private-docker-registry-passwordl>
telegram-ci-bot-token: &lt;telegram-bot-token>
telegram-group-to-report-build: &lt;telegram-group-id>
ci_url: &lt;ci-server-url>
deployer-private-key: |
  -----BEGIN OPENSSH PRIVATE KEY-----
  github-deploy-key
  -----END OPENSSH PRIVATE KEY-----
kubeconfig-demo: |
  apiVersion: v1
  clusters:
  - cluster:
      certificate-authority-data: &lt;kube-cert-data>
      server: &lt;kube-api-server-url>
    name: kubernetes
  contexts:
  - context:
      cluster: kubernetes
      user: kubernetes-admin
    name: kubernetes-admin@kubernetes
  current-context: kubernetes-admin@kubernetes
  kind: Config
  preferences: {}
  users:
  - name: kubernetes-admin
    user:
      client-certificate-data: &lt;kube-client-cert-data>
      client-key-data: &lt;kube-client-key-data></code></pre><br/>
<p>Пишла пора запустить наш первый билд. Сделать мы это можем несколькими способами:</p><br/>
<ol>
<li>Залогиниться на CI-сервере, выбрать необходимый нам пайплайн и джобу и нажать на кнопку с плюсиком:</li>
<li>Сделать всё то же самое (что и в пункте 1), но только используя конcольную утилиту <strong>fly</strong>, которую можно скачать с того же CI-сервера:<br/>
<pre><code class="bash">fly -t bih tj -j hello-microservice/build-hello-microservice -w
# tj - alias for 'trigger-job'
# -j - job (&lt;piprlinr-name>/&lt;job-name-in-pipeline>)
# -w - watch</code></pre></li>
<li>Отправить сообщение <strong>/build_hello_ms</strong> в телеграм-группу, на которую указывает <strong>telegram-group-to-report-build</strong> в файле <strong>credentials.yaml</strong></li>
<li>Отправить коммит в master-ветку в гит (помним, что мы не про идеальную разработку сейчас говорим, а про процесс в целом: коммитить в master — это плохо, — но в обучающих целях можно ;) )</li>
</ol><br/>
<p>В процессе билда (в случае успешного его окончания) мы получим два уведомления в телеграм-группу:</p><br/>
<ol>
<li>Уведомление о начале работы с джобой:<br/>
<a href="https://habrastorage.org/webt/nh/bu/xw/nhbuxw6mlng--ctknv2y2hh7p5q.png"><img src="https://habrastorage.org/r/w1560/webt/nh/bu/xw/nhbuxw6mlng--ctknv2y2hh7p5q.png" data-src="https://habrastorage.org/webt/nh/bu/xw/nhbuxw6mlng--ctknv2y2hh7p5q.png"/></a></li>
<li>Уведомление об успешном завершении сборки:<br/>
<a href="https://habrastorage.org/webt/v9/py/vo/v9pyvoi2szjw9g7h4v_57mf74ei.png"><img src="https://habrastorage.org/r/w1560/webt/v9/py/vo/v9pyvoi2szjw9g7h4v_57mf74ei.png" data-src="https://habrastorage.org/webt/v9/py/vo/v9pyvoi2szjw9g7h4v_57mf74ei.png"/></a><br/>
Давайте посмотрим, как сборка выглядит в UI CI-сервера:<br/>
<div class="oembed"><div><div style="left: 0; width: 100%; height: 0; position: relative; padding-bottom: 56.2493%;"><div class="tm-iframe_temp" data-src="https://www.youtube.com/embed/qHG8P5fkPWc?rel=0&amp;showinfo=1&amp;hl=en-US" data-style="border: 0; top: 0; left: 0; width: 100%; height: 100%; position: absolute;" id="" width=""></div></div></div></div></li>
</ol><br/>
<p>Ура! Сборка прошла, докер-образ собран, задеплоен, приложение в k8s обновлено и отчёты отправлены. Пора проверять задеплоенное:</p><br/>
<ol>
<li>Образ на docker-hub'е<br/>
<a href="https://habrastorage.org/webt/pq/zx/xf/pqzxxfn_dhfqnj6cxgxlcrkb6w0.png"><img src="https://habrastorage.org/r/w1560/webt/pq/zx/xf/pqzxxfn_dhfqnj6cxgxlcrkb6w0.png" data-src="https://habrastorage.org/webt/pq/zx/xf/pqzxxfn_dhfqnj6cxgxlcrkb6w0.png"/></a></li>
<li>Смотрим на список подов<br/>
<a href="https://habrastorage.org/webt/d_/s5/ev/d_s5evcbp9k24rddt1ffweipux8.png"><img src="https://habrastorage.org/r/w1560/webt/d_/s5/ev/d_s5evcbp9k24rddt1ffweipux8.png" data-src="https://habrastorage.org/webt/d_/s5/ev/d_s5evcbp9k24rddt1ffweipux8.png"/></a></li>
<li>И смотрим на версию образа, из которого развёрнут контейнер в одном из подов из 2-го пункта<br/>
<a href="https://habrastorage.org/webt/yb/h-/hr/ybh-hrr4ommmlrsqh4inb4_nii4.png"><img src="https://habrastorage.org/r/w1560/webt/yb/h-/hr/ybh-hrr4ommmlrsqh4inb4_nii4.png" data-src="https://habrastorage.org/webt/yb/h-/hr/ybh-hrr4ommmlrsqh4inb4_nii4.png"/></a></li>
<li>Делаем запрос и смотрим на ответ:</li>
</ol><br/>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">curl https://demo1.bihero.io/api/hello -v</b>
                        <div class="spoiler_text"><pre><code class="bash">curl https://demo1.bihero.io/api/hello -v                                                                                                                             5350  14:59:04  
*   Trying 178.63.194.243...
* TCP_NODELAY set
* Connected to demo1.bihero.io (178.63.194.243) port 443 (#0)
* ALPN, offering h2
* ALPN, offering http/1.1
* Cipher selection: ALL:!EXPORT:!EXPORT40:!EXPORT56:!aNULL:!LOW:!RC4:@STRENGTH
* successfully set certificate verify locations:
*   CAfile: /etc/ssl/certs/ca-certificates.crt
  CApath: /etc/ssl/certs
* TLSv1.2 (OUT), TLS header, Certificate Status (22):
* TLSv1.2 (OUT), TLS handshake, Client hello (1):
* TLSv1.2 (IN), TLS handshake, Server hello (2):
* TLSv1.2 (IN), TLS handshake, Certificate (11):
* TLSv1.2 (IN), TLS handshake, Server key exchange (12):
* TLSv1.2 (IN), TLS handshake, Server finished (14):
* TLSv1.2 (OUT), TLS handshake, Client key exchange (16):
* TLSv1.2 (OUT), TLS change cipher, Client hello (1):
* TLSv1.2 (OUT), TLS handshake, Finished (20):
* TLSv1.2 (IN), TLS change cipher, Client hello (1):
* TLSv1.2 (IN), TLS handshake, Finished (20):
* SSL connection using TLSv1.2 / ECDHE-RSA-AES256-GCM-SHA384
* ALPN, server accepted to use h2
* Server certificate:
*  subject: CN=*.bihero.io
*  start date: Nov  7 13:59:46 2019 GMT
*  expire date: Feb  5 13:59:46 2020 GMT
*  subjectAltName: host "demo1.bihero.io" matched cert's "*.bihero.io"
*  issuer: C=US; O=Let's Encrypt; CN=Let's Encrypt Authority X3
*  SSL certificate verify ok.
* Using HTTP2, server supports multi-use
* Connection state changed (HTTP/2 confirmed)
* Copying HTTP/2 data in stream buffer to connection buffer after upgrade: len=0
* Using Stream ID: 1 (easy handle 0x55778f779520)
> GET /api/hello HTTP/1.1
> Host: demo1.bihero.io
> User-Agent: curl/7.52.1
> Accept: */*
> 
* Connection state changed (MAX_CONCURRENT_STREAMS updated)!
&lt; HTTP/2 200 
&lt; server: nginx/1.15.8
&lt; date: Sun, 01 Dec 2019 11:59:06 GMT
&lt; content-type: text/plain
&lt; content-length: 5
&lt; strict-transport-security: max-age=15724800; includeSubDomains
&lt; 
* Curl_http_done: called premature == 0
* Connection #0 to host demo1.bihero.io left intact
Hello</code></pre></div>
                    </div><br/>
<p>Много всего было сделано, но давайте на забывать, для чего мы тут собрались. Продукт же пилим, и ещё целых два микросервиса не написаны. Дальше мы не будем подробно разжёвывать содержимое каждого оставшего сервиса, только лишь исходники и пайплайн сборки в спойлерах (разве что только для интеграционного сервиса замутим интеграционных тестов с testcontainers). А в конце будут выводы и внушительный TODO-лист (куда же без бэклога). Поехали!</p><br/>
<h2>'World' microservice</h2><br/>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">Service specification</b>
                        <div class="spoiler_text"><pre><code class="plaintext">openapi: 3.0.1
info:
  title: World ;)
  description: "'World' word microservice"
  version: 1.0.0
servers:
  - url: https://demo1.bihero.io/api/world
tags:
  - name: world
    description: Everything about 'World' word
paths:
  /:
    x-vertx-event-bus:
      address: service.world
      timeout: 1000
    get:
      tags:
        - world
      summary: Get 'World' word
      operationId: getWorldWord
      responses:
        200:
          description: OK
          content: {}
  /doc:
    x-vertx-event-bus:
      address: service.world
      timeout: 1000c
    get:
      tags:
        - world
      summary: Get 'World' microservice documentation
      operationId: getDoc
      responses:
        200:
          description: OK
components: {}</code></pre></div>
                    </div><br/>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">pom.xml</b>
                        <div class="spoiler_text"><pre><code class="xml">&lt;?xml version="1.0" encoding="UTF-8"?>
&lt;project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    &lt;modelVersion>4.0.0&lt;/modelVersion>

    &lt;properties>
        &lt;main.verticle>io.bihero.world.WorldVerticle&lt;/main.verticle>
        &lt;vertx.version>3.8.1&lt;/vertx.version>
        &lt;logback.version>1.2.3&lt;/logback.version>
        &lt;junit-jupiter.version>5.3.1&lt;/junit-jupiter.version>
        &lt;maven-surefire-plugin.version>2.19.1&lt;/maven-surefire-plugin.version>
        &lt;junit-platform-surefire-provider.version>1.1.0&lt;/junit-platform-surefire-provider.version>
        &lt;assertj-core.version>3.8.0&lt;/assertj-core.version>
        &lt;allure.version>2.8.1&lt;/allure.version>
        &lt;allure-maven.version>2.10.0&lt;/allure-maven.version>
        &lt;aspectj.version>1.9.2&lt;/aspectj.version>
        &lt;mockito.version>2.21.0&lt;/mockito.version>
        &lt;rest-assured.version>3.0.0&lt;/rest-assured.version>
    &lt;/properties>

    &lt;groupId>io.bihero&lt;/groupId>
    &lt;artifactId>world-microservice&lt;/artifactId>
    &lt;version>1.0.0-SNAPSHOT&lt;/version>
    &lt;build>
        &lt;plugins>
            &lt;plugin>
                &lt;artifactId>maven-compiler-plugin&lt;/artifactId>
                &lt;configuration>
```11&lt;/source>
                    &lt;target>11&lt;/target>
                &lt;/configuration>
                &lt;executions>
                    &lt;execution>
                        &lt;id>default-compile&lt;/id>
                        &lt;configuration>
                            &lt;annotationProcessors>
                                &lt;annotationProcessor>io.vertx.codegen.CodeGenProcessor&lt;/annotationProcessor>
                            &lt;/annotationProcessors>
                            &lt;generatedSourcesDirectory>src/main/generated&lt;/generatedSourcesDirectory>
                            &lt;compilerArgs>
                                &lt;arg>-Acodegen.output=${project.basedir}/src/main&lt;/arg>
                            &lt;/compilerArgs>
                        &lt;/configuration>
                    &lt;/execution>
                    &lt;execution>
                        &lt;id>default-testCompile&lt;/id>
                        &lt;configuration>
                            &lt;annotationProcessors>
                                &lt;annotationProcessor>io.vertx.codegen.CodeGenProcessor&lt;/annotationProcessor>
                            &lt;/annotationProcessors>
                            &lt;generatedTestSourcesDirectory>src/test/generated&lt;/generatedTestSourcesDirectory>
                            &lt;compilerArgs>
                                &lt;arg>-Acodegen.output=${project.basedir}/src/test&lt;/arg>
                            &lt;/compilerArgs>
                        &lt;/configuration>
                    &lt;/execution>
                &lt;/executions>
            &lt;/plugin>
            &lt;plugin>
                &lt;groupId>org.apache.maven.plugins&lt;/groupId>
                &lt;artifactId>maven-surefire-plugin&lt;/artifactId>
                &lt;version>${maven-surefire-plugin.version}&lt;/version>
                &lt;configuration>
                    &lt;properties>
                        &lt;property>
                            &lt;name>listener&lt;/name>
                            &lt;value>io.qameta.allure.junit5.AllureJunit5&lt;/value>
                        &lt;/property>
                    &lt;/properties>
                    &lt;includes>
                        &lt;include>**/*Test*.java&lt;/include>
                    &lt;/includes>
                    &lt;argLine>
                        -javaagent:"${settings.localRepository}/org/aspectj/aspectjweaver/${aspectj.version}/aspectjweaver-${aspectj.version}.jar" -Djdk.net.URLClassPath.disableClassPathURLCheck=true
                    &lt;/argLine>
                    &lt;systemProperties>
                        &lt;property>
                            &lt;name>allure.results.directory&lt;/name>
                            &lt;value>${project.basedir}/target/allure-results&lt;/value>
                        &lt;/property>
                        &lt;property>
                            &lt;name>junit.jupiter.extensions.autodetection.enabled&lt;/name>
                            &lt;value>true&lt;/value>
                        &lt;/property>
                    &lt;/systemProperties>
                    &lt;reportFormat>plain&lt;/reportFormat>
                &lt;/configuration>
                &lt;dependencies>
                    &lt;dependency>
                        &lt;groupId>org.aspectj&lt;/groupId>
                        &lt;artifactId>aspectjweaver&lt;/artifactId>
                        &lt;version>${aspectj.version}&lt;/version>
                    &lt;/dependency>
                    &lt;dependency>
                        &lt;groupId>org.junit.platform&lt;/groupId>
                        &lt;artifactId>junit-platform-surefire-provider&lt;/artifactId>
                        &lt;version>${junit-platform-surefire-provider.version}&lt;/version>
                    &lt;/dependency>
                    &lt;dependency>
                        &lt;groupId>org.junit.jupiter&lt;/groupId>
                        &lt;artifactId>junit-jupiter-engine&lt;/artifactId>
                        &lt;version>${junit-jupiter.version}&lt;/version>
                    &lt;/dependency>
                &lt;/dependencies>
            &lt;/plugin>
            &lt;plugin>
                &lt;groupId>io.qameta.allure&lt;/groupId>
                &lt;artifactId>allure-maven&lt;/artifactId>
                &lt;version>${allure-maven.version}&lt;/version>
            &lt;/plugin>
            &lt;plugin>
                &lt;groupId>org.apache.maven.plugins&lt;/groupId>
                &lt;artifactId>maven-site-plugin&lt;/artifactId>
                &lt;version>3.7.1&lt;/version>
                &lt;dependencies>
                    &lt;dependency>
                        &lt;groupId>org.apache.maven.wagon&lt;/groupId>
                        &lt;artifactId>wagon-webdav-jackrabbit&lt;/artifactId>
                        &lt;version>2.8&lt;/version>
                    &lt;/dependency>
                &lt;/dependencies>
            &lt;/plugin>

            &lt;plugin>
                &lt;groupId>org.apache.maven.plugins&lt;/groupId>
                &lt;artifactId>maven-project-info-reports-plugin&lt;/artifactId>
                &lt;version>3.0.0&lt;/version>
            &lt;/plugin>
            &lt;plugin>
                &lt;groupId>org.apache.maven.plugins&lt;/groupId>
                &lt;artifactId>maven-shade-plugin&lt;/artifactId>
                &lt;version>2.3&lt;/version>
                &lt;executions>
                    &lt;execution>
                        &lt;phase>package&lt;/phase>
                        &lt;goals>
                            &lt;goal>shade&lt;/goal>
                        &lt;/goals>
                        &lt;configuration>
                            &lt;transformers>
                                &lt;transformer implementation="org.apache.maven.plugins.shade.resource.ManifestResourceTransformer">
                                    &lt;manifestEntries>
                                        &lt;Main-Class>io.vertx.core.Launcher&lt;/Main-Class>
                                        &lt;Main-Verticle>${main.verticle}&lt;/Main-Verticle>
                                    &lt;/manifestEntries>
                                &lt;/transformer>
                                &lt;transformer implementation="org.apache.maven.plugins.shade.resource.AppendingTransformer">
                                    &lt;resource>META-INF/services/io.vertx.core.spi.VerticleFactory&lt;/resource>
                                &lt;/transformer>
                            &lt;/transformers>
                            &lt;artifactSet>
                            &lt;/artifactSet>
                            &lt;outputFile>${project.build.directory}/${project.artifactId}-fat.jar&lt;/outputFile>
                        &lt;/configuration>
                    &lt;/execution>
                &lt;/executions>
            &lt;/plugin>
        &lt;/plugins>
        &lt;resources>
            &lt;resource>
                &lt;directory>src/main/resources&lt;/directory>
                &lt;filtering>true&lt;/filtering>
                &lt;includes>
                    &lt;include>**/version.txt&lt;/include>
                &lt;/includes>
            &lt;/resource>
            &lt;resource>
                &lt;directory>src/main/resources&lt;/directory>
                &lt;filtering>false&lt;/filtering>
                &lt;excludes>
                    &lt;exclude>**/version.txt&lt;/exclude>
                &lt;/excludes>
            &lt;/resource>
        &lt;/resources>
    &lt;/build>
    &lt;distributionManagement>
        &lt;site>
            &lt;id>reports&lt;/id>
            &lt;url>dav:https://nexus.dev.techedge.pro:8443/repository/reports/${project.artifactId}/&lt;/url>
        &lt;/site>
    &lt;/distributionManagement>
    &lt;reporting>
        &lt;excludeDefaults>true&lt;/excludeDefaults>
        &lt;plugins>
            &lt;plugin>
                &lt;groupId>io.qameta.allure&lt;/groupId>
                &lt;artifactId>allure-maven&lt;/artifactId>
                &lt;configuration>
                    &lt;resultsDirectory>${project.build.directory}/allure-results&lt;/resultsDirectory>
                    &lt;reportDirectory>${project.reporting.outputDirectory}/${project.version}/allure&lt;/reportDirectory>
                &lt;/configuration>
            &lt;/plugin>
        &lt;/plugins>
    &lt;/reporting>

    &lt;dependencies>
        &lt;dependency>
            &lt;groupId>io.vertx&lt;/groupId>
            &lt;artifactId>vertx-web-api-service&lt;/artifactId>
            &lt;version>${vertx.version}&lt;/version>
        &lt;/dependency>
        &lt;dependency>
            &lt;groupId>io.vertx&lt;/groupId>
            &lt;artifactId>vertx-codegen&lt;/artifactId>
            &lt;version>${vertx.version}&lt;/version>
            &lt;scope>provided&lt;/scope>
        &lt;/dependency>
        &lt;dependency>
            &lt;groupId>ch.qos.logback&lt;/groupId>
            &lt;artifactId>logback-classic&lt;/artifactId>
            &lt;version>${logback.version}&lt;/version>
        &lt;/dependency>

        &lt;!-- test &amp;ndash;&amp;gt;-->
        &lt;dependency>
            &lt;groupId>io.vertx&lt;/groupId>
            &lt;artifactId>vertx-unit&lt;/artifactId>
            &lt;version>${vertx.version}&lt;/version>
            &lt;scope>test&lt;/scope>
        &lt;/dependency>
        &lt;dependency>
            &lt;groupId>io.vertx&lt;/groupId>
            &lt;artifactId>vertx-junit5&lt;/artifactId>
            &lt;version>${vertx.version}&lt;/version>
            &lt;scope>test&lt;/scope>
        &lt;/dependency>
        &lt;dependency>
            &lt;groupId>org.junit.jupiter&lt;/groupId>
            &lt;artifactId>junit-jupiter-api&lt;/artifactId>
            &lt;version>${junit-jupiter.version}&lt;/version>
            &lt;scope>test&lt;/scope>
        &lt;/dependency>
        &lt;dependency>
            &lt;groupId>org.junit.jupiter&lt;/groupId>
            &lt;artifactId>junit-jupiter-engine&lt;/artifactId>
            &lt;version>${junit-jupiter.version}&lt;/version>
            &lt;scope>test&lt;/scope>
        &lt;/dependency>
        &lt;dependency>
            &lt;groupId>org.assertj&lt;/groupId>
            &lt;artifactId>assertj-core&lt;/artifactId>
            &lt;version>${assertj-core.version}&lt;/version>
            &lt;scope>test&lt;/scope>
        &lt;/dependency>
        &lt;dependency>
            &lt;groupId>org.mockito&lt;/groupId>
            &lt;artifactId>mockito-core&lt;/artifactId>
            &lt;version>${mockito.version}&lt;/version>
            &lt;scope>test&lt;/scope>
        &lt;/dependency>
        &lt;dependency>
            &lt;groupId>io.qameta.allure&lt;/groupId>
            &lt;artifactId>allure-junit5&lt;/artifactId>
            &lt;version>${allure.version}&lt;/version>
            &lt;scope>test&lt;/scope>
        &lt;/dependency>
        &lt;dependency>
            &lt;groupId>io.vertx&lt;/groupId>
            &lt;artifactId>vertx-web-client&lt;/artifactId>
            &lt;version>${vertx.version}&lt;/version>
            &lt;scope>test&lt;/scope>
        &lt;/dependency>
    &lt;/dependencies>

&lt;/project></code></pre></div>
                    </div><br/>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">WorldService.java</b>
                        <div class="spoiler_text"><pre><code class="java">package io.bihero.world;

import io.vertx.core.AsyncResult;
import io.vertx.core.Handler;
import io.vertx.core.Vertx;
import io.vertx.ext.web.api.OperationRequest;
import io.vertx.ext.web.api.OperationResponse;
import io.vertx.ext.web.api.generator.WebApiServiceGen;

@WebApiServiceGen
public interface WorldService {

    static WorldService create(Vertx vertx) {
        return new DefaultWorldService(vertx);
    }

    void getWorldWord(OperationRequest context, Handler&lt;AsyncResult&lt;OperationResponse>> resultHandler);

    void getDoc(OperationRequest context, Handler&lt;AsyncResult&lt;OperationResponse>> resultHandler);

}</code></pre></div>
                    </div><br/>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">DefaultWorldService.java</b>
                        <div class="spoiler_text"><pre><code class="java">package io.bihero.world;

import io.vertx.core.AsyncResult;
import io.vertx.core.Future;
import io.vertx.core.Handler;
import io.vertx.core.Vertx;
import io.vertx.core.buffer.Buffer;
import io.vertx.ext.web.api.OperationRequest;
import io.vertx.ext.web.api.OperationResponse;

public class DefaultWorldService implements WorldService {

    private final Vertx vertx;

    public DefaultWorldService(Vertx vertx) {
        this.vertx = vertx;
    }

    public void getWorldWord(OperationRequest context, Handler&lt;AsyncResult&lt;OperationResponse>> resultHandler) {
        resultHandler.handle(Future.succeededFuture(OperationResponse.completedWithPlainText(Buffer.buffer("World"))));
    }

    @Override
    public void getDoc(OperationRequest context, Handler&lt;AsyncResult&lt;OperationResponse>> resultHandler) {
        vertx.fileSystem().readFile("doc.yaml", buffResult ->
                resultHandler.handle(Future.succeededFuture(
                        OperationResponse.completedWithPlainText(buffResult.result()))
                ));
    }

}</code></pre></div>
                    </div><br/>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">WorldVerticle.java</b>
                        <div class="spoiler_text"><pre><code class="java">package io.bihero.world;

import io.vertx.core.AbstractVerticle;
import io.vertx.core.Promise;
import io.vertx.core.eventbus.MessageConsumer;
import io.vertx.core.http.HttpServer;
import io.vertx.core.http.HttpServerOptions;
import io.vertx.core.json.JsonObject;
import io.vertx.ext.web.Router;
import io.vertx.ext.web.api.contract.openapi3.OpenAPI3RouterFactory;
import io.vertx.serviceproxy.ServiceBinder;

public class WorldVerticle extends AbstractVerticle {

    HttpServer server;
    MessageConsumer&lt;JsonObject> consumer;

    public void startWorldService() {
        consumer = new ServiceBinder(vertx).setAddress("service.world")
                .register(WorldService.class, WorldService.create(getVertx()));
    }

    /**
     * This method constructs the router factory, mounts services and handlers and starts the http server
     * with built router
     * @return
     */
    private Promise&lt;Void> startHttpServer() {
        Promise&lt;Void> promise = Promise.promise();
        OpenAPI3RouterFactory.create(this.vertx, "/doc.yaml", openAPI3RouterFactoryAsyncResult -> {
            if (openAPI3RouterFactoryAsyncResult.succeeded()) {
                OpenAPI3RouterFactory routerFactory = openAPI3RouterFactoryAsyncResult.result();

                // Mount services on event bus based on extensions
                routerFactory.mountServicesFromExtensions();

                // Generate the router
                Router router = routerFactory.getRouter();

                int port = config().getInteger("serverPort", 8080);
                String host = config().getString("serverHost", "localhost");

                server = vertx.createHttpServer(new HttpServerOptions().setPort(port).setHost(host));
                server.requestHandler(router).listen(ar -> {
                    // Error starting the HttpServer
                    if (ar.succeeded()) promise.complete();
                    else promise.fail(ar.cause());
                });
            } else {
                // Something went wrong during router factory initialization
                promise.fail(openAPI3RouterFactoryAsyncResult.cause());
            }
        });
        return promise;
    }

    @Override
    public void start(Promise&lt;Void> promise) {
        startWorldService();
        startHttpServer().future().setHandler(promise);
    }

    /**
     * This method closes the http server and unregister all services loaded to Event Bus
     */
    @Override
    public void stop(){
        this.server.close();
        consumer.unregister();
    }

}</code></pre></div>
                    </div><br/>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">WorldServiceTest.java</b>
                        <div class="spoiler_text"><pre><code class="java">package io.bihero.world;

import io.vertx.core.Vertx;
import io.vertx.core.json.JsonObject;
import io.vertx.ext.web.api.OperationRequest;
import io.vertx.junit5.VertxExtension;
import io.vertx.junit5.VertxTestContext;
import org.apache.commons.io.IOUtils;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;

import java.io.IOException;

import static org.assertj.core.api.Assertions.assertThat;

@ExtendWith(VertxExtension.class)
public class WorldServiceTest {

    private WorldService worldService = WorldService.create(Vertx.vertx());

    @Test
    @DisplayName("Test 'getWorldWord' method returns 'World' word")
    public void testHelloMethod(VertxTestContext testContext) {
        worldService.getWorldWord(new OperationRequest(new JsonObject()), testContext.succeeding(it -> {
            assertThat(it.getStatusCode()).isEqualTo(200);
            assertThat(it.getPayload().toString()).isEqualTo("World");
            testContext.completeNow();
        }));
    }

    @Test
    @DisplayName("Test 'getDoc' method returns service documentation in OpenAPI format")
    public void testDocMethod(VertxTestContext testContext) {
        worldService.getDoc(new OperationRequest(new JsonObject()), testContext.succeeding(it -> {
            try {
                assertThat(it.getStatusCode()).isEqualTo(200);
                assertThat(it.getPayload().toString()).isEqualTo(IOUtils.toString(this.getClass()
                        .getResourceAsStream("../../../doc.yaml"), "UTF-8"));
                testContext.completeNow();
            } catch (IOException e) {
                testContext.failNow(e);
            }
        }));
    }

}</code></pre></div>
                    </div><br/>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">WorldVerticleTest.java</b>
                        <div class="spoiler_text"><pre><code class="java">package io.bihero.world;

import io.vertx.core.Vertx;
import io.vertx.core.json.JsonObject;
import io.vertx.ext.web.client.WebClient;
import io.vertx.ext.web.codec.BodyCodec;
import io.vertx.junit5.Checkpoint;
import io.vertx.junit5.VertxExtension;
import io.vertx.junit5.VertxTestContext;
import org.apache.commons.io.IOUtils;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;

import static org.assertj.core.api.Assertions.assertThat;
import static org.mockito.Mockito.doReturn;
import static org.mockito.Mockito.spy;

@ExtendWith(VertxExtension.class)
public class WorldVerticleTest {

    @Test
    @DisplayName("Test that verticle is up and respond me by 'World' word and doc in OpenAPI format")
    public void testHelloVerticle(Vertx vertx, VertxTestContext testContext) {
        WebClient webClient = WebClient.create(vertx);

        Checkpoint deploymentCheckpoint = testContext.checkpoint();
        Checkpoint requestCheckpoint = testContext.checkpoint(2);

        WorldVerticle verticle = spy(new WorldVerticle());
        JsonObject config = new JsonObject().put("serverPort", 8082).put("serverHost", "0.0.0.0");
        doReturn(config).when(verticle).config();
        vertx.deployVerticle(verticle, testContext.succeeding(id -> {
            deploymentCheckpoint.flag();
            // test GET /
            webClient.get(8082, "localhost", "/")
                    .as(BodyCodec.string())
                    .send(testContext.succeeding(resp -> {
                        assertThat(resp.body()).isEqualTo("World");
                        assertThat(resp.statusCode()).isEqualTo(200);
                        requestCheckpoint.flag();
                    }));
            // test GET /doc
            webClient.get(8082, "localhost", "/doc")
                    .as(BodyCodec.string())
                    .send(testContext.succeeding(resp -> {
                        try {
                            assertThat(resp.body()).isEqualTo(IOUtils.toString(this.getClass()
                                    .getResourceAsStream("../../../doc.yaml"), "UTF-8"));
                            assertThat(resp.statusCode()).isEqualTo(200);
                            requestCheckpoint.flag();
                        } catch (Exception e) {
                            requestCheckpoint.flag();
                            testContext.failNow(e);
                        }
                    }));
        }));
    }

}</code></pre></div>
                    </div><br/>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">Dockerfile</b>
                        <div class="spoiler_text"><pre><code class="plaintext">FROM adoptopenjdk/openjdk11:alpine-jre
COPY target/world-microservice-fat.jar app.jar
COPY src/conf/config.json .
COPY src/conf/logback-console.xml .
COPY run.sh .
RUN chmod +x run.sh
CMD ["./run.sh"]</code></pre></div>
                    </div><br/>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">run.sh</b>
                        <div class="spoiler_text"><pre><code class="bash">#!/bin/sh
java ${JVM_OPTS} -Dlogback.configurationFile=./logback-console.xml -jar app.jar -conf config.json</code></pre></div>
                    </div><br/>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">pipeline.yaml</b>
                        <div class="spoiler_text"><pre><code class="plaintext">resource_types:
  - name: telegram
    type: docker-image
    source:
      repository: vtutrinov/concourse-telegram-resource
      tag: latest
  - name: kubernetes
    type: docker-image
    source:
      repository: zlabjp/kubernetes-resource
      tag: 1.16
  - name: metadata
    type: docker-image
    source:
      repository: olhtbr/metadata-resource
      tag: 2.0.1
resources:
  - name: metadata
    type: metadata
  - name: sources
    type: git
    source:
      branch: master
      uri: git@github.com:bihero-io/worldmicroservice.git
      private_key: ((deployer-private-key))
  - name: docker-image
    type: docker-image
    source:
      repository: bihero/world
      username: ((docker-registry-user))
      password: ((docker-registry-password))
  - name: telegram
    type: telegram
    source:
      bot_token: ((telegram-ci-bot-token))
      chat_id: ((telegram-group-to-report-build))
      ci_url: ((ci_url))
      command: "/build_world_ms"
  - name: kubernetes-demo
    type: kubernetes
    source:
      server: ((k8s-api-server))
      namespace: default
      kubeconfig: ((kubeconfig-demo))
jobs:
  - name: build-world-microservice
    serial: true
    public: true
    plan:
      - in_parallel:
          - get: sources
            trigger: true
          - get: telegram
            trigger: true
          - put: metadata
      - put: telegram
        params:
          status: Build In Progress
      - task: unit-tests
        config:
          platform: linux
          image_resource:
            type: docker-image
            source:
              repository: ((docker-registry-uri))/bih/maven-dind
              tag: 3-jdk-11
              username: ((docker-private-registry-user))
              password: ((docker-private-registry-password))
          inputs:
            - name: sources
          outputs:
            - name: tested-workspace
          run:
            path: /bin/sh
            args:
              - -c
              - |
                output_dir=tested-workspace
                cp -R ./sources/* "${output_dir}/"
                mvn -f "${output_dir}/pom.xml" clean test
          caches:
            - path: ~/.m2/
        on_failure:
          do:
            - task: tests-report
              config:
                platform: linux
                image_resource:
                  type: docker-image
                  source:
                    repository: ((docker-registry-uri))/bih/maven-dind
                    tag: 3-jdk-11
                    username: ((docker-private-registry-user))
                    password: ((docker-private-registry-password))
                inputs:
                  - name: tested-workspace
                outputs:
                  - name: message
                run:
                  path: /bin/sh
                  args:
                    - -c
                    - |
                      output_dir=tested-workspace
                      mvn -Dmaven.wagon.http.ssl.insecure=true -Dmaven.wagon.http.ssl.allowall=true -f "${output_dir}/pom.xml" site-deploy
                      version=$(cat $output_dir/target/classes/version.txt)
                      cat >message/msg &lt;&lt;EOL
                      &lt;a href="https://nexus.dev.techedge.pro:8443/repository/reports/hello-microservice/${version}/allure/">Allure report&lt;/a>
                      EOL
                caches:
                  - path: ~/.m2/
            - put: telegram
              params:
                status: Build Failed (unit-tests)
                message_file: message/msg
      - task: tests-report
        config:
          platform: linux
          image_resource:
            type: docker-image
            source:
              repository: ((docker-registry-uri))/bih/maven-dind
              tag: 3-jdk-11
              username: ((docker-private-registry-user))
              password: ((docker-private-registry-password))
          inputs:
            - name: tested-workspace
          outputs:
            - name: message
            - name: tested-workspace
          run:
            path: /bin/sh
            args:
              - -c
              - |
                work_dir=tested-workspace
                mvn -Dmaven.wagon.http.ssl.insecure=true -Dmaven.wagon.http.ssl.allowall=true -f "${work_dir}/pom.xml" site-deploy
                version=$(cat $work_dir/target/classes/version.txt)
                cat >message/msg &lt;&lt;EOL
                &lt;a href="https://nexus.dev.techedge.pro:8443/repository/reports/world-microservice/${version}/allure/">Allure report&lt;/a>
                EOL
          caches:
            - path: ~/.m2/
      - task: package
        config:
          platform: linux
          image_resource:
            type: docker-image
            source:
              repository: ((docker-registry-uri))/bih/maven-dind
              tag: 3-jdk-11
              username: ((docker-private-registry-user))
              password: ((docker-private-registry-password))
          inputs:
            - name: tested-workspace
            - name: metadata
          outputs:
            - name: app-packaged-workspace
            - name: metadata
          run:
            path: /bin/sh
            args:
              - -c
              - |
                output_dir=app-packaged-workspace
                cp -R ./tested-workspace/* "${output_dir}/"
                mvn -f "${output_dir}/pom.xml" package -Dmaven.main.skip -DskipTests
                tag="-"$(cat metadata/build_name)
                echo $tag >> ${output_dir}/target/classes/version.txt
                cat ${output_dir}/target/classes/version.txt > metadata/version
          caches:
            - path: ~/.m2/
        on_failure:
          do:
            - put: telegram
              params:
                status: Build Failed (package)
      - put: docker-image
        params:
          build: app-packaged-workspace
          tag_file: app-packaged-workspace/target/classes/version.txt
          tag_as_latest: true
        get_params:
          skip_download: true
      - task: make-k8s-app-template
        config:
          platform: linux
          image_resource:
            type: docker-image
            source:
              repository: bhgedigital/envsubst
          inputs:
            - name: sources
            - name: metadata
          outputs:
            - name: k8s
          run:
            path: /bin/sh
            args:
              - -c
              - |
                export DOMAIN=demo1.bihero.io
                export WORLD_SERVICE_IMAGE_VERSION=$(cat metadata/version)
                cat sources/k8s.yaml | envsubst > k8s/world_app_template.yaml
                cat k8s/world_app_template.yaml
      - put: kubernetes-demo
        params:
          kubectl: apply -f k8s/world_app_template.yaml
      - put: telegram
        params:
          status: Build Success
          message_file: message/msg</code></pre></div>
                    </div><br/>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">k8s app template</b>
                        <div class="spoiler_text"><pre><code class="plaintext">apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  labels:
    io.bihero.hello.service: bihero-world
  name: bihero-world
spec:
  replicas: 3
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 1
  template:
    metadata:
      labels:
        io.bihero.hello.service: bihero-world
    spec:
      containers:
        - image: bihero/world:${WORLD_SERVICE_IMAGE_VERSION}
          name: bihero-world
          ports:
            - containerPort: 8082
          imagePullPolicy: Always
          resources: {}
      restartPolicy: Always
---
apiVersion: v1
kind: Service
metadata:
  labels:
    io.bihero.hello.service: bihero-world
  name: bihero-world
spec:
  ports:
    - name: "8082"
      port: 8082
      targetPort: 8082
  selector:
    io.bihero.hello.service: bihero-world
status:
  loadBalancer: {}
---
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: bihero-world
  annotations:
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/secure-backends: "false"
    nginx.ingress.kubernetes.io/ssl-passthrough: "false"
    nginx.ingress.kubernetes.io/rewrite-target: /$2
    kubernetes.io/tls-acme: "true"
  namespace: default
spec:
  tls:
    - hosts:
        - ${DOMAIN}
      secretName: bihero
  rules:
    - host: ${DOMAIN}
      http:
        paths:
          - path: /api/world(/|$)(.*)
            backend:
              serviceName: bihero-world
              servicePort: 8082</code></pre></div>
                    </div><br/>
<h2>'HelloWorld' microservice</h2><br/>
<p>Этот орешек оказался крепче, чем казалось изначально. Ну, да ладно, мы и его раскололи. Основные сложности возникли при запуске интеграционных тестов с testcontainers, но обо всё по порядку.</p><br/>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">Service specification</b>
                        <div class="spoiler_text"><pre><code class="plaintext">openapi: 3.0.1
info:
  title: Hello World ;)
  description: "Hello World microservice. Aggregate 'Hello World' by hellomicroservice and worldmicroservice"
  version: 1.0.0
servers:
  - url: https://demo1.bihero.io/api/helloworld
tags:
  - name: helloworld
    description: Everything about 'Hello World'
paths:
  /:
    x-vertx-event-bus:
      address: service.helloworld
      timeout: 1000
    get:
      tags:
        - helloworld
      summary: Aggregate 'Hello World'
      operationId: getHelloWorld
      responses:
        200:
          description: OK
          content: {}
  /doc:
    x-vertx-event-bus:
      address: service.helloworld
      timeout: 1000c
    get:
      tags:
        - world
      summary: Get 'Hello World' microservice documentation
      operationId: getDoc
      responses:
        200:
          description: OK
components: {}</code></pre></div>
                    </div><br/>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">pom.xml</b>
                        <div class="spoiler_text"><pre><code class="xml">&lt;?xml version="1.0" encoding="UTF-8"?>
&lt;project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    &lt;modelVersion>4.0.0&lt;/modelVersion>

    &lt;properties>
        &lt;main.verticle>io.bihero.helloworld.HelloWorldVerticle&lt;/main.verticle>
        &lt;vertx.version>3.8.1&lt;/vertx.version>
        &lt;logback.version>1.2.3&lt;/logback.version>
        &lt;junit-jupiter.version>5.3.1&lt;/junit-jupiter.version>
        &lt;maven-surefire-plugin.version>2.19.1&lt;/maven-surefire-plugin.version>
        &lt;junit-platform-surefire-provider.version>1.1.0&lt;/junit-platform-surefire-provider.version>
        &lt;assertj-core.version>3.8.0&lt;/assertj-core.version>
        &lt;allure.version>2.8.1&lt;/allure.version>
        &lt;allure-maven.version>2.10.0&lt;/allure-maven.version>
        &lt;aspectj.version>1.9.2&lt;/aspectj.version>
        &lt;mockito.version>2.21.0&lt;/mockito.version>
        &lt;rest-assured.version>3.0.0&lt;/rest-assured.version>
        &lt;testcontainers.version>1.12.3&lt;/testcontainers.version>
    &lt;/properties>

    &lt;groupId>io.bihero&lt;/groupId>
    &lt;artifactId>hello-world-microservice&lt;/artifactId>
    &lt;version>1.0.0-SNAPSHOT&lt;/version>
    &lt;build>
        &lt;plugins>
            &lt;plugin>
                &lt;artifactId>maven-compiler-plugin&lt;/artifactId>
                &lt;configuration>
```11&lt;/source>
                    &lt;target>11&lt;/target>
                &lt;/configuration>
                &lt;executions>
                    &lt;execution>
                        &lt;id>default-compile&lt;/id>
                        &lt;configuration>
                            &lt;annotationProcessors>
                                &lt;annotationProcessor>io.vertx.codegen.CodeGenProcessor&lt;/annotationProcessor>
                            &lt;/annotationProcessors>
                            &lt;generatedSourcesDirectory>src/main/generated&lt;/generatedSourcesDirectory>
                            &lt;compilerArgs>
                                &lt;arg>-Acodegen.output=${project.basedir}/src/main&lt;/arg>
                            &lt;/compilerArgs>
                        &lt;/configuration>
                    &lt;/execution>
                    &lt;execution>
                        &lt;id>default-testCompile&lt;/id>
                        &lt;configuration>
                            &lt;annotationProcessors>
                                &lt;annotationProcessor>io.vertx.codegen.CodeGenProcessor&lt;/annotationProcessor>
                            &lt;/annotationProcessors>
                            &lt;generatedTestSourcesDirectory>src/test/generated&lt;/generatedTestSourcesDirectory>
                            &lt;compilerArgs>
                                &lt;arg>-Acodegen.output=${project.basedir}/src/test&lt;/arg>
                            &lt;/compilerArgs>
                        &lt;/configuration>
                    &lt;/execution>
                &lt;/executions>
            &lt;/plugin>
            &lt;plugin>
                &lt;groupId>org.apache.maven.plugins&lt;/groupId>
                &lt;artifactId>maven-surefire-plugin&lt;/artifactId>
                &lt;version>${maven-surefire-plugin.version}&lt;/version>
                &lt;configuration>
                    &lt;properties>
                        &lt;property>
                            &lt;name>listener&lt;/name>
                            &lt;value>io.qameta.allure.junit5.AllureJunit5&lt;/value>
                        &lt;/property>
                    &lt;/properties>
                    &lt;includes>
                        &lt;include>**/*Test.java&lt;/include>
                    &lt;/includes>
                    &lt;argLine>
                        -javaagent:"${settings.localRepository}/org/aspectj/aspectjweaver/${aspectj.version}/aspectjweaver-${aspectj.version}.jar" -Djdk.net.URLClassPath.disableClassPathURLCheck=true
                    &lt;/argLine>
                    &lt;systemProperties>
                        &lt;property>
                            &lt;name>allure.results.directory&lt;/name>
                            &lt;value>${project.basedir}/target/allure-results&lt;/value>
                        &lt;/property>
                        &lt;property>
                            &lt;name>junit.jupiter.extensions.autodetection.enabled&lt;/name>
                            &lt;value>true&lt;/value>
                        &lt;/property>
                    &lt;/systemProperties>
                    &lt;reportFormat>plain&lt;/reportFormat>
                &lt;/configuration>
                &lt;dependencies>
                    &lt;dependency>
                        &lt;groupId>org.aspectj&lt;/groupId>
                        &lt;artifactId>aspectjweaver&lt;/artifactId>
                        &lt;version>${aspectj.version}&lt;/version>
                    &lt;/dependency>
                    &lt;dependency>
                        &lt;groupId>org.junit.platform&lt;/groupId>
                        &lt;artifactId>junit-platform-surefire-provider&lt;/artifactId>
                        &lt;version>${junit-platform-surefire-provider.version}&lt;/version>
                    &lt;/dependency>
                    &lt;dependency>
                        &lt;groupId>org.junit.jupiter&lt;/groupId>
                        &lt;artifactId>junit-jupiter-engine&lt;/artifactId>
                        &lt;version>${junit-jupiter.version}&lt;/version>
                    &lt;/dependency>
                &lt;/dependencies>
            &lt;/plugin>
            &lt;plugin>
                &lt;groupId>io.qameta.allure&lt;/groupId>
                &lt;artifactId>allure-maven&lt;/artifactId>
                &lt;version>${allure-maven.version}&lt;/version>
            &lt;/plugin>
            &lt;plugin>
                &lt;groupId>org.apache.maven.plugins&lt;/groupId>
                &lt;artifactId>maven-site-plugin&lt;/artifactId>
                &lt;version>3.7.1&lt;/version>
                &lt;dependencies>
                    &lt;dependency>
                        &lt;groupId>org.apache.maven.wagon&lt;/groupId>
                        &lt;artifactId>wagon-webdav-jackrabbit&lt;/artifactId>
                        &lt;version>2.8&lt;/version>
                    &lt;/dependency>
                &lt;/dependencies>
            &lt;/plugin>

            &lt;plugin>
                &lt;groupId>org.apache.maven.plugins&lt;/groupId>
                &lt;artifactId>maven-project-info-reports-plugin&lt;/artifactId>
                &lt;version>3.0.0&lt;/version>
            &lt;/plugin>
            &lt;plugin>
                &lt;groupId>org.apache.maven.plugins&lt;/groupId>
                &lt;artifactId>maven-shade-plugin&lt;/artifactId>
                &lt;version>2.3&lt;/version>
                &lt;executions>
                    &lt;execution>
                        &lt;phase>package&lt;/phase>
                        &lt;goals>
                            &lt;goal>shade&lt;/goal>
                        &lt;/goals>
                        &lt;configuration>
                            &lt;transformers>
                                &lt;transformer implementation="org.apache.maven.plugins.shade.resource.ManifestResourceTransformer">
                                    &lt;manifestEntries>
                                        &lt;Main-Class>io.vertx.core.Launcher&lt;/Main-Class>
                                        &lt;Main-Verticle>${main.verticle}&lt;/Main-Verticle>
                                    &lt;/manifestEntries>
                                &lt;/transformer>
                                &lt;transformer implementation="org.apache.maven.plugins.shade.resource.AppendingTransformer">
                                    &lt;resource>META-INF/services/io.vertx.core.spi.VerticleFactory&lt;/resource>
                                &lt;/transformer>
                            &lt;/transformers>
                            &lt;artifactSet>
                            &lt;/artifactSet>
                            &lt;outputFile>${project.build.directory}/${project.artifactId}-fat.jar&lt;/outputFile>
                        &lt;/configuration>
                    &lt;/execution>
                &lt;/executions>
            &lt;/plugin>
        &lt;/plugins>
        &lt;resources>
            &lt;resource>
                &lt;directory>src/main/resources&lt;/directory>
                &lt;filtering>true&lt;/filtering>
                &lt;includes>
                    &lt;include>**/version.txt&lt;/include>
                &lt;/includes>
            &lt;/resource>
            &lt;resource>
                &lt;directory>src/main/resources&lt;/directory>
                &lt;filtering>false&lt;/filtering>
                &lt;excludes>
                    &lt;exclude>**/version.txt&lt;/exclude>
                &lt;/excludes>
            &lt;/resource>
        &lt;/resources>
    &lt;/build>
    &lt;distributionManagement>
        &lt;site>
            &lt;id>reports&lt;/id>
            &lt;url>dav:https://nexus.dev.techedge.pro:8443/repository/reports/${project.artifactId}/&lt;/url>
        &lt;/site>
    &lt;/distributionManagement>
    &lt;reporting>
        &lt;excludeDefaults>true&lt;/excludeDefaults>
        &lt;plugins>
            &lt;plugin>
                &lt;groupId>io.qameta.allure&lt;/groupId>
                &lt;artifactId>allure-maven&lt;/artifactId>
                &lt;configuration>
                    &lt;resultsDirectory>${project.build.directory}/allure-results&lt;/resultsDirectory>
                    &lt;reportDirectory>${project.reporting.outputDirectory}/${project.version}/allure&lt;/reportDirectory>
                &lt;/configuration>
            &lt;/plugin>
        &lt;/plugins>
    &lt;/reporting>

    &lt;dependencies>
        &lt;dependency>
            &lt;groupId>io.vertx&lt;/groupId>
            &lt;artifactId>vertx-web-api-service&lt;/artifactId>
            &lt;version>${vertx.version}&lt;/version>
        &lt;/dependency>
        &lt;dependency>
            &lt;groupId>io.vertx&lt;/groupId>
            &lt;artifactId>vertx-web-client&lt;/artifactId>
            &lt;version>${vertx.version}&lt;/version>
        &lt;/dependency>
        &lt;dependency>
            &lt;groupId>io.vertx&lt;/groupId>
            &lt;artifactId>vertx-codegen&lt;/artifactId>
            &lt;version>${vertx.version}&lt;/version>
            &lt;scope>provided&lt;/scope>
        &lt;/dependency>
        &lt;dependency>
            &lt;groupId>ch.qos.logback&lt;/groupId>
            &lt;artifactId>logback-classic&lt;/artifactId>
            &lt;version>${logback.version}&lt;/version>
        &lt;/dependency>

        &lt;!-- test &amp;ndash;&amp;gt;-->
        &lt;dependency>
            &lt;groupId>io.vertx&lt;/groupId>
            &lt;artifactId>vertx-unit&lt;/artifactId>
            &lt;version>${vertx.version}&lt;/version>
            &lt;scope>test&lt;/scope>
        &lt;/dependency>
        &lt;dependency>
            &lt;groupId>io.vertx&lt;/groupId>
            &lt;artifactId>vertx-junit5&lt;/artifactId>
            &lt;version>${vertx.version}&lt;/version>
            &lt;scope>test&lt;/scope>
        &lt;/dependency>
        &lt;dependency>
            &lt;groupId>org.junit.jupiter&lt;/groupId>
            &lt;artifactId>junit-jupiter-api&lt;/artifactId>
            &lt;version>${junit-jupiter.version}&lt;/version>
            &lt;scope>test&lt;/scope>
        &lt;/dependency>
        &lt;dependency>
            &lt;groupId>org.junit.jupiter&lt;/groupId>
            &lt;artifactId>junit-jupiter-engine&lt;/artifactId>
            &lt;version>${junit-jupiter.version}&lt;/version>
            &lt;scope>test&lt;/scope>
        &lt;/dependency>
        &lt;dependency>
            &lt;groupId>org.assertj&lt;/groupId>
            &lt;artifactId>assertj-core&lt;/artifactId>
            &lt;version>${assertj-core.version}&lt;/version>
            &lt;scope>test&lt;/scope>
        &lt;/dependency>
        &lt;dependency>
            &lt;groupId>org.mockito&lt;/groupId>
            &lt;artifactId>mockito-core&lt;/artifactId>
            &lt;version>${mockito.version}&lt;/version>
            &lt;scope>test&lt;/scope>
        &lt;/dependency>
        &lt;dependency>
            &lt;groupId>io.qameta.allure&lt;/groupId>
            &lt;artifactId>allure-junit5&lt;/artifactId>
            &lt;version>${allure.version}&lt;/version>
            &lt;scope>test&lt;/scope>
        &lt;/dependency>
        &lt;dependency>
            &lt;groupId>org.testcontainers&lt;/groupId>
            &lt;artifactId>junit-jupiter&lt;/artifactId>
            &lt;version>${testcontainers.version}&lt;/version>
        &lt;/dependency>
    &lt;/dependencies>

&lt;/project></code></pre></div>
                    </div><br/>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">HelloWorldService.java</b>
                        <div class="spoiler_text"><pre><code class="java">package io.bihero.helloworld;

import io.vertx.core.AsyncResult;
import io.vertx.core.Handler;
import io.vertx.core.Vertx;
import io.vertx.core.json.JsonObject;
import io.vertx.ext.web.api.OperationRequest;
import io.vertx.ext.web.api.OperationResponse;
import io.vertx.ext.web.api.generator.WebApiServiceGen;

@WebApiServiceGen
public interface HelloWorldService {

    static HelloWorldService create(Vertx vertx, JsonObject config) {
        return new DefaultHelloWorldService(vertx, config);
    }

    void getHelloWorld(OperationRequest context, Handler&lt;AsyncResult&lt;OperationResponse>> resultHandler);

    void getDoc(OperationRequest context, Handler&lt;AsyncResult&lt;OperationResponse>> resultHandler);

}</code></pre></div>
                    </div><br/>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">DefaultHelloWorldService.java</b>
                        <div class="spoiler_text"><pre><code class="java">package io.bihero.helloworld;

import io.vertx.core.*;
import io.vertx.core.buffer.Buffer;
import io.vertx.core.json.JsonObject;
import io.vertx.ext.web.api.OperationRequest;
import io.vertx.ext.web.api.OperationResponse;
import io.vertx.ext.web.client.WebClient;

public class DefaultHelloWorldService implements HelloWorldService {

    private final Vertx vertx;

    private final JsonObject config;

    private final WebClient webClient;

    public DefaultHelloWorldService(Vertx vertx, JsonObject config) {
        this.vertx = vertx;
        this.config = config;
        this.webClient = WebClient.create(this.vertx);
    }

    @Override
    public void getHelloWorld(OperationRequest context, Handler&lt;AsyncResult&lt;OperationResponse>> resultHandler) {
        getHelloWord().compose(this::getHelloWorld).setHandler(v ->
                resultHandler.handle(
                        Future.succeededFuture(OperationResponse.completedWithPlainText(Buffer.buffer(v.result())))
                ));
    }

    @Override
    public void getDoc(OperationRequest context, Handler&lt;AsyncResult&lt;OperationResponse>> resultHandler) {
        vertx.fileSystem().readFile("doc.yaml", buffResult ->
                resultHandler.handle(Future.succeededFuture(
                        OperationResponse.completedWithPlainText(buffResult.result()))
                ));
    }

    private Future&lt;String> getHelloWord() {
        Future&lt;String> future = Future.future();
        webClient.get(config.getInteger("hello-service-port"), config.getString("hello-service-host"), "/").send(ar ->
                future.handle(Future.succeededFuture(ar.result().bodyAsString())));
        return future;
    }

    private Future&lt;String> getHelloWorld(String helloWord) {
        Future&lt;String> future = Future.future();
        webClient.get(config.getInteger("world-service-port"), config.getString("world-service-host"), "/").send(ar ->
                future.handle(Future.succeededFuture(helloWord + " " + ar.result().bodyAsString())));
        return future;
    }

}</code></pre></div>
                    </div><br/>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">HelloWorldVerticle.java</b>
                        <div class="spoiler_text"><pre><code class="java">package io.bihero.helloworld;

import io.vertx.core.AbstractVerticle;
import io.vertx.core.Promise;
import io.vertx.core.eventbus.MessageConsumer;
import io.vertx.core.http.HttpServer;
import io.vertx.core.http.HttpServerOptions;
import io.vertx.core.json.JsonObject;
import io.vertx.ext.web.Router;
import io.vertx.ext.web.api.contract.openapi3.OpenAPI3RouterFactory;
import io.vertx.serviceproxy.ServiceBinder;

public class HelloWorldVerticle extends AbstractVerticle {

    HttpServer server;
    MessageConsumer&lt;JsonObject> consumer;

    public void startWorldService() {
        consumer = new ServiceBinder(vertx).setAddress("service.helloworld")
                .register(HelloWorldService.class, HelloWorldService.create(vertx, config()));
    }

    /**
     * This method constructs the router factory, mounts services and handlers and starts the http server
     * with built router
     * @return
     */
    private Promise&lt;Void> startHttpServer() {
        Promise&lt;Void> promise = Promise.promise();
        OpenAPI3RouterFactory.create(this.vertx, "/doc.yaml", openAPI3RouterFactoryAsyncResult -> {
            if (openAPI3RouterFactoryAsyncResult.succeeded()) {
                OpenAPI3RouterFactory routerFactory = openAPI3RouterFactoryAsyncResult.result();

                // Mount services on event bus based on extensions
                routerFactory.mountServicesFromExtensions();

                // Generate the router
                Router router = routerFactory.getRouter();

                int port = config().getInteger("serverPort", 8080);
                String host = config().getString("serverHost", "localhost");

                server = vertx.createHttpServer(new HttpServerOptions().setPort(port).setHost(host));
                server.requestHandler(router).listen(ar -> {
                    // Error starting the HttpServer
                    if (ar.succeeded()) promise.complete();
                    else promise.fail(ar.cause());
                });
            } else {
                // Something went wrong during router factory initialization
                promise.fail(openAPI3RouterFactoryAsyncResult.cause());
            }
        });
        return promise;
    }

    @Override
    public void start(Promise&lt;Void> promise) {
        startWorldService();
        startHttpServer().future().setHandler(promise);
    }

    /**
     * This method closes the http server and unregister all services loaded to Event Bus
     */
    @Override
    public void stop(){
        this.server.close();
        consumer.unregister();
    }

}</code></pre></div>
                    </div><br/>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">HelloWorldServiceTest.java</b>
                        <div class="spoiler_text"><pre><code class="java">package io.bihero.helloworld;

import io.vertx.core.DeploymentOptions;
import io.vertx.core.Vertx;
import io.vertx.core.json.JsonObject;
import io.vertx.ext.web.client.WebClient;
import io.vertx.ext.web.codec.BodyCodec;
import io.vertx.junit5.Checkpoint;
import io.vertx.junit5.VertxExtension;
import io.vertx.junit5.VertxTestContext;
import org.apache.commons.io.IOUtils;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.testcontainers.containers.GenericContainer;
import org.testcontainers.junit.jupiter.Container;
import org.testcontainers.junit.jupiter.Testcontainers;

import static org.assertj.core.api.Assertions.assertThat;
import static org.mockito.Mockito.spy;

@Testcontainers
@ExtendWith(VertxExtension.class)
public class HelloWorldServiceTest {

    @Container
    private static final GenericContainer helloServiceContainer = new GenericContainer("bihero/hello")
            .withExposedPorts(8081);

    @Container
    private static final GenericContainer worldServiceContainer = new GenericContainer("bihero/world")
            .withExposedPorts(8082);

    @Test
    @DisplayName("Test 'helloworld' microservice respond by 'Hello World' string and doc in OpenAPI format")
    public void testHelloWorld(Vertx vertx, VertxTestContext testContext) {
        WebClient webClient = WebClient.create(vertx);

        Checkpoint deploymentCheckpoint = testContext.checkpoint();
        Checkpoint requestCheckpoint = testContext.checkpoint(2);

        HelloWorldVerticle verticle = spy(new HelloWorldVerticle());
        JsonObject config = new JsonObject().put("serverPort", 8083)
                                            .put("serverHost", "0.0.0.0")
                                            .put("hello-service-host", helloServiceContainer.getContainerIpAddress())
                                            .put("world-service-host", worldServiceContainer.getContainerIpAddress())
                                            .put("hello-service-port", helloServiceContainer.getMappedPort(8081))
                                            .put("world-service-port", worldServiceContainer.getMappedPort(8082));
        DeploymentOptions deploymentOptions = new DeploymentOptions().setConfig(config);
        vertx.deployVerticle(verticle, deploymentOptions, testContext.succeeding(id -> {
            deploymentCheckpoint.flag();
            // test GET /
            webClient.get(8083, "localhost", "/")
                    .as(BodyCodec.string())
                    .send(testContext.succeeding(resp -> {
                        assertThat(resp.body()).isEqualTo("Hello World");
                        assertThat(resp.statusCode()).isEqualTo(200);
                        requestCheckpoint.flag();
                    }));
            // test GET /doc
            webClient.get(8083, "localhost", "/doc")
                    .as(BodyCodec.string())
                    .send(testContext.succeeding(resp -> {
                        try {
                            assertThat(resp.body()).isEqualTo(IOUtils.toString(this.getClass()
                                    .getResourceAsStream("../../../doc.yaml"), "UTF-8"));
                            assertThat(resp.statusCode()).isEqualTo(200);
                            requestCheckpoint.flag();
                        } catch (Exception e) {
                            requestCheckpoint.flag();
                            testContext.failNow(e);
                        }
                    }));
        }));
    }

}</code></pre></div>
                    </div><br/>
<p>Dockerfile для интеграционного сервиса немножечко отличается от двух сервисов выше — конфиг для сервиса мы кладём не в <strong>/</strong> как обычно, а в <strong>/usr/local</strong>, чтобы иметь возможность переопределять его ConfigMap'ом при запуске сервиса в k8s</p><br/>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">Dockerfile</b>
                        <div class="spoiler_text"><pre><code class="plaintext">FROM adoptopenjdk/openjdk11:alpine-jre
COPY target/hello-world-microservice-fat.jar app.jar
COPY src/conf/config.json /usr/local/config.json
COPY src/conf/logback-console.xml .
COPY run.sh .
RUN chmod +x run.sh
CMD ["./run.sh"]</code></pre></div>
                    </div><br/>
<p>Итак, подошли к пайпалйну сборки и тут стоит пояснить, как вообще CI крутится и как там таски запускаются. Concourse в той конфигурации, на основе которой писалась эта статья, имеет несколько worker-нод и всё они запущены docker-compose'ом (рядом ещё крутятся ui-нода и postgresql). Таски в джобах — это тоже отдельно стартующие docker-контейнеры, то есть мы уже имеем docker в docker'е. А ещё мы очень хотим интеграционные тесты запускать с помощью testcontainers (в нашем кейсе сервисы <strong>hello</strong> и <strong>world</strong> запускаем при помощи этого крутого тула). Чувствуете чем пахнет? Правилько: <strong>докер в докере в докере</strong>! И для этого нам нужен модный образ с docker'ом, maven'ом и 11-ой джавой на борту. Встречаем, Dockerfile:</p><br/>
<pre><code class="plaintext">FROM alpine:3.7

ENV DOCKER_CHANNEL=stable \
    DOCKER_VERSION=17.12.1-ce \
    DOCKER_COMPOSE_VERSION=1.19.0 \
    DOCKER_SQUASH=0.2.0
# Install Docker, Docker Compose, Docker Squash
RUN apk --update --no-cache add \
        bash \
        curl \
        device-mapper \
        py-pip \
        iptables \
        util-linux \
        ca-certificates \
        maven \
        openjdk11 --repository=http://dl-cdn.alpinelinux.org/alpine/edge/community \
        &amp;&amp; \
    apk upgrade &amp;&amp; \
    curl -fL "https://download.docker.com/linux/static/${DOCKER_CHANNEL}/x86_64/docker-${DOCKER_VERSION}.tgz" | tar zx &amp;&amp; \
    mv /docker/* /bin/ &amp;&amp; chmod +x /bin/docker* &amp;&amp; \
    pip install docker-compose==${DOCKER_COMPOSE_VERSION} &amp;&amp; \
    curl -fL "https://github.com/jwilder/docker-squash/releases/download/v${DOCKER_SQUASH}/docker-squash-linux-amd64-v${DOCKER_SQUASH}.tar.gz" | tar zx &amp;&amp; \
    mv /docker-squash* /bin/ &amp;&amp; chmod +x /bin/docker-squash* &amp;&amp; \
    rm -rf /var/cache/apk/* &amp;&amp; \
    rm -rf /root/.cache

COPY repository /root/.m2/repository # тут мы кладём в образ вендор-зависимости, чтобы не тянуть и при каждом билде с централа
COPY settings.xml /root/.m2/settings.xml # конфиг для maven'а с кредами к приватному репозиторию
COPY entrypoint.sh /bin/entrypoint.sh # волшебный баш-скрипт, который даёт нам возможность стартовать докер в таске
ENV JAVA_HOME=/usr/lib/jvm/java-11-openjdk/
ENTRYPOINT ["entrypoint.sh"]</code></pre><br/>
<p>В пайплайне сборки на шаг запуска тестов будем заходить через <em>entrypoint.sh</em>, который обеспечит нам запуск докера перед запуском самих тестов:</p><br/>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">entrypoint.sh</b>
                        <div class="spoiler_text"><pre><code class="bash">#!/usr/bin/env bash

# Inspired by concourse/docker-image-resource:
# https://github.com/concourse/docker-image-resource/blob/master/assets/common.sh

set -o errexit -o pipefail -o nounset

# Waits DOCKERD_TIMEOUT seconds for startup (default: 60)
DOCKERD_TIMEOUT="${DOCKERD_TIMEOUT:-60}"
# Accepts optional DOCKER_OPTS (default: --data-root /scratch/docker)
DOCKER_OPTS="${DOCKER_OPTS:-}"

# Constants
DOCKERD_PID_FILE="/tmp/docker.pid"
DOCKERD_LOG_FILE="/tmp/docker.log"

sanitize_cgroups() {
  local cgroup="/sys/fs/cgroup"

  mkdir -p "${cgroup}"
  if ! mountpoint -q "${cgroup}"; then
    if ! mount -t tmpfs -o uid=0,gid=0,mode=0755 cgroup "${cgroup}"; then
      echo >&amp;2 "Could not make a tmpfs mount. Did you use --privileged?"
      exit 1
    fi
  fi
  mount -o remount,rw "${cgroup}"

  # Skip AppArmor
  # See: https://github.com/moby/moby/commit/de191e86321f7d3136ff42ff75826b8107399497
  export container=docker

  # Mount /sys/kernel/security
  if [[ -d /sys/kernel/security ]] &amp;&amp; ! mountpoint -q /sys/kernel/security; then
    if ! mount -t securityfs none /sys/kernel/security; then
      echo >&amp;2 "Could not mount /sys/kernel/security."
      echo >&amp;2 "AppArmor detection and --privileged mode might break."
    fi
  fi

  sed -e 1d /proc/cgroups | while read sys hierarchy num enabled; do
    if [[ "${enabled}" != "1" ]]; then
      # subsystem disabled; skip
      continue
    fi

    grouping="$(cat /proc/self/cgroup | cut -d: -f2 | grep "\\&lt;${sys}\\>")"
    if [[ -z "${grouping}" ]]; then
      # subsystem not mounted anywhere; mount it on its own
      grouping="${sys}"
    fi

    mountpoint="${cgroup}/${grouping}"

    mkdir -p "${mountpoint}"

    # clear out existing mount to make sure new one is read-write
    if mountpoint -q "${mountpoint}"; then
      umount "${mountpoint}"
    fi

    mount -n -t cgroup -o "${grouping}" cgroup "${mountpoint}"

    if [[ "${grouping}" != "${sys}" ]]; then
      if [[ -L "${cgroup}/${sys}" ]]; then
        rm "${cgroup}/${sys}"
      fi

      ln -s "${mountpoint}" "${cgroup}/${sys}"
    fi
  done

  # Initialize systemd cgroup if host isn't using systemd.
  # Workaround for https://github.com/docker/for-linux/issues/219
  if ! [[ -d /sys/fs/cgroup/systemd ]]; then
    mkdir "${cgroup}/systemd"
    mount -t cgroup -o none,name=systemd cgroup "${cgroup}/systemd"
  fi
}

# Setup container environment and start docker daemon in the background.
start_docker() {
  echo >&amp;2 "Setting up Docker environment..."
  mkdir -p /var/log
  mkdir -p /var/run

  sanitize_cgroups

  # check for /proc/sys being mounted readonly, as systemd does
  if grep '/proc/sys\s\+\w\+\s\+ro,' /proc/mounts >/dev/null; then
    mount -o remount,rw /proc/sys
  fi

  local docker_opts="${DOCKER_OPTS:-}"

  # Pass through `--garden-mtu` from gardian container
  if [[ "${docker_opts}" != *'--mtu'* ]]; then
    local mtu="$(cat /sys/class/net/$(ip route get 8.8.8.8|awk '{ print $5 }')/mtu)"
    docker_opts+=" --mtu ${mtu}"
  fi

  # Use Concourse's scratch volume to bypass the graph filesystem by default
  if [[ "${docker_opts}" != *'--data-root'* ]] &amp;&amp; [[ "${docker_opts}" != *'--graph'* ]]; then
    docker_opts+=' --data-root /scratch/docker'
  fi

  rm -f "${DOCKERD_PID_FILE}"
  touch "${DOCKERD_LOG_FILE}"

  echo >&amp;2 "Starting Docker..."
  dockerd ${docker_opts} &amp;>"${DOCKERD_LOG_FILE}" &amp;
  echo "$!" > "${DOCKERD_PID_FILE}"
}

# Wait for docker daemon to be healthy
# Timeout after DOCKERD_TIMEOUT seconds
await_docker() {
  local timeout="${DOCKERD_TIMEOUT}"
  echo >&amp;2 "Waiting ${timeout} seconds for Docker to be available..."
  local start=${SECONDS}
  timeout=$(( timeout + start ))
  until docker info &amp;>/dev/null; do
    if (( SECONDS >= timeout )); then
      echo >&amp;2 'Timed out trying to connect to docker daemon.'
      if [[ -f "${DOCKERD_LOG_FILE}" ]]; then
        echo >&amp;2 '---DOCKERD LOGS---'
        cat >&amp;2 "${DOCKERD_LOG_FILE}"
      fi
      exit 1
    fi
    if [[ -f "${DOCKERD_PID_FILE}" ]] &amp;&amp; ! kill -0 $(cat "${DOCKERD_PID_FILE}"); then
      echo >&amp;2 'Docker daemon failed to start.'
      if [[ -f "${DOCKERD_LOG_FILE}" ]]; then
        echo >&amp;2 '---DOCKERD LOGS---'
        cat >&amp;2 "${DOCKERD_LOG_FILE}"
      fi
      exit 1
    fi
    sleep 1
  done
  local duration=$(( SECONDS - start ))
  echo >&amp;2 "Docker available after ${duration} seconds."
}

# Gracefully stop Docker daemon.
stop_docker() {
  if ! [[ -f "${DOCKERD_PID_FILE}" ]]; then
    return 0
  fi
  local docker_pid="$(cat ${DOCKERD_PID_FILE})"
  if [[ -z "${docker_pid}" ]]; then
    return 0
  fi
  echo >&amp;2 "Terminating Docker daemon."
  kill -TERM ${docker_pid}
  local start=${SECONDS}
  echo >&amp;2 "Waiting for Docker daemon to exit..."
  wait ${docker_pid}
  local duration=$(( SECONDS - start ))
  echo >&amp;2 "Docker exited after ${duration} seconds."
}

start_docker
trap stop_docker EXIT
await_docker

# do not exec, because exec disables traps
if [[ "$#" != "0" ]]; then
  "$@"
else
  bash --login
fi</code></pre></div>
                    </div><br/>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">pipeline.yaml</b>
                        <div class="spoiler_text"><pre><code class="plaintext">resource_types:
  - name: telegram
    type: docker-image
    source:
      repository: vtutrinov/concourse-telegram-resource
      tag: latest
  - name: kubernetes
    type: docker-image
    source:
      repository: zlabjp/kubernetes-resource
      tag: 1.16
  - name: metadata
    type: docker-image
    source:
      repository: olhtbr/metadata-resource
      tag: 2.0.1
resources:
  - name: metadata
    type: metadata
  - name: sources
    type: git
    source:
      branch: master
      uri: git@github.com:bihero-io/helloworldmicroservice.git
      private_key: ((deployer-private-key))
  - name: docker-image
    type: docker-image
    source:
      repository: bihero/helloworld
      username: ((docker-registry-user))
      password: ((docker-registry-password))
  - name: telegram
    type: telegram
    source:
      bot_token: ((telegram-ci-bot-token))
      chat_id: ((telegram-group-to-report-build))
      ci_url: ((ci_url))
      command: "/build_helloworld_ms"
  - name: kubernetes-demo
    type: kubernetes
    source:
      server: ((k8s-api-server))
      namespace: default
      kubeconfig: ((kubeconfig-demo))
jobs:
  - name: build-helloworld-microservice
    serial: true
    public: true
    plan:
      - in_parallel:
          - get: sources
            trigger: true
          - get: telegram
            trigger: true
          - put: metadata
      - put: telegram
        params:
          status: Build In Progress
      - task: tests
        privileged: true
        config:
          platform: linux
          image_resource:
            type: docker-image
            source:
              repository: ((docker-registry-uri))/bih/dind  # тут мы указываем образ, собранный на основе докерфайла, где мы ставим докер, maven и 11-ю джаву
              tag: latest
              username: ((docker-private-registry-user))
              password: ((docker-private-registry-password))
          inputs:
            - name: sources
          outputs:
            - name: tested-workspace
          run:
            path: entrypoint.sh
            args:
              - bash
              - -ceux
              - |
                # вот тут мы уже имеем запущенный докер внутри таски и можем запускать тесты с testcontainers
                output_dir=tested-workspace
                cp -R ./sources/* "${output_dir}/"
                mvn -f "${output_dir}/pom.xml" clean test
          caches:
            - path: ~/.m2/
        on_failure:
          do:
            - task: tests-report
              config:
                platform: linux
                image_resource:
                  type: docker-image
                  source:
                    repository: ((docker-registry-uri))/bih/maven-dind
                    tag: 3-jdk-11
                    username: ((docker-private-registry-user))
                    password: ((docker-private-registry-password))
                inputs:
                  - name: tested-workspace
                outputs:
                  - name: message
                run:
                  path: /bin/sh
                  args:
                    - -c
                    - |
                      output_dir=tested-workspace
                      mvn -Dmaven.wagon.http.ssl.insecure=true -Dmaven.wagon.http.ssl.allowall=true -f "${output_dir}/pom.xml" site-deploy
                      version=$(cat $output_dir/target/classes/version.txt)
                      cat >message/msg &lt;&lt;EOL
                      &lt;a href="https://nexus.dev.techedge.pro:8443/repository/reports/hello-world-microservice/${version}/allure/">Allure report&lt;/a>
                      EOL
                caches:
                  - path: ~/.m2/
            - put: telegram
              params:
                status: Build Failed (unit-tests)
                message_file: message/msg
      - task: tests-report
        config:
          platform: linux
          image_resource:
            type: docker-image
            source:
              repository: ((docker-registry-uri))/bih/maven-dind
              tag: 3-jdk-11
              username: ((docker-private-registry-user))
              password: ((docker-private-registry-password))
          inputs:
            - name: tested-workspace
          outputs:
            - name: message
            - name: tested-workspace
          run:
            path: /bin/sh
            args:
              - -c
              - |
                work_dir=tested-workspace
                mvn -Dmaven.wagon.http.ssl.insecure=true -Dmaven.wagon.http.ssl.allowall=true -f "${work_dir}/pom.xml" site-deploy
                version=$(cat $work_dir/target/classes/version.txt)
                cat >message/msg &lt;&lt;EOL
                &lt;a href="https://nexus.dev.techedge.pro:8443/repository/reports/hello-world-microservice/${version}/allure/">Allure report&lt;/a>
                EOL
          caches:
            - path: ~/.m2/
      - task: package
        config:
          platform: linux
          image_resource:
            type: docker-image
            source:
              repository: ((docker-registry-uri))/bih/maven-dind
              tag: 3-jdk-11
              username: ((docker-private-registry-user))
              password: ((docker-private-registry-password))
          inputs:
            - name: tested-workspace
            - name: metadata
          outputs:
            - name: app-packaged-workspace
            - name: metadata
          run:
            path: /bin/sh
            args:
              - -c
              - |
                output_dir=app-packaged-workspace
                cp -R ./tested-workspace/* "${output_dir}/"
                mvn -f "${output_dir}/pom.xml" package -Dmaven.main.skip -DskipTests
                tag="-"$(cat metadata/build_name)
                echo $tag >> ${output_dir}/target/classes/version.txt
                cat ${output_dir}/target/classes/version.txt > metadata/version
          caches:
            - path: ~/.m2/
        on_failure:
          do:
            - put: telegram
              params:
                status: Build Failed (package)
      - put: docker-image
        params:
          build: app-packaged-workspace
          tag_file: app-packaged-workspace/target/classes/version.txt
          tag_as_latest: true
        get_params:
          skip_download: true
      - task: make-k8s-app-template
        config:
          platform: linux
          image_resource:
            type: docker-image
            source:
              repository: bhgedigital/envsubst
          inputs:
            - name: sources
            - name: metadata
          outputs:
            - name: k8s
          run:
            path: /bin/sh
            args:
              - -c
              - |
                export DOMAIN=demo1.bihero.io
                export HELLO_WORLD_SERVICE_IMAGE_VERSION=$(cat metadata/version)
                cat sources/k8s.yaml | envsubst > k8s/helloworld_app_template.yaml
                cat k8s/helloworld_app_template.yaml
      - put: kubernetes-demo
        params:
          kubectl: apply -f k8s/helloworld_app_template.yaml
      - put: telegram
        params:
          status: Build Success
          message_file: message/msg</code></pre></div>
                    </div><br/>
<p>Подошли к деплою интеграционного сервиса в k8s. И тут возникает необходимость знать адреса сервисов <strong>hello</strong> и <strong>world</strong> внутри k8s-кластера. По дефолту все сервисы внутри k8s имет адреса типа <strong>&lt;service-name>..default.svc.cluster.local</strong>, вот ими и воспользуемся, не будем же мы ходить до сервисов, которые крутятся рядом через внешний API. Сказано, сделано :</p><br/>
<div class="spoiler" role="button" tabindex="0">
                        <b class="spoiler_title">конечная версия темплейта для деплоя интеграционного сервиса в k8s</b>
                        <div class="spoiler_text"><pre><code class="plaintext">apiVersion: v1
kind: ConfigMap
metadata:
  name: hello-world-config
data:
  config.json: |
    {
      "type": "file",
      "format": "json",
      "scanPeriod": 5000,
      "config": {
        "path": "/config.json"
      },
      "serverPort": 8083,
      "serverHost": "0.0.0.0",
      "hello-service-host": "bihero-hello.default.svc.cluster.local",
      "hello-service-port": 8081,
      "world-service-host": "bihero-world.default.svc.cluster.local",
      "world-service-port": 8082
    }
---
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  labels:
    io.bihero.hello.service: bihero-helloworld
  name: bihero-helloworld
spec:
  replicas: 3
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 1
  template:
    metadata:
      labels:
        io.bihero.hello.service: bihero-helloworld
    spec:
      containers:
        - image: bihero/helloworld:${HELLO_WORLD_SERVICE_IMAGE_VERSION}
          name: bihero-helloworld
          ports:
            - containerPort: 8083
          imagePullPolicy: Always
          resources: {}
          volumeMounts: # в /usr/local заменяем дефолтный конфиг на занчение из ConfigMap'а сверху
            - mountPath: /usr/local/
              name: hello-world-config
      restartPolicy: Always
      volumes:
        - name: hello-world-config
          configMap:
            name: hello-world-config
---
apiVersion: v1
kind: Service
metadata:
  labels:
    io.bihero.hello.service: bihero-helloworld
  name: bihero-helloworld
spec:
  ports:
    - name: "8083"
      port: 8083
      targetPort: 8083
  selector:
    io.bihero.hello.service: bihero-helloworld
status:
  loadBalancer: {}
---
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: bihero-helloworld
  annotations:
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/secure-backends: "false"
    nginx.ingress.kubernetes.io/ssl-passthrough: "false"
    nginx.ingress.kubernetes.io/rewrite-target: /$2
    kubernetes.io/tls-acme: "true"
  namespace: default
spec:
  tls:
    - hosts:
        - ${DOMAIN}
      secretName: bihero
  rules:
    - host: ${DOMAIN}
      http:
        paths:
          - path: /api/helloworld(/|$)(.*)
            backend:
              serviceName: bihero-helloworld
              servicePort: 8083</code></pre></div>
                    </div><br/>
<p>Ну, и как обычно — коммитимся, пушимся, билдимся, деплоимся, тестируемся:</p><br/>
<pre><code class="bash">curl https://demo1.bihero.io/api/helloworld
Hello World</code></pre><br/>
<pre><code class="bash">curl https://demo1.bihero.io/api/helloworld/doc                 
openapi: 3.0.1
info:
  title: Hello World ;)
  description: "Hello World microservice. Aggregate 'Hello World' by hellomicroservice and worldmicroservice"
  version: 1.0.0
servers:
  - url: https://demo1.bihero.io/api/helloworld
tags:
  - name: helloworld
    description: Everything about 'Hello World'
paths:
  /:
    x-vertx-event-bus:
      address: service.helloworld
      timeout: 1000
    get:
      tags:
        - helloworld
      summary: Aggregate 'Hello World'
      operationId: getHelloWorld
      responses:
        200:
          description: OK
          content: {}
  /doc:
    x-vertx-event-bus:
      address: service.helloworld
      timeout: 1000c
    get:
      tags:
        - world
      summary: Get 'Hello World' microservice documentation
      operationId: getDoc
      responses:
        200:
          description: OK
components: {}</code></pre><br/>
<p>Ура! Работает! Можем релизиться и в прод, но для полноты картины… </p><br/>
<h2>TODO'шечки (backlog)</h2><br/>
<ol>
<li>Много бойлерплейта в помниках — унести всё общее в parent pom и собирать все сервисы продукта на основе него.</li>
<li>Сейчас собранные в пайплайнах docker-образы тегаются и сразу пушатся в docker-hub, включая снэпшотные образы — сделать так, чтобы туда пушились только релизные образы, всё снэпшотное в private registry.</li>
<li>Сделать "нормальное" версионирование (maven-release-plugin? concourse semver-resource ?), возможно хранить версии в отдельном репозитории, и триггерить релизные сборки при изменении в репозитории, отвечающем за хранение версий продукта.</li>
<li>Решить проблему рассинхронизации API между сервисами в условиях НЕ-монорепозитория в гите (когда это три сервиса типа HelloWorld, то проблемы нет, но когда будет несколько десятков сложных сервисов, то наступит АД). Если кто-то занет железобетонные способы, то пишите в комментариях — буду рад узнать и обсудить :)</li>
</ol><br/>
<p>Список в голове был большой, но забылся по пути, если вспомнится, то дополню, ну или дополняйте в комментариях :)</p><br/>
<h3>И исходники</h3><br/>
<p><a href="https://github.com/bihero-io/hello-microservice">https://github.com/bihero-io/hello-microservice</a><br/>
<a href="https://github.com/bihero-io/worldmicroservice">https://github.com/bihero-io/worldmicroservice</a><br/>
<a href="https://github.com/bihero-io/helloworldmicroservice">https://github.com/bihero-io/helloworldmicroservice</a></p><br/>
<p><strong>[UPD] в TODO'шечки</strong></p><br/>
<ol>
<li>Запилить степ в пайплайне для сборки helm-чарта, деплоить в k8s с помощью чарта, давать конечным on-prem юзерам возможность деплоиться как с темплейтами, так и из чарта</li>
</ol></div></div></div> <DIV class="v-portal" style="display:none;"></DIV></div> <!----> <!----></div> <div class="tm-article-presenter__meta"><div class="tm-separated-list tm-article-presenter__meta-list"><span class="tm-separated-list__title">Теги:</span> <ul class="tm-separated-list__list"><li class="tm-separated-list__item"><a href="https://habr.com/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bdevops%5D" class="tm-tags-list__link">devops</a></li><li class="tm-separated-list__item"><a href="https://habr.com/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bci%2Fcd%5D" class="tm-tags-list__link">ci/cd</a></li><li class="tm-separated-list__item"><a href="https://habr.com/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bjava%5D" class="tm-tags-list__link">java</a></li><li class="tm-separated-list__item"><a href="https://habr.com/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bvertx%5D" class="tm-tags-list__link">vertx</a></li><li class="tm-separated-list__item"><a href="https://habr.com/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bjunit5%5D" class="tm-tags-list__link">junit5</a></li><li class="tm-separated-list__item"><a href="https://habr.com/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Btestcontainers%5D" class="tm-tags-list__link">testcontainers</a></li></ul></div> <div class="tm-separated-list tm-article-presenter__meta-list"><span class="tm-separated-list__title">Хабы:</span> <ul class="tm-separated-list__list"><li class="tm-separated-list__item"><a href="https://habr.com/ru/hub/java/" class="tm-hubs-list__link">
    Java
  </a></li><li class="tm-separated-list__item"><a href="https://habr.com/ru/hub/devops/" class="tm-hubs-list__link">
    DevOps
  </a></li></ul></div></div></article></div> <!----></div> <div class="tm-article-sticky-panel"><div class="tm-data-icons tm-article-sticky-panel__icons"><div class="tm-article-rating tm-data-icons__item"><div class="tm-votes-meter tm-article-rating__votes-switcher"><svg height="24" width="24" class="tm-svg-img tm-votes-meter__icon tm-votes-meter__icon_appearance-article"><title>Всего голосов 66: ↑65 и ↓1</title> <use xlink:href="/img/megazord-v25.4b679db1.svg#counter-rating"></use></svg> <span title="Всего голосов 66: ↑65 и ↓1" class="tm-votes-meter__value tm-votes-meter__value_positive tm-votes-meter__value_appearance-article tm-votes-meter__value_rating">+64</span></div> <DIV class="v-portal" style="display:none;"></DIV></div> <!----> <span title="Количество просмотров" class="tm-icon-counter tm-data-icons__item"><svg height="24" width="24" class="tm-svg-img tm-icon-counter__icon"><title>Просмотры</title> <use xlink:href="/img/megazord-v25.4b679db1.svg#counter-views"></use></svg> <span class="tm-icon-counter__value">23K</span></span> <button title="Добавить в закладки" type="button" class="bookmarks-button tm-data-icons__item"><span title="Добавить в закладки" class="tm-svg-icon__wrapper bookmarks-button__icon"><svg height="24" width="24" class="tm-svg-img tm-svg-icon"><title>Добавить в закладки</title> <use xlink:href="/img/megazord-v25.4b679db1.svg#counter-favorite"></use></svg></span> <span title="Количество пользователей, добавивших публикацию в закладки" class="bookmarks-button__counter">
    296
  </span></button> <!----> <div title="Поделиться" class="tm-sharing tm-data-icons__item"><button type="button" class="tm-sharing__button"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="tm-sharing__icon"><path fill="currentColor" d="M13.8 13.8V18l7.2-6.6L13.8 5v3.9C5 8.9 3 18.6 3 18.6c2.5-4.4 6-4.8 10.8-4.8z"></path></svg></button> <DIV class="v-portal" style="display:none;"></DIV></div> <DIV class="v-portal" style="display:none;"></DIV></div> </div></div> <DIV class="v-portal" style="display:none;"></DIV> <div class="tm-article-presenter__footer"><div class="tm-article-blocks"><!----> <section class="tm-block tm-block_spacing-bottom"><!----> <div class="tm-block__body tm-block__body_variant-balanced"><div class="tm-article-author"> <div class="tm-user-card tm-article-author__user-card tm-user-card_variant-article"><div class="tm-user-card__info-container"><div class="tm-user-card__header"><div class="tm-user-card__header-data"><a href="https://habr.com/ru/users/zhulikovatyi/" class="tm-user-card__userpic tm-user-card__userpic_size-40"><div class="tm-entity-image"><svg class="tm-svg-img tm-image-placeholder tm-image-placeholder_green"><!----> <use xlink:href="/img/megazord-v25.4b679db1.svg#placeholder-user"></use></svg></div></a> <div class="tm-user-card__meta"><div title=" 29 голосов " class="tm-karma tm-user-card__karma"><div class="tm-karma__votes tm-karma__votes_positive">
    27
  </div> <div class="tm-karma__text">
    Карма
  </div></div> <div title="Рейтинг пользователя" class="tm-rating tm-user-card__rating"><div class="tm-rating__header"> <div class="tm-rating__counter">0</div></div> <div class="tm-rating__text">
    Рейтинг
  </div></div></div></div></div> <div class="tm-user-card__info tm-user-card__info_variant-article"><div class="tm-user-card__title tm-user-card__title_variant-article"><span class="tm-user-card__name tm-user-card__name_variant-article">Вячеслав Тутринов</span> <a href="https://habr.com/ru/users/zhulikovatyi/" class="tm-user-card__nickname tm-user-card__nickname_variant-article">
          @zhulikovatyi
        </a> <!----></div> <p class="tm-user-card__short-info tm-user-card__short-info_variant-article">Разработчик</p></div></div> <div class="tm-user-card__buttons tm-user-card__buttons_variant-article"><!----> <!----> <!----> <!----> <!----></div></div> <!----></div> <DIV class="v-portal" style="display:none;"></DIV></div> <!----></section> <div class="tm-article-blocks__comments"><div class="tm-article-page-comments"><div class="tm-article-comments-counter-link tm-article-comments-counter-button"><a href="https://habr.com/ru/post/465149/comments/" class="tm-article-comments-counter-link__link tm-article-comments-counter-link__link_button-style"><svg height="24" width="24" class="tm-svg-img tm-article-comments-counter-link__icon tm-article-comments-counter-link__icon_contrasted"><title>Комментарии</title> <use xlink:href="/img/megazord-v25.4b679db1.svg#counter-comments"></use></svg> <span class="tm-article-comments-counter-link__value tm-article-comments-counter-link__value_contrasted">
       Комментарии 47 
    </span></a> <!----></div></div></div> <div class="tm-ad-banner__container tm-page-article__banner"><!----> <div id="articleBottomBanner11924" class="tm-ad-banner"></div></div> <!----> <!----> <!----> <!----> </div></div></div></div></div> <div class="tm-page__sidebar"><div class="tm-layout-sidebar"><div class="tm-layout-sidebar__ads tm-layout-sidebar__ads_initial"><div class="tm-ad-banner__container tm-layout-sidebar__banner"><!----> <div id="sidebarBanner11925" class="tm-ad-banner"></div></div></div> <div class="tm-sexy-sidebar tm-sexy-sidebar_initial" style="margin-top:0px;"><!----> <section data-async-called="true" class="tm-block tm-block_spacing-bottom"><header class="tm-block__header"><h2 class="tm-block__title">Работа</h2> <!----></header> <div class="tm-block__body"><div class="tm-vacancies-block__item"><a href="https://career.habr.com/vacancies/devops" target="_blank" class="tm-vacancies-block__vacancy-title">
        DevOps инженер
      </a> <div class="tm-vacancies-block__vacancies-count">
        87
    вакансий
      </div></div><div class="tm-vacancies-block__item"><a href="https://career.habr.com/vacancies/java_developer" target="_blank" class="tm-vacancies-block__vacancy-title">
        Java разработчик
      </a> <div class="tm-vacancies-block__vacancies-count">
        589
    вакансий
      </div></div></div> <footer class="tm-block__footer"><a href="https://career.habr.com/catalog" class="tm-block-extralink">
      Все вакансии
    </a></footer></section></div></div></div></div></div></div></main> <!----></div> <div class="tm-footer-menu"><div class="tm-page-width"><div class="tm-footer-menu__container"><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Ваш аккаунт
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="https://habr.com/kek/v1/auth/habrahabr/?back=/ru/post/465149/&amp;hl=ru" rel="nofollow" target="_self">
                Войти
              </a></li><li class="tm-footer-menu__list-item"><a href="https://habr.com/kek/v1/auth/habrahabr-register/?back=/ru/post/465149/&amp;hl=ru" rel="nofollow" target="_self">
                Регистрация
              </a></li></ul></div></div><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Разделы
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="https://habr.com/ru/" class="footer-menu__item-link router-link-active">
                Публикации
              </a></li><li class="tm-footer-menu__list-item"><a href="https://habr.com/ru/news/" class="footer-menu__item-link">
                Новости
              </a></li><li class="tm-footer-menu__list-item"><a href="https://habr.com/ru/hubs/" class="footer-menu__item-link">
                Хабы
              </a></li><li class="tm-footer-menu__list-item"><a href="https://habr.com/ru/companies/" class="footer-menu__item-link">
                Компании
              </a></li><li class="tm-footer-menu__list-item"><a href="https://habr.com/ru/users/" class="footer-menu__item-link">
                Авторы
              </a></li><li class="tm-footer-menu__list-item"><a href="https://habr.com/ru/sandbox/" class="footer-menu__item-link">
                Песочница
              </a></li></ul></div></div><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Информация
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="https://habr.com/ru/docs/help/" class="footer-menu__item-link">
                Устройство сайта
              </a></li><li class="tm-footer-menu__list-item"><a href="https://habr.com/ru/docs/authors/codex/" class="footer-menu__item-link">
                Для авторов
              </a></li><li class="tm-footer-menu__list-item"><a href="https://habr.com/ru/docs/companies/corpblogs/" class="footer-menu__item-link">
                Для компаний
              </a></li><li class="tm-footer-menu__list-item"><a href="https://habr.com/ru/docs/docs/transparency/" class="footer-menu__item-link">
                Документы
              </a></li><li class="tm-footer-menu__list-item"><a href="https://account.habr.com/info/agreement" target="_blank">
                Соглашение
              </a></li><li class="tm-footer-menu__list-item"><a href="https://account.habr.com/info/confidential/" target="_blank">
                Конфиденциальность
              </a></li></ul></div></div><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Услуги
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="https://docs.google.com/presentation/d/e/2PACX-1vQLwRfQmXibiUlWaRg-BAc38s7oM3lJiaPju7qmdJsp8ysIvZ_G-Npem0njJLMozE2bPHMpDqiI5hhy/pub?start=false&amp;loop=false&amp;delayms=60000&amp;slide=id.g91a03369cd_4_297" target="_blank">
                Реклама
              </a></li><li class="tm-footer-menu__list-item"><a href="https://habrastorage.org/storage/stuff/habr/service_price.pdf" target="_blank">
                Тарифы
              </a></li><li class="tm-footer-menu__list-item"><a href="https://docs.google.com/presentation/d/e/2PACX-1vQJJds8-Di7BQSP_guHxICN7woVYoN5NP_22ra-BIo4bqnTT9FR6fB-Ku2P0AoRpX0Ds-LRkDeAoD8F/pub?start=false&amp;loop=false&amp;delayms=60000" target="_blank">
                Контент
              </a></li><li class="tm-footer-menu__list-item"><a href="https://tmtm.timepad.ru/" target="_blank">
                Семинары
              </a></li><li class="tm-footer-menu__list-item"><a href="https://habr.com/ru/megaprojects/" class="footer-menu__item-link">
                Мегапроекты
              </a></li></ul></div></div></div></div></div> <div class="tm-footer"><div class="tm-page-width"><div class="tm-footer__container"><!----> <div class="tm-footer__social"><a href="https://www.facebook.com/habrahabr.ru" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Facebook</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-facebook"></use></svg></a><a href="https://twitter.com/habr_com" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Twitter</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-twitter"></use></svg></a><a href="https://vk.com/habr" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>VK</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-vkontakte"></use></svg></a><a href="https://telegram.me/habr_com" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Telegram</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-telegram"></use></svg></a><a href="https://www.youtube.com/channel/UCd_sTwKqVrweTt4oAKY5y4w" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Youtube</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-youtube"></use></svg></a><a href="https://zen.yandex.ru/habr" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Яндекс Дзен</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-zen"></use></svg></a></div> <DIV class="v-portal" style="display:none;"></DIV> <button class="tm-footer__link"><!---->
        Настройка языка
      </button> <a href="https://habr.com/ru/about" class="tm-footer__link">
        О сайте
      </a> <a href="https://habr.com/ru/feedback/" class="tm-footer__link">
        Техническая поддержка
      </a> <!----> <a href="https://habr.com/berserk-mode-nope" class="tm-footer__link">
        Вернуться на старую версию
      </a> <div class="tm-footer-copyright"><span class="tm-copyright"><span class="tm-copyright__years">© 2006–2022 </span> <span class="tm-copyright__name">«<a href="https://company.habr.com/" rel="noopener" target="_blank" class="tm-copyright__link">Habr</a>»</span></span></div></div></div></div> <!----> <!----></div> <div class="vue-portal-target"></div></div>
<script>window.__INITIAL_STATE__={"adblock":{"hasAcceptableAdsFilter":false,"hasAdblock":false},"articlesList":{"articlesList":{"465149":{"id":"465149","timePublished":"2019-12-14T14:10:13+00:00","isCorporative":false,"lang":"ru","titleHtml":"'Hello World' вам в облако","leadData":{"textHtml":"\u003Cp\u003EМир сходит с ума, заталкивая калькулятор для 2+2 в облака. Чем мы хуже? Давайте Hello World затолкаем в три микросервиса, напишем пару-тройку тестов, обеспечим пользователей документацией, нарисуем красивый пайплайн сборки и обеспечим деплой в условный облачный прод при успешном прохождении тестов. Итак, в данной статье будет показан пример того, как может быть построен процесс разработки продукта от спецификации до деплоя в прод. Инетересно? тогда прошу под кат\u003C\u002Fp\u003E","imageUrl":null,"buttonTextHtml":null,"image":null},"editorVersion":"1.0","postType":"article","postLabels":[{"type":"tutorial","data":null}],"author":{"scoreStats":{"score":27,"votesCount":29},"rating":0,"relatedData":null,"contacts":[],"authorContacts":[],"paymentDetails":{"paymentYandexMoney":null,"paymentPayPalMe":null,"paymentWebmoney":null},"id":"520102","alias":"zhulikovatyi","fullname":"Вячеслав Тутринов","avatarUrl":null,"speciality":"Разработчик"},"statistics":{"commentsCount":47,"favoritesCount":296,"readingCount":22709,"score":64,"votesCount":66},"hubs":[{"relatedData":null,"id":"375","alias":"java","type":"collective","title":"Java","titleHtml":"Java","isProfiled":true},{"relatedData":null,"id":"20788","alias":"devops","type":"collective","title":"DevOps","titleHtml":"DevOps","isProfiled":true}],"flows":[{"id":"1","alias":"develop","title":"Разработка"},{"id":"6","alias":"admin","title":"Администрирование"}],"relatedData":null,"textHtml":"\u003Cdiv xmlns=\"http:\u002F\u002Fwww.w3.org\u002F1999\u002Fxhtml\"\u003E\u003Cp\u003EМир сходит с ума, заталкивая калькулятор для 2+2 в облака. Чем мы хуже? Давайте Hello World затолкаем в три микросервиса, напишем пару-тройку тестов, обеспечим пользователей документацией, нарисуем красивый пайплайн сборки и обеспечим деплой в условный облачный прод при успешном прохождении тестов. Итак, в данной статье будет показан пример того, как может быть построен процесс разработки продукта от спецификации до деплоя в прод. Инетересно? тогда прошу под кат\u003Ca name=\"habracut\"\u003E\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Ch2\u003EС чегоооооо начинается Роооо… ?\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EНет не Родина, а продукт. Правильно, продукт начинается c идеи. Итак, идея такова: \u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cul\u003E\r\n\u003Cli\u003Eнужен сервис, который отдаёт 'Hello World' по REST API\u003C\u002Fli\u003E\r\n\u003Cli\u003Ecлово \u003Cstrong\u003E'Hello'\u003C\u002Fstrong\u003E отдаёт один микросервис, проектируемый, создаваемый и тестируемый командой_1\u003C\u002Fli\u003E\r\n\u003Cli\u003Ecлово \u003Cstrong\u003E'World'\u003C\u002Fstrong\u003E отдаёт второй, который находится в ведении команды_2\u003C\u002Fli\u003E\r\n\u003Cli\u003Eкоманда_3 пишет интеграционный сервис для склеивания 'Hello' и 'World'\u003C\u002Fli\u003E\r\n\u003C\u002Ful\u003E\u003Cbr\u002F\u003E\r\n\u003Ch3\u003EToolset\u003C\u002Fh3\u003E\u003Cbr\u002F\u003E\r\n\u003Cul\u003E\r\n\u003Cli\u003EOS (desktop) — Debian 9 Stretch\u003C\u002Fli\u003E\r\n\u003Cli\u003EIDE — IntelliJ IDEA 2019.1\u003C\u002Fli\u003E\r\n\u003Cli\u003EGit Repo — GitHub\u003C\u002Fli\u003E\r\n\u003Cli\u003ECI — Concourse 5.4.0\u003C\u002Fli\u003E\r\n\u003Cli\u003EMaven Repo — Nexus\u003C\u002Fli\u003E\r\n\u003Cli\u003EOpenJDK 11\u003C\u002Fli\u003E\r\n\u003Cli\u003EMaven 3.6.0\u003C\u002Fli\u003E\r\n\u003Cli\u003EKubernetes 1.14 (1 master + 1 worker): calico network, nginx-ingress-controller\u003C\u002Fli\u003E\r\n\u003C\u002Ful\u003E\u003Cbr\u002F\u003E\r\n\u003Cblockquote\u003E\u003Cstrong\u003EВажная заметка:\u003C\u002Fstrong\u003E статья не о красивом коде (codestyle, checkstyle, javadocs, SOLID и прочие умные слова) и вылизанных до идеала решениях (холиварить про идеальный Hello World можно бесконечно). Она о том, как собрать воедино код, спецификациии, пайплайн сборки и доставки всего собранного в прод, а вместо HelloWorld в реальности у вас может быть какой-нибудь высоконагруженный продукт с кучей сложных и крутых микросервисов, и описанный процесс можно применить к нему.\u003C\u002Fblockquote\u003E\u003Cbr\u002F\u003E\r\n\u003Ch3\u003EИз чего состоит сервис?\u003C\u002Fh3\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EСервис в виде конечного продукта должен содержать в себе:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cul\u003E\r\n\u003Cli\u003Eспецификацию в виде yaml-документа стандарта OpenAPI и уметь отдавать её по запросу (GET \u002Fdoc)\u003C\u002Fli\u003E\r\n\u003Cli\u003Eметоды API в соответствии со спецификацией из первого пункта\u003C\u002Fli\u003E\r\n\u003Cli\u003EREADME.md с примерами запуска и конфигурирования сервиса\u003C\u002Fli\u003E\r\n\u003C\u002Ful\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EБудем разбирать сервисы по порядку. Поехали!\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Ch2\u003E'Hello' microservice\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\r\n\u003Ch3\u003ESpecification\u003C\u002Fh3\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EСпеки пишем в Swagger Editor'е и конвертируем им же в OpenAPI спеку. Swagger Editor запускается в докере одной командой, конвертация swagger-доки в openapi-доку делается нажатием одной кнопки в UI эдитора, которая шлёт запрос \u003Cstrong\u003EPOST \u002Fapi\u002Fconvert\u003C\u002Fstrong\u003E на \u003Cstrong\u003E\u003Ca href=\"http:\u002F\u002Fconverter.swagger.io\"\u003Ehttp:\u002F\u002Fconverter.swagger.io\u003C\u002Fa\u003E\u003C\u002Fstrong\u003E. Итоговая спецификация hello сервиса:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"plaintext\"\u003Eopenapi: 3.0.1\ninfo:\n  title: Hello ;)\n  description: Hello microservice\n  version: 1.0.0\nservers:\n  - url: https:\u002F\u002Fdemo1.bihero.io\u002Fapi\u002Fhello\ntags:\n  - name: hello\n    description: Everything about saying 'Hello'\npaths:\n  \u002F:\n    x-vertx-event-bus:\n      address: service.hello\n      timeout: 1000c\n    get:\n      tags:\n        - hello\n      summary: Get 'Hello' word\n      operationId: getHelloWord\n      responses:\n        200:\n          description: OK\n  \u002Fdoc:\n    x-vertx-event-bus:\n      address: service.hello\n      timeout: 1000c\n    get:\n      tags:\n        - hello_doc\n      summary: Get 'Hello' microservice documentation\n      operationId: getDoc\n      responses:\n        200:\n          description: OK\ncomponents: {}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Ch3\u003EImplementation\u003C\u002Fh3\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EСервис с точки зрения кода, который надо писать, состоит из 3-х классов:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cul\u003E\r\n\u003Cli\u003Eинтерфейс с методами сервиса (названия методов указаны в спеке как \u003Cstrong\u003EoperationId\u003C\u002Fstrong\u003E)\u003C\u002Fli\u003E\r\n\u003Cli\u003Eреализация интерфейса\u003C\u002Fli\u003E\r\n\u003Cli\u003Evertx verticle для биндинга сервиса со спекой (методы api -\u003E методы интерфейса из первого пункта) и для старта http-сервера\u003C\u002Fli\u003E\r\n\u003C\u002Ful\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EСтруктура файлов в src выглядит примерно так:\u003Cbr\u002F\u003E\r\n\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fwebt\u002Fn_\u002Fmu\u002F7h\u002Fn_mu7ht4nkqya165lkl7b44ii1w.png\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fn_\u002Fmu\u002F7h\u002Fn_mu7ht4nkqya165lkl7b44ii1w.png\"\u002F\u003E\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cdiv class=\"spoiler\" role=\"button\" tabindex=\"0\"\u003E\n                        \u003Cb class=\"spoiler_title\"\u003Epom.xml\u003C\u002Fb\u003E\n                        \u003Cdiv class=\"spoiler_text\"\u003E\u003Cpre\u003E\u003Ccode class=\"xml\"\u003E&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?\u003E\n&lt;project xmlns=\"http:\u002F\u002Fmaven.apache.org\u002FPOM\u002F4.0.0\"\n         xmlns:xsi=\"http:\u002F\u002Fwww.w3.org\u002F2001\u002FXMLSchema-instance\"\n         xsi:schemaLocation=\"http:\u002F\u002Fmaven.apache.org\u002FPOM\u002F4.0.0 http:\u002F\u002Fmaven.apache.org\u002Fxsd\u002Fmaven-4.0.0.xsd\"\u003E\n    &lt;modelVersion\u003E4.0.0&lt;\u002FmodelVersion\u003E\n\n    &lt;properties\u003E\n        &lt;main.verticle\u003Eio.bihero.hello.HelloVerticle&lt;\u002Fmain.verticle\u003E\n        &lt;vertx.version\u003E3.8.1&lt;\u002Fvertx.version\u003E\n        &lt;logback.version\u003E1.2.3&lt;\u002Flogback.version\u003E\n        &lt;junit-jupiter.version\u003E5.3.1&lt;\u002Fjunit-jupiter.version\u003E\n        &lt;maven-surefire-plugin.version\u003E2.19.1&lt;\u002Fmaven-surefire-plugin.version\u003E\n        &lt;junit-platform-surefire-provider.version\u003E1.1.0&lt;\u002Fjunit-platform-surefire-provider.version\u003E\n        &lt;assertj-core.version\u003E3.8.0&lt;\u002Fassertj-core.version\u003E\n        &lt;allure.version\u003E2.8.1&lt;\u002Fallure.version\u003E\n        &lt;allure-maven.version\u003E2.10.0&lt;\u002Fallure-maven.version\u003E\n        &lt;aspectj.version\u003E1.9.2&lt;\u002Faspectj.version\u003E\n        &lt;mockito.version\u003E2.21.0&lt;\u002Fmockito.version\u003E\n        &lt;rest-assured.version\u003E3.0.0&lt;\u002Frest-assured.version\u003E\n    &lt;\u002Fproperties\u003E\n\n    &lt;groupId\u003Eio.bihero&lt;\u002FgroupId\u003E\n    &lt;artifactId\u003Ehello-microservice&lt;\u002FartifactId\u003E\n    &lt;version\u003E1.0.0-SNAPSHOT&lt;\u002Fversion\u003E\n    &lt;build\u003E\n        &lt;plugins\u003E\n            &lt;plugin\u003E\n                &lt;artifactId\u003Emaven-compiler-plugin&lt;\u002FartifactId\u003E\n                &lt;configuration\u003E\n```1.8&lt;\u002Fsource\u003E\n                    &lt;target\u003E1.8&lt;\u002Ftarget\u003E\n                &lt;\u002Fconfiguration\u003E\n                &lt;executions\u003E\n                    &lt;execution\u003E\n                        &lt;id\u003Edefault-compile&lt;\u002Fid\u003E\n                        &lt;configuration\u003E\n                            &lt;annotationProcessors\u003E\n                                &lt;annotationProcessor\u003Eio.vertx.codegen.CodeGenProcessor&lt;\u002FannotationProcessor\u003E\n                            &lt;\u002FannotationProcessors\u003E\n                            &lt;generatedSourcesDirectory\u003Esrc\u002Fmain\u002Fgenerated&lt;\u002FgeneratedSourcesDirectory\u003E\n                            &lt;compilerArgs\u003E\n                                &lt;arg\u003E-Acodegen.output=${project.basedir}\u002Fsrc\u002Fmain&lt;\u002Farg\u003E\n                            &lt;\u002FcompilerArgs\u003E\n                        &lt;\u002Fconfiguration\u003E\n                    &lt;\u002Fexecution\u003E\n                    &lt;execution\u003E\n                        &lt;id\u003Edefault-testCompile&lt;\u002Fid\u003E\n                        &lt;configuration\u003E\n                            &lt;annotationProcessors\u003E\n                                &lt;annotationProcessor\u003Eio.vertx.codegen.CodeGenProcessor&lt;\u002FannotationProcessor\u003E\n                            &lt;\u002FannotationProcessors\u003E\n                            &lt;generatedTestSourcesDirectory\u003Esrc\u002Ftest\u002Fgenerated&lt;\u002FgeneratedTestSourcesDirectory\u003E\n                            &lt;compilerArgs\u003E\n                                &lt;arg\u003E-Acodegen.output=${project.basedir}\u002Fsrc\u002Ftest&lt;\u002Farg\u003E\n                            &lt;\u002FcompilerArgs\u003E\n                        &lt;\u002Fconfiguration\u003E\n                    &lt;\u002Fexecution\u003E\n                &lt;\u002Fexecutions\u003E\n            &lt;\u002Fplugin\u003E\n            &lt;plugin\u003E\n                &lt;groupId\u003Eorg.apache.maven.plugins&lt;\u002FgroupId\u003E\n                &lt;artifactId\u003Emaven-surefire-plugin&lt;\u002FartifactId\u003E\n                &lt;version\u003E${maven-surefire-plugin.version}&lt;\u002Fversion\u003E\n                &lt;configuration\u003E\n                    &lt;properties\u003E\n                        &lt;property\u003E\n                            &lt;name\u003Elistener&lt;\u002Fname\u003E\n                            &lt;value\u003Eio.qameta.allure.junit5.AllureJunit5&lt;\u002Fvalue\u003E\n                        &lt;\u002Fproperty\u003E\n                    &lt;\u002Fproperties\u003E\n                    &lt;includes\u003E\n                        &lt;include\u003E**\u002F*Test*.java&lt;\u002Finclude\u003E\n                    &lt;\u002Fincludes\u003E\n                    &lt;argLine\u003E\n                        -javaagent:\"${settings.localRepository}\u002Forg\u002Faspectj\u002Faspectjweaver\u002F${aspectj.version}\u002Faspectjweaver-${aspectj.version}.jar\" -Djdk.net.URLClassPath.disableClassPathURLCheck=true\n                    &lt;\u002FargLine\u003E\n                    &lt;systemProperties\u003E\n                        &lt;property\u003E\n                            &lt;name\u003Eallure.results.directory&lt;\u002Fname\u003E\n                            &lt;value\u003E${project.basedir}\u002Ftarget\u002Fallure-results&lt;\u002Fvalue\u003E\n                        &lt;\u002Fproperty\u003E\n                        &lt;property\u003E\n                            &lt;name\u003Ejunit.jupiter.extensions.autodetection.enabled&lt;\u002Fname\u003E\n                            &lt;value\u003Etrue&lt;\u002Fvalue\u003E\n                        &lt;\u002Fproperty\u003E\n                    &lt;\u002FsystemProperties\u003E\n                    &lt;reportFormat\u003Eplain&lt;\u002FreportFormat\u003E\n                &lt;\u002Fconfiguration\u003E\n                &lt;dependencies\u003E\n                    &lt;dependency\u003E\n                        &lt;groupId\u003Eorg.aspectj&lt;\u002FgroupId\u003E\n                        &lt;artifactId\u003Easpectjweaver&lt;\u002FartifactId\u003E\n                        &lt;version\u003E${aspectj.version}&lt;\u002Fversion\u003E\n                    &lt;\u002Fdependency\u003E\n                    &lt;dependency\u003E\n                        &lt;groupId\u003Eorg.junit.platform&lt;\u002FgroupId\u003E\n                        &lt;artifactId\u003Ejunit-platform-surefire-provider&lt;\u002FartifactId\u003E\n                        &lt;version\u003E${junit-platform-surefire-provider.version}&lt;\u002Fversion\u003E\n                    &lt;\u002Fdependency\u003E\n                    &lt;dependency\u003E\n                        &lt;groupId\u003Eorg.junit.jupiter&lt;\u002FgroupId\u003E\n                        &lt;artifactId\u003Ejunit-jupiter-engine&lt;\u002FartifactId\u003E\n                        &lt;version\u003E${junit-jupiter.version}&lt;\u002Fversion\u003E\n                    &lt;\u002Fdependency\u003E\n                &lt;\u002Fdependencies\u003E\n            &lt;\u002Fplugin\u003E\n            &lt;plugin\u003E\n                &lt;groupId\u003Eio.qameta.allure&lt;\u002FgroupId\u003E\n                &lt;artifactId\u003Eallure-maven&lt;\u002FartifactId\u003E\n                &lt;version\u003E${allure-maven.version}&lt;\u002Fversion\u003E\n            &lt;\u002Fplugin\u003E\n            &lt;plugin\u003E\n                &lt;groupId\u003Eorg.apache.maven.plugins&lt;\u002FgroupId\u003E\n                &lt;artifactId\u003Emaven-site-plugin&lt;\u002FartifactId\u003E\n                &lt;version\u003E3.7.1&lt;\u002Fversion\u003E\n                &lt;dependencies\u003E\n                    &lt;dependency\u003E\n                        &lt;groupId\u003Eorg.apache.maven.wagon&lt;\u002FgroupId\u003E\n                        &lt;artifactId\u003Ewagon-webdav-jackrabbit&lt;\u002FartifactId\u003E\n                        &lt;version\u003E2.8&lt;\u002Fversion\u003E\n                    &lt;\u002Fdependency\u003E\n                &lt;\u002Fdependencies\u003E\n            &lt;\u002Fplugin\u003E\n\n            &lt;plugin\u003E\n                &lt;groupId\u003Eorg.apache.maven.plugins&lt;\u002FgroupId\u003E\n                &lt;artifactId\u003Emaven-project-info-reports-plugin&lt;\u002FartifactId\u003E\n                &lt;version\u003E3.0.0&lt;\u002Fversion\u003E\n            &lt;\u002Fplugin\u003E\n            &lt;plugin\u003E\n                &lt;groupId\u003Eorg.apache.maven.plugins&lt;\u002FgroupId\u003E\n                &lt;artifactId\u003Emaven-shade-plugin&lt;\u002FartifactId\u003E\n                &lt;version\u003E2.3&lt;\u002Fversion\u003E\n                &lt;executions\u003E\n                    &lt;execution\u003E\n                        &lt;phase\u003Epackage&lt;\u002Fphase\u003E\n                        &lt;goals\u003E\n                            &lt;goal\u003Eshade&lt;\u002Fgoal\u003E\n                        &lt;\u002Fgoals\u003E\n                        &lt;configuration\u003E\n                            &lt;transformers\u003E\n                                &lt;transformer implementation=\"org.apache.maven.plugins.shade.resource.ManifestResourceTransformer\"\u003E\n                                    &lt;manifestEntries\u003E\n                                        &lt;Main-Class\u003Eio.vertx.core.Launcher&lt;\u002FMain-Class\u003E\n                                        &lt;Main-Verticle\u003E${main.verticle}&lt;\u002FMain-Verticle\u003E\n                                    &lt;\u002FmanifestEntries\u003E\n                                &lt;\u002Ftransformer\u003E\n                                &lt;transformer implementation=\"org.apache.maven.plugins.shade.resource.AppendingTransformer\"\u003E\n                                    &lt;resource\u003EMETA-INF\u002Fservices\u002Fio.vertx.core.spi.VerticleFactory&lt;\u002Fresource\u003E\n                                &lt;\u002Ftransformer\u003E\n                            &lt;\u002Ftransformers\u003E\n                            &lt;artifactSet\u003E\n                            &lt;\u002FartifactSet\u003E\n                            &lt;outputFile\u003E${project.build.directory}\u002F${project.artifactId}-fat.jar&lt;\u002FoutputFile\u003E\n                        &lt;\u002Fconfiguration\u003E\n                    &lt;\u002Fexecution\u003E\n                &lt;\u002Fexecutions\u003E\n            &lt;\u002Fplugin\u003E\n        &lt;\u002Fplugins\u003E\n        &lt;resources\u003E\n            &lt;resource\u003E\n                &lt;directory\u003Esrc\u002Fmain\u002Fresources&lt;\u002Fdirectory\u003E\n                &lt;filtering\u003Etrue&lt;\u002Ffiltering\u003E\n                &lt;includes\u003E\n                    &lt;include\u003E**\u002Fversion.txt&lt;\u002Finclude\u003E\n                &lt;\u002Fincludes\u003E\n            &lt;\u002Fresource\u003E\n            &lt;resource\u003E\n                &lt;directory\u003Esrc\u002Fmain\u002Fresources&lt;\u002Fdirectory\u003E\n                &lt;filtering\u003Efalse&lt;\u002Ffiltering\u003E\n                &lt;excludes\u003E\n                    &lt;exclude\u003E**\u002Fversion.txt&lt;\u002Fexclude\u003E\n                &lt;\u002Fexcludes\u003E\n            &lt;\u002Fresource\u003E\n        &lt;\u002Fresources\u003E\n    &lt;\u002Fbuild\u003E\n    &lt;distributionManagement\u003E\n        &lt;site\u003E\n            &lt;id\u003Ereports&lt;\u002Fid\u003E\n            &lt;url\u003Edav:https:\u002F\u002Fnexus.dev.techedge.pro:8443\u002Frepository\u002Freports\u002F${project.artifactId}\u002F&lt;\u002Furl\u003E\n        &lt;\u002Fsite\u003E\n    &lt;\u002FdistributionManagement\u003E\n    &lt;reporting\u003E\n        &lt;excludeDefaults\u003Etrue&lt;\u002FexcludeDefaults\u003E\n        &lt;plugins\u003E\n            &lt;plugin\u003E\n                &lt;groupId\u003Eio.qameta.allure&lt;\u002FgroupId\u003E\n                &lt;artifactId\u003Eallure-maven&lt;\u002FartifactId\u003E\n                &lt;configuration\u003E\n                    &lt;resultsDirectory\u003E${project.build.directory}\u002Fallure-results&lt;\u002FresultsDirectory\u003E\n                    &lt;reportDirectory\u003E${project.reporting.outputDirectory}\u002F${project.version}\u002Fallure&lt;\u002FreportDirectory\u003E\n                &lt;\u002Fconfiguration\u003E\n            &lt;\u002Fplugin\u003E\n        &lt;\u002Fplugins\u003E\n    &lt;\u002Freporting\u003E\n\n    &lt;dependencies\u003E\n        &lt;dependency\u003E\n            &lt;groupId\u003Eio.vertx&lt;\u002FgroupId\u003E\n            &lt;artifactId\u003Evertx-web-api-service&lt;\u002FartifactId\u003E\n            &lt;version\u003E${vertx.version}&lt;\u002Fversion\u003E\n        &lt;\u002Fdependency\u003E\n        &lt;dependency\u003E\n            &lt;groupId\u003Eio.vertx&lt;\u002FgroupId\u003E\n            &lt;artifactId\u003Evertx-codegen&lt;\u002FartifactId\u003E\n            &lt;version\u003E${vertx.version}&lt;\u002Fversion\u003E\n            &lt;scope\u003Eprovided&lt;\u002Fscope\u003E\n        &lt;\u002Fdependency\u003E\n        &lt;dependency\u003E\n            &lt;groupId\u003Ech.qos.logback&lt;\u002FgroupId\u003E\n            &lt;artifactId\u003Elogback-classic&lt;\u002FartifactId\u003E\n            &lt;version\u003E${logback.version}&lt;\u002Fversion\u003E\n        &lt;\u002Fdependency\u003E\n\n        &lt;!-- test &amp;ndash;&amp;gt;--\u003E\n        &lt;dependency\u003E\n            &lt;groupId\u003Eio.vertx&lt;\u002FgroupId\u003E\n            &lt;artifactId\u003Evertx-unit&lt;\u002FartifactId\u003E\n            &lt;version\u003E${vertx.version}&lt;\u002Fversion\u003E\n            &lt;scope\u003Etest&lt;\u002Fscope\u003E\n        &lt;\u002Fdependency\u003E\n        &lt;dependency\u003E\n            &lt;groupId\u003Eio.vertx&lt;\u002FgroupId\u003E\n            &lt;artifactId\u003Evertx-junit5&lt;\u002FartifactId\u003E\n            &lt;version\u003E${vertx.version}&lt;\u002Fversion\u003E\n            &lt;scope\u003Etest&lt;\u002Fscope\u003E\n        &lt;\u002Fdependency\u003E\n        &lt;dependency\u003E\n            &lt;groupId\u003Eorg.junit.jupiter&lt;\u002FgroupId\u003E\n            &lt;artifactId\u003Ejunit-jupiter-api&lt;\u002FartifactId\u003E\n            &lt;version\u003E${junit-jupiter.version}&lt;\u002Fversion\u003E\n            &lt;scope\u003Etest&lt;\u002Fscope\u003E\n        &lt;\u002Fdependency\u003E\n        &lt;dependency\u003E\n            &lt;groupId\u003Eorg.junit.jupiter&lt;\u002FgroupId\u003E\n            &lt;artifactId\u003Ejunit-jupiter-engine&lt;\u002FartifactId\u003E\n            &lt;version\u003E${junit-jupiter.version}&lt;\u002Fversion\u003E\n            &lt;scope\u003Etest&lt;\u002Fscope\u003E\n        &lt;\u002Fdependency\u003E\n        &lt;dependency\u003E\n            &lt;groupId\u003Eorg.assertj&lt;\u002FgroupId\u003E\n            &lt;artifactId\u003Eassertj-core&lt;\u002FartifactId\u003E\n            &lt;version\u003E${assertj-core.version}&lt;\u002Fversion\u003E\n            &lt;scope\u003Etest&lt;\u002Fscope\u003E\n        &lt;\u002Fdependency\u003E\n        &lt;dependency\u003E\n            &lt;groupId\u003Eorg.mockito&lt;\u002FgroupId\u003E\n            &lt;artifactId\u003Emockito-core&lt;\u002FartifactId\u003E\n            &lt;version\u003E${mockito.version}&lt;\u002Fversion\u003E\n            &lt;scope\u003Etest&lt;\u002Fscope\u003E\n        &lt;\u002Fdependency\u003E\n        &lt;dependency\u003E\n            &lt;groupId\u003Eio.qameta.allure&lt;\u002FgroupId\u003E\n            &lt;artifactId\u003Eallure-junit5&lt;\u002FartifactId\u003E\n            &lt;version\u003E${allure.version}&lt;\u002Fversion\u003E\n            &lt;scope\u003Etest&lt;\u002Fscope\u003E\n        &lt;\u002Fdependency\u003E\n        &lt;dependency\u003E\n            &lt;groupId\u003Eio.vertx&lt;\u002FgroupId\u003E\n            &lt;artifactId\u003Evertx-web-client&lt;\u002FartifactId\u003E\n            &lt;version\u003E${vertx.version}&lt;\u002Fversion\u003E\n            &lt;scope\u003Etest&lt;\u002Fscope\u003E\n        &lt;\u002Fdependency\u003E\n    &lt;\u002Fdependencies\u003E\n\n&lt;\u002Fproject\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\n                    \u003C\u002Fdiv\u003E\u003Cbr\u002F\u003E\r\n\u003Cdiv class=\"spoiler\" role=\"button\" tabindex=\"0\"\u003E\n                        \u003Cb class=\"spoiler_title\"\u003EHelloService.java\u003C\u002Fb\u003E\n                        \u003Cdiv class=\"spoiler_text\"\u003E\u003Cpre\u003E\u003Ccode class=\"java\"\u003Epackage io.bihero.hello;\n\nimport io.vertx.core.AsyncResult;\nimport io.vertx.core.Handler;\nimport io.vertx.core.Vertx;\nimport io.vertx.ext.web.api.OperationRequest;\nimport io.vertx.ext.web.api.OperationResponse;\nimport io.vertx.ext.web.api.generator.WebApiServiceGen;\n\n@WebApiServiceGen\npublic interface HelloService {\n\n    static HelloService create(Vertx vertx) {\n        return new DefaultHelloService(vertx);\n    }\n\n    void getHelloWord(OperationRequest context, Handler&lt;AsyncResult&lt;OperationResponse\u003E\u003E resultHandler);\n\n    void getDoc(OperationRequest context, Handler&lt;AsyncResult&lt;OperationResponse\u003E\u003E resultHandler);\n\n}\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\n                    \u003C\u002Fdiv\u003E\u003Cbr\u002F\u003E\r\n\u003Cdiv class=\"spoiler\" role=\"button\" tabindex=\"0\"\u003E\n                        \u003Cb class=\"spoiler_title\"\u003EDefaultHelloService.java\u003C\u002Fb\u003E\n                        \u003Cdiv class=\"spoiler_text\"\u003E\u003Cpre\u003E\u003Ccode class=\"java\"\u003Epackage io.bihero.hello;\n\nimport io.vertx.core.AsyncResult;\nimport io.vertx.core.Future;\nimport io.vertx.core.Handler;\nimport io.vertx.core.Vertx;\nimport io.vertx.core.buffer.Buffer;\nimport io.vertx.ext.web.api.OperationRequest;\nimport io.vertx.ext.web.api.OperationResponse;\n\npublic class DefaultHelloService implements HelloService {\n\n    private final Vertx vertx;\n\n    public DefaultHelloService(Vertx vertx) {\n        this.vertx = vertx;\n    }\n\n    @Override\n    public void getHelloWord(OperationRequest context, Handler&lt;AsyncResult&lt;OperationResponse\u003E\u003E resultHandler) {\n        resultHandler.handle(Future.succeededFuture(OperationResponse.completedWithPlainText(Buffer.buffer(\"Hello\"))));\n    }\n\n    @Override\n    public void getDoc(OperationRequest context, Handler&lt;AsyncResult&lt;OperationResponse\u003E\u003E resultHandler) {\n        vertx.fileSystem().readFile(\"doc.yaml\", buffResult -\u003E\n                resultHandler.handle(Future.succeededFuture(\n                        OperationResponse.completedWithPlainText(buffResult.result()))\n                ));\n    }\n\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\n                    \u003C\u002Fdiv\u003E\u003Cbr\u002F\u003E\r\n\u003Cdiv class=\"spoiler\" role=\"button\" tabindex=\"0\"\u003E\n                        \u003Cb class=\"spoiler_title\"\u003EHelloVerticle.java\u003C\u002Fb\u003E\n                        \u003Cdiv class=\"spoiler_text\"\u003E\u003Cpre\u003E\u003Ccode class=\"java\"\u003Epackage io.bihero.hello;\n\nimport io.vertx.core.AbstractVerticle;\nimport io.vertx.core.Promise;\nimport io.vertx.core.eventbus.MessageConsumer;\nimport io.vertx.core.http.HttpServer;\nimport io.vertx.core.http.HttpServerOptions;\nimport io.vertx.core.json.JsonObject;\nimport io.vertx.ext.web.Router;\nimport io.vertx.ext.web.api.contract.openapi3.OpenAPI3RouterFactory;\nimport io.vertx.serviceproxy.ServiceBinder;\n\npublic class HelloVerticle extends AbstractVerticle {\n\n    private HttpServer server;\n    private MessageConsumer&lt;JsonObject\u003E consumer;\n\n    @Override\n    public void start(Promise&lt;Void\u003E promise) {\n        startHelloService();\n        startHttpServer().future().setHandler(promise);\n    }\n\n    \u002F**\n     * This method closes the http server and unregister all services loaded to Event Bus\n     *\u002F\n    @Override\n    public void stop(){\n        this.server.close();\n        consumer.unregister();\n    }\n\n    private void startHelloService() {\n        consumer = new ServiceBinder(vertx).setAddress(\"service.hello\")\n                .register(HelloService.class, HelloService.create(getVertx()));\n    }\n\n    \u002F**\n     * This method constructs the router factory, mounts services and handlers and starts the http server\n     * with built router\n     * @return\n     *\u002F\n    private Promise&lt;Void\u003E startHttpServer() {\n        Promise&lt;Void\u003E promise = Promise.promise();\n        OpenAPI3RouterFactory.create(this.vertx, \"\u002Fdoc.yaml\", openAPI3RouterFactoryAsyncResult -\u003E {\n            if (openAPI3RouterFactoryAsyncResult.succeeded()) {\n                OpenAPI3RouterFactory routerFactory = openAPI3RouterFactoryAsyncResult.result();\n\n                \u002F\u002F Mount services on event bus based on extensions\n                routerFactory.mountServicesFromExtensions();\n\n                \u002F\u002F Generate the router\n                Router router = routerFactory.getRouter();\n\n                int port = config().getInteger(\"serverPort\", 8080);\n                String host = config().getString(\"serverHost\", \"localhost\");\n\n                server = vertx.createHttpServer(new HttpServerOptions().setPort(port).setHost(host));\n                server.requestHandler(router).listen(ar -\u003E {\n                    \u002F\u002F Error starting the HttpServer\n                    if (ar.succeeded()) promise.complete();\n                    else promise.fail(ar.cause());\n                });\n            } else {\n                \u002F\u002F Something went wrong during router factory initialization\n                promise.fail(openAPI3RouterFactoryAsyncResult.cause());\n            }\n        });\n        return promise;\n    }\n\n}\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\n                    \u003C\u002Fdiv\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EВ интерфейсе сервиса и его имплементации нет ничего необычного (за исключением аннотации @WebApiServiceGen, но про него можно почитать в \u003Ca href=\"https:\u002F\u002Fvertx.io\u002Fdocs\u002Fvertx-web-api-service\u002Fjava\u002F#_using_vert_x_api_service\"\u003Eдокументации\u003C\u002Fa\u003E), а вот код verticle-класса рассмотрим подробнее.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EИнтересны два метода, которые вызываются на старта вертикла:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cul\u003E\r\n\u003Cli\u003E\u003Cstrong\u003EstartHelloService\u003C\u002Fstrong\u003E создает объект с имплеменатацией нашего сервиса и биндит его на адрес в event bus (вспомним параметр \u003Cem\u003Ex-vertx-event-bus.address\u003C\u002Fem\u003E из спецификации выше)\u003C\u002Fli\u003E\r\n\u003Cli\u003E\u003Cstrong\u003EstartHttpServer\u003C\u002Fstrong\u003E создаёт router factory на основе спецификации сервиса, создаёт http-сервер и прицепляет созданный router к хэндлеру всех входящих http-запросов (если гурбо, то запрос \u003Cstrong\u003EGET \u002F\u003C\u002Fstrong\u003E будет падать в event bus vertex'а с адресом \u003Cstrong\u003Eservice.hello\u003C\u002Fstrong\u003E (а туда мы забиндили реализацию сервиса \u003Cem\u003Eio.bihero.hello.HelloService\u003C\u002Fem\u003E) и с именем метода сервиса \u003Cstrong\u003EgetHelloWord\u003C\u002Fstrong\u003E)\u003C\u002Fli\u003E\r\n\u003C\u002Ful\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EПора собрать джарник и пробовать запускать:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"bash\"\u003Emvn clean package # собираем джарник\njava -Dlogback.configurationFile=.\u002Fsrc\u002Fconf\u002Flogback-console.xml -jar target\u002Fhello-microservice-fat.jar  -conf .\u002Fsrc\u002Fconf\u002Fconfig.json # запускаем сервис\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EВ строке запуска интересны два параметра:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cul\u003E\r\n\u003Cli\u003E-Dlogback.configurationFile=.\u002Fsrc\u002Fconf\u002Flogback-console.xml — путь до конфиг-файла для logback (в зависимостях проекта должны быть slf4j и logback как имплементация slf4j-api)\u003C\u002Fli\u003E\r\n\u003Cli\u003E-conf .\u002Fsrc\u002Fconf\u002Fconfig.json — конфиг сервиса, там для нас важен порт, на котором будет открыт http REST API:\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"json\"\u003E{\n\"type\": \"file\",\n\"format\": \"json\",\n\"scanPeriod\": 5000,\n\"config\": {\n\"path\": \"\u002Fhome\u002Fslava\u002FJavaProjects\u002Fhello-world-to-cloud\u002Fhellomicroservice\u002Fsrc\u002Fconf\u002Fconfig.json\"\n},\n\"serverPort\": 8081,\n\"serverHost\": \"0.0.0.0\"\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fli\u003E\r\n\u003C\u002Ful\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EВывод maven'а нам особо не интересен, а вот как стартанул сервис, можно посмотреть (в настройках логгера для пакета \u003Cstrong\u003Eio.netty\u003C\u002Fstrong\u003E выставлен \u003Cstrong\u003Elevel=\"INFO\"\u003C\u002Fstrong\u003E)\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cdiv class=\"spoiler\" role=\"button\" tabindex=\"0\"\u003E\n                        \u003Cb class=\"spoiler_title\"\u003EКак стартанул сервис\u003C\u002Fb\u003E\n                        \u003Cdiv class=\"spoiler_text\"\u003E\u003Cpre\u003E\u003Ccode class=\"bash\"\u003E2019-10-03 20:52:45,159 [vert.x-worker-thread-0] DEBUG i.s.v.p.OpenAPIV3Parser: Loaded raw data: openapi: 3.0.1\ninfo:\n  title: Hello ;)\n  description: Hello microservice\n  version: 1.0.0\nservers:\n  - url: https:\u002F\u002Fdemo1.bihero.io\u002Fapi\u002Fhello\ntags:\n  - name: hello\n    description: Everything about saying 'Hello'\npaths:\n  \u002F:\n    x-vertx-event-bus:\n      address: service.hello\n      timeout: 1000c\n    get:\n      tags:\n        - hello\n      summary: Get 'Hello' word\n      operationId: getHelloWord\n      responses:\n        200:\n          description: OK\n  \u002Fdoc:\n    x-vertx-event-bus:\n      address: service.hello\n      timeout: 1000c\n    get:\n      tags:\n        - hello_doc\n      summary: Get 'Hello' microservice documentation\n      operationId: getDoc\n      responses:\n        200:\n          description: OK\ncomponents: {}\n2019-10-03 20:52:45,195 [vert.x-worker-thread-0] DEBUG i.s.v.p.OpenAPIV3Parser: Parsed rootNode: {\"openapi\":\"3.0.1\",\"info\":{\"title\":\"Hello ;)\",\"description\":\"Hello microservice\",\"version\":\"1.0.0\"},\"servers\":[{\"url\":\"https:\u002F\u002Fdemo1.bihero.io\u002Fapi\u002Fhello\"}],\"tags\":[{\"name\":\"hello\",\"description\":\"Everything about saying 'Hello'\"}],\"paths\":{\"\u002F\":{\"x-vertx-event-bus\":{\"address\":\"service.hello\",\"timeout\":\"1000c\"},\"get\":{\"tags\":[\"hello\"],\"summary\":\"Get 'Hello' word\",\"operationId\":\"getHelloWord\",\"responses\":{\"200\":{\"description\":\"OK\"}}}},\"\u002Fdoc\":{\"x-vertx-event-bus\":{\"address\":\"service.hello\",\"timeout\":\"1000c\"},\"get\":{\"tags\":[\"hello_doc\"],\"summary\":\"Get 'Hello' microservice documentation\",\"operationId\":\"getDoc\",\"responses\":{\"200\":{\"description\":\"OK\"}}}}},\"components\":{}}\nOct 03, 2019 8:52:45 PM io.vertx.core.impl.launcher.commands.VertxIsolatedDeployer\nINFO: Succeeded in deploying verticle\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\n                    \u003C\u002Fdiv\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EУра! Сервис заработал, можно проверять:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"bash\"\u003Ecurl http:\u002F\u002F127.0.0.1:8081\u002F\nHello\ncurl -v http:\u002F\u002F127.0.0.1:8081\u002Fdoc\nopenapi: 3.0.1\ninfo:\n  title: Hello ;)\n  description: Hello microservice\n  version: 1.0.0\nservers:\n  - url: https:\u002F\u002Fdemo1.bihero.io\u002Fapi\u002Fhello\ntags:\n  - name: hello\n    description: Everything about saying 'Hello'\npaths:\n  \u002F:\n    x-vertx-event-bus:\n      address: service.hello\n      timeout: 1000c\n    get:\n      tags:\n        - hello\n      summary: Get 'Hello' word\n      operationId: getHelloWord\n      responses:\n        200:\n          description: OK\n  \u002Fdoc:\n    x-vertx-event-bus:\n      address: service.hello\n      timeout: 1000c\n    get:\n      tags:\n        - hello_doc\n      summary: Get 'Hello' microservice documentation\n      operationId: getDoc\n      responses:\n        200:\n          description: OK\ncomponents: {}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EСервис отвечает словом \u003Cstrong\u003EHello\u003C\u002Fstrong\u003E на запрос \u003Cstrong\u003EGET \u002F\u003C\u002Fstrong\u003E, что соответствует спецификации, и умеет говорить о том, что он умеет делать, отдавая специфкацию по запросу \u003Cstrong\u003EGET \u002Fdoc\u003C\u002Fstrong\u003E. Круто, идём в прод!\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Ch3\u003EЧто-то тут не так ...\u003C\u002Fh3\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EРанее я писал, что нам не особо важен вывод maven'а при сборке. Я наврал, вывод важен и очень. Нам нужно, чтобы maven запускал тесты и при падении тестов сборка падала. Сборка выше прошла, и это говорит о том, что либо тесты прошли, либо их нет. Тестов у нас, конечно же, нет, настала пора их написать (тут можно поспорить о методологиях, о том когда и как писать тесты, до или после имплементации, но мы вспомним про важную заметку вначала статьи и пойдём дальше — напишем парочку тестов).\u003Cbr\u002F\u003E\r\nПервый тест-класс является по своей природе юнит-тестом, проверяющим два конкретных метода нашего сервиса:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cdiv class=\"spoiler\" role=\"button\" tabindex=\"0\"\u003E\n                        \u003Cb class=\"spoiler_title\"\u003EHelloServiceTest.java\u003C\u002Fb\u003E\n                        \u003Cdiv class=\"spoiler_text\"\u003E\u003Cpre\u003E\u003Ccode class=\"java\"\u003Epackage io.bihero.hello;\n\nimport io.vertx.core.Vertx;\nimport io.vertx.core.json.JsonObject;\nimport io.vertx.ext.web.api.OperationRequest;\nimport io.vertx.junit5.VertxExtension;\nimport io.vertx.junit5.VertxTestContext;\nimport org.apache.commons.io.IOUtils;\nimport org.junit.jupiter.api.DisplayName;\nimport org.junit.jupiter.api.Test;\nimport org.junit.jupiter.api.extension.ExtendWith;\n\nimport java.io.IOException;\n\nimport static org.assertj.core.api.Assertions.assertThat;\n\n@ExtendWith(VertxExtension.class)\npublic class HelloServiceTest {\n\n    private HelloService helloService = HelloService.create(Vertx.vertx());\n\n    @Test\n    @DisplayName(\"Test 'getHelloWord' method returns 'Hello' word\")\n    public void testHelloMethod(VertxTestContext testContext) {\n        helloService.getHelloWord(new OperationRequest(new JsonObject()), testContext.succeeding(it -\u003E {\n            assertThat(it.getStatusCode()).isEqualTo(200);\n            assertThat(it.getPayload().toString()).isEqualTo(\"Hello\");\n            testContext.completeNow();\n        }));\n    }\n\n    @Test\n    @DisplayName(\"Test 'getDoc' method returns service documentation in OpenAPI format\")\n    public void testDocMethod(VertxTestContext testContext) {\n        helloService.getDoc(new OperationRequest(new JsonObject()), testContext.succeeding(it -\u003E {\n            try {\n                assertThat(it.getStatusCode()).isEqualTo(200);\n                assertThat(it.getPayload().toString()).isEqualTo(IOUtils.toString(this.getClass()\n                        .getResourceAsStream(\"..\u002F..\u002F..\u002Fdoc.yaml\"), \"UTF-8\"));\n                testContext.completeNow();\n            } catch (IOException e) {\n                testContext.failNow(e);\n            }\n        }));\n    }\n\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\n                    \u003C\u002Fdiv\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EВторой тест — недоинтеграционный тест, проверяющий, что вертикл поднимается и отвечает на соответствующие http запросы ожидаемыми статусами и текстом:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cdiv class=\"spoiler\" role=\"button\" tabindex=\"0\"\u003E\n                        \u003Cb class=\"spoiler_title\"\u003EHelloVerticleTest.java\u003C\u002Fb\u003E\n                        \u003Cdiv class=\"spoiler_text\"\u003E\u003Cpre\u003E\u003Ccode class=\"java\"\u003Epackage io.bihero.hello;\n\nimport io.vertx.core.Vertx;\nimport io.vertx.core.json.JsonObject;\nimport io.vertx.ext.web.client.WebClient;\nimport io.vertx.ext.web.codec.BodyCodec;\nimport io.vertx.junit5.Checkpoint;\nimport io.vertx.junit5.VertxExtension;\nimport io.vertx.junit5.VertxTestContext;\nimport org.apache.commons.io.IOUtils;\nimport org.junit.jupiter.api.DisplayName;\nimport org.junit.jupiter.api.Test;\nimport org.junit.jupiter.api.extension.ExtendWith;\n\nimport static org.assertj.core.api.Assertions.assertThat;\nimport static org.mockito.Mockito.doReturn;\nimport static org.mockito.Mockito.spy;\n\n@ExtendWith(VertxExtension.class)\npublic class HelloVerticleTest {\n\n    @Test\n    @DisplayName(\"Test that verticle is up and respond me by 'Hello' word and doc in OpenAPI format\")\n    public void testHelloVerticle(Vertx vertx, VertxTestContext testContext) {\n        WebClient webClient = WebClient.create(vertx);\n\n        Checkpoint deploymentCheckpoint = testContext.checkpoint();\n        Checkpoint requestCheckpoint = testContext.checkpoint(2);\n\n        HelloVerticle verticle = spy(new HelloVerticle());\n        JsonObject config = new JsonObject().put(\"serverPort\", 8081).put(\"serverHost\", \"0.0.0.0\");\n        doReturn(config).when(verticle).config();\n        vertx.deployVerticle(verticle, testContext.succeeding(id -\u003E {\n            deploymentCheckpoint.flag();\n            \u002F\u002F test GET \u002F\n            webClient.get(8081, \"localhost\", \"\u002F\")\n                    .as(BodyCodec.string())\n                    .send(testContext.succeeding(resp -\u003E {\n                        assertThat(resp.body()).isEqualTo(\"Hello\");\n                        assertThat(resp.statusCode()).isEqualTo(200);\n                        requestCheckpoint.flag();\n                    }));\n            \u002F\u002F test GET \u002Fdoc\n            webClient.get(8081, \"localhost\", \"\u002Fdoc\")\n                    .as(BodyCodec.string())\n                    .send(testContext.succeeding(resp -\u003E {\n                        try {\n                            assertThat(resp.body()).isEqualTo(IOUtils.toString(this.getClass()\n                                    .getResourceAsStream(\"..\u002F..\u002F..\u002Fdoc.yaml\"), \"UTF-8\"));\n                            assertThat(resp.statusCode()).isEqualTo(200);\n                            requestCheckpoint.flag();\n                        } catch (Exception e) {\n                            requestCheckpoint.flag();\n                            testContext.failNow(e);\n                        }\n                    }));\n        }));\n    }\n\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\n                    \u003C\u002Fdiv\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EПора собирать сервис вместе с тестами:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"bash\"\u003Emvn clean package\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EНас очень интересует лог плагина surefire, выглядеть он будет примерно так (картинка кликабельна):\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002F3l\u002Fs3\u002Fdk\u002F3ls3dkohbjzzlfj1rruhtvtxjzs.png\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fwebt\u002F3l\u002Fs3\u002Fdk\u002F3ls3dkohbjzzlfj1rruhtvtxjzs.png\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002F3l\u002Fs3\u002Fdk\u002F3ls3dkohbjzzlfj1rruhtvtxjzs.png\"\u002F\u003E\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EЗдорово! Сервис собирается, тесты бегут и не падают (чуть позже поговорим о красоте того, как результаты тестов показывать начальству), пора задуматься о том, как мы будем его доставлять до пользователей (то есть до серверов). На дворе конец 2019-го, и, конечно же, бандлить приложение мы будем в виде docker-образа. Поехали!\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Ch2\u003EDocker и все все все\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EDocker image для нашего первого сервиса будем собирать на основе \u003Ccode\u003Eadoptopenjdk\u002Fopenjdk11\u003C\u002Fcode\u003E. Добавим в образ наш собранный джарник со всеми необходимыми конфигами и пропишем в докерфайле команду для старта приложения в контейнере. Итоговый \u003Cstrong\u003EDockerfile\u003C\u002Fstrong\u003E будет выглядеть так:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"bash\"\u003EFROM adoptopenjdk\u002Fopenjdk11:alpine-jre\nCOPY target\u002Fhello-microservice-fat.jar app.jar\nCOPY src\u002Fconf\u002Fconfig.json .\nCOPY src\u002Fconf\u002Flogback-console.xml .\nCOPY run.sh .\nRUN chmod +x run.sh\nCMD [\".\u002Frun.sh\"]\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EСкрипт \u003Cstrong\u003Erun.sh\u003C\u002Fstrong\u003E выглядит так:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"bash\"\u003E#!\u002Fbin\u002Fsh\njava ${JVM_OPTS} -Dlogback.configurationFile=.\u002Flogback-console.xml -jar app.jar -conf config.json\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EПеременная окружения \u003Cstrong\u003EJVM_OPTS\u003C\u002Fstrong\u003E нам на этом этапе пока не особо нужна, но чуть позже мы будем её активно менять и тюнить параметры виртуальной машины и наших сервисов. Пора собрать образ и запустить приложение в контейнере:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"bash\"\u003Edocker build -t=\"hellomicroservice\" .\ndocker run -dit --name helloms hellomicroservice\n# посмотрим в логи контейнера, что он там нам позапускал\ndocker logs -f helloms\n\n# вывод docker logs\n2019-10-05 14:55:46,059 [vert.x-worker-thread-0] DEBUG i.s.v.p.OpenAPIV3Parser: Loaded raw data: openapi: 3.0.1\ninfo:\n  title: Hello ;)\n  description: Hello microservice\n  version: 1.0.0\nservers:\n  - url: https:\u002F\u002Fdemo1.bihero.io\u002Fapi\u002Fhello\ntags:\n  - name: hello\n    description: Everything about saying 'Hello'\npaths:\n  \u002F:\n    x-vertx-event-bus:\n      address: service.hello\n      timeout: 1000c\n    get:\n      tags:\n        - hello\n      summary: Get 'Hello' word\n      operationId: getHelloWord\n      responses:\n        200:\n          description: OK\n  \u002Fdoc:\n    x-vertx-event-bus:\n      address: service.hello\n      timeout: 1000c\n    get:\n      tags:\n        - hello_doc\n      summary: Get 'Hello' microservice documentation\n      operationId: getDoc\n      responses:\n        200:\n          description: OK\ncomponents: {}\n2019-10-05 14:55:46,098 [vert.x-worker-thread-0] DEBUG i.s.v.p.OpenAPIV3Parser: Parsed rootNode: {\"openapi\":\"3.0.1\",\"info\":{\"title\":\"Hello ;)\",\"description\":\"Hello microservice\",\"version\":\"1.0.0\"},\"servers\":[{\"url\":\"https:\u002F\u002Fdemo1.bihero.io\u002Fapi\u002Fhello\"}],\"tags\":[{\"name\":\"hello\",\"description\":\"Everything about saying 'Hello'\"}],\"paths\":{\"\u002F\":{\"x-vertx-event-bus\":{\"address\":\"service.hello\",\"timeout\":\"1000c\"},\"get\":{\"tags\":[\"hello\"],\"summary\":\"Get 'Hello' word\",\"operationId\":\"getHelloWord\",\"responses\":{\"200\":{\"description\":\"OK\"}}}},\"\u002Fdoc\":{\"x-vertx-event-bus\":{\"address\":\"service.hello\",\"timeout\":\"1000c\"},\"get\":{\"tags\":[\"hello_doc\"],\"summary\":\"Get 'Hello' microservice documentation\",\"operationId\":\"getDoc\",\"responses\":{\"200\":{\"description\":\"OK\"}}}}},\"components\":{}}\nOct 05, 2019 2:55:46 PM io.vertx.core.impl.launcher.commands.VertxIsolatedDeployer\nINFO: Succeeded in deploying verticle\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EДостанем ip-адрес контейнера и проверим работу сервиса внутри контейнера:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"bash\"\u003Edocker inspect helloms | grep IPAddress\n \"SecondaryIPAddresses\": null,\n            \"IPAddress\": \"172.17.0.2\",\n                    \"IPAddress\": \"172.17.0.2\",\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"bash\"\u003Ecurl http:\u002F\u002F172.17.0.2:8081\u002F # тут ожидаем увидеть слово 'Hello' в ответе\ncurl http:\u002F\u002F172.17.0.2:8081\u002Fdoc # тут ждём описание сервиса в формате OpenAPI\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EИтак, сервис запускается в контейнере. Но мы же не будем его руками вот так (docker run) запускать в production-окружении, для этого у нас есть прекрасный kubernetes. Чтобы запустить приложение в kubernetes, нам нужен шаблон, yml-файл, с описанием того, какие ресурсы (deployment, service, ingress, etc) мы будем запускать и на основе какого контейнера. Но, прежде чем мы начнём описывать темплейт для запуска приложения в k8s, пушнем ка собранный ранее образ на докерхаб:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"bash\"\u003Edocker tag hello bihero\u002Fhello\ndocker push bihero\u002Fhello\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EПишем темплейт для запуска приложения в kubernetes (в рамках статьи мы не настоящие сварщики и не претендуем на \"кошерность\" темплейта):\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"plaintext\"\u003EapiVersion: extensions\u002Fv1beta1\nkind: Deployment\nmetadata:\n  labels:\n    io.bihero.hello.service: bihero-hello\n  name: bihero-hello\nspec:\n  replicas: 3\n  strategy:\n    type: RollingUpdate\n    rollingUpdate:\n      maxSurge: 1\n      maxUnavailable: 1\n  template:\n    metadata:\n      labels:\n        io.bihero.hello.service: bihero-hello\n    spec:\n      containers:\n        - image: bihero\u002Fhello:${HELLO_SERVICE_IMAGE_VERSION}\n          name: bihero-hello\n          ports:\n            - containerPort: 8081\n          imagePullPolicy: Always\n          resources: {}\n      restartPolicy: Always\n---\napiVersion: v1\nkind: Service\nmetadata:\n  labels:\n    io.bihero.hello.service: bihero-hello\n  name: bihero-hello\nspec:\n  ports:\n    - name: \"8081\"\n      port: 8081\n      targetPort: 8081\n  selector:\n    io.bihero.hello.service: bihero-hello\nstatus:\n  loadBalancer: {}\n---\napiVersion: extensions\u002Fv1beta1\nkind: Ingress\nmetadata:\n  name: bihero-hello\n  annotations:\n    kubernetes.io\u002Fingress.class: nginx\n    nginx.ingress.kubernetes.io\u002Fssl-redirect: \"true\"\n    nginx.ingress.kubernetes.io\u002Fsecure-backends: \"false\"\n    nginx.ingress.kubernetes.io\u002Fssl-passthrough: \"false\"\n    nginx.ingress.kubernetes.io\u002Frewrite-target: \u002F$2\n    kubernetes.io\u002Ftls-acme: \"true\"\n  namespace: default\nspec:\n  tls:\n    - hosts:\n        - ${ID_DOMAIN}\n      secretName: bihero\n  rules:\n    - host: ${ID_DOMAIN}\n      http:\n        paths:\n          - path: \u002Fapi\u002Fhello(\u002F|$)(.*)\n            backend:\n              serviceName: bihero-hello\n              servicePort: 8081\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EКратко о том, что мы видим в шаблоне:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cul\u003E\r\n\u003Cli\u003E\u003Cstrong\u003EDeployment\u003C\u002Fstrong\u003E: тут описываем, из какого образа деплоимся и из какого количества инстансов создаём репликасет для нашего сервиса. Также важно обратить внимание на \u003Cem\u003Emetadata.labels\u003C\u002Fem\u003E — по ним будем привязывать \u003Cstrong\u003EService\u003C\u002Fstrong\u003E к \u003Cstrong\u003EDeployment\u003C\u002Fstrong\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E\u003Cstrong\u003EService\u003C\u002Fstrong\u003E: привязываем сервис к деплойменту\u002Fрепликасету. По сути сервис в k8s — это то, к чему уже можно слать http-запроcы \u003Cstrong\u003Eвнутри\u003C\u002Fstrong\u003E кластера (и да — обращаем внимание на \u003Cstrong\u003Eselector\u003C\u002Fstrong\u003E)\u003C\u002Fli\u003E\r\n\u003Cli\u003E\u003Cstrong\u003EIngress\u003C\u002Fstrong\u003E: ингресс нужен для того, чтобы сервис выставить наружу, во внешний мир. Все запросы начинающиеся с \u003Cstrong\u003E\u002Fapi\u002Fhello\u003C\u002Fstrong\u003E будем заворачивать на наш hello-сервис (\u003Ca href=\"https:\u002F\u002Fdomain.com\u002Fapi\u002Fhello\"\u003Ehttps:\u002F\u002Fdomain.com\u002Fapi\u002Fhello\u003C\u002Fa\u003E -\u003E \u003Ca href=\"http:\u002F\u002Fbihero-hello.service.internal.domain.local:8081\u002F\"\u003Ehttp:\u002F\u002Fbihero-hello.service.internal.domain.local:8081\u002F\u003C\u002Fa\u003E)\u003C\u002Fli\u003E\r\n\u003C\u002Ful\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EТакже в шаблоне фигурируют два переменных окружения:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cul\u003E\r\n\u003Cli\u003E${HELLO_SERVICE_IMAGE_VERSION} — тег docker-образа с сервисом, из которого будем собирать наш первый deployment\u003C\u002Fli\u003E\r\n\u003Cli\u003E${ID_DOMAIN} — домен, на котором развернём наши сервисы\u003C\u002Fli\u003E\r\n\u003C\u002Ful\u003E\u003Cbr\u002F\u003E\r\n\u003Cblockquote\u003E\u003Cstrong\u003EВажное про https\u003C\u002Fstrong\u003E\u003Cbr\u002F\u003E\r\nВ тестовом кластере уже имеется secret с именем \u003Cstrong\u003Ebihero\u003C\u002Fstrong\u003E, созданный на основе wildcard-сертификата от LetsEncrypt. Если кратко, то команды выглядит так\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"bash\"\u003Ekubectl create secret tls bihero --key keys\u002Fprivkey.pem --cert keys\u002Ffullchain.pem\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nгде privkey.pem и fullchain.pem — файлы, генерируемые letsencrypt'ом\u003Cbr\u002F\u003E\r\nПодробнее про создание secret'а для tls в k8s можно почитать пройдя по \u003Ca href=\"https:\u002F\u002Fkubernetes.io\u002Fdocs\u002Fconcepts\u002Fservices-networking\u002Fingress\u002F#tls\"\u003Eссылке\u003C\u002Fa\u003E \u003C\u002Fblockquote\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EНастала пора пробовать деплоиться в k8s :) Поехали!\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"bash\"\u003Eexport HELLO_SERVICE_IMAGE_VERSION=latest\nexport ID_DOMAIN=demo1.bihero.io\ncat k8s.yaml | envsubst | kubectl apply -f -\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EВ stdout должны увидеть вот это:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"bash\"\u003Edeployment.extensions\u002Fbihero-hello created\nservice\u002Fbihero-hello created\ningress.extensions\u002Fbihero-hello created\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EНу что ж, проверим, что там нам kubernetes наворотил:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"bash\"\u003Ekubectl get po # да, вместо pod можно писать po, k8s вас поймёт\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fup\u002Fuu\u002Fmh\u002Fupuumhgqijpejz-jgu9n8zc_ds4.png\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fwebt\u002Fup\u002Fuu\u002Fmh\u002Fupuumhgqijpejz-jgu9n8zc_ds4.png\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fup\u002Fuu\u002Fmh\u002Fupuumhgqijpejz-jgu9n8zc_ds4.png\"\u002F\u003E\u003C\u002Fa\u003E\u003Cbr\u002F\u003E\r\nКак и полагается — 3 пода\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EПосмотрим подробности одного пода\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"bash\"\u003Ekubectl describe po bihero-hello-5b4759d55b-bf4qc\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fdv\u002F31\u002F8n\u002Fdv318n2kmrvhua0bbv63togmivs.png\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fwebt\u002Fdv\u002F31\u002F8n\u002Fdv318n2kmrvhua0bbv63togmivs.png\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fdv\u002F31\u002F8n\u002Fdv318n2kmrvhua0bbv63togmivs.png\"\u002F\u003E\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EКак там сервис поживает?\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"bash\"\u003Ekubectl describe service bihero-hello\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fto\u002F1r\u002Ffy\u002Fto1rfysgzpxwi3zp6jlaffswra4.png\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fwebt\u002Fto\u002F1r\u002Ffy\u002Fto1rfysgzpxwi3zp6jlaffswra4.png\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fto\u002F1r\u002Ffy\u002Fto1rfysgzpxwi3zp6jlaffswra4.png\"\u002F\u003E\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EА ингресс?\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"bash\"\u003Ekubectl describe ing bihero-hello\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fo2\u002Fnp\u002Fm4\u002Fo2npm4hdhucyueujgknmuqitfny.png\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fwebt\u002Fo2\u002Fnp\u002Fm4\u002Fo2npm4hdhucyueujgknmuqitfny.png\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fo2\u002Fnp\u002Fm4\u002Fo2npm4hdhucyueujgknmuqitfny.png\"\u002F\u003E\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EЗдорово! Сервис бегает в k8s и так просится, чтобы его проверили парочкой запросов, согласно спеке.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"bash\"\u003Ecurl https:\u002F\u002Fdemo1.bihero.io\u002Fapi\u002Fhello\nHello\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"bash\"\u003Ecurl https:\u002F\u002Fdemo1.bihero.io\u002Fapi\u002Fhello\u002Fdoc\nopenapi: 3.0.1\ninfo:\n  title: Hello ;)\n  description: Hello microservice\n  version: 1.0.0\nservers:\n  - url: https:\u002F\u002Fdemo1.bihero.io\u002Fapi\u002Fhello\ntags:\n  - name: hello\n    description: Everything about saying 'Hello'\npaths:\n  \u002F:\n    x-vertx-event-bus:\n      address: service.hello\n      timeout: 1000c\n    get:\n      tags:\n        - hello\n      summary: Get 'Hello' word\n      operationId: getHelloWord\n      responses:\n        200:\n          description: OK\n  \u002Fdoc:\n    x-vertx-event-bus:\n      address: service.hello\n      timeout: 1000c\n    get:\n      tags:\n        - hello_doc\n      summary: Get 'Hello' microservice documentation\n      operationId: getDoc\n      responses:\n        200:\n          description: OK\ncomponents: {}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Ch2\u003EА — Автоматизация\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EФух… Дошли до самого вкусного и волнительного. Было сделано немало работы и каждый шаг сопровождался ручным запуском каких-то тулов, на каждом этапе своих. Пора задуматься о том, чтобы все шаги запускались автоматически и триггерили своим завершением следующий шаг паплайна, а на финише был ровный и бесшовный апгрейд нашего сервиса в k8s кластере. Сказано, сделано!\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EПеред тем как начать пилить автоматизацию, давайте разложим всё по полочкам и нарисуем схему того, как будет бежать пайплайн на CI-сервере.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Ch3\u003EЧто было сделано руками?\u003C\u002Fh3\u003E\u003Cbr\u002F\u003E\r\n\u003Col\u003E\r\n\u003Cli\u003EНаписали код, написали тесты к коду, прошли всё чеки (кодревью и прочее), закоммитили в git-репозиторий\u003C\u002Fli\u003E\r\n\u003Cli\u003EЗапуск сборки (mvn), прогон тестов (surefire, allure) — на выходе получаем fat-jar с сервисом\u003C\u002Fli\u003E\r\n\u003Cli\u003EСборка docker-образа (docker build)\u003C\u002Fli\u003E\r\n\u003Cli\u003EPush docker-образа на докерхаб (или корпоративный приватный docker registry) (docker push)\u003C\u002Fli\u003E\r\n\u003Cli\u003EДеплой сервиса в k8s (kubectl apply)\u003C\u002Fli\u003E\r\n\u003C\u002Fol\u003E\u003Cbr\u002F\u003E\r\n\u003Ch3\u003EЧто будет делать CI-сервер ?\u003C\u002Fh3\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EДа всё то же самое, что и мы ручками делали (кроме написания кода и тестов), только по пути будет уведомлять нас о своих действиях и отчёты деплоить в нужные места. Алгоритм выглядит примерно так:\u003Cbr\u002F\u003E\r\n\u003Ca href=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Ffy\u002Fkf\u002Fkn\u002Ffykfkndjy0qzvl79t1_s9_ka6wg.png\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fwebt\u002Ffy\u002Fkf\u002Fkn\u002Ffykfkndjy0qzvl79t1_s9_ka6wg.png\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Ffy\u002Fkf\u002Fkn\u002Ffykfkndjy0qzvl79t1_s9_ka6wg.png\"\u002F\u003E\u003C\u002Fa\u003E\u003Cbr\u002F\u003E\r\nОпишем пайплайн по шагам:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Col\u003E\r\n\u003Cli\u003EПайплайн будет триггерить джобу сборки по коммиту в определенную ветку проекта, пусть это будет ветка \u003Cstrong\u003Emaster\u003C\u002Fstrong\u003E (напрямую в master мы, конечно же, не коммитим, туда коммиты попадают при merge'ах после merge request'ов и тщательного ревью)\u003C\u002Fli\u003E\r\n\u003Cli\u003EУведомление команды разработчиков о том, что началась сборка сервиса из вышеуказанной dev-ветки (telegram-bot)\u003C\u002Fli\u003E\r\n\u003Cli\u003EПрогон тестов\u003C\u002Fli\u003E\r\n\u003Cli\u003EПроверяем, как поршли тесты\u003C\u002Fli\u003E\r\n\u003Cli\u003EТесты прошли успешно — деплоим результат прогона тестов в maven repository (конкретно в нашем кейсе используется \u003Ca href=\"https:\u002F\u002Fhelp.sonatype.com\u002Frepomanager3\u002Fhigh-availability\u002Fconfiguring-blob-stores\"\u003Enexus blob store\u003C\u002Fa\u003E)\u003C\u002Fli\u003E\r\n\u003Cli\u003EСобираем fat-jar (mvn package, но с маленьким хаком, чтобы не компилить по новой код — мы это уже сделали на этапе прогона тестов)\u003C\u002Fli\u003E\r\n\u003Cli\u003EСобираем docker image из собранного джарника и необходимых конфигов. Тут стоить отметить, что данный шаг делает не только сборку образа, но и пушит его в репозиторий, на который ссылается наш образ как ресурс пайплайна (о ресурсах скоро узнаете). Пуш образа в registry триггерит деплой новой версии сервиса в k8s кластер\u003C\u002Fli\u003E\r\n\u003Cli\u003EДеплой новой версии сервиса в k8s кластер\u003C\u002Fli\u003E\r\n\u003Cli\u003EУведомление команды сервиса о том, что сборка прошла и новая версия сервиса ушла в требуемый k8s кластер. Уведомление содержит ссылку на джобу с логами сборки и ссылку на результат прогона тестов\u003C\u002Fli\u003E\r\n\u003Cli\u003EЕсли на 4-м шаге мы понимаем, что тесты не прошли, то деплоим результаты прогона тестов в maven repository\u003C\u002Fli\u003E\r\n\u003Cli\u003EИ уведомляем команду о том, что сборка новой версии сервиса упала со всеми необходимыми ссылками в уведомлении\u003C\u002Fli\u003E\r\n\u003C\u002Fol\u003E\u003Cbr\u002F\u003E\r\n\u003Ch5\u003EConcourse CI\u003C\u002Fh5\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EВышеописанный пайплайн мы будем писать под CI-сервер \u003Ca href=\"https:\u002F\u002Fconcourse-ci.org\u002F\"\u003EConcourse\u003C\u002Fa\u003E. Особенности Concourse CI:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cul\u003E\r\n\u003Cli\u003Eминималистичный UI (всё управление составом пайплайна через yaml-конфиги, которые могут лежать рядом с кодом, и через консольный тул под название \u003Cstrong\u003Efly\u003C\u002Fstrong\u003E): это и плюс и минус одновременно — очень удобно и гибко для разработчиков, которые всегда работают с консолью (mvn, docker, fly, kubectl), но неудобно для менеджерского состава, который хочет потыкать в кнопочки (но для них мы будем отчёты писать в tg-группу со ссылками на все необходимые для них ресурсы)\u003C\u002Fli\u003E\r\n\u003Cli\u003Eкаждый степ сборки проходит в docker container'е, что даёт гибкость в настройке окружения для каждого степа (не надо на каждой worker-ноде шаманить с настройками, если что-то environment-зависимое захотели поменять в одном из шагов пайплайна) — собрал образ один раз, степ пайплайна подтянет его в момент старта, и дело в шляпе.\u003C\u002Fli\u003E\r\n\u003C\u002Ful\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EИтак, встречайте, пайплайн сбрки:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cdiv class=\"spoiler\" role=\"button\" tabindex=\"0\"\u003E\n                        \u003Cb class=\"spoiler_title\"\u003Epipeline.yaml\u003C\u002Fb\u003E\n                        \u003Cdiv class=\"spoiler_text\"\u003E\u003Cpre\u003E\u003Ccode class=\"plaintext\"\u003Eresource_types:\n  - name: telegram\n    type: docker-image\n    source:\n      repository: vtutrinov\u002Fconcourse-telegram-resource\n      tag: latest\n  - name: kubernetes\n    type: docker-image\n    source:\n      repository: zlabjp\u002Fkubernetes-resource\n      tag: 1.16\n  - name: metadata\n    type: docker-image\n    source:\n      repository: olhtbr\u002Fmetadata-resource\n      tag: 2.0.1\nresources:\n  - name: metadata\n    type: metadata\n  - name: sources\n    type: git\n    source:\n      branch: master\n      uri: git@github.com:bihero-io\u002Fhello-microservice.git\n      private_key: ((deployer-private-key))\n  - name: docker-image\n    type: docker-image\n    source:\n      repository: bihero\u002Fhello\n      username: ((docker-registry-user))\n      password: ((docker-registry-password))\n  - name: telegram\n    type: telegram\n    source:\n      bot_token: ((telegram-ci-bot-token))\n      chat_id: ((telegram-group-to-report-build))\n      ci_url: ((ci_url))\n      command: \"\u002Fbuild_hello_ms\"\n  - name: kubernetes-demo\n    type: kubernetes\n    source:\n      server: https:\u002F\u002F178.63.194.241:6443\n      namespace: default\n      kubeconfig: ((kubeconfig-demo))\njobs:\n  - name: build-hello-microservice\n    serial: true\n    public: true\n    plan:\n      - in_parallel:\n          - get: sources\n            trigger: true\n          - get: telegram\n            trigger: true\n          - put: metadata\n      - put: telegram\n        params:\n          status: Build In Progress\n      - task: unit-tests\n        config:\n          platform: linux\n          image_resource:\n            type: docker-image\n            source:\n              repository: ((docker-registry-uri))\u002Fbih\u002Fmaven\n              tag: 3-jdk-11\n              username: ((docker-private-registry-user))\n              password: ((docker-private-registry-password))\n          inputs:\n            - name: sources\n          outputs:\n            - name: tested-workspace\n          run:\n            path: \u002Fbin\u002Fsh\n            args:\n              - -c\n              - |\n                output_dir=tested-workspace\n                cp -R .\u002Fsources\u002F* \"${output_dir}\u002F\"\n                mvn -f \"${output_dir}\u002Fpom.xml\" clean test\n          caches:\n            - path: ~\u002F.m2\u002F\n        on_failure:\n          do:\n            - task: tests-report\n              config:\n                platform: linux\n                image_resource:\n                  type: docker-image\n                  source:\n                    repository: ((docker-registry-uri))\u002Fbih\u002Fmaven\n                    tag: 3-jdk-11\n                    username: ((docker-private-registry-user))\n                    password: ((docker-private-registry-password))\n                inputs:\n                  - name: tested-workspace\n                outputs:\n                  - name: message\n                run:\n                  path: \u002Fbin\u002Fsh\n                  args:\n                    - -c\n                    - |\n                      output_dir=tested-workspace\n                      mvn -Dmaven.wagon.http.ssl.insecure=true -Dmaven.wagon.http.ssl.allowall=true -f \"${output_dir}\u002Fpom.xml\" site-deploy\n                      version=$(cat $output_dir\u002Ftarget\u002Fclasses\u002Fversion.txt)\n                      cat \u003Emessage\u002Fmsg &lt;&lt;EOL\n                      &lt;a href=\"https:\u002F\u002Fnexus.dev.techedge.pro:8443\u002Frepository\u002Freports\u002Fhello-microservice\u002F${version}\u002Fallure\u002F\"\u003EAllure report&lt;\u002Fa\u003E\n                      EOL\n                caches:\n                  - path: ~\u002F.m2\u002F\n            - put: telegram\n              params:\n                status: Build Failed (unit-tests)\n                message_file: message\u002Fmsg\n      - task: tests-report\n        config:\n          platform: linux\n          image_resource:\n            type: docker-image\n            source:\n              repository: ((docker-registry-uri))\u002Fbih\u002Fmaven\n              tag: 3-jdk-11\n              username: ((docker-private-registry-user))\n              password: ((docker-private-registry-password))\n          inputs:\n            - name: tested-workspace\n          outputs:\n            - name: message\n            - name: tested-workspace\n          run:\n            path: \u002Fbin\u002Fsh\n            args:\n              - -c\n              - |\n                work_dir=tested-workspace\n                mvn -Dmaven.wagon.http.ssl.insecure=true -Dmaven.wagon.http.ssl.allowall=true -f \"${work_dir}\u002Fpom.xml\" site-deploy\n                version=$(cat $work_dir\u002Ftarget\u002Fclasses\u002Fversion.txt)\n                cat \u003Emessage\u002Fmsg &lt;&lt;EOL\n                &lt;a href=\"https:\u002F\u002Fnexus.dev.techedge.pro:8443\u002Frepository\u002Freports\u002Fhello-microservice\u002F${version}\u002Fallure\u002F\"\u003EAllure report&lt;\u002Fa\u003E\n                EOL\n          caches:\n            - path: ~\u002F.m2\u002F\n      - task: package\n        config:\n          platform: linux\n          image_resource:\n            type: docker-image\n            source:\n              repository: ((docker-registry-uri))\u002Fbih\u002Fmaven\n              tag: 3-jdk-11\n              username: ((docker-private-registry-user))\n              password: ((docker-private-registry-password))\n          inputs:\n            - name: tested-workspace\n            - name: metadata\n          outputs:\n            - name: app-packaged-workspace\n            - name: metadata\n          run:\n            path: \u002Fbin\u002Fsh\n            args:\n              - -c\n              - |\n                output_dir=app-packaged-workspace\n                cp -R .\u002Ftested-workspace\u002F* \"${output_dir}\u002F\"\n                mvn -f \"${output_dir}\u002Fpom.xml\" package -Dmaven.main.skip -DskipTests\n                env\n                tag=\"-\"$(cat metadata\u002Fbuild_name)\n                echo $tag \u003E\u003E ${output_dir}\u002Ftarget\u002Fclasses\u002Fversion.txt\n                cat ${output_dir}\u002Ftarget\u002Fclasses\u002Fversion.txt \u003E metadata\u002Fversion\n          caches:\n            - path: ~\u002F.m2\u002F\n        on_failure:\n          do:\n            - put: telegram\n              params:\n                status: Build Failed (package)\n      - put: docker-image\n        params:\n          build: app-packaged-workspace\n          tag_file: app-packaged-workspace\u002Ftarget\u002Fclasses\u002Fversion.txt\n          tag_as_latest: true\n        get_params:\n          skip_download: true\n      - task: make-k8s-app-template\n        config:\n          platform: linux\n          image_resource:\n            type: docker-image\n            source:\n              repository: bhgedigital\u002Fenvsubst\n          inputs:\n            - name: sources\n            - name: metadata\n          outputs:\n            - name: k8s\n          run:\n            path: \u002Fbin\u002Fsh\n            args:\n              - -c\n              - |\n                export DOMAIN=demo1.bihero.io\n                export HELLO_SERVICE_IMAGE_VERSION=$(cat metadata\u002Fversion)\n                cat sources\u002Fk8s.yaml | envsubst \u003E k8s\u002Fhello_app_template.yaml\n                cat k8s\u002Fhello_app_template.yaml\n      - put: kubernetes-demo\n        params:\n          kubectl: apply -f k8s\u002Fhello_app_template.yaml\n      - put: telegram\n        params:\n          status: Build Success\n          message_file: message\u002Fmsg\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\n                    \u003C\u002Fdiv\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EРассмотрим кратко содержимое пайплайна:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Col\u003E\r\n\u003Cli\u003EСекция \u003Ca href=\"https:\u002F\u002Fconcourse-ci.org\u002Fresource-types.html\"\u003Eresource_types\u003C\u002Fa\u003E нужна для объявления кастомных типов ресурсов, с которыми мы хотим работать, собирая наш проект. В нашем кейсе это три типа (имена типов можно задавать любые, сама суть типа закладывается в docker-образе, которым описывается тип): telegram для отправки уведомлений в tg-группу и для триггера джобы по сборке по определённой команде, kubernetes для деплоя новой версии сервиса в k8s-кластер и metadata для обеспечения данных по билду (номер билда, дата сборки и т.д.) в тасках пайплайна\u003C\u002Fli\u003E\r\n\u003Cli\u003EСекция resources нужна для объявления ресурсов, с которыми мы будем работать в процессе билда. Это то самое место в пайплайне, где описываются репозитории с исходниками, docker-registry для деплоя собираемых docker-образов и другие ресурсы, необходимые для выполнения степов сборки проекта. Каждый ресурс может быть использован на каждом степе пайплайна как input-ресурс в соответствующем блоке, описывающем таск пайплайна\u003C\u002Fli\u003E\r\n\u003Cli\u003EСекция jobs описывает набор джоб, которые нужно выполнить для сборки проекта. У нас это одна джоба с набором тасков и put-инструкций для деплоя результатов сборки и уведомлений в tg-группу. Иструкциями \u003Cstrong\u003E — get\u003C\u002Fstrong\u003E объявляем входные ресурсы для билда (например, git-репозиторий), \u003Cstrong\u003E — put\u003C\u002Fstrong\u003E — выходные ресурсы (docker image) или ресурсы, генерируемые на первых шагах сборки проекта и используемые на последующих (metadata). Каждый task в джобе — команды внутри docker-контейнера на основе docker-image'а, конфигурируемого параметром \u003Cstrong\u003Eimage_resource\u003C\u002Fstrong\u003E таски\u003C\u002Fli\u003E\r\n\u003Cli\u003EСтроки вида \u003Cstrong\u003E((parameter-name))\u003C\u002Fstrong\u003E — ссылки на параметры в отдельном файле, обычно в этом файле лежат секреты, явки пароли к ресурсам и прочие параметры, универсальные для всех имеющихся пайплайнов (например ссылка до docker-registry).\u003C\u002Fli\u003E\r\n\u003C\u002Fol\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EДеплой пайплайна с файлом параметров выглядит так:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"bash\"\u003Efly -t bih sp -p hello-microservice -c pipeline.yaml -l credentials.yaml\n# -t - target name\n# sp - alias to set-pipeline\n# -p - pipeline name\n# -c - pipeline config file\n# -l - file with parameters and credentials\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EФайл \u003Cstrong\u003Ecredentials.yaml\u003C\u002Fstrong\u003E может выглядеть так:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"plaintext\"\u003Edocker-registry-user: &lt;dockerhub-user\u003E\ndocker-registry-password: &lt;dockerhub-password\u003E\ndocker-registry-uri: &lt;private-docker-registry-url\u003E\ndocker-private-registry-user: &lt;private-docker-registry-user\u003E\ndocker-private-registry-password: &lt;private-docker-registry-passwordl\u003E\ntelegram-ci-bot-token: &lt;telegram-bot-token\u003E\ntelegram-group-to-report-build: &lt;telegram-group-id\u003E\nci_url: &lt;ci-server-url\u003E\ndeployer-private-key: |\n  -----BEGIN OPENSSH PRIVATE KEY-----\n  github-deploy-key\n  -----END OPENSSH PRIVATE KEY-----\nkubeconfig-demo: |\n  apiVersion: v1\n  clusters:\n  - cluster:\n      certificate-authority-data: &lt;kube-cert-data\u003E\n      server: &lt;kube-api-server-url\u003E\n    name: kubernetes\n  contexts:\n  - context:\n      cluster: kubernetes\n      user: kubernetes-admin\n    name: kubernetes-admin@kubernetes\n  current-context: kubernetes-admin@kubernetes\n  kind: Config\n  preferences: {}\n  users:\n  - name: kubernetes-admin\n    user:\n      client-certificate-data: &lt;kube-client-cert-data\u003E\n      client-key-data: &lt;kube-client-key-data\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EПишла пора запустить наш первый билд. Сделать мы это можем несколькими способами:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Col\u003E\r\n\u003Cli\u003EЗалогиниться на CI-сервере, выбрать необходимый нам пайплайн и джобу и нажать на кнопку с плюсиком:\u003C\u002Fli\u003E\r\n\u003Cli\u003EСделать всё то же самое (что и в пункте 1), но только используя конcольную утилиту \u003Cstrong\u003Efly\u003C\u002Fstrong\u003E, которую можно скачать с того же CI-сервера:\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"bash\"\u003Efly -t bih tj -j hello-microservice\u002Fbuild-hello-microservice -w\n# tj - alias for 'trigger-job'\n# -j - job (&lt;piprlinr-name\u003E\u002F&lt;job-name-in-pipeline\u003E)\n# -w - watch\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003EОтправить сообщение \u003Cstrong\u003E\u002Fbuild_hello_ms\u003C\u002Fstrong\u003E в телеграм-группу, на которую указывает \u003Cstrong\u003Etelegram-group-to-report-build\u003C\u002Fstrong\u003E в файле \u003Cstrong\u003Ecredentials.yaml\u003C\u002Fstrong\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003EОтправить коммит в master-ветку в гит (помним, что мы не про идеальную разработку сейчас говорим, а про процесс в целом: коммитить в master — это плохо, — но в обучающих целях можно ;) )\u003C\u002Fli\u003E\r\n\u003C\u002Fol\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EВ процессе билда (в случае успешного его окончания) мы получим два уведомления в телеграм-группу:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Col\u003E\r\n\u003Cli\u003EУведомление о начале работы с джобой:\u003Cbr\u002F\u003E\r\n\u003Ca href=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fnh\u002Fbu\u002Fxw\u002Fnhbuxw6mlng--ctknv2y2hh7p5q.png\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fwebt\u002Fnh\u002Fbu\u002Fxw\u002Fnhbuxw6mlng--ctknv2y2hh7p5q.png\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fnh\u002Fbu\u002Fxw\u002Fnhbuxw6mlng--ctknv2y2hh7p5q.png\"\u002F\u003E\u003C\u002Fa\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003EУведомление об успешном завершении сборки:\u003Cbr\u002F\u003E\r\n\u003Ca href=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fv9\u002Fpy\u002Fvo\u002Fv9pyvoi2szjw9g7h4v_57mf74ei.png\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fwebt\u002Fv9\u002Fpy\u002Fvo\u002Fv9pyvoi2szjw9g7h4v_57mf74ei.png\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fv9\u002Fpy\u002Fvo\u002Fv9pyvoi2szjw9g7h4v_57mf74ei.png\"\u002F\u003E\u003C\u002Fa\u003E\u003Cbr\u002F\u003E\r\nДавайте посмотрим, как сборка выглядит в UI CI-сервера:\u003Cbr\u002F\u003E\r\n\u003Cdiv class=\"oembed\"\u003E\u003Cdiv\u003E\u003Cdiv style=\"left: 0; width: 100%; height: 0; position: relative; padding-bottom: 56.2493%;\"\u003E\u003Cdiv class=\"tm-iframe_temp\" data-src=\"https:\u002F\u002Fwww.youtube.com\u002Fembed\u002FqHG8P5fkPWc?rel=0&amp;showinfo=1&amp;hl=en-US\" data-style=\"border: 0; top: 0; left: 0; width: 100%; height: 100%; position: absolute;\" id=\"\" width=\"\"\u003E\u003C\u002Fdiv\u003E\u003C\u002Fdiv\u003E\u003C\u002Fdiv\u003E\u003C\u002Fdiv\u003E\u003C\u002Fli\u003E\r\n\u003C\u002Fol\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EУра! Сборка прошла, докер-образ собран, задеплоен, приложение в k8s обновлено и отчёты отправлены. Пора проверять задеплоенное:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Col\u003E\r\n\u003Cli\u003EОбраз на docker-hub'е\u003Cbr\u002F\u003E\r\n\u003Ca href=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fpq\u002Fzx\u002Fxf\u002Fpqzxxfn_dhfqnj6cxgxlcrkb6w0.png\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fwebt\u002Fpq\u002Fzx\u002Fxf\u002Fpqzxxfn_dhfqnj6cxgxlcrkb6w0.png\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fpq\u002Fzx\u002Fxf\u002Fpqzxxfn_dhfqnj6cxgxlcrkb6w0.png\"\u002F\u003E\u003C\u002Fa\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003EСмотрим на список подов\u003Cbr\u002F\u003E\r\n\u003Ca href=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fd_\u002Fs5\u002Fev\u002Fd_s5evcbp9k24rddt1ffweipux8.png\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fwebt\u002Fd_\u002Fs5\u002Fev\u002Fd_s5evcbp9k24rddt1ffweipux8.png\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fd_\u002Fs5\u002Fev\u002Fd_s5evcbp9k24rddt1ffweipux8.png\"\u002F\u003E\u003C\u002Fa\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003EИ смотрим на версию образа, из которого развёрнут контейнер в одном из подов из 2-го пункта\u003Cbr\u002F\u003E\r\n\u003Ca href=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fyb\u002Fh-\u002Fhr\u002Fybh-hrr4ommmlrsqh4inb4_nii4.png\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw1560\u002Fwebt\u002Fyb\u002Fh-\u002Fhr\u002Fybh-hrr4ommmlrsqh4inb4_nii4.png\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fyb\u002Fh-\u002Fhr\u002Fybh-hrr4ommmlrsqh4inb4_nii4.png\"\u002F\u003E\u003C\u002Fa\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003EДелаем запрос и смотрим на ответ:\u003C\u002Fli\u003E\r\n\u003C\u002Fol\u003E\u003Cbr\u002F\u003E\r\n\u003Cdiv class=\"spoiler\" role=\"button\" tabindex=\"0\"\u003E\n                        \u003Cb class=\"spoiler_title\"\u003Ecurl https:\u002F\u002Fdemo1.bihero.io\u002Fapi\u002Fhello -v\u003C\u002Fb\u003E\n                        \u003Cdiv class=\"spoiler_text\"\u003E\u003Cpre\u003E\u003Ccode class=\"bash\"\u003Ecurl https:\u002F\u002Fdemo1.bihero.io\u002Fapi\u002Fhello -v                                                                                                                             5350  14:59:04  \n*   Trying 178.63.194.243...\n* TCP_NODELAY set\n* Connected to demo1.bihero.io (178.63.194.243) port 443 (#0)\n* ALPN, offering h2\n* ALPN, offering http\u002F1.1\n* Cipher selection: ALL:!EXPORT:!EXPORT40:!EXPORT56:!aNULL:!LOW:!RC4:@STRENGTH\n* successfully set certificate verify locations:\n*   CAfile: \u002Fetc\u002Fssl\u002Fcerts\u002Fca-certificates.crt\n  CApath: \u002Fetc\u002Fssl\u002Fcerts\n* TLSv1.2 (OUT), TLS header, Certificate Status (22):\n* TLSv1.2 (OUT), TLS handshake, Client hello (1):\n* TLSv1.2 (IN), TLS handshake, Server hello (2):\n* TLSv1.2 (IN), TLS handshake, Certificate (11):\n* TLSv1.2 (IN), TLS handshake, Server key exchange (12):\n* TLSv1.2 (IN), TLS handshake, Server finished (14):\n* TLSv1.2 (OUT), TLS handshake, Client key exchange (16):\n* TLSv1.2 (OUT), TLS change cipher, Client hello (1):\n* TLSv1.2 (OUT), TLS handshake, Finished (20):\n* TLSv1.2 (IN), TLS change cipher, Client hello (1):\n* TLSv1.2 (IN), TLS handshake, Finished (20):\n* SSL connection using TLSv1.2 \u002F ECDHE-RSA-AES256-GCM-SHA384\n* ALPN, server accepted to use h2\n* Server certificate:\n*  subject: CN=*.bihero.io\n*  start date: Nov  7 13:59:46 2019 GMT\n*  expire date: Feb  5 13:59:46 2020 GMT\n*  subjectAltName: host \"demo1.bihero.io\" matched cert's \"*.bihero.io\"\n*  issuer: C=US; O=Let's Encrypt; CN=Let's Encrypt Authority X3\n*  SSL certificate verify ok.\n* Using HTTP2, server supports multi-use\n* Connection state changed (HTTP\u002F2 confirmed)\n* Copying HTTP\u002F2 data in stream buffer to connection buffer after upgrade: len=0\n* Using Stream ID: 1 (easy handle 0x55778f779520)\n\u003E GET \u002Fapi\u002Fhello HTTP\u002F1.1\n\u003E Host: demo1.bihero.io\n\u003E User-Agent: curl\u002F7.52.1\n\u003E Accept: *\u002F*\n\u003E \n* Connection state changed (MAX_CONCURRENT_STREAMS updated)!\n&lt; HTTP\u002F2 200 \n&lt; server: nginx\u002F1.15.8\n&lt; date: Sun, 01 Dec 2019 11:59:06 GMT\n&lt; content-type: text\u002Fplain\n&lt; content-length: 5\n&lt; strict-transport-security: max-age=15724800; includeSubDomains\n&lt; \n* Curl_http_done: called premature == 0\n* Connection #0 to host demo1.bihero.io left intact\nHello\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\n                    \u003C\u002Fdiv\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EМного всего было сделано, но давайте на забывать, для чего мы тут собрались. Продукт же пилим, и ещё целых два микросервиса не написаны. Дальше мы не будем подробно разжёвывать содержимое каждого оставшего сервиса, только лишь исходники и пайплайн сборки в спойлерах (разве что только для интеграционного сервиса замутим интеграционных тестов с testcontainers). А в конце будут выводы и внушительный TODO-лист (куда же без бэклога). Поехали!\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Ch2\u003E'World' microservice\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\r\n\u003Cdiv class=\"spoiler\" role=\"button\" tabindex=\"0\"\u003E\n                        \u003Cb class=\"spoiler_title\"\u003EService specification\u003C\u002Fb\u003E\n                        \u003Cdiv class=\"spoiler_text\"\u003E\u003Cpre\u003E\u003Ccode class=\"plaintext\"\u003Eopenapi: 3.0.1\ninfo:\n  title: World ;)\n  description: \"'World' word microservice\"\n  version: 1.0.0\nservers:\n  - url: https:\u002F\u002Fdemo1.bihero.io\u002Fapi\u002Fworld\ntags:\n  - name: world\n    description: Everything about 'World' word\npaths:\n  \u002F:\n    x-vertx-event-bus:\n      address: service.world\n      timeout: 1000\n    get:\n      tags:\n        - world\n      summary: Get 'World' word\n      operationId: getWorldWord\n      responses:\n        200:\n          description: OK\n          content: {}\n  \u002Fdoc:\n    x-vertx-event-bus:\n      address: service.world\n      timeout: 1000c\n    get:\n      tags:\n        - world\n      summary: Get 'World' microservice documentation\n      operationId: getDoc\n      responses:\n        200:\n          description: OK\ncomponents: {}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\n                    \u003C\u002Fdiv\u003E\u003Cbr\u002F\u003E\r\n\u003Cdiv class=\"spoiler\" role=\"button\" tabindex=\"0\"\u003E\n                        \u003Cb class=\"spoiler_title\"\u003Epom.xml\u003C\u002Fb\u003E\n                        \u003Cdiv class=\"spoiler_text\"\u003E\u003Cpre\u003E\u003Ccode class=\"xml\"\u003E&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?\u003E\n&lt;project xmlns=\"http:\u002F\u002Fmaven.apache.org\u002FPOM\u002F4.0.0\"\n         xmlns:xsi=\"http:\u002F\u002Fwww.w3.org\u002F2001\u002FXMLSchema-instance\"\n         xsi:schemaLocation=\"http:\u002F\u002Fmaven.apache.org\u002FPOM\u002F4.0.0 http:\u002F\u002Fmaven.apache.org\u002Fxsd\u002Fmaven-4.0.0.xsd\"\u003E\n    &lt;modelVersion\u003E4.0.0&lt;\u002FmodelVersion\u003E\n\n    &lt;properties\u003E\n        &lt;main.verticle\u003Eio.bihero.world.WorldVerticle&lt;\u002Fmain.verticle\u003E\n        &lt;vertx.version\u003E3.8.1&lt;\u002Fvertx.version\u003E\n        &lt;logback.version\u003E1.2.3&lt;\u002Flogback.version\u003E\n        &lt;junit-jupiter.version\u003E5.3.1&lt;\u002Fjunit-jupiter.version\u003E\n        &lt;maven-surefire-plugin.version\u003E2.19.1&lt;\u002Fmaven-surefire-plugin.version\u003E\n        &lt;junit-platform-surefire-provider.version\u003E1.1.0&lt;\u002Fjunit-platform-surefire-provider.version\u003E\n        &lt;assertj-core.version\u003E3.8.0&lt;\u002Fassertj-core.version\u003E\n        &lt;allure.version\u003E2.8.1&lt;\u002Fallure.version\u003E\n        &lt;allure-maven.version\u003E2.10.0&lt;\u002Fallure-maven.version\u003E\n        &lt;aspectj.version\u003E1.9.2&lt;\u002Faspectj.version\u003E\n        &lt;mockito.version\u003E2.21.0&lt;\u002Fmockito.version\u003E\n        &lt;rest-assured.version\u003E3.0.0&lt;\u002Frest-assured.version\u003E\n    &lt;\u002Fproperties\u003E\n\n    &lt;groupId\u003Eio.bihero&lt;\u002FgroupId\u003E\n    &lt;artifactId\u003Eworld-microservice&lt;\u002FartifactId\u003E\n    &lt;version\u003E1.0.0-SNAPSHOT&lt;\u002Fversion\u003E\n    &lt;build\u003E\n        &lt;plugins\u003E\n            &lt;plugin\u003E\n                &lt;artifactId\u003Emaven-compiler-plugin&lt;\u002FartifactId\u003E\n                &lt;configuration\u003E\n```11&lt;\u002Fsource\u003E\n                    &lt;target\u003E11&lt;\u002Ftarget\u003E\n                &lt;\u002Fconfiguration\u003E\n                &lt;executions\u003E\n                    &lt;execution\u003E\n                        &lt;id\u003Edefault-compile&lt;\u002Fid\u003E\n                        &lt;configuration\u003E\n                            &lt;annotationProcessors\u003E\n                                &lt;annotationProcessor\u003Eio.vertx.codegen.CodeGenProcessor&lt;\u002FannotationProcessor\u003E\n                            &lt;\u002FannotationProcessors\u003E\n                            &lt;generatedSourcesDirectory\u003Esrc\u002Fmain\u002Fgenerated&lt;\u002FgeneratedSourcesDirectory\u003E\n                            &lt;compilerArgs\u003E\n                                &lt;arg\u003E-Acodegen.output=${project.basedir}\u002Fsrc\u002Fmain&lt;\u002Farg\u003E\n                            &lt;\u002FcompilerArgs\u003E\n                        &lt;\u002Fconfiguration\u003E\n                    &lt;\u002Fexecution\u003E\n                    &lt;execution\u003E\n                        &lt;id\u003Edefault-testCompile&lt;\u002Fid\u003E\n                        &lt;configuration\u003E\n                            &lt;annotationProcessors\u003E\n                                &lt;annotationProcessor\u003Eio.vertx.codegen.CodeGenProcessor&lt;\u002FannotationProcessor\u003E\n                            &lt;\u002FannotationProcessors\u003E\n                            &lt;generatedTestSourcesDirectory\u003Esrc\u002Ftest\u002Fgenerated&lt;\u002FgeneratedTestSourcesDirectory\u003E\n                            &lt;compilerArgs\u003E\n                                &lt;arg\u003E-Acodegen.output=${project.basedir}\u002Fsrc\u002Ftest&lt;\u002Farg\u003E\n                            &lt;\u002FcompilerArgs\u003E\n                        &lt;\u002Fconfiguration\u003E\n                    &lt;\u002Fexecution\u003E\n                &lt;\u002Fexecutions\u003E\n            &lt;\u002Fplugin\u003E\n            &lt;plugin\u003E\n                &lt;groupId\u003Eorg.apache.maven.plugins&lt;\u002FgroupId\u003E\n                &lt;artifactId\u003Emaven-surefire-plugin&lt;\u002FartifactId\u003E\n                &lt;version\u003E${maven-surefire-plugin.version}&lt;\u002Fversion\u003E\n                &lt;configuration\u003E\n                    &lt;properties\u003E\n                        &lt;property\u003E\n                            &lt;name\u003Elistener&lt;\u002Fname\u003E\n                            &lt;value\u003Eio.qameta.allure.junit5.AllureJunit5&lt;\u002Fvalue\u003E\n                        &lt;\u002Fproperty\u003E\n                    &lt;\u002Fproperties\u003E\n                    &lt;includes\u003E\n                        &lt;include\u003E**\u002F*Test*.java&lt;\u002Finclude\u003E\n                    &lt;\u002Fincludes\u003E\n                    &lt;argLine\u003E\n                        -javaagent:\"${settings.localRepository}\u002Forg\u002Faspectj\u002Faspectjweaver\u002F${aspectj.version}\u002Faspectjweaver-${aspectj.version}.jar\" -Djdk.net.URLClassPath.disableClassPathURLCheck=true\n                    &lt;\u002FargLine\u003E\n                    &lt;systemProperties\u003E\n                        &lt;property\u003E\n                            &lt;name\u003Eallure.results.directory&lt;\u002Fname\u003E\n                            &lt;value\u003E${project.basedir}\u002Ftarget\u002Fallure-results&lt;\u002Fvalue\u003E\n                        &lt;\u002Fproperty\u003E\n                        &lt;property\u003E\n                            &lt;name\u003Ejunit.jupiter.extensions.autodetection.enabled&lt;\u002Fname\u003E\n                            &lt;value\u003Etrue&lt;\u002Fvalue\u003E\n                        &lt;\u002Fproperty\u003E\n                    &lt;\u002FsystemProperties\u003E\n                    &lt;reportFormat\u003Eplain&lt;\u002FreportFormat\u003E\n                &lt;\u002Fconfiguration\u003E\n                &lt;dependencies\u003E\n                    &lt;dependency\u003E\n                        &lt;groupId\u003Eorg.aspectj&lt;\u002FgroupId\u003E\n                        &lt;artifactId\u003Easpectjweaver&lt;\u002FartifactId\u003E\n                        &lt;version\u003E${aspectj.version}&lt;\u002Fversion\u003E\n                    &lt;\u002Fdependency\u003E\n                    &lt;dependency\u003E\n                        &lt;groupId\u003Eorg.junit.platform&lt;\u002FgroupId\u003E\n                        &lt;artifactId\u003Ejunit-platform-surefire-provider&lt;\u002FartifactId\u003E\n                        &lt;version\u003E${junit-platform-surefire-provider.version}&lt;\u002Fversion\u003E\n                    &lt;\u002Fdependency\u003E\n                    &lt;dependency\u003E\n                        &lt;groupId\u003Eorg.junit.jupiter&lt;\u002FgroupId\u003E\n                        &lt;artifactId\u003Ejunit-jupiter-engine&lt;\u002FartifactId\u003E\n                        &lt;version\u003E${junit-jupiter.version}&lt;\u002Fversion\u003E\n                    &lt;\u002Fdependency\u003E\n                &lt;\u002Fdependencies\u003E\n            &lt;\u002Fplugin\u003E\n            &lt;plugin\u003E\n                &lt;groupId\u003Eio.qameta.allure&lt;\u002FgroupId\u003E\n                &lt;artifactId\u003Eallure-maven&lt;\u002FartifactId\u003E\n                &lt;version\u003E${allure-maven.version}&lt;\u002Fversion\u003E\n            &lt;\u002Fplugin\u003E\n            &lt;plugin\u003E\n                &lt;groupId\u003Eorg.apache.maven.plugins&lt;\u002FgroupId\u003E\n                &lt;artifactId\u003Emaven-site-plugin&lt;\u002FartifactId\u003E\n                &lt;version\u003E3.7.1&lt;\u002Fversion\u003E\n                &lt;dependencies\u003E\n                    &lt;dependency\u003E\n                        &lt;groupId\u003Eorg.apache.maven.wagon&lt;\u002FgroupId\u003E\n                        &lt;artifactId\u003Ewagon-webdav-jackrabbit&lt;\u002FartifactId\u003E\n                        &lt;version\u003E2.8&lt;\u002Fversion\u003E\n                    &lt;\u002Fdependency\u003E\n                &lt;\u002Fdependencies\u003E\n            &lt;\u002Fplugin\u003E\n\n            &lt;plugin\u003E\n                &lt;groupId\u003Eorg.apache.maven.plugins&lt;\u002FgroupId\u003E\n                &lt;artifactId\u003Emaven-project-info-reports-plugin&lt;\u002FartifactId\u003E\n                &lt;version\u003E3.0.0&lt;\u002Fversion\u003E\n            &lt;\u002Fplugin\u003E\n            &lt;plugin\u003E\n                &lt;groupId\u003Eorg.apache.maven.plugins&lt;\u002FgroupId\u003E\n                &lt;artifactId\u003Emaven-shade-plugin&lt;\u002FartifactId\u003E\n                &lt;version\u003E2.3&lt;\u002Fversion\u003E\n                &lt;executions\u003E\n                    &lt;execution\u003E\n                        &lt;phase\u003Epackage&lt;\u002Fphase\u003E\n                        &lt;goals\u003E\n                            &lt;goal\u003Eshade&lt;\u002Fgoal\u003E\n                        &lt;\u002Fgoals\u003E\n                        &lt;configuration\u003E\n                            &lt;transformers\u003E\n                                &lt;transformer implementation=\"org.apache.maven.plugins.shade.resource.ManifestResourceTransformer\"\u003E\n                                    &lt;manifestEntries\u003E\n                                        &lt;Main-Class\u003Eio.vertx.core.Launcher&lt;\u002FMain-Class\u003E\n                                        &lt;Main-Verticle\u003E${main.verticle}&lt;\u002FMain-Verticle\u003E\n                                    &lt;\u002FmanifestEntries\u003E\n                                &lt;\u002Ftransformer\u003E\n                                &lt;transformer implementation=\"org.apache.maven.plugins.shade.resource.AppendingTransformer\"\u003E\n                                    &lt;resource\u003EMETA-INF\u002Fservices\u002Fio.vertx.core.spi.VerticleFactory&lt;\u002Fresource\u003E\n                                &lt;\u002Ftransformer\u003E\n                            &lt;\u002Ftransformers\u003E\n                            &lt;artifactSet\u003E\n                            &lt;\u002FartifactSet\u003E\n                            &lt;outputFile\u003E${project.build.directory}\u002F${project.artifactId}-fat.jar&lt;\u002FoutputFile\u003E\n                        &lt;\u002Fconfiguration\u003E\n                    &lt;\u002Fexecution\u003E\n                &lt;\u002Fexecutions\u003E\n            &lt;\u002Fplugin\u003E\n        &lt;\u002Fplugins\u003E\n        &lt;resources\u003E\n            &lt;resource\u003E\n                &lt;directory\u003Esrc\u002Fmain\u002Fresources&lt;\u002Fdirectory\u003E\n                &lt;filtering\u003Etrue&lt;\u002Ffiltering\u003E\n                &lt;includes\u003E\n                    &lt;include\u003E**\u002Fversion.txt&lt;\u002Finclude\u003E\n                &lt;\u002Fincludes\u003E\n            &lt;\u002Fresource\u003E\n            &lt;resource\u003E\n                &lt;directory\u003Esrc\u002Fmain\u002Fresources&lt;\u002Fdirectory\u003E\n                &lt;filtering\u003Efalse&lt;\u002Ffiltering\u003E\n                &lt;excludes\u003E\n                    &lt;exclude\u003E**\u002Fversion.txt&lt;\u002Fexclude\u003E\n                &lt;\u002Fexcludes\u003E\n            &lt;\u002Fresource\u003E\n        &lt;\u002Fresources\u003E\n    &lt;\u002Fbuild\u003E\n    &lt;distributionManagement\u003E\n        &lt;site\u003E\n            &lt;id\u003Ereports&lt;\u002Fid\u003E\n            &lt;url\u003Edav:https:\u002F\u002Fnexus.dev.techedge.pro:8443\u002Frepository\u002Freports\u002F${project.artifactId}\u002F&lt;\u002Furl\u003E\n        &lt;\u002Fsite\u003E\n    &lt;\u002FdistributionManagement\u003E\n    &lt;reporting\u003E\n        &lt;excludeDefaults\u003Etrue&lt;\u002FexcludeDefaults\u003E\n        &lt;plugins\u003E\n            &lt;plugin\u003E\n                &lt;groupId\u003Eio.qameta.allure&lt;\u002FgroupId\u003E\n                &lt;artifactId\u003Eallure-maven&lt;\u002FartifactId\u003E\n                &lt;configuration\u003E\n                    &lt;resultsDirectory\u003E${project.build.directory}\u002Fallure-results&lt;\u002FresultsDirectory\u003E\n                    &lt;reportDirectory\u003E${project.reporting.outputDirectory}\u002F${project.version}\u002Fallure&lt;\u002FreportDirectory\u003E\n                &lt;\u002Fconfiguration\u003E\n            &lt;\u002Fplugin\u003E\n        &lt;\u002Fplugins\u003E\n    &lt;\u002Freporting\u003E\n\n    &lt;dependencies\u003E\n        &lt;dependency\u003E\n            &lt;groupId\u003Eio.vertx&lt;\u002FgroupId\u003E\n            &lt;artifactId\u003Evertx-web-api-service&lt;\u002FartifactId\u003E\n            &lt;version\u003E${vertx.version}&lt;\u002Fversion\u003E\n        &lt;\u002Fdependency\u003E\n        &lt;dependency\u003E\n            &lt;groupId\u003Eio.vertx&lt;\u002FgroupId\u003E\n            &lt;artifactId\u003Evertx-codegen&lt;\u002FartifactId\u003E\n            &lt;version\u003E${vertx.version}&lt;\u002Fversion\u003E\n            &lt;scope\u003Eprovided&lt;\u002Fscope\u003E\n        &lt;\u002Fdependency\u003E\n        &lt;dependency\u003E\n            &lt;groupId\u003Ech.qos.logback&lt;\u002FgroupId\u003E\n            &lt;artifactId\u003Elogback-classic&lt;\u002FartifactId\u003E\n            &lt;version\u003E${logback.version}&lt;\u002Fversion\u003E\n        &lt;\u002Fdependency\u003E\n\n        &lt;!-- test &amp;ndash;&amp;gt;--\u003E\n        &lt;dependency\u003E\n            &lt;groupId\u003Eio.vertx&lt;\u002FgroupId\u003E\n            &lt;artifactId\u003Evertx-unit&lt;\u002FartifactId\u003E\n            &lt;version\u003E${vertx.version}&lt;\u002Fversion\u003E\n            &lt;scope\u003Etest&lt;\u002Fscope\u003E\n        &lt;\u002Fdependency\u003E\n        &lt;dependency\u003E\n            &lt;groupId\u003Eio.vertx&lt;\u002FgroupId\u003E\n            &lt;artifactId\u003Evertx-junit5&lt;\u002FartifactId\u003E\n            &lt;version\u003E${vertx.version}&lt;\u002Fversion\u003E\n            &lt;scope\u003Etest&lt;\u002Fscope\u003E\n        &lt;\u002Fdependency\u003E\n        &lt;dependency\u003E\n            &lt;groupId\u003Eorg.junit.jupiter&lt;\u002FgroupId\u003E\n            &lt;artifactId\u003Ejunit-jupiter-api&lt;\u002FartifactId\u003E\n            &lt;version\u003E${junit-jupiter.version}&lt;\u002Fversion\u003E\n            &lt;scope\u003Etest&lt;\u002Fscope\u003E\n        &lt;\u002Fdependency\u003E\n        &lt;dependency\u003E\n            &lt;groupId\u003Eorg.junit.jupiter&lt;\u002FgroupId\u003E\n            &lt;artifactId\u003Ejunit-jupiter-engine&lt;\u002FartifactId\u003E\n            &lt;version\u003E${junit-jupiter.version}&lt;\u002Fversion\u003E\n            &lt;scope\u003Etest&lt;\u002Fscope\u003E\n        &lt;\u002Fdependency\u003E\n        &lt;dependency\u003E\n            &lt;groupId\u003Eorg.assertj&lt;\u002FgroupId\u003E\n            &lt;artifactId\u003Eassertj-core&lt;\u002FartifactId\u003E\n            &lt;version\u003E${assertj-core.version}&lt;\u002Fversion\u003E\n            &lt;scope\u003Etest&lt;\u002Fscope\u003E\n        &lt;\u002Fdependency\u003E\n        &lt;dependency\u003E\n            &lt;groupId\u003Eorg.mockito&lt;\u002FgroupId\u003E\n            &lt;artifactId\u003Emockito-core&lt;\u002FartifactId\u003E\n            &lt;version\u003E${mockito.version}&lt;\u002Fversion\u003E\n            &lt;scope\u003Etest&lt;\u002Fscope\u003E\n        &lt;\u002Fdependency\u003E\n        &lt;dependency\u003E\n            &lt;groupId\u003Eio.qameta.allure&lt;\u002FgroupId\u003E\n            &lt;artifactId\u003Eallure-junit5&lt;\u002FartifactId\u003E\n            &lt;version\u003E${allure.version}&lt;\u002Fversion\u003E\n            &lt;scope\u003Etest&lt;\u002Fscope\u003E\n        &lt;\u002Fdependency\u003E\n        &lt;dependency\u003E\n            &lt;groupId\u003Eio.vertx&lt;\u002FgroupId\u003E\n            &lt;artifactId\u003Evertx-web-client&lt;\u002FartifactId\u003E\n            &lt;version\u003E${vertx.version}&lt;\u002Fversion\u003E\n            &lt;scope\u003Etest&lt;\u002Fscope\u003E\n        &lt;\u002Fdependency\u003E\n    &lt;\u002Fdependencies\u003E\n\n&lt;\u002Fproject\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\n                    \u003C\u002Fdiv\u003E\u003Cbr\u002F\u003E\r\n\u003Cdiv class=\"spoiler\" role=\"button\" tabindex=\"0\"\u003E\n                        \u003Cb class=\"spoiler_title\"\u003EWorldService.java\u003C\u002Fb\u003E\n                        \u003Cdiv class=\"spoiler_text\"\u003E\u003Cpre\u003E\u003Ccode class=\"java\"\u003Epackage io.bihero.world;\n\nimport io.vertx.core.AsyncResult;\nimport io.vertx.core.Handler;\nimport io.vertx.core.Vertx;\nimport io.vertx.ext.web.api.OperationRequest;\nimport io.vertx.ext.web.api.OperationResponse;\nimport io.vertx.ext.web.api.generator.WebApiServiceGen;\n\n@WebApiServiceGen\npublic interface WorldService {\n\n    static WorldService create(Vertx vertx) {\n        return new DefaultWorldService(vertx);\n    }\n\n    void getWorldWord(OperationRequest context, Handler&lt;AsyncResult&lt;OperationResponse\u003E\u003E resultHandler);\n\n    void getDoc(OperationRequest context, Handler&lt;AsyncResult&lt;OperationResponse\u003E\u003E resultHandler);\n\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\n                    \u003C\u002Fdiv\u003E\u003Cbr\u002F\u003E\r\n\u003Cdiv class=\"spoiler\" role=\"button\" tabindex=\"0\"\u003E\n                        \u003Cb class=\"spoiler_title\"\u003EDefaultWorldService.java\u003C\u002Fb\u003E\n                        \u003Cdiv class=\"spoiler_text\"\u003E\u003Cpre\u003E\u003Ccode class=\"java\"\u003Epackage io.bihero.world;\n\nimport io.vertx.core.AsyncResult;\nimport io.vertx.core.Future;\nimport io.vertx.core.Handler;\nimport io.vertx.core.Vertx;\nimport io.vertx.core.buffer.Buffer;\nimport io.vertx.ext.web.api.OperationRequest;\nimport io.vertx.ext.web.api.OperationResponse;\n\npublic class DefaultWorldService implements WorldService {\n\n    private final Vertx vertx;\n\n    public DefaultWorldService(Vertx vertx) {\n        this.vertx = vertx;\n    }\n\n    public void getWorldWord(OperationRequest context, Handler&lt;AsyncResult&lt;OperationResponse\u003E\u003E resultHandler) {\n        resultHandler.handle(Future.succeededFuture(OperationResponse.completedWithPlainText(Buffer.buffer(\"World\"))));\n    }\n\n    @Override\n    public void getDoc(OperationRequest context, Handler&lt;AsyncResult&lt;OperationResponse\u003E\u003E resultHandler) {\n        vertx.fileSystem().readFile(\"doc.yaml\", buffResult -\u003E\n                resultHandler.handle(Future.succeededFuture(\n                        OperationResponse.completedWithPlainText(buffResult.result()))\n                ));\n    }\n\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\n                    \u003C\u002Fdiv\u003E\u003Cbr\u002F\u003E\r\n\u003Cdiv class=\"spoiler\" role=\"button\" tabindex=\"0\"\u003E\n                        \u003Cb class=\"spoiler_title\"\u003EWorldVerticle.java\u003C\u002Fb\u003E\n                        \u003Cdiv class=\"spoiler_text\"\u003E\u003Cpre\u003E\u003Ccode class=\"java\"\u003Epackage io.bihero.world;\n\nimport io.vertx.core.AbstractVerticle;\nimport io.vertx.core.Promise;\nimport io.vertx.core.eventbus.MessageConsumer;\nimport io.vertx.core.http.HttpServer;\nimport io.vertx.core.http.HttpServerOptions;\nimport io.vertx.core.json.JsonObject;\nimport io.vertx.ext.web.Router;\nimport io.vertx.ext.web.api.contract.openapi3.OpenAPI3RouterFactory;\nimport io.vertx.serviceproxy.ServiceBinder;\n\npublic class WorldVerticle extends AbstractVerticle {\n\n    HttpServer server;\n    MessageConsumer&lt;JsonObject\u003E consumer;\n\n    public void startWorldService() {\n        consumer = new ServiceBinder(vertx).setAddress(\"service.world\")\n                .register(WorldService.class, WorldService.create(getVertx()));\n    }\n\n    \u002F**\n     * This method constructs the router factory, mounts services and handlers and starts the http server\n     * with built router\n     * @return\n     *\u002F\n    private Promise&lt;Void\u003E startHttpServer() {\n        Promise&lt;Void\u003E promise = Promise.promise();\n        OpenAPI3RouterFactory.create(this.vertx, \"\u002Fdoc.yaml\", openAPI3RouterFactoryAsyncResult -\u003E {\n            if (openAPI3RouterFactoryAsyncResult.succeeded()) {\n                OpenAPI3RouterFactory routerFactory = openAPI3RouterFactoryAsyncResult.result();\n\n                \u002F\u002F Mount services on event bus based on extensions\n                routerFactory.mountServicesFromExtensions();\n\n                \u002F\u002F Generate the router\n                Router router = routerFactory.getRouter();\n\n                int port = config().getInteger(\"serverPort\", 8080);\n                String host = config().getString(\"serverHost\", \"localhost\");\n\n                server = vertx.createHttpServer(new HttpServerOptions().setPort(port).setHost(host));\n                server.requestHandler(router).listen(ar -\u003E {\n                    \u002F\u002F Error starting the HttpServer\n                    if (ar.succeeded()) promise.complete();\n                    else promise.fail(ar.cause());\n                });\n            } else {\n                \u002F\u002F Something went wrong during router factory initialization\n                promise.fail(openAPI3RouterFactoryAsyncResult.cause());\n            }\n        });\n        return promise;\n    }\n\n    @Override\n    public void start(Promise&lt;Void\u003E promise) {\n        startWorldService();\n        startHttpServer().future().setHandler(promise);\n    }\n\n    \u002F**\n     * This method closes the http server and unregister all services loaded to Event Bus\n     *\u002F\n    @Override\n    public void stop(){\n        this.server.close();\n        consumer.unregister();\n    }\n\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\n                    \u003C\u002Fdiv\u003E\u003Cbr\u002F\u003E\r\n\u003Cdiv class=\"spoiler\" role=\"button\" tabindex=\"0\"\u003E\n                        \u003Cb class=\"spoiler_title\"\u003EWorldServiceTest.java\u003C\u002Fb\u003E\n                        \u003Cdiv class=\"spoiler_text\"\u003E\u003Cpre\u003E\u003Ccode class=\"java\"\u003Epackage io.bihero.world;\n\nimport io.vertx.core.Vertx;\nimport io.vertx.core.json.JsonObject;\nimport io.vertx.ext.web.api.OperationRequest;\nimport io.vertx.junit5.VertxExtension;\nimport io.vertx.junit5.VertxTestContext;\nimport org.apache.commons.io.IOUtils;\nimport org.junit.jupiter.api.DisplayName;\nimport org.junit.jupiter.api.Test;\nimport org.junit.jupiter.api.extension.ExtendWith;\n\nimport java.io.IOException;\n\nimport static org.assertj.core.api.Assertions.assertThat;\n\n@ExtendWith(VertxExtension.class)\npublic class WorldServiceTest {\n\n    private WorldService worldService = WorldService.create(Vertx.vertx());\n\n    @Test\n    @DisplayName(\"Test 'getWorldWord' method returns 'World' word\")\n    public void testHelloMethod(VertxTestContext testContext) {\n        worldService.getWorldWord(new OperationRequest(new JsonObject()), testContext.succeeding(it -\u003E {\n            assertThat(it.getStatusCode()).isEqualTo(200);\n            assertThat(it.getPayload().toString()).isEqualTo(\"World\");\n            testContext.completeNow();\n        }));\n    }\n\n    @Test\n    @DisplayName(\"Test 'getDoc' method returns service documentation in OpenAPI format\")\n    public void testDocMethod(VertxTestContext testContext) {\n        worldService.getDoc(new OperationRequest(new JsonObject()), testContext.succeeding(it -\u003E {\n            try {\n                assertThat(it.getStatusCode()).isEqualTo(200);\n                assertThat(it.getPayload().toString()).isEqualTo(IOUtils.toString(this.getClass()\n                        .getResourceAsStream(\"..\u002F..\u002F..\u002Fdoc.yaml\"), \"UTF-8\"));\n                testContext.completeNow();\n            } catch (IOException e) {\n                testContext.failNow(e);\n            }\n        }));\n    }\n\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\n                    \u003C\u002Fdiv\u003E\u003Cbr\u002F\u003E\r\n\u003Cdiv class=\"spoiler\" role=\"button\" tabindex=\"0\"\u003E\n                        \u003Cb class=\"spoiler_title\"\u003EWorldVerticleTest.java\u003C\u002Fb\u003E\n                        \u003Cdiv class=\"spoiler_text\"\u003E\u003Cpre\u003E\u003Ccode class=\"java\"\u003Epackage io.bihero.world;\n\nimport io.vertx.core.Vertx;\nimport io.vertx.core.json.JsonObject;\nimport io.vertx.ext.web.client.WebClient;\nimport io.vertx.ext.web.codec.BodyCodec;\nimport io.vertx.junit5.Checkpoint;\nimport io.vertx.junit5.VertxExtension;\nimport io.vertx.junit5.VertxTestContext;\nimport org.apache.commons.io.IOUtils;\nimport org.junit.jupiter.api.DisplayName;\nimport org.junit.jupiter.api.Test;\nimport org.junit.jupiter.api.extension.ExtendWith;\n\nimport static org.assertj.core.api.Assertions.assertThat;\nimport static org.mockito.Mockito.doReturn;\nimport static org.mockito.Mockito.spy;\n\n@ExtendWith(VertxExtension.class)\npublic class WorldVerticleTest {\n\n    @Test\n    @DisplayName(\"Test that verticle is up and respond me by 'World' word and doc in OpenAPI format\")\n    public void testHelloVerticle(Vertx vertx, VertxTestContext testContext) {\n        WebClient webClient = WebClient.create(vertx);\n\n        Checkpoint deploymentCheckpoint = testContext.checkpoint();\n        Checkpoint requestCheckpoint = testContext.checkpoint(2);\n\n        WorldVerticle verticle = spy(new WorldVerticle());\n        JsonObject config = new JsonObject().put(\"serverPort\", 8082).put(\"serverHost\", \"0.0.0.0\");\n        doReturn(config).when(verticle).config();\n        vertx.deployVerticle(verticle, testContext.succeeding(id -\u003E {\n            deploymentCheckpoint.flag();\n            \u002F\u002F test GET \u002F\n            webClient.get(8082, \"localhost\", \"\u002F\")\n                    .as(BodyCodec.string())\n                    .send(testContext.succeeding(resp -\u003E {\n                        assertThat(resp.body()).isEqualTo(\"World\");\n                        assertThat(resp.statusCode()).isEqualTo(200);\n                        requestCheckpoint.flag();\n                    }));\n            \u002F\u002F test GET \u002Fdoc\n            webClient.get(8082, \"localhost\", \"\u002Fdoc\")\n                    .as(BodyCodec.string())\n                    .send(testContext.succeeding(resp -\u003E {\n                        try {\n                            assertThat(resp.body()).isEqualTo(IOUtils.toString(this.getClass()\n                                    .getResourceAsStream(\"..\u002F..\u002F..\u002Fdoc.yaml\"), \"UTF-8\"));\n                            assertThat(resp.statusCode()).isEqualTo(200);\n                            requestCheckpoint.flag();\n                        } catch (Exception e) {\n                            requestCheckpoint.flag();\n                            testContext.failNow(e);\n                        }\n                    }));\n        }));\n    }\n\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\n                    \u003C\u002Fdiv\u003E\u003Cbr\u002F\u003E\r\n\u003Cdiv class=\"spoiler\" role=\"button\" tabindex=\"0\"\u003E\n                        \u003Cb class=\"spoiler_title\"\u003EDockerfile\u003C\u002Fb\u003E\n                        \u003Cdiv class=\"spoiler_text\"\u003E\u003Cpre\u003E\u003Ccode class=\"plaintext\"\u003EFROM adoptopenjdk\u002Fopenjdk11:alpine-jre\nCOPY target\u002Fworld-microservice-fat.jar app.jar\nCOPY src\u002Fconf\u002Fconfig.json .\nCOPY src\u002Fconf\u002Flogback-console.xml .\nCOPY run.sh .\nRUN chmod +x run.sh\nCMD [\".\u002Frun.sh\"]\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\n                    \u003C\u002Fdiv\u003E\u003Cbr\u002F\u003E\r\n\u003Cdiv class=\"spoiler\" role=\"button\" tabindex=\"0\"\u003E\n                        \u003Cb class=\"spoiler_title\"\u003Erun.sh\u003C\u002Fb\u003E\n                        \u003Cdiv class=\"spoiler_text\"\u003E\u003Cpre\u003E\u003Ccode class=\"bash\"\u003E#!\u002Fbin\u002Fsh\njava ${JVM_OPTS} -Dlogback.configurationFile=.\u002Flogback-console.xml -jar app.jar -conf config.json\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\n                    \u003C\u002Fdiv\u003E\u003Cbr\u002F\u003E\r\n\u003Cdiv class=\"spoiler\" role=\"button\" tabindex=\"0\"\u003E\n                        \u003Cb class=\"spoiler_title\"\u003Epipeline.yaml\u003C\u002Fb\u003E\n                        \u003Cdiv class=\"spoiler_text\"\u003E\u003Cpre\u003E\u003Ccode class=\"plaintext\"\u003Eresource_types:\n  - name: telegram\n    type: docker-image\n    source:\n      repository: vtutrinov\u002Fconcourse-telegram-resource\n      tag: latest\n  - name: kubernetes\n    type: docker-image\n    source:\n      repository: zlabjp\u002Fkubernetes-resource\n      tag: 1.16\n  - name: metadata\n    type: docker-image\n    source:\n      repository: olhtbr\u002Fmetadata-resource\n      tag: 2.0.1\nresources:\n  - name: metadata\n    type: metadata\n  - name: sources\n    type: git\n    source:\n      branch: master\n      uri: git@github.com:bihero-io\u002Fworldmicroservice.git\n      private_key: ((deployer-private-key))\n  - name: docker-image\n    type: docker-image\n    source:\n      repository: bihero\u002Fworld\n      username: ((docker-registry-user))\n      password: ((docker-registry-password))\n  - name: telegram\n    type: telegram\n    source:\n      bot_token: ((telegram-ci-bot-token))\n      chat_id: ((telegram-group-to-report-build))\n      ci_url: ((ci_url))\n      command: \"\u002Fbuild_world_ms\"\n  - name: kubernetes-demo\n    type: kubernetes\n    source:\n      server: ((k8s-api-server))\n      namespace: default\n      kubeconfig: ((kubeconfig-demo))\njobs:\n  - name: build-world-microservice\n    serial: true\n    public: true\n    plan:\n      - in_parallel:\n          - get: sources\n            trigger: true\n          - get: telegram\n            trigger: true\n          - put: metadata\n      - put: telegram\n        params:\n          status: Build In Progress\n      - task: unit-tests\n        config:\n          platform: linux\n          image_resource:\n            type: docker-image\n            source:\n              repository: ((docker-registry-uri))\u002Fbih\u002Fmaven-dind\n              tag: 3-jdk-11\n              username: ((docker-private-registry-user))\n              password: ((docker-private-registry-password))\n          inputs:\n            - name: sources\n          outputs:\n            - name: tested-workspace\n          run:\n            path: \u002Fbin\u002Fsh\n            args:\n              - -c\n              - |\n                output_dir=tested-workspace\n                cp -R .\u002Fsources\u002F* \"${output_dir}\u002F\"\n                mvn -f \"${output_dir}\u002Fpom.xml\" clean test\n          caches:\n            - path: ~\u002F.m2\u002F\n        on_failure:\n          do:\n            - task: tests-report\n              config:\n                platform: linux\n                image_resource:\n                  type: docker-image\n                  source:\n                    repository: ((docker-registry-uri))\u002Fbih\u002Fmaven-dind\n                    tag: 3-jdk-11\n                    username: ((docker-private-registry-user))\n                    password: ((docker-private-registry-password))\n                inputs:\n                  - name: tested-workspace\n                outputs:\n                  - name: message\n                run:\n                  path: \u002Fbin\u002Fsh\n                  args:\n                    - -c\n                    - |\n                      output_dir=tested-workspace\n                      mvn -Dmaven.wagon.http.ssl.insecure=true -Dmaven.wagon.http.ssl.allowall=true -f \"${output_dir}\u002Fpom.xml\" site-deploy\n                      version=$(cat $output_dir\u002Ftarget\u002Fclasses\u002Fversion.txt)\n                      cat \u003Emessage\u002Fmsg &lt;&lt;EOL\n                      &lt;a href=\"https:\u002F\u002Fnexus.dev.techedge.pro:8443\u002Frepository\u002Freports\u002Fhello-microservice\u002F${version}\u002Fallure\u002F\"\u003EAllure report&lt;\u002Fa\u003E\n                      EOL\n                caches:\n                  - path: ~\u002F.m2\u002F\n            - put: telegram\n              params:\n                status: Build Failed (unit-tests)\n                message_file: message\u002Fmsg\n      - task: tests-report\n        config:\n          platform: linux\n          image_resource:\n            type: docker-image\n            source:\n              repository: ((docker-registry-uri))\u002Fbih\u002Fmaven-dind\n              tag: 3-jdk-11\n              username: ((docker-private-registry-user))\n              password: ((docker-private-registry-password))\n          inputs:\n            - name: tested-workspace\n          outputs:\n            - name: message\n            - name: tested-workspace\n          run:\n            path: \u002Fbin\u002Fsh\n            args:\n              - -c\n              - |\n                work_dir=tested-workspace\n                mvn -Dmaven.wagon.http.ssl.insecure=true -Dmaven.wagon.http.ssl.allowall=true -f \"${work_dir}\u002Fpom.xml\" site-deploy\n                version=$(cat $work_dir\u002Ftarget\u002Fclasses\u002Fversion.txt)\n                cat \u003Emessage\u002Fmsg &lt;&lt;EOL\n                &lt;a href=\"https:\u002F\u002Fnexus.dev.techedge.pro:8443\u002Frepository\u002Freports\u002Fworld-microservice\u002F${version}\u002Fallure\u002F\"\u003EAllure report&lt;\u002Fa\u003E\n                EOL\n          caches:\n            - path: ~\u002F.m2\u002F\n      - task: package\n        config:\n          platform: linux\n          image_resource:\n            type: docker-image\n            source:\n              repository: ((docker-registry-uri))\u002Fbih\u002Fmaven-dind\n              tag: 3-jdk-11\n              username: ((docker-private-registry-user))\n              password: ((docker-private-registry-password))\n          inputs:\n            - name: tested-workspace\n            - name: metadata\n          outputs:\n            - name: app-packaged-workspace\n            - name: metadata\n          run:\n            path: \u002Fbin\u002Fsh\n            args:\n              - -c\n              - |\n                output_dir=app-packaged-workspace\n                cp -R .\u002Ftested-workspace\u002F* \"${output_dir}\u002F\"\n                mvn -f \"${output_dir}\u002Fpom.xml\" package -Dmaven.main.skip -DskipTests\n                tag=\"-\"$(cat metadata\u002Fbuild_name)\n                echo $tag \u003E\u003E ${output_dir}\u002Ftarget\u002Fclasses\u002Fversion.txt\n                cat ${output_dir}\u002Ftarget\u002Fclasses\u002Fversion.txt \u003E metadata\u002Fversion\n          caches:\n            - path: ~\u002F.m2\u002F\n        on_failure:\n          do:\n            - put: telegram\n              params:\n                status: Build Failed (package)\n      - put: docker-image\n        params:\n          build: app-packaged-workspace\n          tag_file: app-packaged-workspace\u002Ftarget\u002Fclasses\u002Fversion.txt\n          tag_as_latest: true\n        get_params:\n          skip_download: true\n      - task: make-k8s-app-template\n        config:\n          platform: linux\n          image_resource:\n            type: docker-image\n            source:\n              repository: bhgedigital\u002Fenvsubst\n          inputs:\n            - name: sources\n            - name: metadata\n          outputs:\n            - name: k8s\n          run:\n            path: \u002Fbin\u002Fsh\n            args:\n              - -c\n              - |\n                export DOMAIN=demo1.bihero.io\n                export WORLD_SERVICE_IMAGE_VERSION=$(cat metadata\u002Fversion)\n                cat sources\u002Fk8s.yaml | envsubst \u003E k8s\u002Fworld_app_template.yaml\n                cat k8s\u002Fworld_app_template.yaml\n      - put: kubernetes-demo\n        params:\n          kubectl: apply -f k8s\u002Fworld_app_template.yaml\n      - put: telegram\n        params:\n          status: Build Success\n          message_file: message\u002Fmsg\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\n                    \u003C\u002Fdiv\u003E\u003Cbr\u002F\u003E\r\n\u003Cdiv class=\"spoiler\" role=\"button\" tabindex=\"0\"\u003E\n                        \u003Cb class=\"spoiler_title\"\u003Ek8s app template\u003C\u002Fb\u003E\n                        \u003Cdiv class=\"spoiler_text\"\u003E\u003Cpre\u003E\u003Ccode class=\"plaintext\"\u003EapiVersion: extensions\u002Fv1beta1\nkind: Deployment\nmetadata:\n  labels:\n    io.bihero.hello.service: bihero-world\n  name: bihero-world\nspec:\n  replicas: 3\n  strategy:\n    type: RollingUpdate\n    rollingUpdate:\n      maxSurge: 1\n      maxUnavailable: 1\n  template:\n    metadata:\n      labels:\n        io.bihero.hello.service: bihero-world\n    spec:\n      containers:\n        - image: bihero\u002Fworld:${WORLD_SERVICE_IMAGE_VERSION}\n          name: bihero-world\n          ports:\n            - containerPort: 8082\n          imagePullPolicy: Always\n          resources: {}\n      restartPolicy: Always\n---\napiVersion: v1\nkind: Service\nmetadata:\n  labels:\n    io.bihero.hello.service: bihero-world\n  name: bihero-world\nspec:\n  ports:\n    - name: \"8082\"\n      port: 8082\n      targetPort: 8082\n  selector:\n    io.bihero.hello.service: bihero-world\nstatus:\n  loadBalancer: {}\n---\napiVersion: extensions\u002Fv1beta1\nkind: Ingress\nmetadata:\n  name: bihero-world\n  annotations:\n    kubernetes.io\u002Fingress.class: nginx\n    nginx.ingress.kubernetes.io\u002Fssl-redirect: \"true\"\n    nginx.ingress.kubernetes.io\u002Fsecure-backends: \"false\"\n    nginx.ingress.kubernetes.io\u002Fssl-passthrough: \"false\"\n    nginx.ingress.kubernetes.io\u002Frewrite-target: \u002F$2\n    kubernetes.io\u002Ftls-acme: \"true\"\n  namespace: default\nspec:\n  tls:\n    - hosts:\n        - ${DOMAIN}\n      secretName: bihero\n  rules:\n    - host: ${DOMAIN}\n      http:\n        paths:\n          - path: \u002Fapi\u002Fworld(\u002F|$)(.*)\n            backend:\n              serviceName: bihero-world\n              servicePort: 8082\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\n                    \u003C\u002Fdiv\u003E\u003Cbr\u002F\u003E\r\n\u003Ch2\u003E'HelloWorld' microservice\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EЭтот орешек оказался крепче, чем казалось изначально. Ну, да ладно, мы и его раскололи. Основные сложности возникли при запуске интеграционных тестов с testcontainers, но обо всё по порядку.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cdiv class=\"spoiler\" role=\"button\" tabindex=\"0\"\u003E\n                        \u003Cb class=\"spoiler_title\"\u003EService specification\u003C\u002Fb\u003E\n                        \u003Cdiv class=\"spoiler_text\"\u003E\u003Cpre\u003E\u003Ccode class=\"plaintext\"\u003Eopenapi: 3.0.1\ninfo:\n  title: Hello World ;)\n  description: \"Hello World microservice. Aggregate 'Hello World' by hellomicroservice and worldmicroservice\"\n  version: 1.0.0\nservers:\n  - url: https:\u002F\u002Fdemo1.bihero.io\u002Fapi\u002Fhelloworld\ntags:\n  - name: helloworld\n    description: Everything about 'Hello World'\npaths:\n  \u002F:\n    x-vertx-event-bus:\n      address: service.helloworld\n      timeout: 1000\n    get:\n      tags:\n        - helloworld\n      summary: Aggregate 'Hello World'\n      operationId: getHelloWorld\n      responses:\n        200:\n          description: OK\n          content: {}\n  \u002Fdoc:\n    x-vertx-event-bus:\n      address: service.helloworld\n      timeout: 1000c\n    get:\n      tags:\n        - world\n      summary: Get 'Hello World' microservice documentation\n      operationId: getDoc\n      responses:\n        200:\n          description: OK\ncomponents: {}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\n                    \u003C\u002Fdiv\u003E\u003Cbr\u002F\u003E\r\n\u003Cdiv class=\"spoiler\" role=\"button\" tabindex=\"0\"\u003E\n                        \u003Cb class=\"spoiler_title\"\u003Epom.xml\u003C\u002Fb\u003E\n                        \u003Cdiv class=\"spoiler_text\"\u003E\u003Cpre\u003E\u003Ccode class=\"xml\"\u003E&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?\u003E\n&lt;project xmlns=\"http:\u002F\u002Fmaven.apache.org\u002FPOM\u002F4.0.0\"\n         xmlns:xsi=\"http:\u002F\u002Fwww.w3.org\u002F2001\u002FXMLSchema-instance\"\n         xsi:schemaLocation=\"http:\u002F\u002Fmaven.apache.org\u002FPOM\u002F4.0.0 http:\u002F\u002Fmaven.apache.org\u002Fxsd\u002Fmaven-4.0.0.xsd\"\u003E\n    &lt;modelVersion\u003E4.0.0&lt;\u002FmodelVersion\u003E\n\n    &lt;properties\u003E\n        &lt;main.verticle\u003Eio.bihero.helloworld.HelloWorldVerticle&lt;\u002Fmain.verticle\u003E\n        &lt;vertx.version\u003E3.8.1&lt;\u002Fvertx.version\u003E\n        &lt;logback.version\u003E1.2.3&lt;\u002Flogback.version\u003E\n        &lt;junit-jupiter.version\u003E5.3.1&lt;\u002Fjunit-jupiter.version\u003E\n        &lt;maven-surefire-plugin.version\u003E2.19.1&lt;\u002Fmaven-surefire-plugin.version\u003E\n        &lt;junit-platform-surefire-provider.version\u003E1.1.0&lt;\u002Fjunit-platform-surefire-provider.version\u003E\n        &lt;assertj-core.version\u003E3.8.0&lt;\u002Fassertj-core.version\u003E\n        &lt;allure.version\u003E2.8.1&lt;\u002Fallure.version\u003E\n        &lt;allure-maven.version\u003E2.10.0&lt;\u002Fallure-maven.version\u003E\n        &lt;aspectj.version\u003E1.9.2&lt;\u002Faspectj.version\u003E\n        &lt;mockito.version\u003E2.21.0&lt;\u002Fmockito.version\u003E\n        &lt;rest-assured.version\u003E3.0.0&lt;\u002Frest-assured.version\u003E\n        &lt;testcontainers.version\u003E1.12.3&lt;\u002Ftestcontainers.version\u003E\n    &lt;\u002Fproperties\u003E\n\n    &lt;groupId\u003Eio.bihero&lt;\u002FgroupId\u003E\n    &lt;artifactId\u003Ehello-world-microservice&lt;\u002FartifactId\u003E\n    &lt;version\u003E1.0.0-SNAPSHOT&lt;\u002Fversion\u003E\n    &lt;build\u003E\n        &lt;plugins\u003E\n            &lt;plugin\u003E\n                &lt;artifactId\u003Emaven-compiler-plugin&lt;\u002FartifactId\u003E\n                &lt;configuration\u003E\n```11&lt;\u002Fsource\u003E\n                    &lt;target\u003E11&lt;\u002Ftarget\u003E\n                &lt;\u002Fconfiguration\u003E\n                &lt;executions\u003E\n                    &lt;execution\u003E\n                        &lt;id\u003Edefault-compile&lt;\u002Fid\u003E\n                        &lt;configuration\u003E\n                            &lt;annotationProcessors\u003E\n                                &lt;annotationProcessor\u003Eio.vertx.codegen.CodeGenProcessor&lt;\u002FannotationProcessor\u003E\n                            &lt;\u002FannotationProcessors\u003E\n                            &lt;generatedSourcesDirectory\u003Esrc\u002Fmain\u002Fgenerated&lt;\u002FgeneratedSourcesDirectory\u003E\n                            &lt;compilerArgs\u003E\n                                &lt;arg\u003E-Acodegen.output=${project.basedir}\u002Fsrc\u002Fmain&lt;\u002Farg\u003E\n                            &lt;\u002FcompilerArgs\u003E\n                        &lt;\u002Fconfiguration\u003E\n                    &lt;\u002Fexecution\u003E\n                    &lt;execution\u003E\n                        &lt;id\u003Edefault-testCompile&lt;\u002Fid\u003E\n                        &lt;configuration\u003E\n                            &lt;annotationProcessors\u003E\n                                &lt;annotationProcessor\u003Eio.vertx.codegen.CodeGenProcessor&lt;\u002FannotationProcessor\u003E\n                            &lt;\u002FannotationProcessors\u003E\n                            &lt;generatedTestSourcesDirectory\u003Esrc\u002Ftest\u002Fgenerated&lt;\u002FgeneratedTestSourcesDirectory\u003E\n                            &lt;compilerArgs\u003E\n                                &lt;arg\u003E-Acodegen.output=${project.basedir}\u002Fsrc\u002Ftest&lt;\u002Farg\u003E\n                            &lt;\u002FcompilerArgs\u003E\n                        &lt;\u002Fconfiguration\u003E\n                    &lt;\u002Fexecution\u003E\n                &lt;\u002Fexecutions\u003E\n            &lt;\u002Fplugin\u003E\n            &lt;plugin\u003E\n                &lt;groupId\u003Eorg.apache.maven.plugins&lt;\u002FgroupId\u003E\n                &lt;artifactId\u003Emaven-surefire-plugin&lt;\u002FartifactId\u003E\n                &lt;version\u003E${maven-surefire-plugin.version}&lt;\u002Fversion\u003E\n                &lt;configuration\u003E\n                    &lt;properties\u003E\n                        &lt;property\u003E\n                            &lt;name\u003Elistener&lt;\u002Fname\u003E\n                            &lt;value\u003Eio.qameta.allure.junit5.AllureJunit5&lt;\u002Fvalue\u003E\n                        &lt;\u002Fproperty\u003E\n                    &lt;\u002Fproperties\u003E\n                    &lt;includes\u003E\n                        &lt;include\u003E**\u002F*Test.java&lt;\u002Finclude\u003E\n                    &lt;\u002Fincludes\u003E\n                    &lt;argLine\u003E\n                        -javaagent:\"${settings.localRepository}\u002Forg\u002Faspectj\u002Faspectjweaver\u002F${aspectj.version}\u002Faspectjweaver-${aspectj.version}.jar\" -Djdk.net.URLClassPath.disableClassPathURLCheck=true\n                    &lt;\u002FargLine\u003E\n                    &lt;systemProperties\u003E\n                        &lt;property\u003E\n                            &lt;name\u003Eallure.results.directory&lt;\u002Fname\u003E\n                            &lt;value\u003E${project.basedir}\u002Ftarget\u002Fallure-results&lt;\u002Fvalue\u003E\n                        &lt;\u002Fproperty\u003E\n                        &lt;property\u003E\n                            &lt;name\u003Ejunit.jupiter.extensions.autodetection.enabled&lt;\u002Fname\u003E\n                            &lt;value\u003Etrue&lt;\u002Fvalue\u003E\n                        &lt;\u002Fproperty\u003E\n                    &lt;\u002FsystemProperties\u003E\n                    &lt;reportFormat\u003Eplain&lt;\u002FreportFormat\u003E\n                &lt;\u002Fconfiguration\u003E\n                &lt;dependencies\u003E\n                    &lt;dependency\u003E\n                        &lt;groupId\u003Eorg.aspectj&lt;\u002FgroupId\u003E\n                        &lt;artifactId\u003Easpectjweaver&lt;\u002FartifactId\u003E\n                        &lt;version\u003E${aspectj.version}&lt;\u002Fversion\u003E\n                    &lt;\u002Fdependency\u003E\n                    &lt;dependency\u003E\n                        &lt;groupId\u003Eorg.junit.platform&lt;\u002FgroupId\u003E\n                        &lt;artifactId\u003Ejunit-platform-surefire-provider&lt;\u002FartifactId\u003E\n                        &lt;version\u003E${junit-platform-surefire-provider.version}&lt;\u002Fversion\u003E\n                    &lt;\u002Fdependency\u003E\n                    &lt;dependency\u003E\n                        &lt;groupId\u003Eorg.junit.jupiter&lt;\u002FgroupId\u003E\n                        &lt;artifactId\u003Ejunit-jupiter-engine&lt;\u002FartifactId\u003E\n                        &lt;version\u003E${junit-jupiter.version}&lt;\u002Fversion\u003E\n                    &lt;\u002Fdependency\u003E\n                &lt;\u002Fdependencies\u003E\n            &lt;\u002Fplugin\u003E\n            &lt;plugin\u003E\n                &lt;groupId\u003Eio.qameta.allure&lt;\u002FgroupId\u003E\n                &lt;artifactId\u003Eallure-maven&lt;\u002FartifactId\u003E\n                &lt;version\u003E${allure-maven.version}&lt;\u002Fversion\u003E\n            &lt;\u002Fplugin\u003E\n            &lt;plugin\u003E\n                &lt;groupId\u003Eorg.apache.maven.plugins&lt;\u002FgroupId\u003E\n                &lt;artifactId\u003Emaven-site-plugin&lt;\u002FartifactId\u003E\n                &lt;version\u003E3.7.1&lt;\u002Fversion\u003E\n                &lt;dependencies\u003E\n                    &lt;dependency\u003E\n                        &lt;groupId\u003Eorg.apache.maven.wagon&lt;\u002FgroupId\u003E\n                        &lt;artifactId\u003Ewagon-webdav-jackrabbit&lt;\u002FartifactId\u003E\n                        &lt;version\u003E2.8&lt;\u002Fversion\u003E\n                    &lt;\u002Fdependency\u003E\n                &lt;\u002Fdependencies\u003E\n            &lt;\u002Fplugin\u003E\n\n            &lt;plugin\u003E\n                &lt;groupId\u003Eorg.apache.maven.plugins&lt;\u002FgroupId\u003E\n                &lt;artifactId\u003Emaven-project-info-reports-plugin&lt;\u002FartifactId\u003E\n                &lt;version\u003E3.0.0&lt;\u002Fversion\u003E\n            &lt;\u002Fplugin\u003E\n            &lt;plugin\u003E\n                &lt;groupId\u003Eorg.apache.maven.plugins&lt;\u002FgroupId\u003E\n                &lt;artifactId\u003Emaven-shade-plugin&lt;\u002FartifactId\u003E\n                &lt;version\u003E2.3&lt;\u002Fversion\u003E\n                &lt;executions\u003E\n                    &lt;execution\u003E\n                        &lt;phase\u003Epackage&lt;\u002Fphase\u003E\n                        &lt;goals\u003E\n                            &lt;goal\u003Eshade&lt;\u002Fgoal\u003E\n                        &lt;\u002Fgoals\u003E\n                        &lt;configuration\u003E\n                            &lt;transformers\u003E\n                                &lt;transformer implementation=\"org.apache.maven.plugins.shade.resource.ManifestResourceTransformer\"\u003E\n                                    &lt;manifestEntries\u003E\n                                        &lt;Main-Class\u003Eio.vertx.core.Launcher&lt;\u002FMain-Class\u003E\n                                        &lt;Main-Verticle\u003E${main.verticle}&lt;\u002FMain-Verticle\u003E\n                                    &lt;\u002FmanifestEntries\u003E\n                                &lt;\u002Ftransformer\u003E\n                                &lt;transformer implementation=\"org.apache.maven.plugins.shade.resource.AppendingTransformer\"\u003E\n                                    &lt;resource\u003EMETA-INF\u002Fservices\u002Fio.vertx.core.spi.VerticleFactory&lt;\u002Fresource\u003E\n                                &lt;\u002Ftransformer\u003E\n                            &lt;\u002Ftransformers\u003E\n                            &lt;artifactSet\u003E\n                            &lt;\u002FartifactSet\u003E\n                            &lt;outputFile\u003E${project.build.directory}\u002F${project.artifactId}-fat.jar&lt;\u002FoutputFile\u003E\n                        &lt;\u002Fconfiguration\u003E\n                    &lt;\u002Fexecution\u003E\n                &lt;\u002Fexecutions\u003E\n            &lt;\u002Fplugin\u003E\n        &lt;\u002Fplugins\u003E\n        &lt;resources\u003E\n            &lt;resource\u003E\n                &lt;directory\u003Esrc\u002Fmain\u002Fresources&lt;\u002Fdirectory\u003E\n                &lt;filtering\u003Etrue&lt;\u002Ffiltering\u003E\n                &lt;includes\u003E\n                    &lt;include\u003E**\u002Fversion.txt&lt;\u002Finclude\u003E\n                &lt;\u002Fincludes\u003E\n            &lt;\u002Fresource\u003E\n            &lt;resource\u003E\n                &lt;directory\u003Esrc\u002Fmain\u002Fresources&lt;\u002Fdirectory\u003E\n                &lt;filtering\u003Efalse&lt;\u002Ffiltering\u003E\n                &lt;excludes\u003E\n                    &lt;exclude\u003E**\u002Fversion.txt&lt;\u002Fexclude\u003E\n                &lt;\u002Fexcludes\u003E\n            &lt;\u002Fresource\u003E\n        &lt;\u002Fresources\u003E\n    &lt;\u002Fbuild\u003E\n    &lt;distributionManagement\u003E\n        &lt;site\u003E\n            &lt;id\u003Ereports&lt;\u002Fid\u003E\n            &lt;url\u003Edav:https:\u002F\u002Fnexus.dev.techedge.pro:8443\u002Frepository\u002Freports\u002F${project.artifactId}\u002F&lt;\u002Furl\u003E\n        &lt;\u002Fsite\u003E\n    &lt;\u002FdistributionManagement\u003E\n    &lt;reporting\u003E\n        &lt;excludeDefaults\u003Etrue&lt;\u002FexcludeDefaults\u003E\n        &lt;plugins\u003E\n            &lt;plugin\u003E\n                &lt;groupId\u003Eio.qameta.allure&lt;\u002FgroupId\u003E\n                &lt;artifactId\u003Eallure-maven&lt;\u002FartifactId\u003E\n                &lt;configuration\u003E\n                    &lt;resultsDirectory\u003E${project.build.directory}\u002Fallure-results&lt;\u002FresultsDirectory\u003E\n                    &lt;reportDirectory\u003E${project.reporting.outputDirectory}\u002F${project.version}\u002Fallure&lt;\u002FreportDirectory\u003E\n                &lt;\u002Fconfiguration\u003E\n            &lt;\u002Fplugin\u003E\n        &lt;\u002Fplugins\u003E\n    &lt;\u002Freporting\u003E\n\n    &lt;dependencies\u003E\n        &lt;dependency\u003E\n            &lt;groupId\u003Eio.vertx&lt;\u002FgroupId\u003E\n            &lt;artifactId\u003Evertx-web-api-service&lt;\u002FartifactId\u003E\n            &lt;version\u003E${vertx.version}&lt;\u002Fversion\u003E\n        &lt;\u002Fdependency\u003E\n        &lt;dependency\u003E\n            &lt;groupId\u003Eio.vertx&lt;\u002FgroupId\u003E\n            &lt;artifactId\u003Evertx-web-client&lt;\u002FartifactId\u003E\n            &lt;version\u003E${vertx.version}&lt;\u002Fversion\u003E\n        &lt;\u002Fdependency\u003E\n        &lt;dependency\u003E\n            &lt;groupId\u003Eio.vertx&lt;\u002FgroupId\u003E\n            &lt;artifactId\u003Evertx-codegen&lt;\u002FartifactId\u003E\n            &lt;version\u003E${vertx.version}&lt;\u002Fversion\u003E\n            &lt;scope\u003Eprovided&lt;\u002Fscope\u003E\n        &lt;\u002Fdependency\u003E\n        &lt;dependency\u003E\n            &lt;groupId\u003Ech.qos.logback&lt;\u002FgroupId\u003E\n            &lt;artifactId\u003Elogback-classic&lt;\u002FartifactId\u003E\n            &lt;version\u003E${logback.version}&lt;\u002Fversion\u003E\n        &lt;\u002Fdependency\u003E\n\n        &lt;!-- test &amp;ndash;&amp;gt;--\u003E\n        &lt;dependency\u003E\n            &lt;groupId\u003Eio.vertx&lt;\u002FgroupId\u003E\n            &lt;artifactId\u003Evertx-unit&lt;\u002FartifactId\u003E\n            &lt;version\u003E${vertx.version}&lt;\u002Fversion\u003E\n            &lt;scope\u003Etest&lt;\u002Fscope\u003E\n        &lt;\u002Fdependency\u003E\n        &lt;dependency\u003E\n            &lt;groupId\u003Eio.vertx&lt;\u002FgroupId\u003E\n            &lt;artifactId\u003Evertx-junit5&lt;\u002FartifactId\u003E\n            &lt;version\u003E${vertx.version}&lt;\u002Fversion\u003E\n            &lt;scope\u003Etest&lt;\u002Fscope\u003E\n        &lt;\u002Fdependency\u003E\n        &lt;dependency\u003E\n            &lt;groupId\u003Eorg.junit.jupiter&lt;\u002FgroupId\u003E\n            &lt;artifactId\u003Ejunit-jupiter-api&lt;\u002FartifactId\u003E\n            &lt;version\u003E${junit-jupiter.version}&lt;\u002Fversion\u003E\n            &lt;scope\u003Etest&lt;\u002Fscope\u003E\n        &lt;\u002Fdependency\u003E\n        &lt;dependency\u003E\n            &lt;groupId\u003Eorg.junit.jupiter&lt;\u002FgroupId\u003E\n            &lt;artifactId\u003Ejunit-jupiter-engine&lt;\u002FartifactId\u003E\n            &lt;version\u003E${junit-jupiter.version}&lt;\u002Fversion\u003E\n            &lt;scope\u003Etest&lt;\u002Fscope\u003E\n        &lt;\u002Fdependency\u003E\n        &lt;dependency\u003E\n            &lt;groupId\u003Eorg.assertj&lt;\u002FgroupId\u003E\n            &lt;artifactId\u003Eassertj-core&lt;\u002FartifactId\u003E\n            &lt;version\u003E${assertj-core.version}&lt;\u002Fversion\u003E\n            &lt;scope\u003Etest&lt;\u002Fscope\u003E\n        &lt;\u002Fdependency\u003E\n        &lt;dependency\u003E\n            &lt;groupId\u003Eorg.mockito&lt;\u002FgroupId\u003E\n            &lt;artifactId\u003Emockito-core&lt;\u002FartifactId\u003E\n            &lt;version\u003E${mockito.version}&lt;\u002Fversion\u003E\n            &lt;scope\u003Etest&lt;\u002Fscope\u003E\n        &lt;\u002Fdependency\u003E\n        &lt;dependency\u003E\n            &lt;groupId\u003Eio.qameta.allure&lt;\u002FgroupId\u003E\n            &lt;artifactId\u003Eallure-junit5&lt;\u002FartifactId\u003E\n            &lt;version\u003E${allure.version}&lt;\u002Fversion\u003E\n            &lt;scope\u003Etest&lt;\u002Fscope\u003E\n        &lt;\u002Fdependency\u003E\n        &lt;dependency\u003E\n            &lt;groupId\u003Eorg.testcontainers&lt;\u002FgroupId\u003E\n            &lt;artifactId\u003Ejunit-jupiter&lt;\u002FartifactId\u003E\n            &lt;version\u003E${testcontainers.version}&lt;\u002Fversion\u003E\n        &lt;\u002Fdependency\u003E\n    &lt;\u002Fdependencies\u003E\n\n&lt;\u002Fproject\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\n                    \u003C\u002Fdiv\u003E\u003Cbr\u002F\u003E\r\n\u003Cdiv class=\"spoiler\" role=\"button\" tabindex=\"0\"\u003E\n                        \u003Cb class=\"spoiler_title\"\u003EHelloWorldService.java\u003C\u002Fb\u003E\n                        \u003Cdiv class=\"spoiler_text\"\u003E\u003Cpre\u003E\u003Ccode class=\"java\"\u003Epackage io.bihero.helloworld;\n\nimport io.vertx.core.AsyncResult;\nimport io.vertx.core.Handler;\nimport io.vertx.core.Vertx;\nimport io.vertx.core.json.JsonObject;\nimport io.vertx.ext.web.api.OperationRequest;\nimport io.vertx.ext.web.api.OperationResponse;\nimport io.vertx.ext.web.api.generator.WebApiServiceGen;\n\n@WebApiServiceGen\npublic interface HelloWorldService {\n\n    static HelloWorldService create(Vertx vertx, JsonObject config) {\n        return new DefaultHelloWorldService(vertx, config);\n    }\n\n    void getHelloWorld(OperationRequest context, Handler&lt;AsyncResult&lt;OperationResponse\u003E\u003E resultHandler);\n\n    void getDoc(OperationRequest context, Handler&lt;AsyncResult&lt;OperationResponse\u003E\u003E resultHandler);\n\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\n                    \u003C\u002Fdiv\u003E\u003Cbr\u002F\u003E\r\n\u003Cdiv class=\"spoiler\" role=\"button\" tabindex=\"0\"\u003E\n                        \u003Cb class=\"spoiler_title\"\u003EDefaultHelloWorldService.java\u003C\u002Fb\u003E\n                        \u003Cdiv class=\"spoiler_text\"\u003E\u003Cpre\u003E\u003Ccode class=\"java\"\u003Epackage io.bihero.helloworld;\n\nimport io.vertx.core.*;\nimport io.vertx.core.buffer.Buffer;\nimport io.vertx.core.json.JsonObject;\nimport io.vertx.ext.web.api.OperationRequest;\nimport io.vertx.ext.web.api.OperationResponse;\nimport io.vertx.ext.web.client.WebClient;\n\npublic class DefaultHelloWorldService implements HelloWorldService {\n\n    private final Vertx vertx;\n\n    private final JsonObject config;\n\n    private final WebClient webClient;\n\n    public DefaultHelloWorldService(Vertx vertx, JsonObject config) {\n        this.vertx = vertx;\n        this.config = config;\n        this.webClient = WebClient.create(this.vertx);\n    }\n\n    @Override\n    public void getHelloWorld(OperationRequest context, Handler&lt;AsyncResult&lt;OperationResponse\u003E\u003E resultHandler) {\n        getHelloWord().compose(this::getHelloWorld).setHandler(v -\u003E\n                resultHandler.handle(\n                        Future.succeededFuture(OperationResponse.completedWithPlainText(Buffer.buffer(v.result())))\n                ));\n    }\n\n    @Override\n    public void getDoc(OperationRequest context, Handler&lt;AsyncResult&lt;OperationResponse\u003E\u003E resultHandler) {\n        vertx.fileSystem().readFile(\"doc.yaml\", buffResult -\u003E\n                resultHandler.handle(Future.succeededFuture(\n                        OperationResponse.completedWithPlainText(buffResult.result()))\n                ));\n    }\n\n    private Future&lt;String\u003E getHelloWord() {\n        Future&lt;String\u003E future = Future.future();\n        webClient.get(config.getInteger(\"hello-service-port\"), config.getString(\"hello-service-host\"), \"\u002F\").send(ar -\u003E\n                future.handle(Future.succeededFuture(ar.result().bodyAsString())));\n        return future;\n    }\n\n    private Future&lt;String\u003E getHelloWorld(String helloWord) {\n        Future&lt;String\u003E future = Future.future();\n        webClient.get(config.getInteger(\"world-service-port\"), config.getString(\"world-service-host\"), \"\u002F\").send(ar -\u003E\n                future.handle(Future.succeededFuture(helloWord + \" \" + ar.result().bodyAsString())));\n        return future;\n    }\n\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\n                    \u003C\u002Fdiv\u003E\u003Cbr\u002F\u003E\r\n\u003Cdiv class=\"spoiler\" role=\"button\" tabindex=\"0\"\u003E\n                        \u003Cb class=\"spoiler_title\"\u003EHelloWorldVerticle.java\u003C\u002Fb\u003E\n                        \u003Cdiv class=\"spoiler_text\"\u003E\u003Cpre\u003E\u003Ccode class=\"java\"\u003Epackage io.bihero.helloworld;\n\nimport io.vertx.core.AbstractVerticle;\nimport io.vertx.core.Promise;\nimport io.vertx.core.eventbus.MessageConsumer;\nimport io.vertx.core.http.HttpServer;\nimport io.vertx.core.http.HttpServerOptions;\nimport io.vertx.core.json.JsonObject;\nimport io.vertx.ext.web.Router;\nimport io.vertx.ext.web.api.contract.openapi3.OpenAPI3RouterFactory;\nimport io.vertx.serviceproxy.ServiceBinder;\n\npublic class HelloWorldVerticle extends AbstractVerticle {\n\n    HttpServer server;\n    MessageConsumer&lt;JsonObject\u003E consumer;\n\n    public void startWorldService() {\n        consumer = new ServiceBinder(vertx).setAddress(\"service.helloworld\")\n                .register(HelloWorldService.class, HelloWorldService.create(vertx, config()));\n    }\n\n    \u002F**\n     * This method constructs the router factory, mounts services and handlers and starts the http server\n     * with built router\n     * @return\n     *\u002F\n    private Promise&lt;Void\u003E startHttpServer() {\n        Promise&lt;Void\u003E promise = Promise.promise();\n        OpenAPI3RouterFactory.create(this.vertx, \"\u002Fdoc.yaml\", openAPI3RouterFactoryAsyncResult -\u003E {\n            if (openAPI3RouterFactoryAsyncResult.succeeded()) {\n                OpenAPI3RouterFactory routerFactory = openAPI3RouterFactoryAsyncResult.result();\n\n                \u002F\u002F Mount services on event bus based on extensions\n                routerFactory.mountServicesFromExtensions();\n\n                \u002F\u002F Generate the router\n                Router router = routerFactory.getRouter();\n\n                int port = config().getInteger(\"serverPort\", 8080);\n                String host = config().getString(\"serverHost\", \"localhost\");\n\n                server = vertx.createHttpServer(new HttpServerOptions().setPort(port).setHost(host));\n                server.requestHandler(router).listen(ar -\u003E {\n                    \u002F\u002F Error starting the HttpServer\n                    if (ar.succeeded()) promise.complete();\n                    else promise.fail(ar.cause());\n                });\n            } else {\n                \u002F\u002F Something went wrong during router factory initialization\n                promise.fail(openAPI3RouterFactoryAsyncResult.cause());\n            }\n        });\n        return promise;\n    }\n\n    @Override\n    public void start(Promise&lt;Void\u003E promise) {\n        startWorldService();\n        startHttpServer().future().setHandler(promise);\n    }\n\n    \u002F**\n     * This method closes the http server and unregister all services loaded to Event Bus\n     *\u002F\n    @Override\n    public void stop(){\n        this.server.close();\n        consumer.unregister();\n    }\n\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\n                    \u003C\u002Fdiv\u003E\u003Cbr\u002F\u003E\r\n\u003Cdiv class=\"spoiler\" role=\"button\" tabindex=\"0\"\u003E\n                        \u003Cb class=\"spoiler_title\"\u003EHelloWorldServiceTest.java\u003C\u002Fb\u003E\n                        \u003Cdiv class=\"spoiler_text\"\u003E\u003Cpre\u003E\u003Ccode class=\"java\"\u003Epackage io.bihero.helloworld;\n\nimport io.vertx.core.DeploymentOptions;\nimport io.vertx.core.Vertx;\nimport io.vertx.core.json.JsonObject;\nimport io.vertx.ext.web.client.WebClient;\nimport io.vertx.ext.web.codec.BodyCodec;\nimport io.vertx.junit5.Checkpoint;\nimport io.vertx.junit5.VertxExtension;\nimport io.vertx.junit5.VertxTestContext;\nimport org.apache.commons.io.IOUtils;\nimport org.junit.jupiter.api.DisplayName;\nimport org.junit.jupiter.api.Test;\nimport org.junit.jupiter.api.extension.ExtendWith;\nimport org.testcontainers.containers.GenericContainer;\nimport org.testcontainers.junit.jupiter.Container;\nimport org.testcontainers.junit.jupiter.Testcontainers;\n\nimport static org.assertj.core.api.Assertions.assertThat;\nimport static org.mockito.Mockito.spy;\n\n@Testcontainers\n@ExtendWith(VertxExtension.class)\npublic class HelloWorldServiceTest {\n\n    @Container\n    private static final GenericContainer helloServiceContainer = new GenericContainer(\"bihero\u002Fhello\")\n            .withExposedPorts(8081);\n\n    @Container\n    private static final GenericContainer worldServiceContainer = new GenericContainer(\"bihero\u002Fworld\")\n            .withExposedPorts(8082);\n\n    @Test\n    @DisplayName(\"Test 'helloworld' microservice respond by 'Hello World' string and doc in OpenAPI format\")\n    public void testHelloWorld(Vertx vertx, VertxTestContext testContext) {\n        WebClient webClient = WebClient.create(vertx);\n\n        Checkpoint deploymentCheckpoint = testContext.checkpoint();\n        Checkpoint requestCheckpoint = testContext.checkpoint(2);\n\n        HelloWorldVerticle verticle = spy(new HelloWorldVerticle());\n        JsonObject config = new JsonObject().put(\"serverPort\", 8083)\n                                            .put(\"serverHost\", \"0.0.0.0\")\n                                            .put(\"hello-service-host\", helloServiceContainer.getContainerIpAddress())\n                                            .put(\"world-service-host\", worldServiceContainer.getContainerIpAddress())\n                                            .put(\"hello-service-port\", helloServiceContainer.getMappedPort(8081))\n                                            .put(\"world-service-port\", worldServiceContainer.getMappedPort(8082));\n        DeploymentOptions deploymentOptions = new DeploymentOptions().setConfig(config);\n        vertx.deployVerticle(verticle, deploymentOptions, testContext.succeeding(id -\u003E {\n            deploymentCheckpoint.flag();\n            \u002F\u002F test GET \u002F\n            webClient.get(8083, \"localhost\", \"\u002F\")\n                    .as(BodyCodec.string())\n                    .send(testContext.succeeding(resp -\u003E {\n                        assertThat(resp.body()).isEqualTo(\"Hello World\");\n                        assertThat(resp.statusCode()).isEqualTo(200);\n                        requestCheckpoint.flag();\n                    }));\n            \u002F\u002F test GET \u002Fdoc\n            webClient.get(8083, \"localhost\", \"\u002Fdoc\")\n                    .as(BodyCodec.string())\n                    .send(testContext.succeeding(resp -\u003E {\n                        try {\n                            assertThat(resp.body()).isEqualTo(IOUtils.toString(this.getClass()\n                                    .getResourceAsStream(\"..\u002F..\u002F..\u002Fdoc.yaml\"), \"UTF-8\"));\n                            assertThat(resp.statusCode()).isEqualTo(200);\n                            requestCheckpoint.flag();\n                        } catch (Exception e) {\n                            requestCheckpoint.flag();\n                            testContext.failNow(e);\n                        }\n                    }));\n        }));\n    }\n\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\n                    \u003C\u002Fdiv\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EDockerfile для интеграционного сервиса немножечко отличается от двух сервисов выше — конфиг для сервиса мы кладём не в \u003Cstrong\u003E\u002F\u003C\u002Fstrong\u003E как обычно, а в \u003Cstrong\u003E\u002Fusr\u002Flocal\u003C\u002Fstrong\u003E, чтобы иметь возможность переопределять его ConfigMap'ом при запуске сервиса в k8s\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cdiv class=\"spoiler\" role=\"button\" tabindex=\"0\"\u003E\n                        \u003Cb class=\"spoiler_title\"\u003EDockerfile\u003C\u002Fb\u003E\n                        \u003Cdiv class=\"spoiler_text\"\u003E\u003Cpre\u003E\u003Ccode class=\"plaintext\"\u003EFROM adoptopenjdk\u002Fopenjdk11:alpine-jre\nCOPY target\u002Fhello-world-microservice-fat.jar app.jar\nCOPY src\u002Fconf\u002Fconfig.json \u002Fusr\u002Flocal\u002Fconfig.json\nCOPY src\u002Fconf\u002Flogback-console.xml .\nCOPY run.sh .\nRUN chmod +x run.sh\nCMD [\".\u002Frun.sh\"]\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\n                    \u003C\u002Fdiv\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EИтак, подошли к пайпалйну сборки и тут стоит пояснить, как вообще CI крутится и как там таски запускаются. Concourse в той конфигурации, на основе которой писалась эта статья, имеет несколько worker-нод и всё они запущены docker-compose'ом (рядом ещё крутятся ui-нода и postgresql). Таски в джобах — это тоже отдельно стартующие docker-контейнеры, то есть мы уже имеем docker в docker'е. А ещё мы очень хотим интеграционные тесты запускать с помощью testcontainers (в нашем кейсе сервисы \u003Cstrong\u003Ehello\u003C\u002Fstrong\u003E и \u003Cstrong\u003Eworld\u003C\u002Fstrong\u003E запускаем при помощи этого крутого тула). Чувствуете чем пахнет? Правилько: \u003Cstrong\u003Eдокер в докере в докере\u003C\u002Fstrong\u003E! И для этого нам нужен модный образ с docker'ом, maven'ом и 11-ой джавой на борту. Встречаем, Dockerfile:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"plaintext\"\u003EFROM alpine:3.7\n\nENV DOCKER_CHANNEL=stable \\\n    DOCKER_VERSION=17.12.1-ce \\\n    DOCKER_COMPOSE_VERSION=1.19.0 \\\n    DOCKER_SQUASH=0.2.0\n# Install Docker, Docker Compose, Docker Squash\nRUN apk --update --no-cache add \\\n        bash \\\n        curl \\\n        device-mapper \\\n        py-pip \\\n        iptables \\\n        util-linux \\\n        ca-certificates \\\n        maven \\\n        openjdk11 --repository=http:\u002F\u002Fdl-cdn.alpinelinux.org\u002Falpine\u002Fedge\u002Fcommunity \\\n        &amp;&amp; \\\n    apk upgrade &amp;&amp; \\\n    curl -fL \"https:\u002F\u002Fdownload.docker.com\u002Flinux\u002Fstatic\u002F${DOCKER_CHANNEL}\u002Fx86_64\u002Fdocker-${DOCKER_VERSION}.tgz\" | tar zx &amp;&amp; \\\n    mv \u002Fdocker\u002F* \u002Fbin\u002F &amp;&amp; chmod +x \u002Fbin\u002Fdocker* &amp;&amp; \\\n    pip install docker-compose==${DOCKER_COMPOSE_VERSION} &amp;&amp; \\\n    curl -fL \"https:\u002F\u002Fgithub.com\u002Fjwilder\u002Fdocker-squash\u002Freleases\u002Fdownload\u002Fv${DOCKER_SQUASH}\u002Fdocker-squash-linux-amd64-v${DOCKER_SQUASH}.tar.gz\" | tar zx &amp;&amp; \\\n    mv \u002Fdocker-squash* \u002Fbin\u002F &amp;&amp; chmod +x \u002Fbin\u002Fdocker-squash* &amp;&amp; \\\n    rm -rf \u002Fvar\u002Fcache\u002Fapk\u002F* &amp;&amp; \\\n    rm -rf \u002Froot\u002F.cache\n\nCOPY repository \u002Froot\u002F.m2\u002Frepository # тут мы кладём в образ вендор-зависимости, чтобы не тянуть и при каждом билде с централа\nCOPY settings.xml \u002Froot\u002F.m2\u002Fsettings.xml # конфиг для maven'а с кредами к приватному репозиторию\nCOPY entrypoint.sh \u002Fbin\u002Fentrypoint.sh # волшебный баш-скрипт, который даёт нам возможность стартовать докер в таске\nENV JAVA_HOME=\u002Fusr\u002Flib\u002Fjvm\u002Fjava-11-openjdk\u002F\nENTRYPOINT [\"entrypoint.sh\"]\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EВ пайплайне сборки на шаг запуска тестов будем заходить через \u003Cem\u003Eentrypoint.sh\u003C\u002Fem\u003E, который обеспечит нам запуск докера перед запуском самих тестов:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cdiv class=\"spoiler\" role=\"button\" tabindex=\"0\"\u003E\n                        \u003Cb class=\"spoiler_title\"\u003Eentrypoint.sh\u003C\u002Fb\u003E\n                        \u003Cdiv class=\"spoiler_text\"\u003E\u003Cpre\u003E\u003Ccode class=\"bash\"\u003E#!\u002Fusr\u002Fbin\u002Fenv bash\n\n# Inspired by concourse\u002Fdocker-image-resource:\n# https:\u002F\u002Fgithub.com\u002Fconcourse\u002Fdocker-image-resource\u002Fblob\u002Fmaster\u002Fassets\u002Fcommon.sh\n\nset -o errexit -o pipefail -o nounset\n\n# Waits DOCKERD_TIMEOUT seconds for startup (default: 60)\nDOCKERD_TIMEOUT=\"${DOCKERD_TIMEOUT:-60}\"\n# Accepts optional DOCKER_OPTS (default: --data-root \u002Fscratch\u002Fdocker)\nDOCKER_OPTS=\"${DOCKER_OPTS:-}\"\n\n# Constants\nDOCKERD_PID_FILE=\"\u002Ftmp\u002Fdocker.pid\"\nDOCKERD_LOG_FILE=\"\u002Ftmp\u002Fdocker.log\"\n\nsanitize_cgroups() {\n  local cgroup=\"\u002Fsys\u002Ffs\u002Fcgroup\"\n\n  mkdir -p \"${cgroup}\"\n  if ! mountpoint -q \"${cgroup}\"; then\n    if ! mount -t tmpfs -o uid=0,gid=0,mode=0755 cgroup \"${cgroup}\"; then\n      echo \u003E&amp;2 \"Could not make a tmpfs mount. Did you use --privileged?\"\n      exit 1\n    fi\n  fi\n  mount -o remount,rw \"${cgroup}\"\n\n  # Skip AppArmor\n  # See: https:\u002F\u002Fgithub.com\u002Fmoby\u002Fmoby\u002Fcommit\u002Fde191e86321f7d3136ff42ff75826b8107399497\n  export container=docker\n\n  # Mount \u002Fsys\u002Fkernel\u002Fsecurity\n  if [[ -d \u002Fsys\u002Fkernel\u002Fsecurity ]] &amp;&amp; ! mountpoint -q \u002Fsys\u002Fkernel\u002Fsecurity; then\n    if ! mount -t securityfs none \u002Fsys\u002Fkernel\u002Fsecurity; then\n      echo \u003E&amp;2 \"Could not mount \u002Fsys\u002Fkernel\u002Fsecurity.\"\n      echo \u003E&amp;2 \"AppArmor detection and --privileged mode might break.\"\n    fi\n  fi\n\n  sed -e 1d \u002Fproc\u002Fcgroups | while read sys hierarchy num enabled; do\n    if [[ \"${enabled}\" != \"1\" ]]; then\n      # subsystem disabled; skip\n      continue\n    fi\n\n    grouping=\"$(cat \u002Fproc\u002Fself\u002Fcgroup | cut -d: -f2 | grep \"\\\\&lt;${sys}\\\\\u003E\")\"\n    if [[ -z \"${grouping}\" ]]; then\n      # subsystem not mounted anywhere; mount it on its own\n      grouping=\"${sys}\"\n    fi\n\n    mountpoint=\"${cgroup}\u002F${grouping}\"\n\n    mkdir -p \"${mountpoint}\"\n\n    # clear out existing mount to make sure new one is read-write\n    if mountpoint -q \"${mountpoint}\"; then\n      umount \"${mountpoint}\"\n    fi\n\n    mount -n -t cgroup -o \"${grouping}\" cgroup \"${mountpoint}\"\n\n    if [[ \"${grouping}\" != \"${sys}\" ]]; then\n      if [[ -L \"${cgroup}\u002F${sys}\" ]]; then\n        rm \"${cgroup}\u002F${sys}\"\n      fi\n\n      ln -s \"${mountpoint}\" \"${cgroup}\u002F${sys}\"\n    fi\n  done\n\n  # Initialize systemd cgroup if host isn't using systemd.\n  # Workaround for https:\u002F\u002Fgithub.com\u002Fdocker\u002Ffor-linux\u002Fissues\u002F219\n  if ! [[ -d \u002Fsys\u002Ffs\u002Fcgroup\u002Fsystemd ]]; then\n    mkdir \"${cgroup}\u002Fsystemd\"\n    mount -t cgroup -o none,name=systemd cgroup \"${cgroup}\u002Fsystemd\"\n  fi\n}\n\n# Setup container environment and start docker daemon in the background.\nstart_docker() {\n  echo \u003E&amp;2 \"Setting up Docker environment...\"\n  mkdir -p \u002Fvar\u002Flog\n  mkdir -p \u002Fvar\u002Frun\n\n  sanitize_cgroups\n\n  # check for \u002Fproc\u002Fsys being mounted readonly, as systemd does\n  if grep '\u002Fproc\u002Fsys\\s\\+\\w\\+\\s\\+ro,' \u002Fproc\u002Fmounts \u003E\u002Fdev\u002Fnull; then\n    mount -o remount,rw \u002Fproc\u002Fsys\n  fi\n\n  local docker_opts=\"${DOCKER_OPTS:-}\"\n\n  # Pass through `--garden-mtu` from gardian container\n  if [[ \"${docker_opts}\" != *'--mtu'* ]]; then\n    local mtu=\"$(cat \u002Fsys\u002Fclass\u002Fnet\u002F$(ip route get 8.8.8.8|awk '{ print $5 }')\u002Fmtu)\"\n    docker_opts+=\" --mtu ${mtu}\"\n  fi\n\n  # Use Concourse's scratch volume to bypass the graph filesystem by default\n  if [[ \"${docker_opts}\" != *'--data-root'* ]] &amp;&amp; [[ \"${docker_opts}\" != *'--graph'* ]]; then\n    docker_opts+=' --data-root \u002Fscratch\u002Fdocker'\n  fi\n\n  rm -f \"${DOCKERD_PID_FILE}\"\n  touch \"${DOCKERD_LOG_FILE}\"\n\n  echo \u003E&amp;2 \"Starting Docker...\"\n  dockerd ${docker_opts} &amp;\u003E\"${DOCKERD_LOG_FILE}\" &amp;\n  echo \"$!\" \u003E \"${DOCKERD_PID_FILE}\"\n}\n\n# Wait for docker daemon to be healthy\n# Timeout after DOCKERD_TIMEOUT seconds\nawait_docker() {\n  local timeout=\"${DOCKERD_TIMEOUT}\"\n  echo \u003E&amp;2 \"Waiting ${timeout} seconds for Docker to be available...\"\n  local start=${SECONDS}\n  timeout=$(( timeout + start ))\n  until docker info &amp;\u003E\u002Fdev\u002Fnull; do\n    if (( SECONDS \u003E= timeout )); then\n      echo \u003E&amp;2 'Timed out trying to connect to docker daemon.'\n      if [[ -f \"${DOCKERD_LOG_FILE}\" ]]; then\n        echo \u003E&amp;2 '---DOCKERD LOGS---'\n        cat \u003E&amp;2 \"${DOCKERD_LOG_FILE}\"\n      fi\n      exit 1\n    fi\n    if [[ -f \"${DOCKERD_PID_FILE}\" ]] &amp;&amp; ! kill -0 $(cat \"${DOCKERD_PID_FILE}\"); then\n      echo \u003E&amp;2 'Docker daemon failed to start.'\n      if [[ -f \"${DOCKERD_LOG_FILE}\" ]]; then\n        echo \u003E&amp;2 '---DOCKERD LOGS---'\n        cat \u003E&amp;2 \"${DOCKERD_LOG_FILE}\"\n      fi\n      exit 1\n    fi\n    sleep 1\n  done\n  local duration=$(( SECONDS - start ))\n  echo \u003E&amp;2 \"Docker available after ${duration} seconds.\"\n}\n\n# Gracefully stop Docker daemon.\nstop_docker() {\n  if ! [[ -f \"${DOCKERD_PID_FILE}\" ]]; then\n    return 0\n  fi\n  local docker_pid=\"$(cat ${DOCKERD_PID_FILE})\"\n  if [[ -z \"${docker_pid}\" ]]; then\n    return 0\n  fi\n  echo \u003E&amp;2 \"Terminating Docker daemon.\"\n  kill -TERM ${docker_pid}\n  local start=${SECONDS}\n  echo \u003E&amp;2 \"Waiting for Docker daemon to exit...\"\n  wait ${docker_pid}\n  local duration=$(( SECONDS - start ))\n  echo \u003E&amp;2 \"Docker exited after ${duration} seconds.\"\n}\n\nstart_docker\ntrap stop_docker EXIT\nawait_docker\n\n# do not exec, because exec disables traps\nif [[ \"$#\" != \"0\" ]]; then\n  \"$@\"\nelse\n  bash --login\nfi\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\n                    \u003C\u002Fdiv\u003E\u003Cbr\u002F\u003E\r\n\u003Cdiv class=\"spoiler\" role=\"button\" tabindex=\"0\"\u003E\n                        \u003Cb class=\"spoiler_title\"\u003Epipeline.yaml\u003C\u002Fb\u003E\n                        \u003Cdiv class=\"spoiler_text\"\u003E\u003Cpre\u003E\u003Ccode class=\"plaintext\"\u003Eresource_types:\n  - name: telegram\n    type: docker-image\n    source:\n      repository: vtutrinov\u002Fconcourse-telegram-resource\n      tag: latest\n  - name: kubernetes\n    type: docker-image\n    source:\n      repository: zlabjp\u002Fkubernetes-resource\n      tag: 1.16\n  - name: metadata\n    type: docker-image\n    source:\n      repository: olhtbr\u002Fmetadata-resource\n      tag: 2.0.1\nresources:\n  - name: metadata\n    type: metadata\n  - name: sources\n    type: git\n    source:\n      branch: master\n      uri: git@github.com:bihero-io\u002Fhelloworldmicroservice.git\n      private_key: ((deployer-private-key))\n  - name: docker-image\n    type: docker-image\n    source:\n      repository: bihero\u002Fhelloworld\n      username: ((docker-registry-user))\n      password: ((docker-registry-password))\n  - name: telegram\n    type: telegram\n    source:\n      bot_token: ((telegram-ci-bot-token))\n      chat_id: ((telegram-group-to-report-build))\n      ci_url: ((ci_url))\n      command: \"\u002Fbuild_helloworld_ms\"\n  - name: kubernetes-demo\n    type: kubernetes\n    source:\n      server: ((k8s-api-server))\n      namespace: default\n      kubeconfig: ((kubeconfig-demo))\njobs:\n  - name: build-helloworld-microservice\n    serial: true\n    public: true\n    plan:\n      - in_parallel:\n          - get: sources\n            trigger: true\n          - get: telegram\n            trigger: true\n          - put: metadata\n      - put: telegram\n        params:\n          status: Build In Progress\n      - task: tests\n        privileged: true\n        config:\n          platform: linux\n          image_resource:\n            type: docker-image\n            source:\n              repository: ((docker-registry-uri))\u002Fbih\u002Fdind  # тут мы указываем образ, собранный на основе докерфайла, где мы ставим докер, maven и 11-ю джаву\n              tag: latest\n              username: ((docker-private-registry-user))\n              password: ((docker-private-registry-password))\n          inputs:\n            - name: sources\n          outputs:\n            - name: tested-workspace\n          run:\n            path: entrypoint.sh\n            args:\n              - bash\n              - -ceux\n              - |\n                # вот тут мы уже имеем запущенный докер внутри таски и можем запускать тесты с testcontainers\n                output_dir=tested-workspace\n                cp -R .\u002Fsources\u002F* \"${output_dir}\u002F\"\n                mvn -f \"${output_dir}\u002Fpom.xml\" clean test\n          caches:\n            - path: ~\u002F.m2\u002F\n        on_failure:\n          do:\n            - task: tests-report\n              config:\n                platform: linux\n                image_resource:\n                  type: docker-image\n                  source:\n                    repository: ((docker-registry-uri))\u002Fbih\u002Fmaven-dind\n                    tag: 3-jdk-11\n                    username: ((docker-private-registry-user))\n                    password: ((docker-private-registry-password))\n                inputs:\n                  - name: tested-workspace\n                outputs:\n                  - name: message\n                run:\n                  path: \u002Fbin\u002Fsh\n                  args:\n                    - -c\n                    - |\n                      output_dir=tested-workspace\n                      mvn -Dmaven.wagon.http.ssl.insecure=true -Dmaven.wagon.http.ssl.allowall=true -f \"${output_dir}\u002Fpom.xml\" site-deploy\n                      version=$(cat $output_dir\u002Ftarget\u002Fclasses\u002Fversion.txt)\n                      cat \u003Emessage\u002Fmsg &lt;&lt;EOL\n                      &lt;a href=\"https:\u002F\u002Fnexus.dev.techedge.pro:8443\u002Frepository\u002Freports\u002Fhello-world-microservice\u002F${version}\u002Fallure\u002F\"\u003EAllure report&lt;\u002Fa\u003E\n                      EOL\n                caches:\n                  - path: ~\u002F.m2\u002F\n            - put: telegram\n              params:\n                status: Build Failed (unit-tests)\n                message_file: message\u002Fmsg\n      - task: tests-report\n        config:\n          platform: linux\n          image_resource:\n            type: docker-image\n            source:\n              repository: ((docker-registry-uri))\u002Fbih\u002Fmaven-dind\n              tag: 3-jdk-11\n              username: ((docker-private-registry-user))\n              password: ((docker-private-registry-password))\n          inputs:\n            - name: tested-workspace\n          outputs:\n            - name: message\n            - name: tested-workspace\n          run:\n            path: \u002Fbin\u002Fsh\n            args:\n              - -c\n              - |\n                work_dir=tested-workspace\n                mvn -Dmaven.wagon.http.ssl.insecure=true -Dmaven.wagon.http.ssl.allowall=true -f \"${work_dir}\u002Fpom.xml\" site-deploy\n                version=$(cat $work_dir\u002Ftarget\u002Fclasses\u002Fversion.txt)\n                cat \u003Emessage\u002Fmsg &lt;&lt;EOL\n                &lt;a href=\"https:\u002F\u002Fnexus.dev.techedge.pro:8443\u002Frepository\u002Freports\u002Fhello-world-microservice\u002F${version}\u002Fallure\u002F\"\u003EAllure report&lt;\u002Fa\u003E\n                EOL\n          caches:\n            - path: ~\u002F.m2\u002F\n      - task: package\n        config:\n          platform: linux\n          image_resource:\n            type: docker-image\n            source:\n              repository: ((docker-registry-uri))\u002Fbih\u002Fmaven-dind\n              tag: 3-jdk-11\n              username: ((docker-private-registry-user))\n              password: ((docker-private-registry-password))\n          inputs:\n            - name: tested-workspace\n            - name: metadata\n          outputs:\n            - name: app-packaged-workspace\n            - name: metadata\n          run:\n            path: \u002Fbin\u002Fsh\n            args:\n              - -c\n              - |\n                output_dir=app-packaged-workspace\n                cp -R .\u002Ftested-workspace\u002F* \"${output_dir}\u002F\"\n                mvn -f \"${output_dir}\u002Fpom.xml\" package -Dmaven.main.skip -DskipTests\n                tag=\"-\"$(cat metadata\u002Fbuild_name)\n                echo $tag \u003E\u003E ${output_dir}\u002Ftarget\u002Fclasses\u002Fversion.txt\n                cat ${output_dir}\u002Ftarget\u002Fclasses\u002Fversion.txt \u003E metadata\u002Fversion\n          caches:\n            - path: ~\u002F.m2\u002F\n        on_failure:\n          do:\n            - put: telegram\n              params:\n                status: Build Failed (package)\n      - put: docker-image\n        params:\n          build: app-packaged-workspace\n          tag_file: app-packaged-workspace\u002Ftarget\u002Fclasses\u002Fversion.txt\n          tag_as_latest: true\n        get_params:\n          skip_download: true\n      - task: make-k8s-app-template\n        config:\n          platform: linux\n          image_resource:\n            type: docker-image\n            source:\n              repository: bhgedigital\u002Fenvsubst\n          inputs:\n            - name: sources\n            - name: metadata\n          outputs:\n            - name: k8s\n          run:\n            path: \u002Fbin\u002Fsh\n            args:\n              - -c\n              - |\n                export DOMAIN=demo1.bihero.io\n                export HELLO_WORLD_SERVICE_IMAGE_VERSION=$(cat metadata\u002Fversion)\n                cat sources\u002Fk8s.yaml | envsubst \u003E k8s\u002Fhelloworld_app_template.yaml\n                cat k8s\u002Fhelloworld_app_template.yaml\n      - put: kubernetes-demo\n        params:\n          kubectl: apply -f k8s\u002Fhelloworld_app_template.yaml\n      - put: telegram\n        params:\n          status: Build Success\n          message_file: message\u002Fmsg\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\n                    \u003C\u002Fdiv\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EПодошли к деплою интеграционного сервиса в k8s. И тут возникает необходимость знать адреса сервисов \u003Cstrong\u003Ehello\u003C\u002Fstrong\u003E и \u003Cstrong\u003Eworld\u003C\u002Fstrong\u003E внутри k8s-кластера. По дефолту все сервисы внутри k8s имет адреса типа \u003Cstrong\u003E&lt;service-name\u003E..default.svc.cluster.local\u003C\u002Fstrong\u003E, вот ими и воспользуемся, не будем же мы ходить до сервисов, которые крутятся рядом через внешний API. Сказано, сделано :\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cdiv class=\"spoiler\" role=\"button\" tabindex=\"0\"\u003E\n                        \u003Cb class=\"spoiler_title\"\u003Eконечная версия темплейта для деплоя интеграционного сервиса в k8s\u003C\u002Fb\u003E\n                        \u003Cdiv class=\"spoiler_text\"\u003E\u003Cpre\u003E\u003Ccode class=\"plaintext\"\u003EapiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: hello-world-config\ndata:\n  config.json: |\n    {\n      \"type\": \"file\",\n      \"format\": \"json\",\n      \"scanPeriod\": 5000,\n      \"config\": {\n        \"path\": \"\u002Fconfig.json\"\n      },\n      \"serverPort\": 8083,\n      \"serverHost\": \"0.0.0.0\",\n      \"hello-service-host\": \"bihero-hello.default.svc.cluster.local\",\n      \"hello-service-port\": 8081,\n      \"world-service-host\": \"bihero-world.default.svc.cluster.local\",\n      \"world-service-port\": 8082\n    }\n---\napiVersion: extensions\u002Fv1beta1\nkind: Deployment\nmetadata:\n  labels:\n    io.bihero.hello.service: bihero-helloworld\n  name: bihero-helloworld\nspec:\n  replicas: 3\n  strategy:\n    type: RollingUpdate\n    rollingUpdate:\n      maxSurge: 1\n      maxUnavailable: 1\n  template:\n    metadata:\n      labels:\n        io.bihero.hello.service: bihero-helloworld\n    spec:\n      containers:\n        - image: bihero\u002Fhelloworld:${HELLO_WORLD_SERVICE_IMAGE_VERSION}\n          name: bihero-helloworld\n          ports:\n            - containerPort: 8083\n          imagePullPolicy: Always\n          resources: {}\n          volumeMounts: # в \u002Fusr\u002Flocal заменяем дефолтный конфиг на занчение из ConfigMap'а сверху\n            - mountPath: \u002Fusr\u002Flocal\u002F\n              name: hello-world-config\n      restartPolicy: Always\n      volumes:\n        - name: hello-world-config\n          configMap:\n            name: hello-world-config\n---\napiVersion: v1\nkind: Service\nmetadata:\n  labels:\n    io.bihero.hello.service: bihero-helloworld\n  name: bihero-helloworld\nspec:\n  ports:\n    - name: \"8083\"\n      port: 8083\n      targetPort: 8083\n  selector:\n    io.bihero.hello.service: bihero-helloworld\nstatus:\n  loadBalancer: {}\n---\napiVersion: extensions\u002Fv1beta1\nkind: Ingress\nmetadata:\n  name: bihero-helloworld\n  annotations:\n    kubernetes.io\u002Fingress.class: nginx\n    nginx.ingress.kubernetes.io\u002Fssl-redirect: \"true\"\n    nginx.ingress.kubernetes.io\u002Fsecure-backends: \"false\"\n    nginx.ingress.kubernetes.io\u002Fssl-passthrough: \"false\"\n    nginx.ingress.kubernetes.io\u002Frewrite-target: \u002F$2\n    kubernetes.io\u002Ftls-acme: \"true\"\n  namespace: default\nspec:\n  tls:\n    - hosts:\n        - ${DOMAIN}\n      secretName: bihero\n  rules:\n    - host: ${DOMAIN}\n      http:\n        paths:\n          - path: \u002Fapi\u002Fhelloworld(\u002F|$)(.*)\n            backend:\n              serviceName: bihero-helloworld\n              servicePort: 8083\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\n                    \u003C\u002Fdiv\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EНу, и как обычно — коммитимся, пушимся, билдимся, деплоимся, тестируемся:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"bash\"\u003Ecurl https:\u002F\u002Fdemo1.bihero.io\u002Fapi\u002Fhelloworld\nHello World\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"bash\"\u003Ecurl https:\u002F\u002Fdemo1.bihero.io\u002Fapi\u002Fhelloworld\u002Fdoc                 \nopenapi: 3.0.1\ninfo:\n  title: Hello World ;)\n  description: \"Hello World microservice. Aggregate 'Hello World' by hellomicroservice and worldmicroservice\"\n  version: 1.0.0\nservers:\n  - url: https:\u002F\u002Fdemo1.bihero.io\u002Fapi\u002Fhelloworld\ntags:\n  - name: helloworld\n    description: Everything about 'Hello World'\npaths:\n  \u002F:\n    x-vertx-event-bus:\n      address: service.helloworld\n      timeout: 1000\n    get:\n      tags:\n        - helloworld\n      summary: Aggregate 'Hello World'\n      operationId: getHelloWorld\n      responses:\n        200:\n          description: OK\n          content: {}\n  \u002Fdoc:\n    x-vertx-event-bus:\n      address: service.helloworld\n      timeout: 1000c\n    get:\n      tags:\n        - world\n      summary: Get 'Hello World' microservice documentation\n      operationId: getDoc\n      responses:\n        200:\n          description: OK\ncomponents: {}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EУра! Работает! Можем релизиться и в прод, но для полноты картины… \u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Ch2\u003ETODO'шечки (backlog)\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\r\n\u003Col\u003E\r\n\u003Cli\u003EМного бойлерплейта в помниках — унести всё общее в parent pom и собирать все сервисы продукта на основе него.\u003C\u002Fli\u003E\r\n\u003Cli\u003EСейчас собранные в пайплайнах docker-образы тегаются и сразу пушатся в docker-hub, включая снэпшотные образы — сделать так, чтобы туда пушились только релизные образы, всё снэпшотное в private registry.\u003C\u002Fli\u003E\r\n\u003Cli\u003EСделать \"нормальное\" версионирование (maven-release-plugin? concourse semver-resource ?), возможно хранить версии в отдельном репозитории, и триггерить релизные сборки при изменении в репозитории, отвечающем за хранение версий продукта.\u003C\u002Fli\u003E\r\n\u003Cli\u003EРешить проблему рассинхронизации API между сервисами в условиях НЕ-монорепозитория в гите (когда это три сервиса типа HelloWorld, то проблемы нет, но когда будет несколько десятков сложных сервисов, то наступит АД). Если кто-то занет железобетонные способы, то пишите в комментариях — буду рад узнать и обсудить :)\u003C\u002Fli\u003E\r\n\u003C\u002Fol\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EСписок в голове был большой, но забылся по пути, если вспомнится, то дополню, ну или дополняйте в комментариях :)\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Ch3\u003EИ исходники\u003C\u002Fh3\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fbihero-io\u002Fhello-microservice\"\u003Ehttps:\u002F\u002Fgithub.com\u002Fbihero-io\u002Fhello-microservice\u003C\u002Fa\u003E\u003Cbr\u002F\u003E\r\n\u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fbihero-io\u002Fworldmicroservice\"\u003Ehttps:\u002F\u002Fgithub.com\u002Fbihero-io\u002Fworldmicroservice\u003C\u002Fa\u003E\u003Cbr\u002F\u003E\r\n\u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fbihero-io\u002Fhelloworldmicroservice\"\u003Ehttps:\u002F\u002Fgithub.com\u002Fbihero-io\u002Fhelloworldmicroservice\u003C\u002Fa\u003E\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003E\u003Cstrong\u003E[UPD] в TODO'шечки\u003C\u002Fstrong\u003E\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Col\u003E\r\n\u003Cli\u003EЗапилить степ в пайплайне для сборки helm-чарта, деплоить в k8s с помощью чарта, давать конечным on-prem юзерам возможность деплоиться как с темплейтами, так и из чарта\u003C\u002Fli\u003E\r\n\u003C\u002Fol\u003E\u003C\u002Fdiv\u003E","tags":[{"titleHtml":"devops"},{"titleHtml":"ci\u002Fcd"},{"titleHtml":"java"},{"titleHtml":"vertx"},{"titleHtml":"junit5"},{"titleHtml":"testcontainers"}],"metadata":{"stylesUrls":[],"scriptUrls":[],"shareImageUrl":"https:\u002F\u002Fhabr.com\u002Fshare\u002Fpublication\u002F465149\u002Ff5b6d5bdf8da77d9adfed77a9f21a964\u002F","shareImageWidth":1200,"shareImageHeight":630,"vkShareImageUrl":"https:\u002F\u002Fhabr.com\u002Fshare\u002Fpublication\u002F465149\u002Ff5b6d5bdf8da77d9adfed77a9f21a964\u002F?format=vk","schemaJsonLd":"{\"@context\":\"http:\\\u002F\\\u002Fschema.org\",\"@type\":\"Article\",\"mainEntityOfPage\":{\"@type\":\"WebPage\",\"@id\":\"https:\\\u002F\\\u002Fhabr.com\\\u002Fru\\\u002Fpost\\\u002F465149\\\u002F\"},\"headline\":\"'Hello World' вам в облако\",\"datePublished\":\"2019-12-14T17:10:13+03:00\",\"dateModified\":\"2019-12-15T10:28:37+03:00\",\"author\":{\"@type\":\"Person\",\"name\":\"Вячеслав Тутринов\"},\"publisher\":{\"@type\":\"Organization\",\"name\":\"Habr\",\"logo\":{\"@type\":\"ImageObject\",\"url\":\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fa_\\\u002Flk\\\u002F9m\\\u002Fa_lk9mjkccjox-zccjrpfolmkmq.png\"}},\"description\":\"Мир сходит с ума, заталкивая калькулятор для 2+2 в облака. Чем мы хуже? Давайте Hello World затолкаем в три микросервиса, напишем пару-тройку тестов, обеспечим п...\",\"url\":\"https:\\\u002F\\\u002Fhabr.com\\\u002Fru\\\u002Fpost\\\u002F465149\\\u002F#post-content-body\",\"about\":[\"h_java\",\"h_devops\",\"f_develop\",\"f_admin\"],\"image\":[\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fn_\\\u002Fmu\\\u002F7h\\\u002Fn_mu7ht4nkqya165lkl7b44ii1w.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002F3l\\\u002Fs3\\\u002Fdk\\\u002F3ls3dkohbjzzlfj1rruhtvtxjzs.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fup\\\u002Fuu\\\u002Fmh\\\u002Fupuumhgqijpejz-jgu9n8zc_ds4.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fdv\\\u002F31\\\u002F8n\\\u002Fdv318n2kmrvhua0bbv63togmivs.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fto\\\u002F1r\\\u002Ffy\\\u002Fto1rfysgzpxwi3zp6jlaffswra4.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fo2\\\u002Fnp\\\u002Fm4\\\u002Fo2npm4hdhucyueujgknmuqitfny.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Ffy\\\u002Fkf\\\u002Fkn\\\u002Ffykfkndjy0qzvl79t1_s9_ka6wg.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fnh\\\u002Fbu\\\u002Fxw\\\u002Fnhbuxw6mlng--ctknv2y2hh7p5q.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fv9\\\u002Fpy\\\u002Fvo\\\u002Fv9pyvoi2szjw9g7h4v_57mf74ei.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fpq\\\u002Fzx\\\u002Fxf\\\u002Fpqzxxfn_dhfqnj6cxgxlcrkb6w0.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fd_\\\u002Fs5\\\u002Fev\\\u002Fd_s5evcbp9k24rddt1ffweipux8.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fyb\\\u002Fh-\\\u002Fhr\\\u002Fybh-hrr4ommmlrsqh4inb4_nii4.png\"]}","metaDescription":"Мир сходит с ума, заталкивая калькулятор для 2+2 в облака. Чем мы хуже? Давайте Hello World затолкаем в три микросервиса, напишем пару-тройку тестов, обеспечим пользователей документацией, нарисуем...","mainImageUrl":null,"amp":false,"customTrackerLinks":[]},"polls":[],"commentsEnabled":true,"rulesRemindEnabled":false,"votesEnabled":true,"status":"published","plannedPublishTime":null,"checked":null,"isEditorial":false}},"articlesIds":{},"isLoading":false,"pagesCount":{},"route":{},"reasonsList":null,"view":"cards","lastVisitedRoute":{},"ssrCommentsArticleIds":[""],"karma":{}},"authorContribution":{"authors":{}},"betaTest":{"currentAnnouncement":null,"announcements":{},"announcementCards":null,"announcementComments":{},"announcementCommentThreads":{},"announcementCommentingStatuses":{},"archivedList":[]},"authorStatistics":{"articleRefs":{},"articleIds":{},"pagesCount":{},"route":{},"viewsCount":[],"maxStatsCount":{}},"career":{"seoLandings":[{"title":"DevOps инженер","vacanciesCount":87,"itemUrl":"https:\u002F\u002Fcareer.habr.com\u002Fvacancies\u002Fdevops","itemHubs":["devops","build_automation","sys_admin","virtualization","kubernetes"]},{"title":"Java разработчик","vacanciesCount":589,"itemUrl":"https:\u002F\u002Fcareer.habr.com\u002Fvacancies\u002Fjava_developer","itemHubs":["java","javame_dev","gradle"]}],"hubs":"java,devops"},"comments":{"articleComments":{},"searchCommentsResults":null,"previewComment":null,"pagesCount":null,"commentAccess":{},"scrollParents":{},"pageArticleComments":{"lastViewedComment":0,"postId":null,"lastCommentTimestamp":"","moderated":[],"moderatedIds":[],"commentRoute":""}},"companies":{"companyRefs":{},"companyIds":{},"companyTopIds":{},"pagesCount":{},"companyProfiles":{},"companiesCategories":[],"companiesCategoriesTotalCount":0,"companiesWidgets":{},"companiesWorkers":{},"companiesFans":{},"route":{},"isLoading":false,"companyWorkersLoading":false,"companyFansLoading":false,"vacancies":{},"workplaceInfo":null},"companyAdmin":{"companyInfo":null,"companyInfoLoading":false,"faqArticles":null,"brandingPreviewImageUrl":null},"companiesContribution":{"hubs":{},"flows":{},"companyRefs":{}},"companyHubsContribution":{"contributionRefs":{"hubRefs":{},"hubIds":{}}},"conversation":{"messages":[],"respondent":null,"isLoadMore":false},"conversations":{"conversations":[],"unreadCount":0,"pagesCount":0,"isLoadMore":false},"desktopState":{"desktopFl":null,"desktopHl":null,"isChecked":false,"isLoginDemanded":false},"docs":{"menu":{},"articles":{},"mainMenu":[],"loading":{"main":false,"dropdown":false,"article":false}},"feature":{"isProbablyVisible":"true"},"flows":{"flows":[{"alias":"develop","id":1,"route":{"name":"FLOW_PAGE","params":{"flowName":"develop"}}},{"alias":"admin","id":6,"route":{"name":"FLOW_PAGE","params":{"flowName":"admin"}}},{"alias":"design","id":2,"route":{"name":"FLOW_PAGE","params":{"flowName":"design"}}},{"alias":"management","id":3,"route":{"name":"FLOW_PAGE","params":{"flowName":"management"}}},{"alias":"marketing","id":4,"route":{"name":"FLOW_PAGE","params":{"flowName":"marketing"}}},{"alias":"popsci","id":7,"route":{"name":"FLOW_PAGE","params":{"flowName":"popsci"}}}]},"global":{"isPwa":false,"device":"desktop","isHabrCom":true},"hubs":{"hubRefs":{},"hubIds":{},"pagesCount":{},"isLoading":false,"route":{}},"hubsBlock":{"hubRefs":{},"hubIds":{}},"i18n":{"fl":"ru","hl":"ru"},"info":{"infoPage":{},"isLoading":true},"location":{"urlStruct":{"protocol":null,"slashes":null,"auth":null,"host":null,"port":null,"hostname":null,"hash":null,"search":null,"query":{},"pathname":null,"path":null,"href":""},"searchQuery":null},"me":{"user":null,"ppgDemanded":false,"karmaResetInfo":{"canReincarnate":null,"wasReincarnated":null,"currentScore":null},"notes":null},"mostReadingList":{"mostReadingListIds":[],"mostReadingListRefs":null,"promoPost":null},"pinnedPost":{"pinnedPost":null},"ppa":{"articles":{},"card":null,"transactions":null,"totalTransactions":null,"isAccessible":null},"projectsBlocks":{"activeBlocks":{}},"promoData":{"isLoading":false,"hasLoaded":false,"featurer":null,"megaposts":null,"promoLinks":null,"promoPosts":null},"pullRefresh":{"shouldRefresh":false},"sandbox":{"articleIds":[],"articleRefs":{},"pagesCount":null,"route":{},"lastVisitedRoute":{},"isLoading":false},"search":{"searchQueryError":null},"settingsOther":{"inputs":{"uiLang":{"errors":[],"ref":null,"value":""},"articlesLangEnglish":{"errors":[],"ref":null,"value":false},"articlesLangRussian":{"errors":[],"ref":null,"value":false},"agreement":{"errors":[],"ref":null,"value":false},"email":{"errors":[],"ref":null,"value":true},"digest":{"errors":[],"ref":null,"value":true}}},"similarList":{"similarListIds":[],"similarListRefs":null},"ssr":{"error":null,"isDataLoaded":false,"isDataLoading":false,"isHydrationFailed":false,"isServer":false},"technotext":{"nominationsList":[]},"userHubsContribution":{"contributionRefs":{"hubRefs":{},"hubIds":{}}},"userInvites":{"availableInvites":0,"usedInvitesIds":[],"usedInvitesRefs":{},"usedInvitesPagesCount":0,"unusedInvitesIds":[],"unusedInvitesRefs":{},"unusedInvitesPagesCount":0},"users":{"authorRefs":{},"authorIds":{},"pagesCount":{},"authorProfiles":{},"userHubs":{},"userInvitations":{},"authorFollowers":{},"authorFollowed":{},"userSpecialization":{},"karmaStats":[],"statistics":null,"isLoading":false,"authorFollowersLoading":false,"authorFollowedLoading":false,"userHubsLoading":false,"userInvitationsLoading":false,"route":{}},"viewport":{"prevScrollY":{},"scrollY":0,"width":0},"tracker":{"items":{},"pagesCache":{},"markedViewedSilently":{},"markedRead":{},"unreadCounters":{"applications":null,"system":null,"mentions":null,"subscribers":null,"posts_and_comments":null},"unviewedCounters":{"applications":null,"system":null,"mentions":null,"subscribers":null,"posts_and_comments":null}}};(function(){var s;(s=document.currentScript||document.scripts[document.scripts.length-1]).parentNode.removeChild(s);}());</script>
<script src="https://assets.habr.com/habr-web/js/chunk-vendors.da6c6b36.js" defer></script><script src="https://assets.habr.com/habr-web/js/app.92df6f6d.js" defer></script>



    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    </script>
  
  <script type="text/javascript" >
    (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
    m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
    (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

    ym(24049213, "init", {
      defer:true,
      trackLinks:true,
      accurateTrackBounce:true,
      webvisor:false,
    });
  </script>
  <noscript>
    <div>
      <img src="https://mc.yandex.ru/watch/24049213" style="position:absolute; left:-9999px;" alt="" />
    </div>
  </noscript>
  
    <script type="text/javascript">
      window.addEventListener('load', function () {
        setTimeout(() => {
          const img = new Image();
          img.src = 'https://vk.com/rtrg?p=VK-RTRG-421343-57vKE';
        }, 0);
      });
    </script>
  
<script src="https://habr.com/js/ads.js" onload="window['zhY4i4nJ9K'] = true"></script>
</body>
</html>
