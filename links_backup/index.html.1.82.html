<!DOCTYPE html>
<html lang="ru">
<head>
    <link rel="apple-touch-icon" sizes="57x57" href="https://yiiframework.com.ua/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="https://yiiframework.com.ua/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="https://yiiframework.com.ua/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="https://yiiframework.com.ua/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="https://yiiframework.com.ua/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="https://yiiframework.com.ua/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="https://yiiframework.com.ua/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="https://yiiframework.com.ua/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="https://yiiframework.com.ua/apple-touch-icon-180x180.png">
    <link rel="icon" type="image/png" href="https://yiiframework.com.ua/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="https://yiiframework.com.ua/favicon-194x194.png" sizes="194x194">
    <link rel="icon" type="image/png" href="https://yiiframework.com.ua/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="https://yiiframework.com.ua/android-chrome-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="https://yiiframework.com.ua/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="https://yiiframework.com.ua/manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png">
    <meta name="theme-color" content="#1185c7">

    <meta charset="UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="csrf-param" content="_csrf">
    <meta name="csrf-token" content="bUlic1JpREcyPxA.CwYAHgAkDQQwGDJ/XysjPSAKLnE6ByoBZDAHdg==">
    <title>Полное руководство (v2): Active Record - Украинское сообщество Yii Framework</title>
    <meta property="og:image" content="https://yiiframework.com.ua/css/img/logo-square.png">
<meta property="og:site_name" content="Украинское сообщество Yii Framework">
<meta property="og:title" content="Полное руководство (v2): Active Record">
<link href="https://yiiframework.com.ua/assets/70587f1e/image.css" rel="stylesheet">
<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-social/4.12.0/bootstrap-social.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/awesome-bootstrap-checkbox/0.3.7/awesome-bootstrap-checkbox.min.css" rel="stylesheet">
<link href="https://yiiframework.com.ua/css/compiled.min.css?v=1469914490" rel="stylesheet">
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
<![endif]-->
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head>
<body>

    <nav id="nav" class="navbar-inverse navbar-custom navbar-fixed-top navbar"><div class="container"><div class="navbar-header"><button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#nav-collapse"><span class="sr-only">Toggle navigation</span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
<span class="icon-bar"></span></button><a class="navbar-brand" href="https://yiiframework.com.ua/ru/"><img src="https://yiiframework.com.ua/css/img/logo-small.png" alt=""></a></div><div id="nav-collapse" class="collapse navbar-collapse"><ul id="w2" class="navbar-nav navbar-right nav"><li class="dropdown"><a class="dropdown-toggle" href="index.html.1.82.html#" data-toggle="dropdown"><i class="fa fa-indent fa-fw"></i>&nbsp; Разделы <span class="caret"></span></a><ul id="w3" class="dropdown-menu"><li><a href="https://yiiframework.com.ua/ru/posts/" tabindex="-1">Статьи</a></li>
<li class="divider"></li>
<li><a href="https://yiiframework.com.ua/ru/contact/" tabindex="-1">Обратная связь</a></li>
<li><a href="https://yiiframework.com.ua/ru/updates/" tabindex="-1">Обновления cайта</a></li></ul></li>
<li class="dropdown active"><a class="dropdown-toggle" href="index.html.1.82.html#" data-toggle="dropdown"><i class="fa fa-book fa-fw"></i>&nbsp; Документация <span class="caret"></span></a><ul id="w4" class="dropdown-menu"><li class="dropdown-header first">Yii 1.1</li>
<li><a href="https://yiiframework.com.ua/ru/doc/guide/" tabindex="-1">Полное руководство</a></li>
<li><a href="https://yiiframework.com.ua/ru/doc/blog/" tabindex="-1">Создание блога</a></li>
<li><a href="http://www.yiiframework.com/doc/api/" target="_blank" tabindex="-1">Yii API</a></li>
<li><a href="http://yiiapi.com" target="_blank" tabindex="-1">yiiapi.com</a></li>
<li class="divider"></li>
<li class="dropdown-header">Yii 2.*</li>
<li class="active"><a href="https://yiiframework.com.ua/ru/doc/guide/2/" tabindex="-1">Полное руководство</a></li>
<li><a href="http://www.yiiframework.com/doc-2.0/" rel="nofollow" target="_blank" tabindex="-1">Yii 2 API</a></li>
<li class="divider visible-xs"></li></ul></li>
<li class="dropdown"><a class="dropdown-toggle" href="index.html.1.82.html#" data-toggle="dropdown"><i class="fa fa-user fa-fw"></i>&nbsp; Профиль <span class="caret"></span></a><ul id="w5" class="dropdown-menu"><li><a href="https://yiiframework.com.ua/ru/sign-in/" tabindex="-1">Вход</a></li>
<li><a href="https://yiiframework.com.ua/ru/sign-up/" tabindex="-1">Регистрация</a></li></ul></li>
<li class="lang uk"><a href="https://yiiframework.com.ua/uk/" title="Перейти на українську мову">Перейти на <i></i></a></li></ul></div></div></nav>    <div class="container">
        <img src="https://yiiframework.com.ua/css/img/logo.png" alt="Украинское сообщество Yii Framework" title="Украинское сообщество Yii Framework" class="center-block logo"/>
            <div class="row">
        <div class="col-md-4 col-md-push-8">
            <div class="card">
                <div class="card-content">
                    
<div id="doc_toc" class="list-group panel panel-default">
    <div class="panel-heading"><h3 class="panel-title">Оглавление</h3></div>
    <div class="panel-body">
        <a class="list-group-item" href="index.html.1.82.html#chapter2" data-toggle="collapse" data-parent="#doc_toc">Введение <b class="caret"></b></a><div id="chapter2" class="submenu panel-collapse collapse"><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/"><i class="fa fa-angle-right fa-fw"></i>О Yii</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/intro-upgrade-from-v1/"><i class="fa fa-angle-right fa-fw"></i>Обновление с версии 1.1</a></div><a class="list-group-item" href="index.html.1.82.html#chapter3" data-toggle="collapse" data-parent="#doc_toc">Первое знакомство <b class="caret"></b></a><div id="chapter3" class="submenu panel-collapse collapse"><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/start-installation/"><i class="fa fa-angle-right fa-fw"></i>Установка Yii</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/start-workflow/"><i class="fa fa-angle-right fa-fw"></i>Запуск приложения</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/start-hello/"><i class="fa fa-angle-right fa-fw"></i>Говорим «привет»</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/start-forms/"><i class="fa fa-angle-right fa-fw"></i>Работа с формами</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/start-databases/"><i class="fa fa-angle-right fa-fw"></i>Работа с базами данных</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/start-gii/"><i class="fa fa-angle-right fa-fw"></i>Генерация кода при помощи Gii</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/start-looking-ahead/"><i class="fa fa-angle-right fa-fw"></i>Что дальше?</a></div><a class="list-group-item" href="index.html.1.82.html#chapter4" data-toggle="collapse" data-parent="#doc_toc">Структура приложения <b class="caret"></b></a><div id="chapter4" class="submenu panel-collapse collapse"><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/structure-overview/"><i class="fa fa-angle-right fa-fw"></i>Обзор</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/structure-entry-scripts/"><i class="fa fa-angle-right fa-fw"></i>Входные скрипты</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/structure-applications/"><i class="fa fa-angle-right fa-fw"></i>Приложения</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/structure-application-components/"><i class="fa fa-angle-right fa-fw"></i>Компоненты приложения</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/structure-controllers/"><i class="fa fa-angle-right fa-fw"></i>Контроллеры</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/structure-models/"><i class="fa fa-angle-right fa-fw"></i>Модели</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/structure-views/"><i class="fa fa-angle-right fa-fw"></i>Представления</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/structure-modules/"><i class="fa fa-angle-right fa-fw"></i>Модули</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/structure-filters/"><i class="fa fa-angle-right fa-fw"></i>Фильтры</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/structure-widgets/"><i class="fa fa-angle-right fa-fw"></i>Виджеты</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/structure-assets/"><i class="fa fa-angle-right fa-fw"></i>Ресурсы</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/structure-extensions/"><i class="fa fa-angle-right fa-fw"></i>Расширения</a></div><a class="list-group-item" href="index.html.1.82.html#chapter5" data-toggle="collapse" data-parent="#doc_toc">Обработка запросов <b class="caret"></b></a><div id="chapter5" class="submenu panel-collapse collapse"><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/runtime-overview/"><i class="fa fa-angle-right fa-fw"></i>Обзор</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/runtime-bootstrapping/"><i class="fa fa-angle-right fa-fw"></i>Bootstrapping</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/runtime-routing/"><i class="fa fa-angle-right fa-fw"></i>Разбор и генерация URL</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/runtime-requests/"><i class="fa fa-angle-right fa-fw"></i>Запросы</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/runtime-responses/"><i class="fa fa-angle-right fa-fw"></i>Ответы</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/runtime-sessions-cookies/"><i class="fa fa-angle-right fa-fw"></i>Сессии и куки</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/runtime-handling-errors/"><i class="fa fa-angle-right fa-fw"></i>Обработка ошибок</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/runtime-logging/"><i class="fa fa-angle-right fa-fw"></i>Логирование</a></div><a class="list-group-item" href="index.html.1.82.html#chapter6" data-toggle="collapse" data-parent="#doc_toc">Основные понятия <b class="caret"></b></a><div id="chapter6" class="submenu panel-collapse collapse"><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/concept-components/"><i class="fa fa-angle-right fa-fw"></i>Компоненты</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/concept-properties/"><i class="fa fa-angle-right fa-fw"></i>Свойства</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/concept-events/"><i class="fa fa-angle-right fa-fw"></i>События</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/concept-behaviors/"><i class="fa fa-angle-right fa-fw"></i>Поведения</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/concept-configurations/"><i class="fa fa-angle-right fa-fw"></i>Конфигурации</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/concept-aliases/"><i class="fa fa-angle-right fa-fw"></i>Псевдонимы</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/concept-autoloading/"><i class="fa fa-angle-right fa-fw"></i>Автозагрузка классов</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/concept-service-locator/"><i class="fa fa-angle-right fa-fw"></i>Service Locator</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/concept-di-container/"><i class="fa fa-angle-right fa-fw"></i>Dependency Injection Container</a></div><a class="list-group-item active" href="index.html.1.82.html#chapter7" data-toggle="collapse" data-parent="#doc_toc">Работа с базами данных <b class="caret"></b></a><div id="chapter7" class="submenu panel-collapse collapse in"><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/db-dao/"><i class="fa fa-angle-right fa-fw"></i>Объекты доступа к данным (DAO)</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/db-query-builder/"><i class="fa fa-angle-right fa-fw"></i>Построитель запросов</a><a class="list-group-item active" href="index.html.1.82.html"><i class="fa fa-angle-right fa-fw"></i>Active Record</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/db-migrations/"><i class="fa fa-angle-right fa-fw"></i>Миграции</a></div><a class="list-group-item" href="index.html.1.82.html#chapter8" data-toggle="collapse" data-parent="#doc_toc">Получение данных от пользователя <b class="caret"></b></a><div id="chapter8" class="submenu panel-collapse collapse"><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/input-forms/"><i class="fa fa-angle-right fa-fw"></i>Создание форм</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/input-validation/"><i class="fa fa-angle-right fa-fw"></i>Валидация</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/input-file-upload/"><i class="fa fa-angle-right fa-fw"></i>Загрузка файлов</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/input-tabular-input/"><i class="fa fa-angle-right fa-fw"></i>Табличный ввод</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/input-multiple-models/"><i class="fa fa-angle-right fa-fw"></i>Работа с несколькими моделями</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/input-form-javascript/"><i class="fa fa-angle-right fa-fw"></i>Расширение ActiveForm на стороне клиента</a></div><a class="list-group-item" href="index.html.1.82.html#chapter9" data-toggle="collapse" data-parent="#doc_toc">Отображение данных <b class="caret"></b></a><div id="chapter9" class="submenu panel-collapse collapse"><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/output-formatting/"><i class="fa fa-angle-right fa-fw"></i>Форматирование данных</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/output-pagination/"><i class="fa fa-angle-right fa-fw"></i>Постраничная разбивка</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/output-sorting/"><i class="fa fa-angle-right fa-fw"></i>Сортировка</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/output-data-providers/"><i class="fa fa-angle-right fa-fw"></i>Провайдеры данных</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/output-data-widgets/"><i class="fa fa-angle-right fa-fw"></i>Виджеты для данных</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/output-client-scripts/"><i class="fa fa-angle-right fa-fw"></i>Работа с клиентскими скриптами</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/output-theming/"><i class="fa fa-angle-right fa-fw"></i>Темизация</a></div><a class="list-group-item" href="index.html.1.82.html#chapter10" data-toggle="collapse" data-parent="#doc_toc">Безопасность <b class="caret"></b></a><div id="chapter10" class="submenu panel-collapse collapse"><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/security-overview/"><i class="fa fa-angle-right fa-fw"></i>Обзор</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/security-authentication/"><i class="fa fa-angle-right fa-fw"></i>Аутентификация</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/security-authorization/"><i class="fa fa-angle-right fa-fw"></i>Авторизация</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/security-passwords/"><i class="fa fa-angle-right fa-fw"></i>Работа с паролями</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/security-cryptography/"><i class="fa fa-angle-right fa-fw"></i>Криптография</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/security-best-practices/"><i class="fa fa-angle-right fa-fw"></i>Лучшие практики</a></div><a class="list-group-item" href="index.html.1.82.html#chapter11" data-toggle="collapse" data-parent="#doc_toc">Кеширование <b class="caret"></b></a><div id="chapter11" class="submenu panel-collapse collapse"><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/caching-overview/"><i class="fa fa-angle-right fa-fw"></i>Обзор</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/caching-data/"><i class="fa fa-angle-right fa-fw"></i>Кэширование данных</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/caching-fragment/"><i class="fa fa-angle-right fa-fw"></i>Кэширование фрагментов</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/caching-page/"><i class="fa fa-angle-right fa-fw"></i>Кэширование страниц</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/caching-http/"><i class="fa fa-angle-right fa-fw"></i>HTTP кэширование</a></div><a class="list-group-item" href="index.html.1.82.html#chapter12" data-toggle="collapse" data-parent="#doc_toc">Веб-сервисы REST <b class="caret"></b></a><div id="chapter12" class="submenu panel-collapse collapse"><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/rest-quick-start/"><i class="fa fa-angle-right fa-fw"></i>Быстрый старт</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/rest-resources/"><i class="fa fa-angle-right fa-fw"></i>Ресурсы</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/rest-controllers/"><i class="fa fa-angle-right fa-fw"></i>Контроллеры</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/rest-routing/"><i class="fa fa-angle-right fa-fw"></i>Роутинг</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/rest-response-formatting/"><i class="fa fa-angle-right fa-fw"></i>Форматирование ответа</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/rest-authentication/"><i class="fa fa-angle-right fa-fw"></i>Аутентификация</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/rest-rate-limiting/"><i class="fa fa-angle-right fa-fw"></i>Ограничение частоты запросов</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/rest-versioning/"><i class="fa fa-angle-right fa-fw"></i>Версионирование</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/rest-error-handling/"><i class="fa fa-angle-right fa-fw"></i>Обработка ошибок</a></div><a class="list-group-item" href="index.html.1.82.html#chapter14" data-toggle="collapse" data-parent="#doc_toc">Тестирование <b class="caret"></b></a><div id="chapter14" class="submenu panel-collapse collapse"><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/test-overview/"><i class="fa fa-angle-right fa-fw"></i>Обзор</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/test-environment-setup/"><i class="fa fa-angle-right fa-fw"></i>Настройка тестового окружения</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/test-unit/"><i class="fa fa-angle-right fa-fw"></i>Модульные тесты</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/test-functional/"><i class="fa fa-angle-right fa-fw"></i>Функциональные тесты</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/test-acceptance/"><i class="fa fa-angle-right fa-fw"></i>Приёмочные тесты</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/test-fixtures/"><i class="fa fa-angle-right fa-fw"></i>Фикстуры</a></div><a class="list-group-item" href="index.html.1.82.html#chapter15" data-toggle="collapse" data-parent="#doc_toc">Специальные темы <b class="caret"></b></a><div id="chapter15" class="submenu panel-collapse collapse"><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/tutorial-start-from-scratch/"><i class="fa fa-angle-right fa-fw"></i>Создание приложения с нуля</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/tutorial-console/"><i class="fa fa-angle-right fa-fw"></i>Консольные команды</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/tutorial-core-validators/"><i class="fa fa-angle-right fa-fw"></i>Встроенные валидаторы</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/tutorial-i18n/"><i class="fa fa-angle-right fa-fw"></i>Интернационализация</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/tutorial-mailing/"><i class="fa fa-angle-right fa-fw"></i>Отправка почты</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/tutorial-performance-tuning/"><i class="fa fa-angle-right fa-fw"></i>Оптимизация производительности</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/tutorial-shared-hosting/"><i class="fa fa-angle-right fa-fw"></i>Окружение виртуального хостинга</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/tutorial-template-engines/"><i class="fa fa-angle-right fa-fw"></i>Шаблонизаторы</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/tutorial-yii-integration/"><i class="fa fa-angle-right fa-fw"></i>Работа со сторонним кодом</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/tutorial-yii-as-micro-framework/"><i class="fa fa-angle-right fa-fw"></i>Использование Yii в качестве микро-framework'а</a></div><a class="list-group-item" href="index.html.1.82.html#chapter16" data-toggle="collapse" data-parent="#doc_toc">Виджеты <b class="caret"></b></a><div id="chapter16" class="submenu panel-collapse collapse"><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/yii-grid-gridview/"><i class="fa fa-angle-right fa-fw"></i>GridView</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/yii-widgets-listview/"><i class="fa fa-angle-right fa-fw"></i>ListView</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/yii-widgets-detailview/"><i class="fa fa-angle-right fa-fw"></i>DetailView</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/guide-input-forms/"><i class="fa fa-angle-right fa-fw"></i>ActiveForm</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/yii-widgets-pjax/"><i class="fa fa-angle-right fa-fw"></i>Pjax</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/yii-widgets-menu/"><i class="fa fa-angle-right fa-fw"></i>Menu</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/yii-widgets-linkpager/"><i class="fa fa-angle-right fa-fw"></i>LinkPager</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/yii-widgets-linksorter/"><i class="fa fa-angle-right fa-fw"></i>LinkSorter</a></div><a class="list-group-item" href="index.html.1.82.html#chapter17" data-toggle="collapse" data-parent="#doc_toc">Хелперы <b class="caret"></b></a><div id="chapter17" class="submenu panel-collapse collapse"><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/helper-overview/"><i class="fa fa-angle-right fa-fw"></i>Обзор</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/helper-array/"><i class="fa fa-angle-right fa-fw"></i>ArrayHelper</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/helper-html/"><i class="fa fa-angle-right fa-fw"></i>Html</a><a class="list-group-item" href="https://yiiframework.com.ua/ru/doc/guide/2/helper-url/"><i class="fa fa-angle-right fa-fw"></i>Url хелпер</a></div>    </div>
</div>                </div>
            </div>

            <div class="card">
                <div class="card-content">
                    <script src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js" async></script><!-- Documentation --><ins class="adsbygoogle" style="display: block;" data-ad-client="ca-pub-8275858625830540" data-ad-slot="7690380517" data-ad-format="auto"></ins><small style="margin-top: 10px; display: block;"><a href="https://yiiframework.com.ua/ru/adv/" rel="nofollow" target="_blank">Зачем реклама?</a></small><script>(adsbygoogle = window.adsbygoogle || []).push({})</script>                </div>
            </div>
        </div>
        <div class="col-md-8 col-md-pull-4">
            <div class="card">
                <div class="card-content">
                    <ul class="breadcrumb breadcrumb_doc"><li><a href="https://yiiframework.com.ua/ru/doc/guide/2/">Полное руководство (v2)</a></li>
<li class="active">Работа с базами данных</li>
<li class="active">Active Record</li>
</ul>                                        
<div class="documentation-content section-guide version-2">
    <h1>Active Record</h1>
<p><a href="http://ru.wikipedia.org/wiki/ActiveRecord" target="_blank">Active Record</a> обеспечивает объектно-ориентированный интерфейс для доступа
и манипулирования данными, хранящимися в базах данных. Класс Active Record соответствует таблице в базе данных, объект
Active Record соответствует строке этой таблицы, а <em>атрибут</em> объекта Active Record представляет собой значение
отдельного столбца строки. Вместо непосредственного написания SQL-выражений вы сможете получать доступ к атрибутам
Active Record и вызывать методы Active Record для доступа и манипулирования данными, хранящимися в таблицах базы данных.</p>
<p>Для примера предположим, что <code>Customer</code> - это класс Active Record, который сопоставлен с таблицей <code>customer</code>, а <code>name</code> -
столбец в таблице <code>customer</code>. Тогда вы можете написать следующий код для вставки новой строки в таблицу <code>customer</code>:</p>
<pre><code class="language-php"><span style="color: #0000BB">$customer&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">();<br /></span><span style="color: #0000BB">$customer</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">name&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">'Qiang'</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">$customer</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">save</span><span style="color: #007700">();</span>
</code></pre>
<p>Вышеприведённый код аналогичен использованию следующего SQL-выражения в MySQL, которое менее интуитивно, потенциально
может вызвать ошибки и даже проблемы совместимости, если вы используете различные виды баз данных:</p>
<pre><code class="language-php"><span style="color: #0000BB">$db</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">createCommand</span><span style="color: #007700">(</span><span style="color: #DD0000">'INSERT&nbsp;INTO&nbsp;`customer`&nbsp;(`name`)&nbsp;VALUES&nbsp;(:name)'</span><span style="color: #007700">,&nbsp;[<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">':name'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'Qiang'</span><span style="color: #007700">,<br />])-&gt;</span><span style="color: #0000BB">execute</span><span style="color: #007700">();</span>
</code></pre>
<p>Yii поддерживает работу с Active Record для следующих реляционных баз данных:</p>
<ul>
<li>MySQL 4.1 и выше: посредством <a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html" title="yii\db\ActiveRecord" target="_blank">yii\db\ActiveRecord</a></li>
<li>PostgreSQL 7.3 и выше: посредством <a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html" title="yii\db\ActiveRecord" target="_blank">yii\db\ActiveRecord</a></li>
<li>SQLite 2 и 3: посредством <a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html" title="yii\db\ActiveRecord" target="_blank">yii\db\ActiveRecord</a></li>
<li>Microsoft SQL Server 2008 и выше: посредством <a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html" title="yii\db\ActiveRecord" target="_blank">yii\db\ActiveRecord</a></li>
<li>Oracle: посредством <a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html" title="yii\db\ActiveRecord" target="_blank">yii\db\ActiveRecord</a></li>
<li>CUBRID 9.3 и выше: посредством <a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html" title="yii\db\ActiveRecord" target="_blank">yii\db\ActiveRecord</a> (Имейте в виду, что вследствие
<a href="http://jira.cubrid.org/browse/APIS-658" target="_blank">бага</a> в PDO-расширении для CUBRID, заключение значений в кавычки не работает,
поэтому необходимо использовать CUBRID версии 9.3 как на клиентской стороне, так и на сервере)</li>
<li>Sphinx: посредством <a href="http://www.yiiframework.com/doc-2.0/yii-sphinx-activerecord.html" title="yii\sphinx\ActiveRecord" target="_blank">yii\sphinx\ActiveRecord</a>, потребуется расширение <code>yii2-sphinx</code></li>
<li>ElasticSearch: посредством <a href="http://www.yiiframework.com/doc-2.0/yii-elasticsearch-activerecord.html" title="yii\elasticsearch\ActiveRecord" target="_blank">yii\elasticsearch\ActiveRecord</a>, потребуется расширение <code>yii2-elasticsearch</code></li>
</ul>
<p>Кроме того Yii поддерживает использование Active Record со следующими NoSQL базами данных:</p>
<ul>
<li>Redis 2.6.12 и выше: посредством <a href="http://www.yiiframework.com/doc-2.0/yii-redis-activerecord.html" title="yii\redis\ActiveRecord" target="_blank">yii\redis\ActiveRecord</a>, потребуется расширение <code>yii2-redis</code></li>
<li>MongoDB 1.3.0 и выше: посредством <a href="http://www.yiiframework.com/doc-2.0/yii-mongodb-activerecord.html" title="yii\mongodb\ActiveRecord" target="_blank">yii\mongodb\ActiveRecord</a>, потребуется расширение <code>yii2-mongodb</code></li>
</ul>
<p>В этом руководстве мы в основном будем описывать использование Active Record для реляционных баз данных. Однако большая
часть этого материала также применима при использовании Active Record с NoSQL базами данных.</p>
<h2>Объявление классов Active Record<span id="declaring-ar-classes"></span> <a href="index.html.1.82.html#declaring-ar-classes" class="hashlink">#</a></h2><p>Для начала объявите свой собственный класс, унаследовав класс <a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html" title="yii\db\ActiveRecord" target="_blank">yii\db\ActiveRecord</a>.</p>
<h3>Настройка имени таблицы<span id="nastrojka-imeni-tablicy"></span> <a href="index.html.1.82.html#nastrojka-imeni-tablicy" class="hashlink">#</a></h3><p>По умолчанию каждый класс Active Record ассоциирован с таблицей в базе данных. Метод
<a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#tableName()-detail" title="tableName()" target="_blank">tableName()</a> получает имя таблицы из имени класса с помощью <a href="http://www.yiiframework.com/doc-2.0/yii-helpers-inflector.html#camel2id()-detail" title="yii\helpers\Inflector::camel2id()" target="_blank">yii\helpers\Inflector::camel2id()</a>.
Если таблица не названа соответственно, вы можете переопределить данный метод.</p>
<p>Также может быть применён <a href="http://www.yiiframework.com/doc-2.0/yii-db-connection.html#$tablePrefix-detail" title="tablePrefix" target="_blank">tablePrefix</a> по умолчанию. Например, если 
<a href="http://www.yiiframework.com/doc-2.0/yii-db-connection.html#$tablePrefix-detail" title="tablePrefix" target="_blank">tablePrefix</a> задан как <code>tbl_</code>, <code>Customer</code> преобразуется в <code>tbl_customer</code>, а
<code>OrderItem</code> в <code>tbl_order_item</code>. </p>
<p>Если имя таблицы указано в формате <code>{{%TableName}}</code>, символ <code>%</code> заменяется префиксом. Например <code>{{%post}}</code> становится
<code>{{tbl_post}}</code>. Фигуриные скобки используются для <a href="https://yiiframework.com.ua/ru/doc/guide/2/db-dao/#quoting-table-and-column-names">экранирования в SQL-запросах</a>.</p>
<p>В нижеследующем примере мы объявляем класс Active Record с названием <code>Customer</code> для таблицы <code>customer</code>.</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #007700">namespace&nbsp;</span><span style="color: #0000BB">app</span><span style="color: #007700">\</span><span style="color: #0000BB">models</span><span style="color: #007700">;<br /><br />use&nbsp;</span><span style="color: #0000BB">yii</span><span style="color: #007700">\</span><span style="color: #0000BB">db</span><span style="color: #007700">\</span><span style="color: #0000BB">ActiveRecord</span><span style="color: #007700">;<br /><br />class&nbsp;</span><span style="color: #0000BB">Customer&nbsp;</span><span style="color: #007700">extends&nbsp;</span><span style="color: #0000BB">ActiveRecord<br /></span><span style="color: #007700">{<br />&nbsp;&nbsp;&nbsp;&nbsp;const&nbsp;</span><span style="color: #0000BB">STATUS_INACTIVE&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">0</span><span style="color: #007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;const&nbsp;</span><span style="color: #0000BB">STATUS_ACTIVE&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">1</span><span style="color: #007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;string&nbsp;название&nbsp;таблицы,&nbsp;сопоставленной&nbsp;с&nbsp;этим&nbsp;ActiveRecord-классом.<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">public&nbsp;static&nbsp;function&nbsp;</span><span style="color: #0000BB">tableName</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #DD0000">'{{customer}}'</span><span style="color: #007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />}</span>
</code></pre>
<h3>Классы Active record называются "моделями"<span id="klassy-active-record-nazyvautsa-modelami"></span> <a href="index.html.1.82.html#klassy-active-record-nazyvautsa-modelami" class="hashlink">#</a></h3><p>Объекты Active Record являются <a href="https://yiiframework.com.ua/ru/doc/guide/2/structure-models/">моделями</a>. Именно поэтому мы обычно задаём классам Active Record
пространство имён <code>app\models</code> (или другое пространство имён, предназначенное для моделей). </p>
<p>Т.к. класс <a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html" title="yii\db\ActiveRecord" target="_blank">yii\db\ActiveRecord</a> наследует класс <a href="http://www.yiiframework.com/doc-2.0/yii-base-model.html" title="yii\base\Model" target="_blank">yii\base\Model</a>, он обладает <em>всеми</em> возможностями
<a href="https://yiiframework.com.ua/ru/doc/guide/2/structure-models/">моделей</a>, такими как атрибуты, правила валидации, способы сериализации данных и т.д.</p>
<h2>Подключение к базам данных<span id="db-connection"></span> <a href="index.html.1.82.html#db-connection" class="hashlink">#</a></h2><p>По умолчанию Active Record для доступа и манипулирования данными БД использует
<a href="https://yiiframework.com.ua/ru/doc/guide/2/structure-application-components/">компонент приложения</a> <code>db</code> в качестве компонента
<a href="http://www.yiiframework.com/doc-2.0/yii-db-connection.html" title="DB connection" target="_blank">DB connection</a>. Как сказано в разделе <a href="https://yiiframework.com.ua/ru/doc/guide/2/db-dao/">Объекты доступа к данным (DAO)</a>, вы можете
настраивать компонент <code>db</code> на уровне конфигурации приложения как показано ниже:</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #007700">return&nbsp;[<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'components'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;[<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'db'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;[<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'class'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'yii\db\Connection'</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'dsn'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'mysql:host=localhost;dbname=testdb'</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'username'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'demo'</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'password'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'demo'</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;],<br />&nbsp;&nbsp;&nbsp;&nbsp;],<br />];</span>
</code></pre>
<p>Если вы хотите использовать для подключения к базе данных другой компонент подключения, отличный от <code>db</code>, вам нужно
переопределить метод <a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#getDb()-detail" title="getDb()" target="_blank">getDb()</a>:</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #007700">class&nbsp;</span><span style="color: #0000BB">Customer&nbsp;</span><span style="color: #007700">extends&nbsp;</span><span style="color: #0000BB">ActiveRecord<br /></span><span style="color: #007700">{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;...<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">public&nbsp;static&nbsp;function&nbsp;</span><span style="color: #0000BB">getDb</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;использовать&nbsp;компонент&nbsp;приложения&nbsp;"db2"<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">return&nbsp;\</span><span style="color: #0000BB">Yii</span><span style="color: #007700">::</span><span style="color: #0000BB">$app</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">db2</span><span style="color: #007700">;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />}</span>
</code></pre>
<h2>Получение данных<span id="querying-data"></span> <a href="index.html.1.82.html#querying-data" class="hashlink">#</a></h2><p>После объявления класса Active Record вы можете использовать его для получения данных из соответствующей таблицы базы
данных. Этот процесс, как правило, состоит из следующих трёх шагов:</p>
<ol>
<li>Создать новый объект запроса вызовом метода <a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#find()-detail" title="yii\db\ActiveRecord::find()" target="_blank">yii\db\ActiveRecord::find()</a>;</li>
<li>Настроить объект запроса вызовом <a href="https://yiiframework.com.ua/ru/doc/guide/2/db-query-builder/#building-queries">методов построения запросов</a>;</li>
<li>Вызвать один из <a href="https://yiiframework.com.ua/ru/doc/guide/2/db-query-builder/#query-methods">методов получения данных</a> для извлечения данных в виде объектов
Active Record.</li>
</ol>
<p>Как вы могли заметить, эти шаги очень похожи на работу с <a href="https://yiiframework.com.ua/ru/doc/guide/2/db-query-builder/">построителем запросов</a>. Различие лишь в
том, что для создания объекта запроса вместо оператора <code>new</code> используется метод <a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#find()-detail" title="yii\db\ActiveRecord::find()" target="_blank">yii\db\ActiveRecord::find()</a>,
возвращающий новый объект запроса, являющийся представителем класса <a href="http://www.yiiframework.com/doc-2.0/yii-db-activequery.html" title="yii\db\ActiveQuery" target="_blank">yii\db\ActiveQuery</a>.</p>
<p>Ниже приведено несколько примеров использования Active Query для получения данных:</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #FF8000">//&nbsp;возвращает&nbsp;покупателя&nbsp;с&nbsp;идентификатором&nbsp;123<br />//&nbsp;SELECT&nbsp;*&nbsp;FROM&nbsp;`customer`&nbsp;WHERE&nbsp;`id`&nbsp;=&nbsp;123<br /></span><span style="color: #0000BB">$customer&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">find</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;-&gt;</span><span style="color: #0000BB">where</span><span style="color: #007700">([</span><span style="color: #DD0000">'id'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">123</span><span style="color: #007700">])<br />&nbsp;&nbsp;&nbsp;&nbsp;-&gt;</span><span style="color: #0000BB">one</span><span style="color: #007700">();<br /><br /></span><span style="color: #FF8000">//&nbsp;возвращает&nbsp;всех&nbsp;активных&nbsp;покупателей,&nbsp;сортируя&nbsp;их&nbsp;по&nbsp;идентификаторам<br />//&nbsp;SELECT&nbsp;*&nbsp;FROM&nbsp;`customer`&nbsp;WHERE&nbsp;`status`&nbsp;=&nbsp;1&nbsp;ORDER&nbsp;BY&nbsp;`id`<br /></span><span style="color: #0000BB">$customers&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">find</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;-&gt;</span><span style="color: #0000BB">where</span><span style="color: #007700">([</span><span style="color: #DD0000">'status'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">STATUS_ACTIVE</span><span style="color: #007700">])<br />&nbsp;&nbsp;&nbsp;&nbsp;-&gt;</span><span style="color: #0000BB">orderBy</span><span style="color: #007700">(</span><span style="color: #DD0000">'id'</span><span style="color: #007700">)<br />&nbsp;&nbsp;&nbsp;&nbsp;-&gt;</span><span style="color: #0000BB">all</span><span style="color: #007700">();<br /><br /></span><span style="color: #FF8000">//&nbsp;возвращает&nbsp;количество&nbsp;активных&nbsp;покупателей<br />//&nbsp;SELECT&nbsp;COUNT(*)&nbsp;FROM&nbsp;`customer`&nbsp;WHERE&nbsp;`status`&nbsp;=&nbsp;1<br /></span><span style="color: #0000BB">$count&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">find</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;-&gt;</span><span style="color: #0000BB">where</span><span style="color: #007700">([</span><span style="color: #DD0000">'status'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">STATUS_ACTIVE</span><span style="color: #007700">])<br />&nbsp;&nbsp;&nbsp;&nbsp;-&gt;</span><span style="color: #0000BB">count</span><span style="color: #007700">();<br /><br /></span><span style="color: #FF8000">//&nbsp;возвращает&nbsp;всех&nbsp;покупателей&nbsp;массивом,&nbsp;индексированным&nbsp;их&nbsp;идентификаторами<br />//&nbsp;SELECT&nbsp;*&nbsp;FROM&nbsp;`customer`<br /></span><span style="color: #0000BB">$customers&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">find</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;-&gt;</span><span style="color: #0000BB">indexBy</span><span style="color: #007700">(</span><span style="color: #DD0000">'id'</span><span style="color: #007700">)<br />&nbsp;&nbsp;&nbsp;&nbsp;-&gt;</span><span style="color: #0000BB">all</span><span style="color: #007700">();</span>
</code></pre>
<p>В примерах выше <code>$customer</code> - это объект класса <code>Customer</code>, в то время как <code>$customers</code> - это массив таких объектов. Все
эти объекты заполнены данными таблицы <code>customer</code>.</p>
<blockquote><p><strong>Info:</strong> Т.к. класс <a href="http://www.yiiframework.com/doc-2.0/yii-db-activequery.html" title="yii\db\ActiveQuery" target="_blank">yii\db\ActiveQuery</a> наследует <a href="http://www.yiiframework.com/doc-2.0/yii-db-query.html" title="yii\db\Query" target="_blank">yii\db\Query</a>, вы можете использовать в нём <em>все</em> методы
  построения запросов и все методы класса Query как описано в разделе <a href="https://yiiframework.com.ua/ru/doc/guide/2/db-query-builder/">Построитель запросов</a>.</p>
</blockquote>
<p>Т.к. извлечение данных по первичному ключу или значениям отдельных столбцов достаточно распространённая задача, Yii
предоставляет два коротких метода для её решения:</p>
<ul>
<li><a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#findOne()-detail" title="yii\db\ActiveRecord::findOne()" target="_blank">yii\db\ActiveRecord::findOne()</a>: возвращает один объект Active Record, заполненный первой строкой результата запроса.</li>
<li><a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#findAll()-detail" title="yii\db\ActiveRecord::findAll()" target="_blank">yii\db\ActiveRecord::findAll()</a>: возвращает массив объектов Active Record, заполненных <em>всеми</em> полученными результатами запроса.</li>
</ul>
<p>Оба метода могут принимать параметры в одном из следующих форматов:</p>
<ul>
<li>скалярное значение: значение интерпретируется как первичный ключ, по которому следует искать. Yii прочитает
информацию о структуре базы данных и автоматически определит, какой столбец таблицы содержит первичные ключи.</li>
<li>массив скалярных значений: массив интерпретируется как набор первичных ключей, по которым следует искать.</li>
<li>ассоциативный массив: ключи массива интерпретируются как названия столбцов, а значения - как содержимое столбцов,
которое следует искать. За подробностями вы можете обратиться к разделу <a href="https://yiiframework.com.ua/ru/doc/guide/2/db-query-builder/#hash-format">Hash Format</a></li>
</ul>
<p>Нижеследующий код демонстрирует, каким образом эти методы могут быть использованы:</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #FF8000">//&nbsp;возвращает&nbsp;покупателя&nbsp;с&nbsp;идентификатором&nbsp;123<br />//&nbsp;SELECT&nbsp;*&nbsp;FROM&nbsp;`customer`&nbsp;WHERE&nbsp;`id`&nbsp;=&nbsp;123<br /></span><span style="color: #0000BB">$customer&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">findOne</span><span style="color: #007700">(</span><span style="color: #0000BB">123</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000">//&nbsp;возвращает&nbsp;покупателей&nbsp;с&nbsp;идентификаторами&nbsp;100,&nbsp;101,&nbsp;123&nbsp;и&nbsp;124<br />//&nbsp;SELECT&nbsp;*&nbsp;FROM&nbsp;`customer`&nbsp;WHERE&nbsp;`id`&nbsp;IN&nbsp;(100,&nbsp;101,&nbsp;123,&nbsp;124)<br /></span><span style="color: #0000BB">$customers&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">findAll</span><span style="color: #007700">([</span><span style="color: #0000BB">100</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">101</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">123</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">124</span><span style="color: #007700">]);<br /><br /></span><span style="color: #FF8000">//&nbsp;возвращает&nbsp;активного&nbsp;покупателя&nbsp;с&nbsp;идентификатором&nbsp;123<br />//&nbsp;SELECT&nbsp;*&nbsp;FROM&nbsp;`customer`&nbsp;WHERE&nbsp;`id`&nbsp;=&nbsp;123&nbsp;AND&nbsp;`status`&nbsp;=&nbsp;1<br /></span><span style="color: #0000BB">$customer&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">findOne</span><span style="color: #007700">([<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'id'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">123</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'status'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">STATUS_ACTIVE</span><span style="color: #007700">,<br />]);<br /><br /></span><span style="color: #FF8000">//&nbsp;возвращает&nbsp;всех&nbsp;неактивных&nbsp;покупателей<br />//&nbsp;SELECT&nbsp;*&nbsp;FROM&nbsp;`customer`&nbsp;WHERE&nbsp;`status`&nbsp;=&nbsp;0<br /></span><span style="color: #0000BB">$customers&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">findAll</span><span style="color: #007700">([<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'status'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">STATUS_INACTIVE</span><span style="color: #007700">,<br />]);</span>
</code></pre>
<blockquote><p><strong>Warning:</strong> Если вам нужно передать в эти методы данные, полученные от пользователя, убедитесь что передаваемое значение – это скаляр,
а если необходимо указать условия в формате массива – убедитесь, что пользовательские данные не могут изменить структуру этого массива.</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #FF8000">//&nbsp;yii\web\Controller&nbsp;гарантирует,&nbsp;что&nbsp;$id&nbsp;будет&nbsp;скаляром<br /></span><span style="color: #007700">public&nbsp;function&nbsp;</span><span style="color: #0000BB">actionView</span><span style="color: #007700">(</span><span style="color: #0000BB">$id</span><span style="color: #007700">)<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$model&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Post</span><span style="color: #007700">::</span><span style="color: #0000BB">findOne</span><span style="color: #007700">(</span><span style="color: #0000BB">$id</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;...<br /></span><span style="color: #007700">}<br /><br /></span><span style="color: #FF8000">//&nbsp;явное&nbsp;указание&nbsp;имени&nbsp;столбца&nbsp;для&nbsp;поиска&nbsp;гарантирует&nbsp;поиск&nbsp;по&nbsp;столбцу&nbsp;`id`,<br />//&nbsp;и&nbsp;возвращение&nbsp;одной&nbsp;записи&nbsp;как&nbsp;для&nbsp;массива,&nbsp;так&nbsp;и&nbsp;для&nbsp;скаляра&nbsp;в&nbsp;принятом&nbsp;от&nbsp;пользователя&nbsp;поле&nbsp;`id`&nbsp;<br /></span><span style="color: #0000BB">$model&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Post</span><span style="color: #007700">::</span><span style="color: #0000BB">findOne</span><span style="color: #007700">([</span><span style="color: #DD0000">'id'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">Yii</span><span style="color: #007700">::</span><span style="color: #0000BB">$app</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">request</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">get</span><span style="color: #007700">(</span><span style="color: #DD0000">'id'</span><span style="color: #007700">)]);<br /><br /></span><span style="color: #FF8000">//&nbsp;НЕ&nbsp;используйте&nbsp;этот&nbsp;код!&nbsp;Пользователь&nbsp;может&nbsp;передать&nbsp;в&nbsp;параметр&nbsp;`id`&nbsp;массив<br />//&nbsp;и&nbsp;осуществить&nbsp;поиск&nbsp;по&nbsp;имени&nbsp;столбца,&nbsp;которое&nbsp;не&nbsp;должно&nbsp;быть&nbsp;использовано&nbsp;для&nbsp;поиска&nbsp;по&nbsp;логике&nbsp;вашего&nbsp;приложения.<br /></span><span style="color: #0000BB">$model&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Post</span><span style="color: #007700">::</span><span style="color: #0000BB">findOne</span><span style="color: #007700">(</span><span style="color: #0000BB">Yii</span><span style="color: #007700">::</span><span style="color: #0000BB">$app</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">request</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">get</span><span style="color: #007700">(</span><span style="color: #DD0000">'id'</span><span style="color: #007700">));</span>
</code></pre>
</blockquote>
<blockquote><p><strong>Note:</strong> Ни метод <a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#findOne()-detail" title="yii\db\ActiveRecord::findOne()" target="_blank">yii\db\ActiveRecord::findOne()</a>, ни <a href="http://www.yiiframework.com/doc-2.0/yii-db-activequery.html#one()-detail" title="yii\db\ActiveQuery::one()" target="_blank">yii\db\ActiveQuery::one()</a> не добавляет условие <code>LIMIT 1</code> к
  генерируемым SQL-запросам. Если ваш запрос может вернуть много строк данных, вы должны вызвать метод <code>limit(1)</code> явно
  в целях улучшения производительности, например: <code>Customer::find()-&gt;limit(1)-&gt;one()</code>.</p>
</blockquote>
<p>Помимо использования методов построения запросов вы можете также писать запросы на "чистом" SQL для получения данных и
заполнения ими объектов Active Record. Вы можете делать это посредством метода <a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#findBySql()-detail" title="yii\db\ActiveRecord::findBySql()" target="_blank">yii\db\ActiveRecord::findBySql()</a>:</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #FF8000">//&nbsp;возвращает&nbsp;всех&nbsp;неактивных&nbsp;покупателей<br /></span><span style="color: #0000BB">$sql&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">'SELECT&nbsp;*&nbsp;FROM&nbsp;customer&nbsp;WHERE&nbsp;status=:status'</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">$customers&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">findBySql</span><span style="color: #007700">(</span><span style="color: #0000BB">$sql</span><span style="color: #007700">,&nbsp;[</span><span style="color: #DD0000">':status'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">STATUS_INACTIVE</span><span style="color: #007700">])-&gt;</span><span style="color: #0000BB">all</span><span style="color: #007700">();</span>
</code></pre>
<p>Не используйте дополнительные методы построения запросов после вызова метода
<a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#findBySql()-detail" title="findBySql()" target="_blank">findBySql()</a>, т.к. они будут проигнорированы.</p>
<h2>Доступ к данным<span id="accessing-data"></span> <a href="index.html.1.82.html#accessing-data" class="hashlink">#</a></h2><p>Как сказано выше, получаемые из базы данные заполняют объекты Active Record и каждая строка результата запроса
соответствует одному объекту Active Record. Вы можете получить доступ к значениям столбцов с помощью атрибутов этих
объектов. Например так:</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #FF8000">//&nbsp;"id"&nbsp;и&nbsp;"email"&nbsp;-&nbsp;названия&nbsp;столбцов&nbsp;в&nbsp;таблице&nbsp;"customer"<br /></span><span style="color: #0000BB">$customer&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">findOne</span><span style="color: #007700">(</span><span style="color: #0000BB">123</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$id&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$customer</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">id</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">$email&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$customer</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">email</span><span style="color: #007700">;</span>
</code></pre>
<blockquote><p><strong>Note:</strong> Атрибуты объекта Active Record названы в соответствии с названиями столбцов связной таблицы с учётом
  регистра. Yii автоматически объявляет для каждого столбца связной таблицы атрибут в Active Record. Вы НЕ должны
  переопределять какие-либо из этих атрибутов. </p>
</blockquote>
<p>Атрибуты Active Record названы в соответствии с именами столбцов таблицы. Если столбцы вашей таблицы именуются через
нижнее подчёркивание, то может оказаться, что вам придётся писать PHP-код вроде этого: <code>$customer-&gt;first_name</code> - в нём
будет использоваться нижнее подчёркивание для разделения слов в названиях атрибутов. Если вы обеспокоены единообразием
стиля кодирования, вам придётся переименовать столбцы вашей таблицы соответствующим образом (например, назвать столбцы
в стиле camelCase).</p>
<h3>Преобразование данных<span id="data-transformation"></span> <a href="index.html.1.82.html#data-transformation" class="hashlink">#</a></h3><p>Часто бывает так, что данные вводятся и/или отображаются в формате, который отличается от формата их хранения в базе
данных. Например, в базе данных вы храните дни рождения покупателей в формате UNIX timestamp (что, кстати говоря, не
является хорошим дизайном), в то время как во многих случаях вы хотите манипулировать днями рождения в виде строк
формата <code>'ДД.ММ.ГГГГ'</code>. Для достижения этой цели, вы можете объявить методы <em>преобразования данных</em> в
ActiveRecord-классе <code>Customer</code> как показано ниже:</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #007700">class&nbsp;</span><span style="color: #0000BB">Customer&nbsp;</span><span style="color: #007700">extends&nbsp;</span><span style="color: #0000BB">ActiveRecord<br /></span><span style="color: #007700">{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;...<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">public&nbsp;function&nbsp;</span><span style="color: #0000BB">getBirthdayText</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">date</span><span style="color: #007700">(</span><span style="color: #DD0000">'d.m.Y'</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">birthday</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000BB">setBirthdayText</span><span style="color: #007700">(</span><span style="color: #0000BB">$value</span><span style="color: #007700">)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">birthday&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">strtotime</span><span style="color: #007700">(</span><span style="color: #0000BB">$value</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />}</span>
</code></pre>
<p>Теперь в своём PHP коде вместо доступа к <code>$customer-&gt;birthday</code>, вы сможете получить доступ к <code>$customer-&gt;birthdayText</code>,
что позволить вам вводить и отображать дни рождения покупателей в формате <code>'ДД.ММ.ГГГГ'</code>.</p>
<blockquote><p><strong>Tip:</strong> Вышеприведённый пример демонстрирует общий способ преобразования данных в различные форматы. Если вы
  работаете с датами и временем, вы можете использовать <a href="https://yiiframework.com.ua/ru/doc/guide/2/tutorial-core-validators/#date">DateValidator</a> и
  <a href="http://www.yiiframework.com/doc-2.0/yii-jui-datepicker.html" title="DatePicker" target="_blank">DatePicker</a>, которые проще в использовании и являются более мощными инструментами.</p>
</blockquote>
<h3>Получение данных в виде массива<span id="data-in-arrays"></span> <a href="index.html.1.82.html#data-in-arrays" class="hashlink">#</a></h3><p>Несмотря на то, что получение данных в виде Active Record объектов является удобным и гибким, этот способ не всегда
подходит при получении большого количества данных из-за больших накладных расходов памяти. В этом случае вы можете
получить данные в виде PHP-массива, используя перед выполнением запроса метод
<a href="http://www.yiiframework.com/doc-2.0/yii-db-activequery.html#asArray()-detail" title="asArray()" target="_blank">asArray()</a>:</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #FF8000">//&nbsp;возвращает&nbsp;всех&nbsp;покупателей<br />//&nbsp;каждый&nbsp;покупатель&nbsp;будет&nbsp;представлен&nbsp;в&nbsp;виде&nbsp;ассоциативного&nbsp;массива<br /></span><span style="color: #0000BB">$customers&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">find</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;-&gt;</span><span style="color: #0000BB">asArray</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;-&gt;</span><span style="color: #0000BB">all</span><span style="color: #007700">();</span>
</code></pre>
<blockquote><p><strong>Note:</strong> В то время как этот способ бережёт память и улучшает производительность, он ближе к низкому слою
  абстракции базы данных и вы потеряете многие возможности Active Record. Важное отличие заключается в типах данных
  значений столбцов. Когда вы получаете данные в виде объектов Active Record, значения столбцов автоматически приводятся
  к типам, соответствующим типам столбцов; с другой стороны, когда вы получаете данные в массивах, значения столбцов
  будут строковыми (до тех пор, пока они являются результатом работы PDO-слоя без какой-либо обработки), несмотря на
  настоящие типы данных соответствующих столбцов.</p>
</blockquote>
<h3>Пакетное получение данных<span id="data-in-batches"></span> <a href="index.html.1.82.html#data-in-batches" class="hashlink">#</a></h3><p>В главе <a href="https://yiiframework.com.ua/ru/doc/guide/2/db-query-builder/">Построитель запросов</a> мы объясняли, что вы можете использовать <em>пакетную выборку</em> для
снижения расходов памяти при получении большого количества данных из базы. Вы можете использовать такой же подход при
работе с Active Record. Например:</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #FF8000">//&nbsp;получить&nbsp;10&nbsp;покупателей&nbsp;одновременно<br /></span><span style="color: #007700">foreach&nbsp;(</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">find</span><span style="color: #007700">()-&gt;</span><span style="color: #0000BB">batch</span><span style="color: #007700">(</span><span style="color: #0000BB">10</span><span style="color: #007700">)&nbsp;as&nbsp;</span><span style="color: #0000BB">$customers</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;$customers&nbsp;-&nbsp;это&nbsp;массив,&nbsp;в&nbsp;котором&nbsp;находится&nbsp;10&nbsp;или&nbsp;меньше&nbsp;объектов&nbsp;класса&nbsp;Customer<br /></span><span style="color: #007700">}<br /><br /></span><span style="color: #FF8000">//&nbsp;получить&nbsp;одновременно&nbsp;десять&nbsp;покупателей&nbsp;и&nbsp;перебрать&nbsp;их&nbsp;одного&nbsp;за&nbsp;другим<br /></span><span style="color: #007700">foreach&nbsp;(</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">find</span><span style="color: #007700">()-&gt;</span><span style="color: #0000BB">each</span><span style="color: #007700">(</span><span style="color: #0000BB">10</span><span style="color: #007700">)&nbsp;as&nbsp;</span><span style="color: #0000BB">$customer</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;$customer&nbsp;-&nbsp;это&nbsp;объект&nbsp;класса&nbsp;Customer<br /></span><span style="color: #007700">}<br /><br /></span><span style="color: #FF8000">//&nbsp;пакетная&nbsp;выборка&nbsp;с&nbsp;жадной&nbsp;загрузкой<br /></span><span style="color: #007700">foreach&nbsp;(</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">find</span><span style="color: #007700">()-&gt;</span><span style="color: #0000BB">with</span><span style="color: #007700">(</span><span style="color: #DD0000">'orders'</span><span style="color: #007700">)-&gt;</span><span style="color: #0000BB">each</span><span style="color: #007700">()&nbsp;as&nbsp;</span><span style="color: #0000BB">$customer</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;$customer&nbsp;-&nbsp;это&nbsp;объект&nbsp;класса&nbsp;Customer<br /></span><span style="color: #007700">}</span>
</code></pre>
<h2>Сохранение данных<span id="inserting-updating-data"></span> <a href="index.html.1.82.html#inserting-updating-data" class="hashlink">#</a></h2><p>Используя Active Record, вы легко можете сохранить данные в базу данных, осуществив следующие шаги:</p>
<ol>
<li>Подготовьте объект Active Record;</li>
<li>Присвойте новые значения атрибутам Active Record;</li>
<li>Вызовите метод <a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#save()-detail" title="yii\db\ActiveRecord::save()" target="_blank">yii\db\ActiveRecord::save()</a> для сохранения данных в базу данных.</li>
</ol>
<p>Например:</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #FF8000">//&nbsp;вставить&nbsp;новую&nbsp;строку&nbsp;данных<br /></span><span style="color: #0000BB">$customer&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">();<br /></span><span style="color: #0000BB">$customer</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">name&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">'James'</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">$customer</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">email&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">'james@example.com'</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">$customer</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">save</span><span style="color: #007700">();<br /><br /></span><span style="color: #FF8000">//&nbsp;обновить&nbsp;имеющуюся&nbsp;строку&nbsp;данных<br /></span><span style="color: #0000BB">$customer&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">findOne</span><span style="color: #007700">(</span><span style="color: #0000BB">123</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$customer</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">email&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">'james@newexample.com'</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">$customer</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">save</span><span style="color: #007700">();</span>
</code></pre>
<p>Метод <a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#save()-detail" title="save()" target="_blank">save()</a> может вставить или обновить строку данных в зависимости от состояния
Active Record объекта. Если объект создан с помощью оператора <code>new</code>, вызов метода <a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#save()-detail" title="save()" target="_blank">save()</a>
приведёт к вставке новой строки данных; если объект был получен с помощью запроса на получение данных, вызов 
<a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#save()-detail" title="save()" target="_blank">save()</a> обновит строку таблицы, соответствующую объекту Active Record.</p>
<p>Вы можете различать два состояния Active Record объекта с помощью проверки значения его свойства
<a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#$isNewRecord-detail" title="isNewRecord" target="_blank">isNewRecord</a>. Это свойство также используется внутри метода
<a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#save()-detail" title="save()" target="_blank">save()</a> как показано ниже:</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #007700">public&nbsp;function&nbsp;</span><span style="color: #0000BB">save</span><span style="color: #007700">(</span><span style="color: #0000BB">$runValidation&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">true</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$attributeNames&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">null</span><span style="color: #007700">)<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">getIsNewRecord</span><span style="color: #007700">())&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">insert</span><span style="color: #007700">(</span><span style="color: #0000BB">$runValidation</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$attributeNames</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">update</span><span style="color: #007700">(</span><span style="color: #0000BB">$runValidation</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$attributeNames</span><span style="color: #007700">)&nbsp;!==&nbsp;</span><span style="color: #0000BB">false</span><span style="color: #007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />}</span>
</code></pre>
<blockquote><p><strong>Tip:</strong> Вы можете вызвать <a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#insert()-detail" title="insert()" target="_blank">insert()</a> или <a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#update()-detail" title="update()" target="_blank">update()</a>
  непосредственно, чтобы вставить или обновить строку данных в таблице.</p>
</blockquote>
<h3>Валидация данных<span id="data-validation"></span> <a href="index.html.1.82.html#data-validation" class="hashlink">#</a></h3><p>Т.к. класс <a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html" title="yii\db\ActiveRecord" target="_blank">yii\db\ActiveRecord</a> наследует класс <a href="http://www.yiiframework.com/doc-2.0/yii-base-model.html" title="yii\base\Model" target="_blank">yii\base\Model</a>, он обладает такими же возможностями
<a href="https://yiiframework.com.ua/ru/doc/guide/2/input-validation/">валидации данных</a>. Вы можете объявить правила валидации переопределив метод
<a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#rules()-detail" title="rules()" target="_blank">rules()</a> и осуществлять валидацию данных посредством вызовов метода
<a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#validate()-detail" title="validate()" target="_blank">validate()</a>.</p>
<p>Когда вы вызываете метод <a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#save()-detail" title="save()" target="_blank">save()</a>, по умолчанию он автоматически вызывает метод
<a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#validate()-detail" title="validate()" target="_blank">validate()</a>. Только после успешного прохождения валидации происходит сохранение
данных; в ином случае метод <a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#save()-detail" title="save()" target="_blank">save()</a> просто возвращает <code>false</code>, и вы можете проверить
свойство <a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#$errors-detail" title="errors" target="_blank">errors</a> для получения сообщений об ошибках валидации.</p>
<blockquote><p><strong>Tip:</strong> Если вы уверены, что ваши данные не требуют валидации (например, данные пришли из доверенного источника),
  вы можете вызвать <code>save(false)</code>, чтобы пропустить валидацию.</p>
</blockquote>
<h3>Массовое присваивание<span id="massive-assignment"></span> <a href="index.html.1.82.html#massive-assignment" class="hashlink">#</a></h3><p>Как и обычные <a href="https://yiiframework.com.ua/ru/doc/guide/2/structure-models/">модели</a>, объекты Active Record тоже обладают
<a href="https://yiiframework.com.ua/ru/doc/guide/2/structure-models/#massive-assignment">возможностью массового присваивания</a>. Как будет показано ниже, используя эту
возможность, вы можете одним PHP выражением присвоить значения множества атрибутов Active Record объекту. Запомните
однако, что только <a href="https://yiiframework.com.ua/ru/doc/guide/2/structure-models/#safe-attributes">безопасные атрибуты</a> могут быть массово присвоены.</p>
<pre><code class="language-php"><span style="color: #0000BB">$values&nbsp;</span><span style="color: #007700">=&nbsp;[<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'name'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'James'</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'email'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'james@example.com'</span><span style="color: #007700">,<br />];<br /><br /></span><span style="color: #0000BB">$customer&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">();<br /><br /></span><span style="color: #0000BB">$customer</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">attributes&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$values</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">$customer</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">save</span><span style="color: #007700">();</span>
</code></pre>
<h3>Обновление счётчиков<span id="updating-counters"></span> <a href="index.html.1.82.html#updating-counters" class="hashlink">#</a></h3><p>Распространённой задачей является инкремент или декремент столбца в таблице базы данных. Назовём такие столбцы
столбцами-счётчиками. Вы можете использовать метод <a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#updateCounters()-detail" title="updateCounters()" target="_blank">updateCounters()</a> для
обновления одного или нескольких столбцов-счётчиков. Например:</p>
<pre><code class="language-php"><span style="color: #0000BB">$post&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Post</span><span style="color: #007700">::</span><span style="color: #0000BB">findOne</span><span style="color: #007700">(</span><span style="color: #0000BB">100</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000">//&nbsp;UPDATE&nbsp;`post`&nbsp;SET&nbsp;`view_count`&nbsp;=&nbsp;`view_count`&nbsp;+&nbsp;1&nbsp;WHERE&nbsp;`id`&nbsp;=&nbsp;100<br /></span><span style="color: #0000BB">$post</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">updateCounters</span><span style="color: #007700">([</span><span style="color: #DD0000">'view_count'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">1</span><span style="color: #007700">]);</span>
</code></pre>
<blockquote><p><strong>Note:</strong> Если вы используете метод <a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#save()-detail" title="yii\db\ActiveRecord::save()" target="_blank">yii\db\ActiveRecord::save()</a> для обновления столбца-счётчика, вы можете
  прийти к некорректному результату, т.к. вполне вероятно, что этот же счётчик был сохранён сразу несколькими запросами,
  которые читают и записывают этот же столбец-счётчик.</p>
</blockquote>
<h3>Dirty-атрибуты<span id="dirty-attributes"></span> <a href="index.html.1.82.html#dirty-attributes" class="hashlink">#</a></h3><p>Когда вы вызываете <a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#save()-detail" title="save()" target="_blank">save()</a> для сохранения Active Record объекта, сохраняются только 
<em>dirty-атрибуты</em>. Атрибут считается <em>dirty-атрибутом</em>, если его значение было изменено после чтения из базы данных или
же он был сохранён в базу данных совсем недавно. Заметьте, что валидация данных осуществляется независимо от того,
имеются ли dirty-атрибуты в объекте Active Record или нет.</p>
<p>Active Record автоматически поддерживает список dirty-атрибутов. Это достигается за счёт хранения старых значений
атрибутов и сравнения их с новыми. Вы можете вызвать метод <a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#getDirtyAttributes()-detail" title="yii\db\ActiveRecord::getDirtyAttributes()" target="_blank">yii\db\ActiveRecord::getDirtyAttributes()</a> для получения
текущего списка dirty-атрибутов. Вы также можете вызвать <a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#markAttributeDirty()-detail" title="yii\db\ActiveRecord::markAttributeDirty()" target="_blank">yii\db\ActiveRecord::markAttributeDirty()</a>, чтобы явно
пометить атрибут в качестве dirty-атрибута.</p>
<p>Если вам нужны значения атрибутов, какими они были до их изменения, вы можете вызвать
<a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#getOldAttributes()-detail" title="getOldAttributes()" target="_blank">getOldAttributes()</a> или
<a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#getOldAttribute()-detail" title="getOldAttribute()" target="_blank">getOldAttribute()</a>.</p>
<blockquote><p><strong>Note:</strong> Сравнение старых и новых значений будет осуществлено с помощью оператора <code>===</code>, так что значение будет
  считаться dirty-значением даже в том случае, если оно осталось таким же, но изменило свой тип. Это часто происходит,
  когда модель получает пользовательский ввод из HTML-форм, где каждое значение представлено строкой. Чтобы убедиться в
  корректности типа данных, например для целых значений, вы можете применить
  <a href="https://yiiframework.com.ua/ru/doc/guide/2/input-validation/#data-filtering">фильтрацию данных</a>: <code>['attributeName', 'filter', 'filter' =&gt; 'intval']</code>.</p>
</blockquote>
<h3>Значения атрибутов по умолчанию<span id="default-attribute-values"></span> <a href="index.html.1.82.html#default-attribute-values" class="hashlink">#</a></h3><p>Некоторые столбцы ваших таблиц могут иметь значения по умолчанию, объявленные в базе данных. Иногда вы можете захотеть
предварительно заполнить этими значениями вашу веб-форму, которая соответствует Active Record объекту. Чтобы избежать
повторного указания этих значений, вы можете вызвать метод
<a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#loadDefaultValues()-detail" title="loadDefaultValues()" target="_blank">loadDefaultValues()</a> для заполнения соответствующих Active Record атрибутов
значениями по умолчанию, объявленными в базе данных:</p>
<pre><code class="language-php"><span style="color: #0000BB">$customer&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">();<br /></span><span style="color: #0000BB">$customer</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">loadDefaultValues</span><span style="color: #007700">();<br /></span><span style="color: #FF8000">//&nbsp;$customer-&gt;xyz&nbsp;получит&nbsp;значение&nbsp;по&nbsp;умолчанию,&nbsp;которое&nbsp;было&nbsp;указано&nbsp;при&nbsp;объявлении&nbsp;столбца&nbsp;"xyz"</span>
</code></pre>
<h3>Приведение типов атрибутов<span id="attributes-typecasting"></span> <a href="index.html.1.82.html#attributes-typecasting" class="hashlink">#</a></h3><p>При заполнении результатами запроса <a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html" title="yii\db\ActiveRecord" target="_blank">yii\db\ActiveRecord</a> производит автоматическое приведение типов для значений
атрибутов на основе информации из <a href="https://yiiframework.com.ua/ru/doc/guide/2/db-dao/#database-schema">схемы базы данны</a>. Это позволяет данным, полученным из
колонки таблицы объявленной как целое, заноситься в экземпляр ActiveRecord как значение целого типа PHP, булево как
булево и т.д.
Однако, механизм приведения типов имеет несколько ограничений:</p>
<ul>
<li>Числа с плавающей точкой не будут обработаны, а будут представленны как строки, в противном случае они могут потерять точность.</li>
<li>Конвертация целых чисел зависит от разрядности используемой операционной системы. В частности: значения колонок, объявленных
как 'unsigned integer' или 'big integer' будут приведены к целому типу PHP только на 64-х разрядных системах, в то время
как на 32-х разрядных - они будут представленны как строки.</li>
</ul>
<p>Имейте в виду, что преобразование типов производиться только в момент заполнения экземпляра ActiveRecord данными из результата
запроса. При заполнении данных из HTTP запроса или непосредственно через механизм доступа к полям - автоматическая конвертация
не производтся.
Схема таблицы базы данных также используется при построении SQL запроса для сохранения данных ActiveRecord, обеспечивая
соответсвие типов связываемых параметров в запросе. Однако, над атрибутами объекта ActiveRecord не будет производиться
приведение типов в процессе сохранения.</p>
<blockquote><p><strong>Совет:</strong> вы можете использовать поведение <a href="http://www.yiiframework.com/doc-2.0/yii-behaviors-attributetypecastbehavior.html" title="yii\behaviors\AttributeTypecastBehavior" target="_blank">yii\behaviors\AttributeTypecastBehavior</a> для того, чтобы производить
  приведение типов для ActiveRecord во время валидации или сохранения.</p>
</blockquote>
<p>Начиная с 2.0.14, Yii ActiveRecord поддерживает сложные типы данных, такие как JSON или многомерные массивы.</p>
<h4>JSON в MySQL и PostgreSQL<span id="json-v-mysql-i-postgresql"></span> <a href="index.html.1.82.html#json-v-mysql-i-postgresql" class="hashlink">#</a></h4><p>После заполнения данных, значение из столбца JSON будет автоматически декодировано из JSON в соответствии со стандартными правилами декодирования JSON.</p>
<p>Чтобы сохранить значение атрибута в столбец JSON, ActiveRecord автоматически создаст объект <a href="http://www.yiiframework.com/doc-2.0/yii-db-jsonexpression.html" title="JsonExpression" target="_blank">JsonExpression</a>, который будет закодирован в строку JSON на уровне <a href="https://yiiframework.com.ua/ru/doc/guide/2/db-query-builder/">QueryBuilder</a>.</p>
<h4>Массивы в PostgreSQL<span id="massivy-v-postgresql"></span> <a href="index.html.1.82.html#massivy-v-postgresql" class="hashlink">#</a></h4><p>После заполнения данных значение из столбца <code>Array</code> будет автоматически декодировано из нотации PgSQL в объект <a href="http://www.yiiframework.com/doc-2.0/yii-db-arrayexpression.html" title="ArrayExpression" target="_blank">ArrayExpression</a>. Он реализует интерфейс PHP <code>ArrayAccess</code>, так что вы можете использовать его в качестве массива, или вызвать <code>-&gt;getValue ()</code>, чтобы получить сам массив.</p>
<p>Чтобы сохранить значение атрибута в столбец массива, ActiveRecord автоматически создаст объект [[yii\db\Array Expression|ArrayExpression]], который будет закодирован <a href="https://yiiframework.com.ua/ru/doc/guide/2/db-query-builder/">QueryBuilder</a> в строковое представление массива PgSQL.</p>
<p>Можно также использовать условия для столбцов JSON:</p>
<pre><code class="language-php"><span style="color: #0000BB">$query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">andWhere</span><span style="color: #007700">([</span><span style="color: #DD0000">'='</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'json'</span><span style="color: #007700">,&nbsp;new&nbsp;</span><span style="color: #0000BB">ArrayExpression</span><span style="color: #007700">([</span><span style="color: #DD0000">'foo'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'bar'</span><span style="color: #007700">])</span>
</code></pre>
<p>Дополнительные сведения о системе построения выражений см. <a href="https://yiiframework.com.ua/ru/doc/guide/2/db-query-builder/#adding-custom-conditions-and-expressions">Query Builder – добавление пользовательских условий и выражений</a></p>
<h3>Обновление нескольких строк данных<span id="updating-multiple-rows"></span> <a href="index.html.1.82.html#updating-multiple-rows" class="hashlink">#</a></h3><p>Методы, представленные выше, работают с отдельными Active Record объектами, инициируя вставку или обновление данных для
отдельной строки таблицы. Вместо них для обновления нескольких строк одновременно можно использовать метод
<a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#updateAll()-detail" title="updateAll()" target="_blank">updateAll()</a>, который является статическим.</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #FF8000">//&nbsp;UPDATE&nbsp;`customer`&nbsp;SET&nbsp;`status`&nbsp;=&nbsp;1&nbsp;WHERE&nbsp;`email`&nbsp;LIKE&nbsp;`%@example.com%`<br /></span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">updateAll</span><span style="color: #007700">([</span><span style="color: #DD0000">'status'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">STATUS_ACTIVE</span><span style="color: #007700">],&nbsp;[</span><span style="color: #DD0000">'like'</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'email'</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'@example.com'</span><span style="color: #007700">]);</span>
</code></pre>
<p>Подобным образом можно использовать метод <a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#updateAllCounters()-detail" title="updateAllCounters()" target="_blank">updateAllCounters()</a> для
обновления значений столбцов-счётчиков в нескольких строках одновременно.</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #FF8000">//&nbsp;UPDATE&nbsp;`customer`&nbsp;SET&nbsp;`age`&nbsp;=&nbsp;`age`&nbsp;+&nbsp;1<br /></span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">updateAllCounters</span><span style="color: #007700">([</span><span style="color: #DD0000">'age'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">1</span><span style="color: #007700">]);</span>
</code></pre>
<h2>Удаление данных<span id="deleting-data"></span> <a href="index.html.1.82.html#deleting-data" class="hashlink">#</a></h2><p>Для удаления одной отдельной строки данных сначала получите Active Record объект, соответствующий этой строке, а затем
вызовите метод <a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#delete()-detail" title="yii\db\ActiveRecord::delete()" target="_blank">yii\db\ActiveRecord::delete()</a>.</p>
<pre><code class="language-php"><span style="color: #0000BB">$customer&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">findOne</span><span style="color: #007700">(</span><span style="color: #0000BB">123</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$customer</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">delete</span><span style="color: #007700">();</span>
</code></pre>
<p>Вы можете вызвать <a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#deleteAll()-detail" title="yii\db\ActiveRecord::deleteAll()" target="_blank">yii\db\ActiveRecord::deleteAll()</a> для удаления всех или нескольких строк данных одновременно.
Например:</p>
<pre><code class="language-php"><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">deleteAll</span><span style="color: #007700">([</span><span style="color: #DD0000">'status'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">STATUS_INACTIVE</span><span style="color: #007700">]);</span>
</code></pre>
<blockquote><p><strong>Note:</strong> будьте очень осторожны, используя метод <a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#deleteAll()-detail" title="deleteAll()" target="_blank">deleteAll()</a>, потому что он
  может полностью удалить все данные из вашей таблицы, если вы сделаете ошибку при указании условий удаления.</p>
</blockquote>
<h2>Жизненные циклы Active Record<span id="ar-life-cycles"></span> <a href="index.html.1.82.html#ar-life-cycles" class="hashlink">#</a></h2><p>Важно понимать как устроены жизненные циклы Active Record при использовании Active Record для различных целей.
В течение каждого жизненного цикла вызывается определённая последовательность методов, которые вы можете переопределять,
чтобы получить возможность тонкой настройки жизненного цикла. Для встраивания своего кода вы также можете отвечать на
конкретные события Active Record, которые срабатывают в течение жизненного цикла. Эти события особенно полезны, когда
вы разрабатываете <a href="https://yiiframework.com.ua/ru/doc/guide/2/concept-behaviors/">поведения</a>, которые требуют тонкой настройки жизненных циклов Active Record.</p>
<p>Ниже мы подробно опишем различные жизненные циклы Active Record и методы/события, которые участвуют в жизненных циклах.</p>
<h3>Жизненный цикл создания нового объекта<span id="new-instance-life-cycle"></span> <a href="index.html.1.82.html#new-instance-life-cycle" class="hashlink">#</a></h3><p>Когда создаётся новый объект Active Record с помощью оператора <code>new</code>, следующий жизненный цикл имеет место:</p>
<ol>
<li>Вызывается конструктор класса;</li>
<li>Вызывается <a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#init()-detail" title="init()" target="_blank">init()</a>:
инициируется событие <a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#EVENT_INIT-detail" title="EVENT_INIT" target="_blank">EVENT_INIT</a>.</li>
</ol>
<h3>Жизненный цикл получения данных<span id="querying-data-life-cycle"></span> <a href="index.html.1.82.html#querying-data-life-cycle" class="hashlink">#</a></h3><p>Когда происходит получение данных посредством одного из <a href="index.html.1.82.html#querying-data">методов получения данных</a>, каждый вновь
создаваемый объект Active Record при заполнении данными проходит следующий жизненный цикл:</p>
<ol>
<li>Вызывается конструктор класса.</li>
<li>Вызывается <a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#init()-detail" title="init()" target="_blank">init()</a>: инициируется событие
<a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#EVENT_INIT-detail" title="EVENT_INIT" target="_blank">EVENT_INIT</a>.</li>
<li>Вызывается <a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#afterFind()-detail" title="afterFind()" target="_blank">afterFind()</a>: инициируется событие
<a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#EVENT_AFTER_FIND-detail" title="EVENT_AFTER_FIND" target="_blank">EVENT_AFTER_FIND</a>.</li>
</ol>
<h3>Жизненный цикл сохранения данных<span id="saving-data-life-cycle"></span> <a href="index.html.1.82.html#saving-data-life-cycle" class="hashlink">#</a></h3><p>Когда вызывается метод <a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#save()-detail" title="save()" target="_blank">save()</a> для вставки или обновления объекта Active Record,
следующий жизненный цикл имеет место:</p>
<ol>
<li>Вызывается <a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#beforeValidate()-detail" title="beforeValidate()" target="_blank">beforeValidate()</a>: инициируется событие 
<a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#EVENT_BEFORE_VALIDATE-detail" title="EVENT_BEFORE_VALIDATE" target="_blank">EVENT_BEFORE_VALIDATE</a>. Если метод возвращает <code>false</code> или свойство
события <a href="http://www.yiiframework.com/doc-2.0/yii-base-modelevent.html#$isValid-detail" title="yii\base\ModelEvent::isValid" target="_blank">yii\base\ModelEvent::isValid</a> равно <code>false</code>, оставшиеся шаги не выполняются.</li>
<li>Осуществляется валидация данных. Если валидация закончилась неудачей, после 3-го шага остальные шаги не выполняются.</li>
<li>Вызывается <a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#afterValidate()-detail" title="afterValidate()" target="_blank">afterValidate()</a>: инициируется событие 
<a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#EVENT_AFTER_VALIDATE-detail" title="EVENT_AFTER_VALIDATE" target="_blank">EVENT_AFTER_VALIDATE</a>.</li>
<li>Вызывается <a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#beforeSave()-detail" title="beforeSave()" target="_blank">beforeSave()</a>: инициируется событие 
<a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#EVENT_BEFORE_INSERT-detail" title="EVENT_BEFORE_INSERT" target="_blank">EVENT_BEFORE_INSERT</a> или событие
<a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#EVENT_BEFORE_UPDATE-detail" title="EVENT_BEFORE_UPDATE" target="_blank">EVENT_BEFORE_UPDATE</a>. Если метод возвращает <code>false</code> или свойство события
<a href="http://www.yiiframework.com/doc-2.0/yii-base-modelevent.html#$isValid-detail" title="yii\base\ModelEvent::isValid" target="_blank">yii\base\ModelEvent::isValid</a> равно <code>false</code>, оставшиеся шаги не выполняются.</li>
<li>Осуществляется фактическая вставка или обновление данных в базу данных;</li>
<li>Вызывается <a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#afterSave()-detail" title="afterSave()" target="_blank">afterSave()</a>: инициируется событие
<a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#EVENT_AFTER_INSERT-detail" title="EVENT_AFTER_INSERT" target="_blank">EVENT_AFTER_INSERT</a> или событие
<a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#EVENT_AFTER_UPDATE-detail" title="EVENT_AFTER_UPDATE" target="_blank">EVENT_AFTER_UPDATE</a>.</li>
</ol>
<h3>Жизненный цикл удаления данных<span id="deleting-data-life-cycle"></span> <a href="index.html.1.82.html#deleting-data-life-cycle" class="hashlink">#</a></h3><p>Когда вызывается метод <a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#delete()-detail" title="delete()" target="_blank">delete()</a> для удаления объекта Active Record, следующий
жизненный цикл имеет место:</p>
<ol>
<li>Вызывается <a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#beforeDelete()-detail" title="beforeDelete()" target="_blank">beforeDelete()</a>: инициируется событие
<a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#EVENT_BEFORE_DELETE-detail" title="EVENT_BEFORE_DELETE" target="_blank">EVENT_BEFORE_DELETE</a>. Если метод возвращает <code>false</code> или свойство события
<a href="http://www.yiiframework.com/doc-2.0/yii-base-modelevent.html#$isValid-detail" title="yii\base\ModelEvent::isValid" target="_blank">yii\base\ModelEvent::isValid</a> равно <code>false</code>, остальные шаги не выполняются.</li>
<li>Осуществляется фактическое удаление данных из базы данных.</li>
<li>Вызывается <a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#afterDelete()-detail" title="afterDelete()" target="_blank">afterDelete()</a>: инициируется событие
<a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#EVENT_AFTER_DELETE-detail" title="EVENT_AFTER_DELETE" target="_blank">EVENT_AFTER_DELETE</a>.</li>
</ol>
<blockquote><p><strong>Note:</strong> Вызов следующих методов НЕ инициирует ни один из вышеприведённых жизненных циклов:</p>
<ul>
<li><a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#updateAll()-detail" title="yii\db\ActiveRecord::updateAll()" target="_blank">yii\db\ActiveRecord::updateAll()</a></li>
<li><a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#deleteAll()-detail" title="yii\db\ActiveRecord::deleteAll()" target="_blank">yii\db\ActiveRecord::deleteAll()</a></li>
<li><a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#updateCounters()-detail" title="yii\db\ActiveRecord::updateCounters()" target="_blank">yii\db\ActiveRecord::updateCounters()</a> </li>
<li><a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#updateAllCounters()-detail" title="yii\db\ActiveRecord::updateAllCounters()" target="_blank">yii\db\ActiveRecord::updateAllCounters()</a> </li>
</ul>
</blockquote>
<h2>Работа с транзакциями<span id="transactional-operations"></span> <a href="index.html.1.82.html#transactional-operations" class="hashlink">#</a></h2><p>Есть два способа использования <a href="https://yiiframework.com.ua/ru/doc/guide/2/db-dao/#performing-transactions">транзакций</a> при работе с Active Record.</p>
<p>Первый способ заключается в том, чтобы явно заключить все вызовы методов Active Record в блок транзакции как показано
ниже:</p>
<pre><code class="language-php"><span style="color: #0000BB">$customer&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">findOne</span><span style="color: #007700">(</span><span style="color: #0000BB">123</span><span style="color: #007700">);<br /><br /></span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">getDb</span><span style="color: #007700">()-&gt;</span><span style="color: #0000BB">transaction</span><span style="color: #007700">(function(</span><span style="color: #0000BB">$db</span><span style="color: #007700">)&nbsp;use&nbsp;(</span><span style="color: #0000BB">$customer</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$customer</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">id&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">200</span><span style="color: #007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$customer</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">save</span><span style="color: #007700">();<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;...другие&nbsp;операции&nbsp;с&nbsp;базой&nbsp;данных...<br /></span><span style="color: #007700">});<br /><br /></span><span style="color: #FF8000">//&nbsp;или&nbsp;по-другому<br /><br /></span><span style="color: #0000BB">$transaction&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">getDb</span><span style="color: #007700">()-&gt;</span><span style="color: #0000BB">beginTransaction</span><span style="color: #007700">();<br />try&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$customer</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">id&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">200</span><span style="color: #007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$customer</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">save</span><span style="color: #007700">();<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;...другие&nbsp;операции&nbsp;с&nbsp;базой&nbsp;данных...<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$transaction</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">commit</span><span style="color: #007700">();<br />}&nbsp;catch(\</span><span style="color: #0000BB">Exception&nbsp;$e</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$transaction</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">rollBack</span><span style="color: #007700">();<br />&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;</span><span style="color: #0000BB">$e</span><span style="color: #007700">;<br />}&nbsp;catch(\</span><span style="color: #0000BB">Throwable&nbsp;$e</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$transaction</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">rollBack</span><span style="color: #007700">();<br />&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;</span><span style="color: #0000BB">$e</span><span style="color: #007700">;<br />}</span>
</code></pre>
<blockquote><p><strong>Note:</strong> в коде выше ради совместимости с PHP 5.x и PHP 7.x использованы два блока catch. 
<code>\Exception</code> реализует интерфейс <a href="https://www.php.net/manual/ru/class.throwable.php" target="_blank"><code>\Throwable</code> interface</a>
начиная с PHP 7.0. Если вы используете только PHP 7 и новее, можете пропустить блок с <code>\Exception</code>.</p>
</blockquote>
<p>Второй способ заключается в том, чтобы перечислить операции с базой данных, которые требуют тразнакционного выполнения,
в методе <a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#transactions()-detail" title="yii\db\ActiveRecord::transactions()" target="_blank">yii\db\ActiveRecord::transactions()</a>. Например:</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #007700">class&nbsp;</span><span style="color: #0000BB">Customer&nbsp;</span><span style="color: #007700">extends&nbsp;</span><span style="color: #0000BB">ActiveRecord<br /></span><span style="color: #007700">{<br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000BB">transactions</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;[<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'admin'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">self</span><span style="color: #007700">::</span><span style="color: #0000BB">OP_INSERT</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'api'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">self</span><span style="color: #007700">::</span><span style="color: #0000BB">OP_INSERT&nbsp;</span><span style="color: #007700">|&nbsp;</span><span style="color: #0000BB">self</span><span style="color: #007700">::</span><span style="color: #0000BB">OP_UPDATE&nbsp;</span><span style="color: #007700">|&nbsp;</span><span style="color: #0000BB">self</span><span style="color: #007700">::</span><span style="color: #0000BB">OP_DELETE</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;вышеприведённая&nbsp;строка&nbsp;эквивалентна&nbsp;следующей:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;'api'&nbsp;=&gt;&nbsp;self::OP_ALL,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">];<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />}</span>
</code></pre>
<p>Метод <a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#transactions()-detail" title="yii\db\ActiveRecord::transactions()" target="_blank">yii\db\ActiveRecord::transactions()</a> должен возвращать массив, ключи которого являются именами 
<a href="https://yiiframework.com.ua/ru/doc/guide/2/structure-models/#scenarios">сценариев</a>, а значения соответствуют операциям, которые должны быть выполнены с помощью
транзакций. Вы должны использовать следующие константы для обозначения различных операций базы данных:</p>
<ul>
<li><a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#OP_INSERT-detail" title="OP_INSERT" target="_blank">OP_INSERT</a>: операция вставки, осуществляемая с помощью метода
<a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#insert()-detail" title="insert()" target="_blank">insert()</a>;</li>
<li><a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#OP_UPDATE-detail" title="OP_UPDATE" target="_blank">OP_UPDATE</a>: операция обновления, осуществляемая с помощью метода
<a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#update()-detail" title="update()" target="_blank">update()</a>;</li>
<li><a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#OP_DELETE-detail" title="OP_DELETE" target="_blank">OP_DELETE</a>: операция удаления, осуществляемая с помощью метода
<a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#delete()-detail" title="delete()" target="_blank">delete()</a>.</li>
</ul>
<p>Используйте операторы <code>|</code> для объединения вышеприведённых констант при обозначении множества операций. Вы можете также
использовать вспомогательную константу <a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#OP_ALL-detail" title="OP_ALL" target="_blank">OP_ALL</a>, чтобы обозначить одной константой все три
вышеприведённые операции.</p>
<h2>Оптимистическая блокировка<span id="optimistic-locks"></span> <a href="index.html.1.82.html#optimistic-locks" class="hashlink">#</a></h2><p>Оптимистическая блокировка - это способ предотвращения конфликтов, которые могут возникать, когда одна и та же строка
данных обновляется несколькими пользователями. Например, пользователь A и пользователь B одновременно редактируют одну и
ту же wiki-статью. После того, как пользователь A сохранит свои изменения, пользователь B нажимает на кнопку "Сохранить"
в попытке также сохранить свои изменения. Т.к. пользователь B работал с фактически-устаревшей версией статьи, было бы
неплохо иметь способ предотвратить сохранение его варианта статьи и показать ему некоторое сообщение с подсказкой о том,
что произошло.</p>
<p>Оптимистическая блокировка решает вышеприведённую проблему за счёт использования отдельного столбца для сохранения
номера версии каждой строки данных. Когда строка данных сохраняется с использованием устаревшего номера версии,
выбрасывается исключение <a href="http://www.yiiframework.com/doc-2.0/yii-db-staleobjectexception.html" title="yii\db\StaleObjectException" target="_blank">yii\db\StaleObjectException</a>, которое предохраняет строку от сохранения. Оптимистическая
блокировка поддерживается только тогда, когда вы обновляете или удаляете существующую строку данных, используя методы
<a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#update()-detail" title="yii\db\ActiveRecord::update()" target="_blank">yii\db\ActiveRecord::update()</a> или <a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#delete()-detail" title="yii\db\ActiveRecord::delete()" target="_blank">yii\db\ActiveRecord::delete()</a> соответственно.</p>
<p>Для использования оптимистической блокировки:</p>
<ol>
<li>Создайте столбец в таблице базы данных, ассоциированной с классом Active Record, для сохранения номера версии каждой
строки данных. Столбец должен быть типа big integer (в Mysql это будет <code>BIGINT DEFAULT 0</code>).</li>
<li>Переопределите метод <a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#optimisticLock()-detail" title="yii\db\ActiveRecord::optimisticLock()" target="_blank">yii\db\ActiveRecord::optimisticLock()</a> таким образом, чтобы он возвращал название этого
столбца.</li>
<li>В веб-форме, которая принимает пользовательский ввод, добавьте скрытое поле для сохранения текущей версии обновляемой
строки. Убедитесь, что для вашего атрибута с версией объявлены правила валидации, и валидация проходит успешно.</li>
<li>В действии контроллера, которое занимается обновлением строки данных с использованием Active Record, оберните в блок
try...catch код и перехватывайте исключение <a href="http://www.yiiframework.com/doc-2.0/yii-db-staleobjectexception.html" title="yii\db\StaleObjectException" target="_blank">yii\db\StaleObjectException</a>. Реализуйте необходимую бизнес-логику
(например, возможность слияния изменений, подсказку о том, что данные устарели) для разрешения возникшего конфликта.</li>
</ol>
<p>Например, предположим, что столбец с версией называется <code>version</code>. Вы можете реализовать оптимистическую блокировку с 
помощью подобного кода:</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #FF8000">//&nbsp;------&nbsp;код&nbsp;представления&nbsp;-------<br /><br /></span><span style="color: #007700">use&nbsp;</span><span style="color: #0000BB">yii</span><span style="color: #007700">\</span><span style="color: #0000BB">helpers</span><span style="color: #007700">\</span><span style="color: #0000BB">Html</span><span style="color: #007700">;<br /><br /></span><span style="color: #FF8000">//&nbsp;...другие&nbsp;поля&nbsp;ввода<br /></span><span style="color: #007700">echo&nbsp;</span><span style="color: #0000BB">Html</span><span style="color: #007700">::</span><span style="color: #0000BB">activeHiddenInput</span><span style="color: #007700">(</span><span style="color: #0000BB">$model</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'version'</span><span style="color: #007700">);<br /><br /><br /></span><span style="color: #FF8000">//&nbsp;------&nbsp;код&nbsp;контроллера&nbsp;-------<br /><br /></span><span style="color: #007700">use&nbsp;</span><span style="color: #0000BB">yii</span><span style="color: #007700">\</span><span style="color: #0000BB">db</span><span style="color: #007700">\</span><span style="color: #0000BB">StaleObjectException</span><span style="color: #007700">;<br /><br />public&nbsp;function&nbsp;</span><span style="color: #0000BB">actionUpdate</span><span style="color: #007700">(</span><span style="color: #0000BB">$id</span><span style="color: #007700">)<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$model&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">findModel</span><span style="color: #007700">(</span><span style="color: #0000BB">$id</span><span style="color: #007700">);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000BB">$model</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">load</span><span style="color: #007700">(</span><span style="color: #0000BB">Yii</span><span style="color: #007700">::</span><span style="color: #0000BB">$app</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">request</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">post</span><span style="color: #007700">())&nbsp;&amp;&amp;&nbsp;</span><span style="color: #0000BB">$model</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">save</span><span style="color: #007700">())&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">redirect</span><span style="color: #007700">([</span><span style="color: #DD0000">'view'</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'id'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">$model</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">id</span><span style="color: #007700">]);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">render</span><span style="color: #007700">(</span><span style="color: #DD0000">'update'</span><span style="color: #007700">,&nbsp;[<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'model'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">$model</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;catch&nbsp;(</span><span style="color: #0000BB">StaleObjectException&nbsp;$e</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;логика&nbsp;разрешения&nbsp;конфликта&nbsp;версий<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">}<br />}</span>
</code></pre>
<h2>Работа со связными данными<span id="relational-data"></span> <a href="index.html.1.82.html#relational-data" class="hashlink">#</a></h2><p>Помимо работы с отдельными таблицами баз данных, Active Record также имеет возможность объединять связные данные, что
делает их легко-доступными для получения через основные объекты данных. Например, данные покупателя связаны с данными
заказов, потому что один покупатель может осуществить один или несколько заказов. С помощью объявления этой связи вы
можете получить возможность доступа к информации о заказе покупателя с помощью выражения <code>$customer-&gt;orders</code>, которое
возвращает информацию о заказе покупателя в виде массива объектов класса <code>Order</code>, которые являются Active Record
объектами.</p>
<h3>Объявление связей<span id="declaring-relations"></span> <a href="index.html.1.82.html#declaring-relations" class="hashlink">#</a></h3><p>Для работы со связными данными посредством Active Record вы прежде всего должны объявить связи в классе Active Record.
Эта задача решается простым объявлением <em>методов получения связных данных</em> для каждой интересующей вас связи как
показано ниже:</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #007700">class&nbsp;</span><span style="color: #0000BB">Customer&nbsp;</span><span style="color: #007700">extends&nbsp;</span><span style="color: #0000BB">ActiveRecord<br /></span><span style="color: #007700">{<br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000BB">getOrders</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">hasMany</span><span style="color: #007700">(</span><span style="color: #0000BB">Order</span><span style="color: #007700">::class,&nbsp;[</span><span style="color: #DD0000">'customer_id'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'id'</span><span style="color: #007700">]);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />}<br /><br />class&nbsp;</span><span style="color: #0000BB">Order&nbsp;</span><span style="color: #007700">extends&nbsp;</span><span style="color: #0000BB">ActiveRecord<br /></span><span style="color: #007700">{<br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000BB">getCustomer</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">hasOne</span><span style="color: #007700">(</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::class,&nbsp;[</span><span style="color: #DD0000">'id'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'customer_id'</span><span style="color: #007700">]);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />}</span>
</code></pre>
<p>В вышеприведённом коде мы объявили связь <code>orders</code> для класса <code>Customer</code> и связь <code>customer</code> для класса <code>Order</code>. </p>
<p>Каждый метод получения связных данных должен быть назван в формате <code>getXyz</code>. Мы называем <code>xyz</code> (первая буква в нижнем
регистре) <em>именем связи</em>. Помните, что имена связей чувствительны к регистру.</p>
<p>При объявлении связи, вы должны указать следующую информацию:</p>
<ul>
<li>кратность связи: указывается с помощью вызова метода <a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#hasMany()-detail" title="hasMany()" target="_blank">hasMany()</a> или метода
<a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#hasOne()-detail" title="hasOne()" target="_blank">hasOne()</a>. В вышеприведённом примере вы можете легко увидеть в объявлениях связей,
что покупатель может иметь много заказов в то время, как заказ может быть сделан лишь одним покупателем.</li>
<li>название связного Active Record класса: указывается в качестве первого параметра для метода 
<a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#hasMany()-detail" title="hasMany()" target="_blank">hasMany()</a> или для метода <a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#hasOne()-detail" title="hasOne()" target="_blank">hasOne()</a>. Рекомендуется
использовать код <code>Xyz::class</code>, чтобы получить строку с именем класса, при этом вы сможете воспользоваться
возможностями авто-дополнения кода, встроенного в IDE, а также получите обработку ошибок на этапе компиляции.</li>
<li><p>связь между двумя типами данных: указываются столбцы с помощью которых два типа данных связаны. Значения массива - это
столбцы  основного объекта данных (представлен классом Active Record, в котором объявляется связь), в то время как
ключи массива - столбцы связанных данных.</p>
<p>Есть простой способ запомнить это правило: как вы можете увидеть в примере выше, столбец связной Active Record
указывается сразу после указания самого класса Active Record. Вы видите, что <code>customer_id</code> - это свойство класса
<code>Order</code>, а <code>id</code> - свойство класса <code>Customer</code>.</p>
</li>
</ul>
<blockquote><p><strong>Warning:</strong> Имя связи <code>relation</code> зарезервировано. Его использование приведёт к ошибке <code>ArgumentCountError</code>.</p>
</blockquote>
<h3>Доступ к связным данным<span id="accessing-relational-data"></span> <a href="index.html.1.82.html#accessing-relational-data" class="hashlink">#</a></h3><p>После объявления связей вы можете получать доступ к связным данным с помощью имён связей. Это происходит таким же
образом, каким осуществляется доступ к <a href="https://yiiframework.com.ua/ru/doc/guide/2/concept-properties/">свойству</a> объекта объявленному с помощью метода получения
связных данных. По этой причине, мы называем его <em>свойством связи</em>. Например:</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #FF8000">//&nbsp;SELECT&nbsp;*&nbsp;FROM&nbsp;`customer`&nbsp;WHERE&nbsp;`id`&nbsp;=&nbsp;123<br /></span><span style="color: #0000BB">$customer&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">findOne</span><span style="color: #007700">(</span><span style="color: #0000BB">123</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000">//&nbsp;SELECT&nbsp;*&nbsp;FROM&nbsp;`order`&nbsp;WHERE&nbsp;`customer_id`&nbsp;=&nbsp;123<br />//&nbsp;$orders&nbsp;-&nbsp;это&nbsp;массив&nbsp;объектов&nbsp;Order<br /></span><span style="color: #0000BB">$orders&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$customer</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">orders</span><span style="color: #007700">;</span>
</code></pre>
<blockquote><p><strong>Info:</strong> когда вы объявляете связь с названием <code>xyz</code> посредством геттера <code>getXyz()</code>, у вас появляется возможность
  доступа к свойству <code>xyz</code> подобно <a href="https://yiiframework.com.ua/ru/doc/guide/2/concept-properties/">свойству объекта</a>. Помните, что название связи чувствительно
  к регистру.</p>
</blockquote>
<p>Если связь объявлена с помощью метода <a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#hasMany()-detail" title="hasMany()" target="_blank">hasMany()</a>, доступ к свойству связи вернёт
массив связных объектов Active Record; если связь объявлена с помощью метода <a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#hasOne()-detail" title="hasOne()" target="_blank">hasOne()</a>,
доступ к свойству связи вернёт связный Active Record объект или <code>null</code>, если связные данные не найдены.</p>
<p>Когда вы запрашиваете свойство связи в первый раз, выполняется SQL-выражение как показано в примере выше. Если то же
самое свойство запрашивается вновь, будет возвращён результат предыдущего SQL-запроса без повторного выполнения
SQL-выражения. Для принудительного повторного выполнения SQL-запроса, вы можете удалить свойство связи с помощью
операции: <code>unset($customer-&gt;orders)</code>.</p>
<blockquote><p><strong>Note:</strong> Несмотря на то, что эта концепция выглядит похожей на концепцию <a href="https://yiiframework.com.ua/ru/doc/guide/2/concept-properties/">свойств объектов</a>,
  между ними есть важное различие. Для обычных свойств объектов значения свойств имеют тот же тип, который возвращает
  геттер. Однако метод получения связных данных возвращает объект <a href="http://www.yiiframework.com/doc-2.0/yii-db-activequery.html" title="yii\db\ActiveQuery" target="_blank">yii\db\ActiveQuery</a>, в то время как доступ к
  свойству связи возвращает объект <a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html" title="yii\db\ActiveRecord" target="_blank">yii\db\ActiveRecord</a> или массив таких объектов.
  <code>`</code>php
  $customer-&gt;orders; // массив объектов <code>Order</code>
  $customer-&gt;getOrders(); // объект ActiveQuery
  <code>`</code>
  Это полезно при тонкой настройке запросов к связным данным, что будет описано в следующем разделе.</p>
</blockquote>
<h3>Динамические запросы связных данных<span id="dynamic-relational-query"></span> <a href="index.html.1.82.html#dynamic-relational-query" class="hashlink">#</a></h3><p>Т.к. метод получения связных данных возвращает объект запроса <a href="http://www.yiiframework.com/doc-2.0/yii-db-activequery.html" title="yii\db\ActiveQuery" target="_blank">yii\db\ActiveQuery</a>, вы можете в дальнейшем перед его
отправкой в базу данных настроить этот запрос, используя методы построения запросов. Например:</p>
<pre><code class="language-php"><span style="color: #0000BB">$customer&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">findOne</span><span style="color: #007700">(</span><span style="color: #0000BB">123</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000">//&nbsp;SELECT&nbsp;*&nbsp;FROM&nbsp;`order`&nbsp;WHERE&nbsp;`customer_id`&nbsp;=&nbsp;123&nbsp;AND&nbsp;`subtotal`&nbsp;&gt;&nbsp;200&nbsp;ORDER&nbsp;BY&nbsp;`id`<br /></span><span style="color: #0000BB">$orders&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$customer</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">getOrders</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;-&gt;</span><span style="color: #0000BB">where</span><span style="color: #007700">([</span><span style="color: #DD0000">'&gt;'</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'subtotal'</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">200</span><span style="color: #007700">])<br />&nbsp;&nbsp;&nbsp;&nbsp;-&gt;</span><span style="color: #0000BB">orderBy</span><span style="color: #007700">(</span><span style="color: #DD0000">'id'</span><span style="color: #007700">)<br />&nbsp;&nbsp;&nbsp;&nbsp;-&gt;</span><span style="color: #0000BB">all</span><span style="color: #007700">();</span>
</code></pre>
<p>В отличие от доступа к данным с помощью свойства связи, каждый раз при выполнении такого динамического запроса
посредством метода получения связных данных будет выполняться SQL-запрос, даже если тот же самый динамический запрос был
отправлен ранее.</p>
<p>Иногда вы можете даже захотеть настроить объявление связи таким образом, чтобы вы могли более просто осуществлять 
динамические запросы связных данных. Например, вы можете объявить связь <code>bigOrders</code> как показано ниже: </p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #007700">class&nbsp;</span><span style="color: #0000BB">Customer&nbsp;</span><span style="color: #007700">extends&nbsp;</span><span style="color: #0000BB">ActiveRecord<br /></span><span style="color: #007700">{<br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000BB">getBigOrders</span><span style="color: #007700">(</span><span style="color: #0000BB">$threshold&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">100</span><span style="color: #007700">)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">hasMany</span><span style="color: #007700">(</span><span style="color: #0000BB">Order</span><span style="color: #007700">::class,&nbsp;[</span><span style="color: #DD0000">'customer_id'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'id'</span><span style="color: #007700">])<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&gt;</span><span style="color: #0000BB">where</span><span style="color: #007700">(</span><span style="color: #DD0000">'subtotal&nbsp;&gt;&nbsp;:threshold'</span><span style="color: #007700">,&nbsp;[</span><span style="color: #DD0000">':threshold'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">$threshold</span><span style="color: #007700">])<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&gt;</span><span style="color: #0000BB">orderBy</span><span style="color: #007700">(</span><span style="color: #DD0000">'id'</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />}</span>
</code></pre>
<p>После этого вы сможете выполнять следующие запросы связных данных:</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #FF8000">//&nbsp;SELECT&nbsp;*&nbsp;FROM&nbsp;`order`&nbsp;WHERE&nbsp;`customer_id`&nbsp;=&nbsp;123&nbsp;AND&nbsp;`subtotal`&nbsp;&gt;&nbsp;200&nbsp;ORDER&nbsp;BY&nbsp;`id`<br /></span><span style="color: #0000BB">$orders&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$customer</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">getBigOrders</span><span style="color: #007700">(</span><span style="color: #0000BB">200</span><span style="color: #007700">)-&gt;</span><span style="color: #0000BB">all</span><span style="color: #007700">();<br /><br /></span><span style="color: #FF8000">//&nbsp;SELECT&nbsp;*&nbsp;FROM&nbsp;`order`&nbsp;WHERE&nbsp;`customer_id`&nbsp;=&nbsp;123&nbsp;AND&nbsp;`subtotal`&nbsp;&gt;&nbsp;100&nbsp;ORDER&nbsp;BY&nbsp;`id`<br /></span><span style="color: #0000BB">$orders&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$customer</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">bigOrders</span><span style="color: #007700">;</span>
</code></pre>
<h3>Связывание посредством промежуточной таблицы<span id="junction-table"></span> <a href="index.html.1.82.html#junction-table" class="hashlink">#</a></h3><p>При проектировании баз данных, когда между двумя таблицами имеется кратность связи many-to-many, обычно вводится 
<a href="http://en.wikipedia.org/wiki/Junction_table" target="_blank">промежуточная таблица</a>. Например, таблицы <code>order</code> и <code>item</code> могут быть
связаны посредством промежуточной таблицы с названием <code>order_item</code>. Один заказ будет соотноситься с несколькими товарами,
в то время как один товар будет также соотноситься с несколькими заказами.</p>
<p>При объявлении подобных связей вы можете пользоваться методом <a href="http://www.yiiframework.com/doc-2.0/yii-db-activequery.html#via()-detail" title="via()" target="_blank">via()</a> или методом
<a href="http://www.yiiframework.com/doc-2.0/yii-db-activequery.html#viaTable()-detail" title="viaTable()" target="_blank">viaTable()</a> для указания промежуточной таблицы. Разница между методами
<a href="http://www.yiiframework.com/doc-2.0/yii-db-activequery.html#via()-detail" title="via()" target="_blank">via()</a> и <a href="http://www.yiiframework.com/doc-2.0/yii-db-activequery.html#viaTable()-detail" title="viaTable()" target="_blank">viaTable()</a> заключается в том, что первый
метод указывает промежуточную таблицу с помощью названия связи, в то время как второй метод непосредственно указывает
промежуточную таблицу. Например:</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #007700">class&nbsp;</span><span style="color: #0000BB">Order&nbsp;</span><span style="color: #007700">extends&nbsp;</span><span style="color: #0000BB">ActiveRecord<br /></span><span style="color: #007700">{<br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000BB">getItems</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">hasMany</span><span style="color: #007700">(</span><span style="color: #0000BB">Item</span><span style="color: #007700">::class,&nbsp;[</span><span style="color: #DD0000">'id'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'item_id'</span><span style="color: #007700">])<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&gt;</span><span style="color: #0000BB">viaTable</span><span style="color: #007700">(</span><span style="color: #DD0000">'order_item'</span><span style="color: #007700">,&nbsp;[</span><span style="color: #DD0000">'order_id'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'id'</span><span style="color: #007700">]);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />}</span>
</code></pre>
<p>или по-другому:</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #007700">class&nbsp;</span><span style="color: #0000BB">Order&nbsp;</span><span style="color: #007700">extends&nbsp;</span><span style="color: #0000BB">ActiveRecord<br /></span><span style="color: #007700">{<br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000BB">getOrderItems</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">hasMany</span><span style="color: #007700">(</span><span style="color: #0000BB">OrderItem</span><span style="color: #007700">::class,&nbsp;[</span><span style="color: #DD0000">'order_id'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'id'</span><span style="color: #007700">]);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000BB">getItems</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">hasMany</span><span style="color: #007700">(</span><span style="color: #0000BB">Item</span><span style="color: #007700">::class,&nbsp;[</span><span style="color: #DD0000">'id'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'item_id'</span><span style="color: #007700">])<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&gt;</span><span style="color: #0000BB">via</span><span style="color: #007700">(</span><span style="color: #DD0000">'orderItems'</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />}</span>
</code></pre>
<p>Использовать связи, объявленные с помощью промежуточных таблиц, можно точно также, как и обычные связи. Например:</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #FF8000">//&nbsp;SELECT&nbsp;*&nbsp;FROM&nbsp;`order`&nbsp;WHERE&nbsp;`id`&nbsp;=&nbsp;100<br /></span><span style="color: #0000BB">$order&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Order</span><span style="color: #007700">::</span><span style="color: #0000BB">findOne</span><span style="color: #007700">(</span><span style="color: #0000BB">100</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000">//&nbsp;SELECT&nbsp;*&nbsp;FROM&nbsp;`order_item`&nbsp;WHERE&nbsp;`order_id`&nbsp;=&nbsp;100<br />//&nbsp;SELECT&nbsp;*&nbsp;FROM&nbsp;`item`&nbsp;WHERE&nbsp;`item_id`&nbsp;IN&nbsp;(...)<br />//&nbsp;возвращает&nbsp;массив&nbsp;объектов&nbsp;Item<br /></span><span style="color: #0000BB">$items&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$order</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">items</span><span style="color: #007700">;</span>
</code></pre>
<h3>Отложенная и жадная загрузка<span id="lazy-eager-loading"></span> <a href="index.html.1.82.html#lazy-eager-loading" class="hashlink">#</a></h3><p>В разделе <a href="index.html.1.82.html#accessing-relational-data">Доступ к связным данным</a>, мы показывали, что вы можете получать доступ к свойству
связи объекта Active Record точно также, как получаете доступ к свойству обычного объекта. SQL-запрос будет выполнен
только во время первого доступа к свойству связи. Мы называем подобный способ получения связных данных <em>отложенной
загрузкой</em>. Например:</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #FF8000">//&nbsp;SELECT&nbsp;*&nbsp;FROM&nbsp;`customer`&nbsp;WHERE&nbsp;`id`&nbsp;=&nbsp;123<br /></span><span style="color: #0000BB">$customer&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">findOne</span><span style="color: #007700">(</span><span style="color: #0000BB">123</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000">//&nbsp;SELECT&nbsp;*&nbsp;FROM&nbsp;`order`&nbsp;WHERE&nbsp;`customer_id`&nbsp;=&nbsp;123<br /></span><span style="color: #0000BB">$orders&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$customer</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">orders</span><span style="color: #007700">;<br /><br /></span><span style="color: #FF8000">//&nbsp;SQL-запрос&nbsp;не&nbsp;выполняется<br /></span><span style="color: #0000BB">$orders2&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$customer</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">orders</span><span style="color: #007700">;</span>
</code></pre>
<p>Отложенная загрузка очень удобна в использовании. Однако этот метод может вызвать проблемы производительности, когда вам
понадобится получить доступ к тем же самым свойствам связей для нескольких объектов Active Record. Рассмотрите
следующий пример кода. Сколько SQL-запросов будет выполнено?</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #FF8000">//&nbsp;SELECT&nbsp;*&nbsp;FROM&nbsp;`customer`&nbsp;LIMIT&nbsp;100<br /></span><span style="color: #0000BB">$customers&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">find</span><span style="color: #007700">()-&gt;</span><span style="color: #0000BB">limit</span><span style="color: #007700">(</span><span style="color: #0000BB">100</span><span style="color: #007700">)-&gt;</span><span style="color: #0000BB">all</span><span style="color: #007700">();<br /><br />foreach&nbsp;(</span><span style="color: #0000BB">$customers&nbsp;</span><span style="color: #007700">as&nbsp;</span><span style="color: #0000BB">$customer</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;SELECT&nbsp;*&nbsp;FROM&nbsp;`order`&nbsp;WHERE&nbsp;`customer_id`&nbsp;=&nbsp;...<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$orders&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$customer</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">orders</span><span style="color: #007700">;<br />}</span>
</code></pre>
<p>Как вы могли заметить по вышеприведённым комментариям кода, будет выполнен 101 SQL-запрос! Это произойдёт из-за того,
что каждый раз внутри цикла будет выполняться SQL-запрос при получении доступа к свойству связи <code>orders</code> каждого
отдельного объекта <code>Customer</code>.</p>
<p>Для решения этой проблемы производительности вы можете, как показано ниже, использовать подход, который называется
<em>жадная загрузка</em>:</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #FF8000">//&nbsp;SELECT&nbsp;*&nbsp;FROM&nbsp;`customer`&nbsp;LIMIT&nbsp;100;<br />//&nbsp;SELECT&nbsp;*&nbsp;FROM&nbsp;`orders`&nbsp;WHERE&nbsp;`customer_id`&nbsp;IN&nbsp;(...)<br /></span><span style="color: #0000BB">$customers&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">find</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;-&gt;</span><span style="color: #0000BB">with</span><span style="color: #007700">(</span><span style="color: #DD0000">'orders'</span><span style="color: #007700">)<br />&nbsp;&nbsp;&nbsp;&nbsp;-&gt;</span><span style="color: #0000BB">limit</span><span style="color: #007700">(</span><span style="color: #0000BB">100</span><span style="color: #007700">)<br />&nbsp;&nbsp;&nbsp;&nbsp;-&gt;</span><span style="color: #0000BB">all</span><span style="color: #007700">();<br /><br />foreach&nbsp;(</span><span style="color: #0000BB">$customers&nbsp;</span><span style="color: #007700">as&nbsp;</span><span style="color: #0000BB">$customer</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;SQL-запрос&nbsp;не&nbsp;выполняется<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$orders&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$customer</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">orders</span><span style="color: #007700">;<br />}</span>
</code></pre>
<p>Посредством вызова метода <a href="http://www.yiiframework.com/doc-2.0/yii-db-activequery.html#with()-detail" title="yii\db\ActiveQuery::with()" target="_blank">yii\db\ActiveQuery::with()</a>, вы указываете объекту Active Record вернуть заказы первых 100
покупателей с помощью одного SQL-запроса. В результате снижаете количество выполняемых SQL-запросов от 101 до 2!</p>
<p>Вы можете жадно загружать одну или несколько связей. Вы можете даже жадно загружать <em>вложенные связи</em>. Вложенная связь -
это связь, которая объявлена внутри связного Active Record класса. Например, <code>Customer</code> связан с <code>Order</code> посредством
связи <code>orders</code>, а <code>Order</code> связан с <code>Item</code> посредством связи <code>items</code>. При формировании запроса для <code>Customer</code>, вы можете
жадно загрузить <code>items</code>, используя нотацию вложенной связи <code>orders.items</code>. </p>
<p>Ниже представлен код, который показывает различные способы использования метода <a href="http://www.yiiframework.com/doc-2.0/yii-db-activequery.html#with()-detail" title="with()" target="_blank">with()</a>.
Мы полагаем, что класс <code>Customer</code> имеет две связи: <code>orders</code> и <code>country</code> - в то время как класс <code>Order</code> имеет лишь одну
связь <code>items</code>.</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #FF8000">//&nbsp;жадная&nbsp;загрузка&nbsp;"orders"&nbsp;и&nbsp;"country"&nbsp;одновременно<br /></span><span style="color: #0000BB">$customers&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">find</span><span style="color: #007700">()-&gt;</span><span style="color: #0000BB">with</span><span style="color: #007700">(</span><span style="color: #DD0000">'orders'</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'country'</span><span style="color: #007700">)-&gt;</span><span style="color: #0000BB">all</span><span style="color: #007700">();<br /></span><span style="color: #FF8000">//&nbsp;аналог&nbsp;с&nbsp;использованием&nbsp;синтаксиса&nbsp;массива<br /></span><span style="color: #0000BB">$customers&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">find</span><span style="color: #007700">()-&gt;</span><span style="color: #0000BB">with</span><span style="color: #007700">([</span><span style="color: #DD0000">'orders'</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'country'</span><span style="color: #007700">])-&gt;</span><span style="color: #0000BB">all</span><span style="color: #007700">();<br /></span><span style="color: #FF8000">//&nbsp;SQL-запрос&nbsp;не&nbsp;выполняется<br /></span><span style="color: #0000BB">$orders</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$customers</span><span style="color: #007700">[</span><span style="color: #0000BB">0</span><span style="color: #007700">]-&gt;</span><span style="color: #0000BB">orders</span><span style="color: #007700">;<br /></span><span style="color: #FF8000">//&nbsp;SQL-запрос&nbsp;не&nbsp;выполняется<br /></span><span style="color: #0000BB">$country&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$customers</span><span style="color: #007700">[</span><span style="color: #0000BB">0</span><span style="color: #007700">]-&gt;</span><span style="color: #0000BB">country</span><span style="color: #007700">;<br /><br /></span><span style="color: #FF8000">//&nbsp;жадная&nbsp;загрузка&nbsp;связи&nbsp;"orders"&nbsp;и&nbsp;вложенной&nbsp;связи&nbsp;"orders.items"<br /></span><span style="color: #0000BB">$customers&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">find</span><span style="color: #007700">()-&gt;</span><span style="color: #0000BB">with</span><span style="color: #007700">(</span><span style="color: #DD0000">'orders.items'</span><span style="color: #007700">)-&gt;</span><span style="color: #0000BB">all</span><span style="color: #007700">();<br /></span><span style="color: #FF8000">//&nbsp;доступ&nbsp;к&nbsp;деталям&nbsp;первого&nbsp;заказа&nbsp;первого&nbsp;покупателя&nbsp;<br />//&nbsp;SQL-запрос&nbsp;не&nbsp;выполняется<br /></span><span style="color: #0000BB">$items&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$customers</span><span style="color: #007700">[</span><span style="color: #0000BB">0</span><span style="color: #007700">]-&gt;</span><span style="color: #0000BB">orders</span><span style="color: #007700">[</span><span style="color: #0000BB">0</span><span style="color: #007700">]-&gt;</span><span style="color: #0000BB">items</span><span style="color: #007700">;</span>
</code></pre>
<p>Вы можете жадно загрузить более глубокие вложенные связи, такие как <code>a.b.c.d</code>. Все родительские связи будут жадно
загружены. Таким образом, когда вы вызываете метод <a href="http://www.yiiframework.com/doc-2.0/yii-db-activequery.html#with()-detail" title="with()" target="_blank">with()</a> с параметром <code>a.b.c.d</code>, вы
жадно загрузите связи <code>a</code>, <code>a.b</code>, <code>a.b.c</code> и <code>a.b.c.d</code>.</p>
<blockquote><p><strong>Info:</strong> В целом, когда жадно загружается <code>N</code> связей, среди которых <code>M</code> связей объявлено с помощью
  <a href="index.html.1.82.html#junction-table">промежуточной таблицы</a>, суммарное количество выполняемых SQL-запросов будет равно <code>N+M+1</code>. Заметьте,
  что вложенная связь <code>a.b.c.d</code> насчитывает 4 связи.</p>
</blockquote>
<p>Когда связь жадно загружается, вы можете настроить соответствующий запрос получения связных данных с использованием
анонимной функции. Например:</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #FF8000">//&nbsp;найти&nbsp;покупателей&nbsp;и&nbsp;получить&nbsp;их&nbsp;вместе&nbsp;с&nbsp;их&nbsp;странами&nbsp;и&nbsp;активными&nbsp;заказами<br />//&nbsp;SELECT&nbsp;*&nbsp;FROM&nbsp;`customer`<br />//&nbsp;SELECT&nbsp;*&nbsp;FROM&nbsp;`country`&nbsp;WHERE&nbsp;`id`&nbsp;IN&nbsp;(...)<br />//&nbsp;SELECT&nbsp;*&nbsp;FROM&nbsp;`order`&nbsp;WHERE&nbsp;`customer_id`&nbsp;IN&nbsp;(...)&nbsp;AND&nbsp;`status`&nbsp;=&nbsp;1<br /></span><span style="color: #0000BB">$customers&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">find</span><span style="color: #007700">()-&gt;</span><span style="color: #0000BB">with</span><span style="color: #007700">([<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'country'</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'orders'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;function&nbsp;(</span><span style="color: #0000BB">$query</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">andWhere</span><span style="color: #007700">([</span><span style="color: #DD0000">'status'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">Order</span><span style="color: #007700">::</span><span style="color: #0000BB">STATUS_ACTIVE</span><span style="color: #007700">]);<br />&nbsp;&nbsp;&nbsp;&nbsp;},<br />])-&gt;</span><span style="color: #0000BB">all</span><span style="color: #007700">();</span>
</code></pre>
<p>Когда настраивается запрос на получение связных данных для какой-либо связи, вы можете указать название связи в виде
ключа массива и использовать анонимную функцию в качестве соответствующего значения этого массива. Анонимная функция
получит параметр <code>$query</code>, который представляет собой объект <a href="http://www.yiiframework.com/doc-2.0/yii-db-activequery.html" title="yii\db\ActiveQuery" target="_blank">yii\db\ActiveQuery</a>, используемый для выполнения запроса
на получение связных данных для данной связи. В вышеприведённом примере кода мы изменили запрос на получение связных
данных, наложив на него дополнительное условие выборки статуса заказов.</p>
<blockquote><p><strong>Note:</strong> Если вы вызываете метод <a href="http://www.yiiframework.com/doc-2.0/yii-db-query.html#select()-detail" title="select()" target="_blank">select()</a> в процессе жадной загрузки связей, вы должны
убедиться, что будут выбраны столбцы, участвующие в объявлении связей. Иначе связные модели будут загружены
неправильно. Например:</p>
<pre><code class="language-php"><span style="color: #0000BB">$orders&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Order</span><span style="color: #007700">::</span><span style="color: #0000BB">find</span><span style="color: #007700">()-&gt;</span><span style="color: #0000BB">select</span><span style="color: #007700">([</span><span style="color: #DD0000">'id'</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'amount'</span><span style="color: #007700">])-&gt;</span><span style="color: #0000BB">with</span><span style="color: #007700">(</span><span style="color: #DD0000">'customer'</span><span style="color: #007700">)-&gt;</span><span style="color: #0000BB">all</span><span style="color: #007700">();<br /></span><span style="color: #FF8000">//&nbsp;$orders[0]-&gt;customer&nbsp;всегда&nbsp;равно&nbsp;null.&nbsp;Для&nbsp;исправления&nbsp;проблемы&nbsp;вы&nbsp;должны&nbsp;сделать&nbsp;следующее:<br /></span><span style="color: #0000BB">$orders&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Order</span><span style="color: #007700">::</span><span style="color: #0000BB">find</span><span style="color: #007700">()-&gt;</span><span style="color: #0000BB">select</span><span style="color: #007700">([</span><span style="color: #DD0000">'id'</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'amount'</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'customer_id'</span><span style="color: #007700">])-&gt;</span><span style="color: #0000BB">with</span><span style="color: #007700">(</span><span style="color: #DD0000">'customer'</span><span style="color: #007700">)-&gt;</span><span style="color: #0000BB">all</span><span style="color: #007700">();</span>
</code></pre>
</blockquote>
<h3>Использование JOIN со связями<span id="joining-with-relations"></span> <a href="index.html.1.82.html#joining-with-relations" class="hashlink">#</a></h3><blockquote><p><strong>Note:</strong> Материал этого раздела применим только к реляционным базам данных, таким как MySQL, PostgreSQL, и т.д.</p>
</blockquote>
<p>Запросы на получение связных данных, которые мы рассмотрели выше, ссылаются только на столбцы основной таблицы при
извлечении основной информации. На самом же деле нам часто нужно ссылаться в запросах на столбцы связных таблиц.
Например, мы можем захотеть получить покупателей, для которых имеется хотя бы один активный заказ. Для решения этой
проблемы мы можем построить запрос с использованием JOIN как показано ниже:</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #FF8000">//&nbsp;SELECT&nbsp;`customer`.*&nbsp;FROM&nbsp;`customer`<br />//&nbsp;LEFT&nbsp;JOIN&nbsp;`order`&nbsp;ON&nbsp;`order`.`customer_id`&nbsp;=&nbsp;`customer`.`id`<br />//&nbsp;WHERE&nbsp;`order`.`status`&nbsp;=&nbsp;1<br />//&nbsp;<br />//&nbsp;SELECT&nbsp;*&nbsp;FROM&nbsp;`order`&nbsp;WHERE&nbsp;`customer_id`&nbsp;IN&nbsp;(...)<br /></span><span style="color: #0000BB">$customers&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">find</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;-&gt;</span><span style="color: #0000BB">select</span><span style="color: #007700">(</span><span style="color: #DD0000">'customer.*'</span><span style="color: #007700">)<br />&nbsp;&nbsp;&nbsp;&nbsp;-&gt;</span><span style="color: #0000BB">leftJoin</span><span style="color: #007700">(</span><span style="color: #DD0000">'order'</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'`order`.`customer_id`&nbsp;=&nbsp;`customer`.`id`'</span><span style="color: #007700">)<br />&nbsp;&nbsp;&nbsp;&nbsp;-&gt;</span><span style="color: #0000BB">where</span><span style="color: #007700">([</span><span style="color: #DD0000">'order.status'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">Order</span><span style="color: #007700">::</span><span style="color: #0000BB">STATUS_ACTIVE</span><span style="color: #007700">])<br />&nbsp;&nbsp;&nbsp;&nbsp;-&gt;</span><span style="color: #0000BB">with</span><span style="color: #007700">(</span><span style="color: #DD0000">'orders'</span><span style="color: #007700">)<br />&nbsp;&nbsp;&nbsp;&nbsp;-&gt;</span><span style="color: #0000BB">all</span><span style="color: #007700">();</span>
</code></pre>
<blockquote><p><strong>Note:</strong> Важно однозначно указывать в SQL-выражениях имена столбцов при построении запросов на получение связных
  данных с участием оператора JOIN. Наиболее распространённая практика - предварять названия столбцов с помощью имён
  соответствующих им таблиц.</p>
</blockquote>
<p>Однако лучшим подходом является использование имеющихся объявлений связей с помощью вызова метода
<a href="http://www.yiiframework.com/doc-2.0/yii-db-activequery.html#joinWith()-detail" title="yii\db\ActiveQuery::joinWith()" target="_blank">yii\db\ActiveQuery::joinWith()</a>:</p>
<pre><code class="language-php"><span style="color: #0000BB">$customers&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">find</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;-&gt;</span><span style="color: #0000BB">joinWith</span><span style="color: #007700">(</span><span style="color: #DD0000">'orders'</span><span style="color: #007700">)<br />&nbsp;&nbsp;&nbsp;&nbsp;-&gt;</span><span style="color: #0000BB">where</span><span style="color: #007700">([</span><span style="color: #DD0000">'order.status'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">Order</span><span style="color: #007700">::</span><span style="color: #0000BB">STATUS_ACTIVE</span><span style="color: #007700">])<br />&nbsp;&nbsp;&nbsp;&nbsp;-&gt;</span><span style="color: #0000BB">all</span><span style="color: #007700">();</span>
</code></pre>
<p>Оба подхода выполняют одинаковый набор SQL-запросов. Однако второй подход более прозрачен и прост.</p>
<p>По умолчанию, метод <a href="http://www.yiiframework.com/doc-2.0/yii-db-activequery.html#joinWith()-detail" title="joinWith()" target="_blank">joinWith()</a> будет использовать конструкцию <code>LEFT JOIN</code> для
объединения основной таблицы со связной. Вы можете указать другой тип операции JOIN (например, <code>RIGHT JOIN</code>) с помощью
третьего параметра этого метода - <code>$joinType</code>. Если вам нужен <code>INNER JOIN</code>, вы можете вместо этого просто вызвать
метод <a href="http://www.yiiframework.com/doc-2.0/yii-db-activequery.html#innerJoinWith()-detail" title="innerJoinWith()" target="_blank">innerJoinWith()</a>.</p>
<p>Вызов метода <a href="http://www.yiiframework.com/doc-2.0/yii-db-activequery.html#joinWith()-detail" title="joinWith()" target="_blank">joinWith()</a> будет <a href="index.html.1.82.html#lazy-eager-loading">жадно загружать</a> связные данные
по умолчанию. Если вы не хотите получать связные данные, вы можете передать во втором параметре <code>$eagerLoading</code> значение
<code>false</code>. </p>
<p>Подобно методу <a href="http://www.yiiframework.com/doc-2.0/yii-db-activequery.html#with()-detail" title="with()" target="_blank">with()</a> вы можете объединять данные с одной или несколькими связями; вы 
можете настроить запрос на получение связных данных "на лету"; вы можете объединять данные с вложенными связями; вы
можете смешивать использование метода <a href="http://www.yiiframework.com/doc-2.0/yii-db-activequery.html#with()-detail" title="with()" target="_blank">with()</a> и метода 
<a href="http://www.yiiframework.com/doc-2.0/yii-db-activequery.html#joinWith()-detail" title="joinWith()" target="_blank">joinWith()</a>. Например:</p>
<pre><code class="language-php"><span style="color: #0000BB">$customers&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">find</span><span style="color: #007700">()-&gt;</span><span style="color: #0000BB">joinWith</span><span style="color: #007700">([<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'orders'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;function&nbsp;(</span><span style="color: #0000BB">$query</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">andWhere</span><span style="color: #007700">([</span><span style="color: #DD0000">'&gt;'</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'subtotal'</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">100</span><span style="color: #007700">]);<br />&nbsp;&nbsp;&nbsp;&nbsp;},<br />])-&gt;</span><span style="color: #0000BB">with</span><span style="color: #007700">(</span><span style="color: #DD0000">'country'</span><span style="color: #007700">)<br />&nbsp;&nbsp;&nbsp;&nbsp;-&gt;</span><span style="color: #0000BB">all</span><span style="color: #007700">();</span>
</code></pre>
<p>Иногда во время объединения двух таблиц вам может потребоваться указать некоторые дополнительные условия рядом с
оператором <code>ON</code> во время выполнения JOIN-запроса. Это можно сделать с помощью вызова метода 
<a href="http://www.yiiframework.com/doc-2.0/yii-db-activequery.html#onCondition()-detail" title="yii\db\ActiveQuery::onCondition()" target="_blank">yii\db\ActiveQuery::onCondition()</a> как показано ниже:</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #FF8000">//&nbsp;SELECT&nbsp;`customer`.*&nbsp;FROM&nbsp;`customer`<br />//&nbsp;LEFT&nbsp;JOIN&nbsp;`order`&nbsp;ON&nbsp;`order`.`customer_id`&nbsp;=&nbsp;`customer`.`id`&nbsp;AND&nbsp;`order`.`status`&nbsp;=&nbsp;1&nbsp;<br />//&nbsp;<br />//&nbsp;SELECT&nbsp;*&nbsp;FROM&nbsp;`order`&nbsp;WHERE&nbsp;`customer_id`&nbsp;IN&nbsp;(...)<br /></span><span style="color: #0000BB">$customers&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">find</span><span style="color: #007700">()-&gt;</span><span style="color: #0000BB">joinWith</span><span style="color: #007700">([<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'orders'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;function&nbsp;(</span><span style="color: #0000BB">$query</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">onCondition</span><span style="color: #007700">([</span><span style="color: #DD0000">'order.status'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">Order</span><span style="color: #007700">::</span><span style="color: #0000BB">STATUS_ACTIVE</span><span style="color: #007700">]);<br />&nbsp;&nbsp;&nbsp;&nbsp;},<br />])-&gt;</span><span style="color: #0000BB">all</span><span style="color: #007700">();</span>
</code></pre>
<p>Вышеприведённый запрос вернёт <em>всех</em> покупателей и для каждого покупателя вернёт все активные заказы. Заметьте, что это
поведение отличается от нашего предыдущего примера, в котором возвращались только покупатели, у которых был как минимум
один активный заказ.</p>
<blockquote><p><strong>Info:</strong> Когда в объекте <a href="http://www.yiiframework.com/doc-2.0/yii-db-activequery.html" title="yii\db\ActiveQuery" target="_blank">yii\db\ActiveQuery</a> указано условие выборки с помощью метода
  <a href="http://www.yiiframework.com/doc-2.0/yii-db-activequery.html#onCondition()-detail" title="onCondition()" target="_blank">onCondition()</a>, это условие будет размещено в конструкции <code>ON</code>, если запрос
  содержит оператор JOIN. Если же запрос не содержит оператор JOIN, такое условие будет автоматически размещено в
  конструкции <code>WHERE</code>.</p>
</blockquote>
<h4>Псевдонимы связанных таблиц<span id="relation-table-aliases"></span> <a href="index.html.1.82.html#relation-table-aliases" class="hashlink">#</a></h4><p>Как уже было отмечено, при использовании в запросе JOIN-ов, приходится явно решать конфликты имён. Поэтому часто таблицам
дают псевдонимы. Задать псевдоним для реляционного запроса можно следующим образом:</p>
<pre><code class="language-php"><span style="color: #0000BB">$query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">joinWith</span><span style="color: #007700">([<br />&nbsp;&nbsp;</span><span style="color: #DD0000">'orders'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;function&nbsp;(</span><span style="color: #0000BB">$q</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$q</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">from</span><span style="color: #007700">([</span><span style="color: #DD0000">'o'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">Order</span><span style="color: #007700">::</span><span style="color: #0000BB">tableName</span><span style="color: #007700">()]);<br />&nbsp;&nbsp;},<br />])</span>
</code></pre>
<p>Выглядит это довольно сложно. Либо приходится задавать явно имена таблиц, либо вызывать <code>Order::tableName()</code>.
Начиная с версии 2.0.7 вы можете задать и использовать псевдоним для связанной таблицы следующим образом:</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #FF8000">//&nbsp;join&nbsp;the&nbsp;orders&nbsp;relation&nbsp;and&nbsp;sort&nbsp;the&nbsp;result&nbsp;by&nbsp;orders.id<br /></span><span style="color: #0000BB">$query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">joinWith</span><span style="color: #007700">([</span><span style="color: #DD0000">'orders&nbsp;o'</span><span style="color: #007700">])-&gt;</span><span style="color: #0000BB">orderBy</span><span style="color: #007700">(</span><span style="color: #DD0000">'o.id'</span><span style="color: #007700">);</span>
</code></pre>
<p>Этот синтаксис работает для простых связей. Если необходимо использовать связующую таблицу, например 
<code>$query-&gt;joinWith(['orders.product'])</code>, то вызовы joinWith вкладываются друг в друга:</p>
<pre><code class="language-php"><span style="color: #0000BB">$query</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">joinWith</span><span style="color: #007700">([</span><span style="color: #DD0000">'orders&nbsp;o'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;function(</span><span style="color: #0000BB">$q</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$q</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">joinWith</span><span style="color: #007700">(</span><span style="color: #DD0000">'product&nbsp;p'</span><span style="color: #007700">);<br />&nbsp;&nbsp;}])<br />&nbsp;&nbsp;-&gt;</span><span style="color: #0000BB">where</span><span style="color: #007700">(</span><span style="color: #DD0000">'o.amount&nbsp;&gt;&nbsp;100'</span><span style="color: #007700">);</span>
</code></pre>
<h3>Обратные связи<span id="inverse-relations"></span> <a href="index.html.1.82.html#inverse-relations" class="hashlink">#</a></h3><p>Объявления связей часто взаимны между двумя Active Record классами. Например, <code>Customer</code> связан с <code>Order</code> посредством
связи <code>orders</code>, а <code>Order</code> взаимно связан с <code>Customer</code> посредством связи <code>customer</code>.</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #007700">class&nbsp;</span><span style="color: #0000BB">Customer&nbsp;</span><span style="color: #007700">extends&nbsp;</span><span style="color: #0000BB">ActiveRecord<br /></span><span style="color: #007700">{<br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000BB">getOrders</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">hasMany</span><span style="color: #007700">(</span><span style="color: #0000BB">Order</span><span style="color: #007700">::class,&nbsp;[</span><span style="color: #DD0000">'customer_id'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'id'</span><span style="color: #007700">]);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />}<br /><br />class&nbsp;</span><span style="color: #0000BB">Order&nbsp;</span><span style="color: #007700">extends&nbsp;</span><span style="color: #0000BB">ActiveRecord<br /></span><span style="color: #007700">{<br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000BB">getCustomer</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">hasOne</span><span style="color: #007700">(</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::class,&nbsp;[</span><span style="color: #DD0000">'id'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'customer_id'</span><span style="color: #007700">]);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />}</span>
</code></pre>
<p>Теперь рассмотрим следующий участок кода:</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #FF8000">//&nbsp;SELECT&nbsp;*&nbsp;FROM&nbsp;`customer`&nbsp;WHERE&nbsp;`id`&nbsp;=&nbsp;123<br /></span><span style="color: #0000BB">$customer&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">findOne</span><span style="color: #007700">(</span><span style="color: #0000BB">123</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000">//&nbsp;SELECT&nbsp;*&nbsp;FROM&nbsp;`order`&nbsp;WHERE&nbsp;`customer_id`&nbsp;=&nbsp;123<br /></span><span style="color: #0000BB">$order&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$customer</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">orders</span><span style="color: #007700">[</span><span style="color: #0000BB">0</span><span style="color: #007700">];<br /><br /></span><span style="color: #FF8000">//&nbsp;SELECT&nbsp;*&nbsp;FROM&nbsp;`customer`&nbsp;WHERE&nbsp;`id`&nbsp;=&nbsp;123<br /></span><span style="color: #0000BB">$customer2&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$order</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">customer</span><span style="color: #007700">;<br /><br /></span><span style="color: #FF8000">//&nbsp;выведет&nbsp;"not&nbsp;the&nbsp;same"<br /></span><span style="color: #007700">echo&nbsp;</span><span style="color: #0000BB">$customer2&nbsp;</span><span style="color: #007700">===&nbsp;</span><span style="color: #0000BB">$customer&nbsp;</span><span style="color: #007700">?&nbsp;</span><span style="color: #DD0000">'same'&nbsp;</span><span style="color: #007700">:&nbsp;</span><span style="color: #DD0000">'not&nbsp;the&nbsp;same'</span><span style="color: #007700">;</span>
</code></pre>
<p>Мы думали, что <code>$customer</code> и <code>$customer2</code> эквивалентны, но оказалось, что нет! Фактически они содержат одинаковые
данные, но являются разными объектами. Когда мы получаем доступ к данным посредством <code>$order-&gt;customer</code>, выполняется
дополнительный SQL-запрос для заполнения нового объекта <code>$customer2</code>.</p>
<p>Чтобы избежать избыточного выполнения последнего SQL-запроса в вышеприведённом примере, мы должны подсказать Yii, что
<code>customer</code> - <em>обратная связь</em> относительно <code>orders</code>, и сделаем это с помощью вызова метода
<a href="http://www.yiiframework.com/doc-2.0/yii-db-activequery.html#inverseOf()-detail" title="inverseOf()" target="_blank">inverseOf()</a> как показано ниже:</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #007700">class&nbsp;</span><span style="color: #0000BB">Customer&nbsp;</span><span style="color: #007700">extends&nbsp;</span><span style="color: #0000BB">ActiveRecord<br /></span><span style="color: #007700">{<br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000BB">getOrders</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">hasMany</span><span style="color: #007700">(</span><span style="color: #0000BB">Order</span><span style="color: #007700">::class,&nbsp;[</span><span style="color: #DD0000">'customer_id'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'id'</span><span style="color: #007700">])-&gt;</span><span style="color: #0000BB">inverseOf</span><span style="color: #007700">(</span><span style="color: #DD0000">'customer'</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />}</span>
</code></pre>
<p>Теперь, после этих изменений в объявлении связи, получим:</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #FF8000">//&nbsp;SELECT&nbsp;*&nbsp;FROM&nbsp;`customer`&nbsp;WHERE&nbsp;`id`&nbsp;=&nbsp;123<br /></span><span style="color: #0000BB">$customer&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">findOne</span><span style="color: #007700">(</span><span style="color: #0000BB">123</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000">//&nbsp;SELECT&nbsp;*&nbsp;FROM&nbsp;`order`&nbsp;WHERE&nbsp;`customer_id`&nbsp;=&nbsp;123<br /></span><span style="color: #0000BB">$order&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$customer</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">orders</span><span style="color: #007700">[</span><span style="color: #0000BB">0</span><span style="color: #007700">];<br /><br /></span><span style="color: #FF8000">//&nbsp;SQL-запрос&nbsp;не&nbsp;выполняется<br /></span><span style="color: #0000BB">$customer2&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$order</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">customer</span><span style="color: #007700">;<br /><br /></span><span style="color: #FF8000">//&nbsp;выведет&nbsp;"same"<br /></span><span style="color: #007700">echo&nbsp;</span><span style="color: #0000BB">$customer2&nbsp;</span><span style="color: #007700">===&nbsp;</span><span style="color: #0000BB">$customer&nbsp;</span><span style="color: #007700">?&nbsp;</span><span style="color: #DD0000">'same'&nbsp;</span><span style="color: #007700">:&nbsp;</span><span style="color: #DD0000">'not&nbsp;the&nbsp;same'</span><span style="color: #007700">;</span>
</code></pre>
<blockquote><p><strong>Note:</strong> обратные связи не могут быть объявлены для связей, использующих <a href="index.html.1.82.html#junction-table">промежуточную таблицу</a>.
  То есть, если связь объявлена с помощью методов <a href="http://www.yiiframework.com/doc-2.0/yii-db-activequery.html#via()-detail" title="via()" target="_blank">via()</a> или
  <a href="http://www.yiiframework.com/doc-2.0/yii-db-activequery.html#viaTable()-detail" title="viaTable()" target="_blank">viaTable()</a>, вы не должны вызывать после этого метод
  <a href="http://www.yiiframework.com/doc-2.0/yii-db-activequery.html#inverseOf()-detail" title="inverseOf()" target="_blank">inverseOf()</a>.</p>
</blockquote>
<h2>Сохранение связных данных<span id="saving-relations"></span> <a href="index.html.1.82.html#saving-relations" class="hashlink">#</a></h2><p>Во время работы со связными данными вам часто требуется установить связи между двумя разными видами данных или удалить
существующие связи. Это требует установки правильных значений для столбцов, с помощью которых заданы связи. При
использовании Active Record вам может понадобится завершить участок кода следующим образом:</p>
<pre><code class="language-php"><span style="color: #0000BB">$customer&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">findOne</span><span style="color: #007700">(</span><span style="color: #0000BB">123</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$order&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">Order</span><span style="color: #007700">();<br /></span><span style="color: #0000BB">$order</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">subtotal&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">100</span><span style="color: #007700">;<br /></span><span style="color: #FF8000">//&nbsp;...<br /><br />//&nbsp;установка&nbsp;атрибута,&nbsp;которой&nbsp;задаёт&nbsp;связь&nbsp;"customer"&nbsp;в&nbsp;объекте&nbsp;Order<br /></span><span style="color: #0000BB">$order</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">customer_id&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$customer</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">id</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">$order</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">save</span><span style="color: #007700">();</span>
</code></pre>
<p>Active Record предоставляет метод <a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#link()-detail" title="link()" target="_blank">link()</a>, который позволяет выполнить эту задачу
более красивым способом:</p>
<pre><code class="language-php"><span style="color: #0000BB">$customer&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">findOne</span><span style="color: #007700">(</span><span style="color: #0000BB">123</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$order&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">Order</span><span style="color: #007700">();<br /></span><span style="color: #0000BB">$order</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">subtotal&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">100</span><span style="color: #007700">;<br /></span><span style="color: #FF8000">//&nbsp;...<br /><br /></span><span style="color: #0000BB">$order</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">link</span><span style="color: #007700">(</span><span style="color: #DD0000">'customer'</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$customer</span><span style="color: #007700">);</span>
</code></pre>
<p>Метод <a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#link()-detail" title="link()" target="_blank">link()</a> требует указать название связи и целевой объект Active Record, с которым
должна быть установлена связь. Метод изменит значения атрибутов, которые связывают два объекта Active Record, и сохранит
их в базу данных. В вышеприведённом примере, метод присвоит атрибуту <code>customer_id</code> объекта <code>Order</code> значение атрибута
<code>id</code> объекта <code>Customer</code> и затем сохранит его в базу данных.</p>
<blockquote><p><strong>Note:</strong> Невозможно связать два свежесозданных объекта Active Record.</p>
</blockquote>
<p>Преимущество метода <a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#link()-detail" title="link()" target="_blank">link()</a> становится ещё более очевидным, когда связь объявлена
посредством <a href="index.html.1.82.html#junction-table">промежуточной таблицы</a>. Например, вы можете использовать следующий код, чтобы связать
объект <code>Order</code> с объектом <code>Item</code>:</p>
<pre><code class="language-php"><span style="color: #0000BB">$order</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">link</span><span style="color: #007700">(</span><span style="color: #DD0000">'items'</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$item</span><span style="color: #007700">);</span>
</code></pre>
<p>Вышеприведённый код автоматически вставит строку данных в промежуточную таблицу <code>order_item</code>, чтобы связать объект 
<code>order</code> с объектом <code>item</code>.</p>
<blockquote><p><strong>Info:</strong> Метод <a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#link()-detail" title="link()" target="_blank">link()</a> не осуществляет какую-либо валидацию данных во время
  сохранения целевого объекта Active Record. На вас лежит ответственность за валидацию любых введённых данных перед
  вызовом этого метода.</p>
</blockquote>
<p>Существует противоположная операция для <a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#link()-detail" title="link()" target="_blank">link()</a> - это операция
<a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#unlink()-detail" title="unlink()" target="_blank">unlink()</a>, она снимает существующую связь с двух объектов Active Record. Например:</p>
<pre><code class="language-php"><span style="color: #0000BB">$customer&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">find</span><span style="color: #007700">()-&gt;</span><span style="color: #0000BB">with</span><span style="color: #007700">(</span><span style="color: #DD0000">'orders'</span><span style="color: #007700">)-&gt;</span><span style="color: #0000BB">where</span><span style="color: #007700">([</span><span style="color: #DD0000">'id'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">123</span><span style="color: #007700">])-&gt;</span><span style="color: #0000BB">one</span><span style="color: #007700">();<br /></span><span style="color: #0000BB">$customer</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">unlink</span><span style="color: #007700">(</span><span style="color: #DD0000">'orders'</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$customer</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">orders</span><span style="color: #007700">[</span><span style="color: #0000BB">0</span><span style="color: #007700">]);</span>
</code></pre>
<p>По умолчанию метод <a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#unlink()-detail" title="unlink()" target="_blank">unlink()</a> задаст вторичному ключу (или ключам), который определяет
существующую связь, значение <code>null</code>. Однако вы можете запросить удаление строки таблицы, которая содержит значение
вторичного ключа, передав значение <code>true</code> в параметре <code>$delete</code> для этого метода.</p>
<p>Если связь построена на основе промежуточной таблицы, вызов метода <a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#unlink()-detail" title="unlink()" target="_blank">unlink()</a> инициирует
очистку вторичных ключей в промежуточной таблице, или же удаление соответствующей строки данных в промежуточной таблице,
если параметр <code>$delete</code> равен <code>true</code>.</p>
<h2>Связывание объектов из разных баз данных<span id="cross-database-relations"></span> <a href="index.html.1.82.html#cross-database-relations" class="hashlink">#</a></h2><p>Active Record позволяет вам объявить связи между классами Active Record, которые относятся к разным базам данных. Базы
данных могут быть разных типов (например, MySQL и PostgreSQL или MS SQL и MongoDB), и они могут быть запущены на разных
серверах. Вы можете использовать тот же самый синтаксис для осуществления запросов выборки связных данных. Например:</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #FF8000">//&nbsp;Объект&nbsp;Customer&nbsp;соответствует&nbsp;таблице&nbsp;"customer"&nbsp;в&nbsp;реляционной&nbsp;базе&nbsp;данных&nbsp;(например&nbsp;MySQL)<br /></span><span style="color: #007700">class&nbsp;</span><span style="color: #0000BB">Customer&nbsp;</span><span style="color: #007700">extends&nbsp;\</span><span style="color: #0000BB">yii</span><span style="color: #007700">\</span><span style="color: #0000BB">db</span><span style="color: #007700">\</span><span style="color: #0000BB">ActiveRecord<br /></span><span style="color: #007700">{<br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;function&nbsp;</span><span style="color: #0000BB">tableName</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #DD0000">'customer'</span><span style="color: #007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000BB">getComments</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;у&nbsp;покупателя&nbsp;может&nbsp;быть&nbsp;много&nbsp;комментариев<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">return&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">hasMany</span><span style="color: #007700">(</span><span style="color: #0000BB">Comment</span><span style="color: #007700">::class,&nbsp;[</span><span style="color: #DD0000">'customer_id'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'id'</span><span style="color: #007700">]);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />}<br /><br /></span><span style="color: #FF8000">//&nbsp;Объект&nbsp;Comment&nbsp;соответствует&nbsp;коллекции&nbsp;"comment"&nbsp;в&nbsp;базе&nbsp;данных&nbsp;MongoDB<br /></span><span style="color: #007700">class&nbsp;</span><span style="color: #0000BB">Comment&nbsp;</span><span style="color: #007700">extends&nbsp;\</span><span style="color: #0000BB">yii</span><span style="color: #007700">\</span><span style="color: #0000BB">mongodb</span><span style="color: #007700">\</span><span style="color: #0000BB">ActiveRecord<br /></span><span style="color: #007700">{<br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;function&nbsp;</span><span style="color: #0000BB">collectionName</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #DD0000">'comment'</span><span style="color: #007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000BB">getCustomer</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;комментарий&nbsp;принадлежит&nbsp;одному&nbsp;покупателю<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">return&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">hasOne</span><span style="color: #007700">(</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::class,&nbsp;[</span><span style="color: #DD0000">'id'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'customer_id'</span><span style="color: #007700">]);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />}<br /><br /></span><span style="color: #0000BB">$customers&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">find</span><span style="color: #007700">()-&gt;</span><span style="color: #0000BB">with</span><span style="color: #007700">(</span><span style="color: #DD0000">'comments'</span><span style="color: #007700">)-&gt;</span><span style="color: #0000BB">all</span><span style="color: #007700">();</span>
</code></pre>
<p>Вы можете использовать большую часть возможностей запросов получения связных данных, которые были описаны в этой главе.</p>
<blockquote><p><strong>Note:</strong> Применимость метода <a href="http://www.yiiframework.com/doc-2.0/yii-db-activequery.html#joinWith()-detail" title="joinWith()" target="_blank">joinWith()</a> ограничена базами данных, которые
  позволяют выполнять запросы между разными базами с использованием оператора JOIN. По этой причине вы не можете
  использовать этот метод в вышеприведённом примере, т.к. MongoDB не поддерживает операцию JOIN.</p>
</blockquote>
<h2>Тонкая настройка классов Query<span id="customizing-query-classes"></span> <a href="index.html.1.82.html#customizing-query-classes" class="hashlink">#</a></h2><p>По умолчанию все запросы данных для Active Record поддерживаются с помощью класса <a href="http://www.yiiframework.com/doc-2.0/yii-db-activequery.html" title="yii\db\ActiveQuery" target="_blank">yii\db\ActiveQuery</a>. Для
использования собственного класса запроса вам необходимо переопределить метод <a href="http://www.yiiframework.com/doc-2.0/yii-db-activerecord.html#find()-detail" title="yii\db\ActiveRecord::find()" target="_blank">yii\db\ActiveRecord::find()</a> и
возвращать из него объект вашего собственного класса запроса. Например:</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #007700">namespace&nbsp;</span><span style="color: #0000BB">app</span><span style="color: #007700">\</span><span style="color: #0000BB">models</span><span style="color: #007700">;<br /><br />use&nbsp;</span><span style="color: #0000BB">yii</span><span style="color: #007700">\</span><span style="color: #0000BB">db</span><span style="color: #007700">\</span><span style="color: #0000BB">ActiveRecord</span><span style="color: #007700">;<br />use&nbsp;</span><span style="color: #0000BB">yii</span><span style="color: #007700">\</span><span style="color: #0000BB">db</span><span style="color: #007700">\</span><span style="color: #0000BB">ActiveQuery</span><span style="color: #007700">;<br /><br />class&nbsp;</span><span style="color: #0000BB">Comment&nbsp;</span><span style="color: #007700">extends&nbsp;</span><span style="color: #0000BB">ActiveRecord<br /></span><span style="color: #007700">{<br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;function&nbsp;</span><span style="color: #0000BB">find</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;</span><span style="color: #0000BB">CommentQuery</span><span style="color: #007700">(</span><span style="color: #0000BB">get_called_class</span><span style="color: #007700">());<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />}<br /><br />class&nbsp;</span><span style="color: #0000BB">CommentQuery&nbsp;</span><span style="color: #007700">extends&nbsp;</span><span style="color: #0000BB">ActiveQuery<br /></span><span style="color: #007700">{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;...<br /></span><span style="color: #007700">}</span>
</code></pre>
<p>Теперь, когда вы будете осуществлять получение данных (например, выполните <code>find()</code>, <code>findOne()</code>) или объявите связь
(например, <code>hasOne()</code>) с объектом <code>Comment</code>, вы будете работать с объектом класса <code>CommentQuery</code> вместо <code>ActiveQuery</code>.</p>
<blockquote><p><strong>Tip:</strong> В больших проектах рекомендуется использовать собственные классы запросов, которые будут содержать в себе
  большую часть кода, связанного с настройкой запросов, таким образом классы Active Record удастся сохранить более
  чистыми.</p>
</blockquote>
<p>Вы можете настроить класс запроса большим количеством различных способов для улучшения методик построения запросов.
Например, можете объявить новые методы построения запросов в собственном классе запросов:</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #007700">class&nbsp;</span><span style="color: #0000BB">CommentQuery&nbsp;</span><span style="color: #007700">extends&nbsp;</span><span style="color: #0000BB">ActiveQuery<br /></span><span style="color: #007700">{<br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000BB">active</span><span style="color: #007700">(</span><span style="color: #0000BB">$state&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">true</span><span style="color: #007700">)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">andWhere</span><span style="color: #007700">([</span><span style="color: #DD0000">'active'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">$state</span><span style="color: #007700">]);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />}</span>
</code></pre>
<blockquote><p><strong>Note:</strong> Вместо вызова метода <a href="http://www.yiiframework.com/doc-2.0/yii-db-activequery.html#where()-detail" title="where()" target="_blank">where()</a> старайтесь во время объявления новых методов
  построения запросов использовать <a href="http://www.yiiframework.com/doc-2.0/yii-db-activequery.html#andWhere()-detail" title="andWhere()" target="_blank">andWhere()</a> или
  <a href="http://www.yiiframework.com/doc-2.0/yii-db-activequery.html#orWhere()-detail" title="orWhere()" target="_blank">orWhere()</a> для добавления дополнительных условий, в этом случае уже заданные условия
  выборок не будут перезаписаны.</p>
</blockquote>
<p>Это позволит вам писать код построения запросов как показано ниже:</p>
<pre><code class="language-php"><span style="color: #0000BB">$comments&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Comment</span><span style="color: #007700">::</span><span style="color: #0000BB">find</span><span style="color: #007700">()-&gt;</span><span style="color: #0000BB">active</span><span style="color: #007700">()-&gt;</span><span style="color: #0000BB">all</span><span style="color: #007700">();<br /></span><span style="color: #0000BB">$inactiveComments&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Comment</span><span style="color: #007700">::</span><span style="color: #0000BB">find</span><span style="color: #007700">()-&gt;</span><span style="color: #0000BB">active</span><span style="color: #007700">(</span><span style="color: #0000BB">false</span><span style="color: #007700">)-&gt;</span><span style="color: #0000BB">all</span><span style="color: #007700">();</span>
</code></pre>
<p>Вы также можете использовать новые методы построения запросов, когда объявляете связи для класса <code>Comment</code> или
осуществляете запрос для выборки связных данных:</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #007700">class&nbsp;</span><span style="color: #0000BB">Customer&nbsp;</span><span style="color: #007700">extends&nbsp;\</span><span style="color: #0000BB">yii</span><span style="color: #007700">\</span><span style="color: #0000BB">db</span><span style="color: #007700">\</span><span style="color: #0000BB">ActiveRecord<br /></span><span style="color: #007700">{<br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000BB">getActiveComments</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">hasMany</span><span style="color: #007700">(</span><span style="color: #0000BB">Comment</span><span style="color: #007700">::class,&nbsp;[</span><span style="color: #DD0000">'customer_id'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'id'</span><span style="color: #007700">])-&gt;</span><span style="color: #0000BB">active</span><span style="color: #007700">();<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />}<br /><br /></span><span style="color: #0000BB">$customers&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">find</span><span style="color: #007700">()-&gt;</span><span style="color: #0000BB">with</span><span style="color: #007700">(</span><span style="color: #DD0000">'activeComments'</span><span style="color: #007700">)-&gt;</span><span style="color: #0000BB">all</span><span style="color: #007700">();<br /><br /></span><span style="color: #FF8000">//&nbsp;или&nbsp;по-другому:<br />&nbsp;<br /></span><span style="color: #0000BB">$customers&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">find</span><span style="color: #007700">()-&gt;</span><span style="color: #0000BB">with</span><span style="color: #007700">([<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'comments'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;function(</span><span style="color: #0000BB">$q</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$q</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">active</span><span style="color: #007700">();<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />])-&gt;</span><span style="color: #0000BB">all</span><span style="color: #007700">();</span>
</code></pre>
<blockquote><p><strong>Info:</strong> В Yii версии 1.1 была концепция с названием <em>scope</em>. Она больше не поддерживается в Yii версии 2.0, и вы
  можете использовать собственные классы запросов и собственные методы построения запросов, чтобы добиться той же самой
  цели.</p>
</blockquote>
<h2>Получение дополнительных атрибутов<span id="polucenie-dopolnitelnyh-atributov"></span> <a href="index.html.1.82.html#polucenie-dopolnitelnyh-atributov" class="hashlink">#</a></h2><p>Когда объект Active Record заполнен результатами запроса, его атрибуты заполнены значениями соответствующих столбцов
из полученного набора данных.</p>
<p>Вы можете получить дополнительные столбцы или значения с помощью запроса и сохранить их внутри объекта Active Record.
Например, предположим, что у нас есть таблица 'room', которая содержит информацию о доступных в отеле комнатах. Каждая
комната хранит информацию о её геометрических размерах с помощью атрибутов 'length', 'width', 'height'. Представьте, что
вам требуется получить список всех доступных комнат, отсортированных по их объёму в порядке убывания. В этом случае вы
не можете вычислять объём с помощью PHP, потому что нам требуется сортировать записи по объёму, но вы также хотите
отображать объем в списке. Для достижения этой цели, вам необходимо объявить дополнительный атрибут в вашем Active
Record классе 'Room', который будет хранить значение 'volume':</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #007700">class&nbsp;</span><span style="color: #0000BB">Room&nbsp;</span><span style="color: #007700">extends&nbsp;\</span><span style="color: #0000BB">yii</span><span style="color: #007700">\</span><span style="color: #0000BB">db</span><span style="color: #007700">\</span><span style="color: #0000BB">ActiveRecord<br /></span><span style="color: #007700">{<br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;</span><span style="color: #0000BB">$volume</span><span style="color: #007700">;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;...<br /></span><span style="color: #007700">}</span>
</code></pre>
<p>Далее вам необходимо составить запрос, который вычисляет объём комнаты и выполняет сортировку:</p>
<pre><code class="language-php"><span style="color: #0000BB">$rooms&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Room</span><span style="color: #007700">::</span><span style="color: #0000BB">find</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;-&gt;</span><span style="color: #0000BB">select</span><span style="color: #007700">([<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'{{room}}.*'</span><span style="color: #007700">,&nbsp;</span><span style="color: #FF8000">//&nbsp;получить&nbsp;все&nbsp;столбцы<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'([[length]]&nbsp;*&nbsp;[[width]]&nbsp;*&nbsp;[[height]])&nbsp;AS&nbsp;volume'</span><span style="color: #007700">,&nbsp;</span><span style="color: #FF8000">//&nbsp;вычислить&nbsp;объём<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">])<br />&nbsp;&nbsp;&nbsp;&nbsp;-&gt;</span><span style="color: #0000BB">orderBy</span><span style="color: #007700">(</span><span style="color: #DD0000">'volume&nbsp;DESC'</span><span style="color: #007700">)&nbsp;</span><span style="color: #FF8000">//&nbsp;отсортировать<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">all</span><span style="color: #007700">();<br /><br />foreach&nbsp;(</span><span style="color: #0000BB">$rooms&nbsp;</span><span style="color: #007700">as&nbsp;</span><span style="color: #0000BB">$room</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;</span><span style="color: #0000BB">$room</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">volume</span><span style="color: #007700">;&nbsp;</span><span style="color: #FF8000">//&nbsp;содержит&nbsp;значение,&nbsp;вычисленное&nbsp;с&nbsp;помощью&nbsp;SQL-запроса<br /></span><span style="color: #007700">}</span>
</code></pre>
<p>Возможность выбирать дополнительные атрибуты может быть особенно полезной для агрегирующих запросов. Представьте, что
вам необходимо отображать список покупателей с количеством их заказов. Прежде всего вам потребуется объявить класс 
<code>Customer</code> со связью 'orders' и дополнительным атрибутом для хранения расчётов:</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #007700">class&nbsp;</span><span style="color: #0000BB">Customer&nbsp;</span><span style="color: #007700">extends&nbsp;\</span><span style="color: #0000BB">yii</span><span style="color: #007700">\</span><span style="color: #0000BB">db</span><span style="color: #007700">\</span><span style="color: #0000BB">ActiveRecord<br /></span><span style="color: #007700">{<br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;</span><span style="color: #0000BB">$ordersCount</span><span style="color: #007700">;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;...<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">public&nbsp;function&nbsp;</span><span style="color: #0000BB">getOrders</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">hasMany</span><span style="color: #007700">(</span><span style="color: #0000BB">Order</span><span style="color: #007700">::class,&nbsp;[</span><span style="color: #DD0000">'customer_id'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'id'</span><span style="color: #007700">]);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />}</span>
</code></pre>
<p>После этого вы сможете составить запрос, который объединяет заказы и вычисляет их количество:</p>
<pre><code class="language-php"><span style="color: #0000BB">$customers&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">find</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;-&gt;</span><span style="color: #0000BB">select</span><span style="color: #007700">([<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'{{customer}}.*'</span><span style="color: #007700">,&nbsp;</span><span style="color: #FF8000">//&nbsp;получить&nbsp;все&nbsp;атрибуты&nbsp;покупателя<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'COUNT({{order}}.id)&nbsp;AS&nbsp;ordersCount'&nbsp;</span><span style="color: #FF8000">//&nbsp;вычислить&nbsp;количество&nbsp;заказов<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">])<br />&nbsp;&nbsp;&nbsp;&nbsp;-&gt;</span><span style="color: #0000BB">joinWith</span><span style="color: #007700">(</span><span style="color: #DD0000">'orders'</span><span style="color: #007700">)&nbsp;</span><span style="color: #FF8000">//&nbsp;обеспечить&nbsp;построение&nbsp;промежуточной&nbsp;таблицы<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">groupBy</span><span style="color: #007700">(</span><span style="color: #DD0000">'{{customer}}.id'</span><span style="color: #007700">)&nbsp;</span><span style="color: #FF8000">//&nbsp;сгруппировать&nbsp;результаты,&nbsp;чтобы&nbsp;заставить&nbsp;агрегацию&nbsp;работать<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">all</span><span style="color: #007700">();</span>
</code></pre>
<p>Недостаток этого подхода заключается в том, что если данные для поля не загружены по результатам SQL запроса, то они
должны быть вычисленны отдельно. Это означает, что запись, полученная посредством обычного запроса без дополнительных полей в
разделе 'select', не может вернуть реальное значения для дополнительного поля. Это же касается и только что сохранненой
записи.</p>
<pre><code class="language-php"><span style="color: #0000BB">$room&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">Room</span><span style="color: #007700">();<br /></span><span style="color: #0000BB">$room</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">length&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">100</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">$room</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">width&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">50</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">$room</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">height&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">2</span><span style="color: #007700">;<br /><br /></span><span style="color: #0000BB">$room</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">volume</span><span style="color: #007700">;&nbsp;</span><span style="color: #FF8000">//&nbsp;значение&nbsp;будет&nbsp;равно&nbsp;`null`,&nbsp;т.к.&nbsp;поле&nbsp;не&nbsp;было&nbsp;заполнено</span>
</code></pre>
<p>Использование магических методов <a href="http://www.yiiframework.com/doc-2.0/yii-db-baseactiverecord.html#__get()-detail" title="__get()" target="_blank">__get()</a> и <a href="http://www.yiiframework.com/doc-2.0/yii-db-baseactiverecord.html#__set()-detail" title="__set()" target="_blank">__set()</a>
позволяет эмулировать поведение обычного поля:</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #007700">class&nbsp;</span><span style="color: #0000BB">Room&nbsp;</span><span style="color: #007700">extends&nbsp;\</span><span style="color: #0000BB">yii</span><span style="color: #007700">\</span><span style="color: #0000BB">db</span><span style="color: #007700">\</span><span style="color: #0000BB">ActiveRecord<br /></span><span style="color: #007700">{<br />&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;</span><span style="color: #0000BB">$_volume</span><span style="color: #007700">;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000BB">setVolume</span><span style="color: #007700">(</span><span style="color: #0000BB">$volume</span><span style="color: #007700">)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">_volume&nbsp;</span><span style="color: #007700">=&nbsp;(float)&nbsp;</span><span style="color: #0000BB">$volume</span><span style="color: #007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000BB">getVolume</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(empty(</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">length</span><span style="color: #007700">)&nbsp;||&nbsp;empty(</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">width</span><span style="color: #007700">)&nbsp;||&nbsp;empty(</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">height</span><span style="color: #007700">))&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">null</span><span style="color: #007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">_volume&nbsp;</span><span style="color: #007700">===&nbsp;</span><span style="color: #0000BB">null</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">setVolume</span><span style="color: #007700">(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">length&nbsp;</span><span style="color: #007700">*&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">width&nbsp;</span><span style="color: #007700">*&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">height<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">_volume</span><span style="color: #007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;...<br /></span><span style="color: #007700">}</span>
</code></pre>
<p>Если результат запроса на выборку данных не содержит поле 'volume', то модель сможет расчитать его автоматически
используя имеющиеся атрибуты.</p>
<p>Вы также можете вычислять агрегируемые поля используя объявленные отношения:</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #007700">class&nbsp;</span><span style="color: #0000BB">Customer&nbsp;</span><span style="color: #007700">extends&nbsp;\</span><span style="color: #0000BB">yii</span><span style="color: #007700">\</span><span style="color: #0000BB">db</span><span style="color: #007700">\</span><span style="color: #0000BB">ActiveRecord<br /></span><span style="color: #007700">{<br />&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;</span><span style="color: #0000BB">$_ordersCount</span><span style="color: #007700">;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000BB">setOrdersCount</span><span style="color: #007700">(</span><span style="color: #0000BB">$count</span><span style="color: #007700">)<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">_ordersCount&nbsp;</span><span style="color: #007700">=&nbsp;(int)&nbsp;</span><span style="color: #0000BB">$count</span><span style="color: #007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000BB">getOrdersCount</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">isNewRecord</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">null</span><span style="color: #007700">;&nbsp;</span><span style="color: #FF8000">//&nbsp;нет&nbsp;смысла&nbsp;выполнять&nbsp;запрос&nbsp;на&nbsp;поиск&nbsp;по&nbsp;пустым&nbsp;ключам<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">_ordersCount&nbsp;</span><span style="color: #007700">===&nbsp;</span><span style="color: #0000BB">null</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">setOrdersCount</span><span style="color: #007700">(</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">getOrders</span><span style="color: #007700">()-&gt;</span><span style="color: #0000BB">count</span><span style="color: #007700">());&nbsp;</span><span style="color: #FF8000">//&nbsp;вычисляем&nbsp;агрегацию&nbsp;по&nbsp;требованию&nbsp;из&nbsp;отношения<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">_ordersCount</span><span style="color: #007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;...<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">public&nbsp;function&nbsp;</span><span style="color: #0000BB">getOrders</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">hasMany</span><span style="color: #007700">(</span><span style="color: #0000BB">Order</span><span style="color: #007700">::class,&nbsp;[</span><span style="color: #DD0000">'customer_id'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'id'</span><span style="color: #007700">]);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />}</span>
</code></pre>
<p>При такой реализации, в случае когда 'ordersCount' присутсвует в разделе 'select' - значение 'Customer::ordersCount' будет
заполнено из результатов запроса, в противном случае - оно будет вычислено по первому требованию на основании отношения <code>Customer::orders</code>.</p>
<p>Этот подход также можно использовать для быстрого доступа к некоторым данным отношений, в особенности для агрегации.
Например:</p>
<pre><code class="language-php"><span style="color: #0000BB"></span><span style="color: #007700">class&nbsp;</span><span style="color: #0000BB">Customer&nbsp;</span><span style="color: #007700">extends&nbsp;\</span><span style="color: #0000BB">yii</span><span style="color: #007700">\</span><span style="color: #0000BB">db</span><span style="color: #007700">\</span><span style="color: #0000BB">ActiveRecord<br /></span><span style="color: #007700">{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Объявляет&nbsp;виртуальное&nbsp;свойство&nbsp;для&nbsp;агрегируемых&nbsp;данных,&nbsp;доступное&nbsp;только&nbsp;на&nbsp;чтение.<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">public&nbsp;function&nbsp;</span><span style="color: #0000BB">getOrdersCount</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">isNewRecord</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">null</span><span style="color: #007700">;&nbsp;</span><span style="color: #FF8000">//&nbsp;нет&nbsp;смысла&nbsp;выполнять&nbsp;запрос&nbsp;на&nbsp;поиск&nbsp;по&nbsp;пустым&nbsp;ключам<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">ordersAggregation</span><span style="color: #007700">[</span><span style="color: #0000BB">0</span><span style="color: #007700">][</span><span style="color: #DD0000">'counted'</span><span style="color: #007700">];<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Объявляет&nbsp;обычное&nbsp;отношение&nbsp;'orders'.<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">public&nbsp;function&nbsp;</span><span style="color: #0000BB">getOrders</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">hasMany</span><span style="color: #007700">(</span><span style="color: #0000BB">Order</span><span style="color: #007700">::class,&nbsp;[</span><span style="color: #DD0000">'customer_id'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'id'</span><span style="color: #007700">]);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/**<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Объявляет&nbsp;новое&nbsp;отношение,&nbsp;основанное&nbsp;на&nbsp;'orders',&nbsp;которое&nbsp;предоставляет&nbsp;агрегацию.<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">public&nbsp;function&nbsp;</span><span style="color: #0000BB">getOrdersAggregation</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">getOrders</span><span style="color: #007700">()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&gt;</span><span style="color: #0000BB">select</span><span style="color: #007700">([</span><span style="color: #DD0000">'customer_id'</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'counted'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'count(*)'</span><span style="color: #007700">])<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&gt;</span><span style="color: #0000BB">groupBy</span><span style="color: #007700">(</span><span style="color: #DD0000">'customer_id'</span><span style="color: #007700">)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&gt;</span><span style="color: #0000BB">asArray</span><span style="color: #007700">(</span><span style="color: #0000BB">true</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;...<br /></span><span style="color: #007700">}<br /><br />foreach&nbsp;(</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">find</span><span style="color: #007700">()-&gt;</span><span style="color: #0000BB">with</span><span style="color: #007700">(</span><span style="color: #DD0000">'ordersAggregation'</span><span style="color: #007700">)-&gt;</span><span style="color: #0000BB">all</span><span style="color: #007700">()&nbsp;as&nbsp;</span><span style="color: #0000BB">$customer</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;</span><span style="color: #0000BB">$customer</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">ordersCount</span><span style="color: #007700">;&nbsp;</span><span style="color: #FF8000">//&nbsp;выводит&nbsp;агрегируемые&nbsp;данные&nbsp;из&nbsp;отношения&nbsp;без&nbsp;дополнительного&nbsp;запроса&nbsp;благодаря&nbsp;жадной&nbsp;загрузке<br /></span><span style="color: #007700">}<br /><br /></span><span style="color: #0000BB">$customer&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">Customer</span><span style="color: #007700">::</span><span style="color: #0000BB">findOne</span><span style="color: #007700">(</span><span style="color: #0000BB">$pk</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$customer</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">ordersCount</span><span style="color: #007700">;&nbsp;</span><span style="color: #FF8000">//&nbsp;выводит&nbsp;агрегируемые&nbsp;данные&nbsp;отношения&nbsp;через&nbsp;ленивую&nbsp;загрузку</span>
</code></pre>
</div>
<hr><script src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js" async></script><!-- Documentation (footer) --><ins class="adsbygoogle" style="display: block;" data-ad-client="ca-pub-8275858625830540" data-ad-slot="4067432912" data-ad-format="auto"></ins><small style="margin-top: 10px; display: block;"><a href="https://yiiframework.com.ua/ru/adv/" rel="nofollow" target="_blank">Зачем реклама?</a></small><script>(adsbygoogle = window.adsbygoogle || []).push({})</script>                </div>
            </div>
        </div>
    </div>
    <div class="row footer">
    <div class="col-sm-6">
        <small class="text-left center-block">
            <img src="https://img.shields.io/badge/Украинское сообщество Yii Framework-v16.4-brightgreen.svg?style=flat-square" alt="">            <img src="https://img.shields.io/badge/©-2012%20--%202022-lightgrey.svg?style=flat-square" alt="">            <br>
            <img src="https://img.shields.io/badge/Docker-1.11.1-0296C9.svg?style=flat-square" alt="">            <img src="https://img.shields.io/badge/Yii-2.0.10--dev-red.svg?style=flat-square" alt="">            <img src="https://img.shields.io/badge/PHP-7.0.9-8892BF.svg?style=flat-square" alt="">        </small>
    </div>
    <div class="col-sm-6 text-right">
        <small class="text-muted">
            <span>&copy; 2012 — 2022 <a href="https://github.com/yiiframework-ua">Borales</a></span>
            <br/>
            <span>
                &copy; 2008 — 2022 <a href="http://www.yiisoft.com/" target="_blank" rel="nofollow">Yii Software LLC</a>
                | <a href="http://www.yiiframework.com/license/" target="_blank" rel="nofollow">Лицензия</a>
            </span>
        </small>
    </div>
</div>
            </div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-timeago/1.5.2/jquery.timeago.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="https://yiiframework.com.ua/js/compiled.min.js?v=1469914490"></script>
<script src="https://yiiframework.com.ua/assets/aea75a06/js/jquery.scrollUp.js?v=1469914548"></script>
<script type="text/javascript">jQuery(document).ready(function () {
$.scrollUp({"scrollText":"","scrollName":"scrollUp","topDistance":400,"topSpeed":2000,"animation":"slide","animationInSpeed":200,"animationOutSpeed":200,"activeOverlay":false});
});</script>
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-8920748-5', 'auto');
    ga('send', 'pageview');
</script>
</body>
</html>
