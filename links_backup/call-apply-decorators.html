<!DOCTYPE html><html lang="ru" data-theme-enabled="1"><head><script>window.currentUser = null;</script><script>window.rateUsdToNative = 98.8745;</script><title itemprop="name">Декораторы и переадресация вызова, call/apply</title><link href="https://learn.javascript.ru/pack/styles.151c2ad2b575d09af8f5.css" rel="stylesheet"><meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes, minimum-scale=1.0"><meta name="apple-mobile-web-app-capable" content="yes"><!-- chrome autotranslate is enabled only for "en" main version--><meta name="google" content="notranslate"><script>if (window.devicePixelRatio > 1) document.cookie = 'pixelRatio=' + window.devicePixelRatio + ';path=/;expires=Tue, 19 Jan 2038 03:14:07 GMT';</script><link href="https://fonts.googleapis.com/css?family=Open+Sans:bold,italic,bolditalic" rel="stylesheet"><link rel="apple-touch-icon-precomposed" href="https://learn.javascript.ru/img/favicon/apple-touch-icon-precomposed.png"><link rel="canonical" href="call-apply-decorators.html"><meta name="msapplication-TileColor" content="#222A2C"><meta name="msapplication-TileImage" content="/img/favicon/tileicon.png"><link rel="icon" href="https://learn.javascript.ru/img/favicon/favicon.png"><meta itemprop="image" content="https://learn.javascript.ru/img/site_preview_ru_512x512.png"><meta property="og:title" content="Декораторы и переадресация вызова, call/apply"><meta property="og:image" content="https://learn.javascript.ru/img/site_preview_ru_1200x630.png"><meta property="og:image:type" content="image/png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="630"><meta property="fb:admins" content="100001562528165"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Декораторы и переадресация вызова, call/apply"><meta name="twitter:site" content="@iliakan"><meta name="twitter:creator" content="@iliakan"><meta name="twitter:image" content="https://learn.javascript.ru/img/site_preview_ru_512x512.png"><link rel="prev" href="https://learn.javascript.ru/settimeout-setinterval"><link rel="next" href="https://learn.javascript.ru/bind"><script>window.GA_ID = "UA-2056213-16";</script><script>window.GTM_ID = 'GTM-WD2DZPG'</script><script>window.YANDEX_METRIKA_ID = 17649010;</script><script>window.GoogleAnalyticsObject="ga",window.ga=function(){window.ga.q.push(arguments)},window.ga.q=[],window.ga.l=Date.now(),ga("create",GA_ID,"auto"),window.GTM_ID&&ga("require",GTM_ID),window.currentUser?ga("set","&uid",currentUser.id):ga("set","anonymizeIp",!0),window.addEventListener("error",function(e){var r=(e.filename||e.errorUrl)+": "+(e.lineno||e.errorLine),n=e.stack||e.error&&e.error.stack;ga("send","exception",{exDescription:e.message+" "+r+" "+n,exFatal:!0})});</script><script src="https://www.google-analytics.com/analytics.js" async></script><script>ga('send', 'pageview');</script><script>window.metrika={reachGoal:function(){}},window.yandex_metrika_callbacks=[function(){try{window.metrika=new Ya.Metrika({id:YANDEX_METRIKA_ID,webvisor:!0,clickmap:!0,params:{user:window.currentUser&&window.currentUser.id}}),metrika.trackLinks({delay:150}),window.addEventListener("error",function(r){window.metrika.reachGoal("JSERROR",{src:(r.filename||r.errorUrl)+": "+(r.lineno||r.errorLine),stack:r.stack||r.error&&r.error.stack,message:r.message})})}catch(r){}}];</script><script src="https://mc.yandex.ru/metrika/watch.js" async></script><script>window.RECAPTCHA_ID = "6LfmLAEVAAAAAJMykMnf7aY8nkyTRmYi2ynx51R1";</script><script src="https://learn.javascript.ru/pack/init.f43ee4b37d6f76e4f838.js"></script><script src="https://learn.javascript.ru/pack/head.9546f64faccf13e736f6.js" defer></script><meta property="og:title" content="Декораторы и переадресация вызова, call/apply"><meta property="og:type" content="article"><script src="https://learn.javascript.ru/pack/tutorial.f792acb067a354bc7904.js" defer></script><script src="https://learn.javascript.ru/pack/footer.440ca4f81c63a09affe0.js" defer></script></head><body class="no-icons"><script>window.fontTest();</script><div class="page-wrapper page-wrapper_sidebar_on"><!--[if IE]><div style="color:red;text-align:center">Извините, Internet Explorer не поддерживается, пожалуйста используйте более новый браузер.</div><![endif]--><div class="sitetoolbar sitetoolbar_tutorial"><script>window.langs = [{"code":"ar","name":"Arabic"},{"code":"az","name":"Azerbaijani"},{"code":"bg","name":"Bulgarian"},{"code":"bn","name":"Bengali"},{"code":"bs","name":"Bosnian"},{"code":"ca","name":"Catalan"},{"code":"cs","name":"Czech"},{"code":"da","name":"Danish"},{"code":"de","name":"German"},{"code":"el","name":"Greek"},{"code":"en","name":"English"},{"code":"es","name":"Spanish"},{"code":"fa","name":"Persian (Farsi)"},{"code":"fi","name":"Finnish"},{"code":"fr","name":"French"},{"code":"he","name":"Hebrew"},{"code":"hi","name":"Hindi"},{"code":"hr","name":"Croatian"},{"code":"hu","name":"Hungarian"},{"code":"hy","name":"Armenian"},{"code":"id","name":"Indonesian"},{"code":"it","name":"Italian"},{"code":"ja","name":"Japanese"},{"code":"ka","name":"Georgian"},{"code":"kk","name":"Kazakh"},{"code":"km","name":"Central Khmer"},{"code":"ko","name":"Korean"},{"code":"lt","name":"Lithuanian"},{"code":"me","name":"Montenegrin"},{"code":"ml","name":"Malayalam"},{"code":"my","name":"Burmese"},{"code":"nl","name":"Dutch"},{"code":"no","name":"Norvegian"},{"code":"pa","name":"Punjabi"},{"code":"pl","name":"Polish"},{"code":"pt","name":"Portuguese"},{"code":"ro","name":"Romanian"},{"code":"ru","name":"Russian"},{"code":"si","name":"Sinhala"},{"code":"sk","name":"Slovak"},{"code":"sl","name":"Slovenian"},{"code":"sq","name":"Albanian"},{"code":"sr","name":"Serbian"},{"code":"ta","name":"Tamil"},{"code":"te","name":"Telugu"},{"code":"test","name":"Test"},{"code":"th","name":"Thai"},{"code":"tk","name":"Turkmen"},{"code":"tr","name":"Turkish"},{"code":"uk","name":"Ukrainian"},{"code":"ur","name":"Urdu"},{"code":"uz","name":"Uzbek"},{"code":"v2","name":"v2"},{"code":"vi","name":"Vietnamese"},{"code":"zh-hant","name":"Chinese Traditional"},{"code":"zh","name":"Chinese"}];</script><script>window.lang = "ru";</script><script>{let t=navigator.languages||[];t=t.map(t=>t.toLowerCase());let o,i,n=[];for(let o of window.langs)for(let i of t)if(i===o.code||i.startsWith(o.code+"-")){n.push(o);break}if(!o&&"ru"!=lang&&"en"!=lang){n.find(t=>"en"==t.code)&&(o=`\n            According to your browser headers, you know English. Please help to <a href="https://github.com/javascript-tutorial/${lang}.javascript.info#readme">translate the tutorial</a>.\n            Thank you!\n          `,i="notify-translate-tutorial-local")}if(o){let t=`<div class="notification notification_top notification_info sitetoolbar__notification" style="display:none" id="${i}">\n          <div class="notification__content">${o}</div>\n          <button class="notification__close" title="Close"></button>\n        </div>`;document.write(t),showTopNotification()}}</script><div class="sitetoolbar__content"><div class="sitetoolbar__lang-switcher"><button class="sitetoolbar__dropdown-button" data-dropdown-toggler>RU</button><div class="sitetoolbar__dropdown-wrap"><div class="sitetoolbar__dropdown-body"><div class="sitetoolbar__lang-switcher-body"><div class="supported-langs supported-langs_toolbar"><div class="supported-langs__container"><ul class="supported-langs__list" style="height:200px"><li class="supported-langs__item"><a class="supported-langs__link" href="https://ar.javascript.info/call-apply-decorators"><span class="supported-langs__brief">AR</span><span class="supported-langs__title">عربي</span></a></li><li class="supported-langs__item"><a class="supported-langs__link" href="https://javascript.info/call-apply-decorators"><span class="supported-langs__brief">EN</span><span class="supported-langs__title">English</span></a></li><li class="supported-langs__item"><a class="supported-langs__link" href="https://es.javascript.info/call-apply-decorators"><span class="supported-langs__brief">ES</span><span class="supported-langs__title">Español</span></a></li><li class="supported-langs__item"><a class="supported-langs__link" href="https://fr.javascript.info/call-apply-decorators"><span class="supported-langs__brief">FR</span><span class="supported-langs__title">Français</span></a></li><li class="supported-langs__item"><a class="supported-langs__link" href="https://id.javascript.info/call-apply-decorators"><span class="supported-langs__brief">ID</span><span class="supported-langs__title">Indonesia</span></a></li><li class="supported-langs__item"><a class="supported-langs__link" href="https://it.javascript.info/call-apply-decorators"><span class="supported-langs__brief">IT</span><span class="supported-langs__title">Italiano</span></a></li></ul><ul class="supported-langs__list" style="height:200px"><li class="supported-langs__item"><a class="supported-langs__link" href="https://ja.javascript.info/call-apply-decorators"><span class="supported-langs__brief">JA</span><span class="supported-langs__title">日本語</span></a></li><li class="supported-langs__item"><a class="supported-langs__link" href="https://ko.javascript.info/call-apply-decorators"><span class="supported-langs__brief">KO</span><span class="supported-langs__title">한국어</span></a></li><li class="supported-langs__item supported-langs__item_current"><a class="supported-langs__link" href="call-apply-decorators.html"><span class="supported-langs__brief">RU</span><span class="supported-langs__title">Русский</span></a></li><li class="supported-langs__item"><a class="supported-langs__link" href="https://tr.javascript.info/call-apply-decorators"><span class="supported-langs__brief">TR</span><span class="supported-langs__title">Türkçe</span></a></li><li class="supported-langs__item"><a class="supported-langs__link" href="https://uk.javascript.info/call-apply-decorators"><span class="supported-langs__brief">UK</span><span class="supported-langs__title">Українська</span></a></li><li class="supported-langs__item"><a class="supported-langs__link" href="https://zh.javascript.info/call-apply-decorators"><span class="supported-langs__brief">ZH</span><span class="supported-langs__title">简体中文</span></a></li></ul></div><div class="supported-langs__text">Мы хотим сделать этот проект с открытым исходным кодом доступным для людей во всем мире. Пожалуйста, <a href="https://github.com/javascript-tutorial/translate" rel="noopener noreferrer" target="_blank">помогите нам перевести</a> это руководство на свой язык</div></div></div></div></div></div><div class="sitetoolbar__logo-wrap"><a class="sitetoolbar__link sitetoolbar__link_logo" href="https://learn.javascript.ru/"><img class="sitetoolbar__logo sitetoolbar__logo_normal" src="https://learn.javascript.ru/img/sitetoolbar__logo_ru.svg" width="171" alt="" role="presentation"/><img class="sitetoolbar__logo sitetoolbar__logo_normal sitetoolbar__logo_dark" src="https://learn.javascript.ru/img/sitetoolbar__logo_ru-white.svg" width="171" alt="" role="presentation"/><img class="sitetoolbar__logo sitetoolbar__logo_small" src="https://learn.javascript.ru/img/sitetoolbar__logo_small_ru.svg" width="80" alt="" role="presentation"/><img class="sitetoolbar__logo sitetoolbar__logo_small sitetoolbar__logo_dark" src="https://learn.javascript.ru/img/sitetoolbar__logo_small_ru-white.svg" width="80" alt="" role="presentation"/><script>Array.prototype.forEach.call(document.querySelectorAll("img.sitetoolbar__logo"),function(e){let t=document.createElement("object");t.type="image/svg+xml",t.className=e.className,t.style.cssText="left:0;top:0;position:absolute",t.onload=function(){t.onload=null,e.style.visibility="hidden"},t.data=e.src,e.parentNode.insertBefore(t,e)});</script></a></div><div class="sitetoolbar__nav-toggle-wrap"><button class="sitetoolbar__nav-toggle" type="button"></button></div><nav class="sitetoolbar__sections"><ul class="sitetoolbar__sections-list"><li class="sitetoolbar__section sitetoolbar__section_current"><a class="sitetoolbar__link" href="https://learn.javascript.ru/">Учебник</a></li><li class="sitetoolbar__section"><a class="sitetoolbar__link" href="https://learn.javascript.ru/courses">Курсы</a></li><li class="sitetoolbar__section"><a class="sitetoolbar__link" href="https://javascript.ru/forum/">Форум</a></li><li class="sitetoolbar__section"><a class="sitetoolbar__link" href="https://learn.javascript.ru/quiz">Тесты знаний</a></li><li class="sitetoolbar__section sitetoolbar__section_dropdown"><button class="sitetoolbar__dropdown-button" data-dropdown-toggler>Скринкасты</button><div class="sitetoolbar__dropdown-wrap"><div class="sitetoolbar__dropdown-body"><ul class="sitetoolbar__dropdown-items"><li class="sitetoolbar__dropdown-item"><a class="sitetoolbar__secondary-link sitetoolbar__dropdown-link" href="https://learn.javascript.ru/screencast/nodejs">Node.js</a></li><li class="sitetoolbar__dropdown-item"><a class="sitetoolbar__secondary-link sitetoolbar__dropdown-link" href="https://learn.javascript.ru/screencast/webpack">Webpack</a></li><li class="sitetoolbar__dropdown-item"><a class="sitetoolbar__secondary-link sitetoolbar__dropdown-link" href="https://learn.javascript.ru/screencast/gulp">Gulp</a></li><li class="sitetoolbar__dropdown-item"><a class="sitetoolbar__secondary-link sitetoolbar__dropdown-link" href="https://learn.javascript.ru/screencast/react">React.js</a></li><li class="sitetoolbar__dropdown-item"><a class="sitetoolbar__secondary-link sitetoolbar__dropdown-link" href="https://learn.javascript.ru/screencast/angular">Angular</a></li><li class="sitetoolbar__dropdown-item"><a class="sitetoolbar__secondary-link sitetoolbar__dropdown-link" href="https://youtu.be/W4hoc24K93E?list=PLDyvV36pndZFHXjXuwA_NywNrVQO0aQqb">Git: курс</a></li><li class="sitetoolbar__dropdown-item"><a class="sitetoolbar__secondary-link sitetoolbar__dropdown-link" href="https://youtu.be/lHacJuru1bc?list=PLDyvV36pndZEB7kWWocU4QSn-G78LoaEE">Git: разное</a></li></ul></div></div></li></ul></nav><div class="sitetoolbar__book-wrap"><a class="buy-book-button" href="https://learn.javascript.ru/ebook"><span class="buy-book-button__extra-text">Купить</span>EPUB/PDF</a></div><div class="sitetoolbar__login-wrap"><button class="sitetoolbar__login sitetoolbar__login_unready" data-action-login></button></div><div class="sitetoolbar__theme-switcher"><div class="theme-changer"><label class="theme-changer__label" for="theme-changer-input" data-tooltip="Сменить тему оформления"><input class="theme-changer__input" type="checkbox" id="theme-changer-input" data-theme-changer="data-theme-changer"/><span class="theme-changer__icon theme-changer__icon_light-theme"></span><span class="theme-changer__icon theme-changer__icon_dark-theme"></span></label></div></div><div class="sitetoolbar__search-wrap"><div class="sitetoolbar__search-content"><button class="sitetoolbar__search-toggle" type="button"></button><form class="sitetoolbar__search" method="GET" action="https://learn.javascript.ru/search"><div class="sitetoolbar__search-input"><div class="text-input"><input class="text-input__control" name="query" placeholder="Искать на Javascript.ru" required="required" type="text"/></div><button class="sitetoolbar__find" type="submit">Найти</button></div></form></div></div></div><div class="tablet-menu"><div class="tablet-menu__line"><div class="tablet-menu__content"><select class="tablet-menu__nav input-select input-select input-select_small" onchange="if(this.value) window.location.href=this.value"><option value="/" selected>Учебник</option><option value="/courses">Курсы</option><option value="https://javascript.ru/forum/">Форум</option><option value="/quiz">Тесты знаний</option></select></div></div><div class="tablet-menu__line"><div class="tablet-menu__content"><form class="tablet-menu-search" action="https://learn.javascript.ru/search/"><input class="tablet-menu-search__input" type="search" name="query" placeholder="Поиск в учебнике" required="required"/><button class="tablet-menu-search__button" type="submit" name="type" value="articles">Поиск</button></form></div></div><div class="tablet-menu__line"><div class="tablet-menu__content"><a class="map" href="https://learn.javascript.ru/tutorial/map" data-action="tutorial-map"><span class="map__text">Карта учебника</span></a></div></div><div class="tablet-menu__line"><div class="tablet-menu__content"><div class="theme-changer theme-changer_tablet-menu theme-changer_has-label"><label class="theme-changer__label" for="theme-changer-input-tablet" data-tooltip="Сменить тему оформления"><input class="theme-changer__input" type="checkbox" id="theme-changer-input-tablet" data-theme-changer="data-theme-changer"/><span class="theme-changer__icon theme-changer__icon_light-theme"></span><span class="theme-changer__icon theme-changer__icon_dark-theme"></span><span class="theme-changer__label-text theme-changer__label-text_light-theme">Светлая тема</span><span class="theme-changer__label-text theme-changer__label-text_dark-theme">Тёмная тема</span></label></div></div></div><div class="tablet-menu__line"><div class="tablet-menu__content"><div class="share-icons"><span class="share-icons__title">Поделиться</span><a class="share share_tw" href="https://twitter.com/share?url=https%3A%2F%2Flearn.javascript.ru%2Fcall-apply-decorators" rel="nofollow"></a><a class="share share_fb" href="https://www.facebook.com/sharer/sharer.php?s=100&amp;p%5Burl%5D=https%3A%2F%2Flearn.javascript.ru%2Fcall-apply-decorators" rel="nofollow"></a><a class="share share_vk" href="https://vkontakte.ru/share.php?url=https%3A%2F%2Flearn.javascript.ru%2Fcall-apply-decorators" rel="nofollow"></a></div></div></div><div class="tablet-menu__line"><div class="tablet-menu__content"><select class="tablet-menu__nav input-select input-select input-select_small" onchange="if(this.value) window.location.href=this.value"><option value="https://ar.javascript.info/call-apply-decorators">عربي</option><option value="https://javascript.info/call-apply-decorators">English</option><option value="https://es.javascript.info/call-apply-decorators">Español</option><option value="https://fr.javascript.info/call-apply-decorators">Français</option><option value="https://id.javascript.info/call-apply-decorators">Indonesia</option><option value="https://it.javascript.info/call-apply-decorators">Italiano</option><option value="https://ja.javascript.info/call-apply-decorators">日本語</option><option value="https://ko.javascript.info/call-apply-decorators">한국어</option><option value="https://learn.javascript.ru/call-apply-decorators" selected>Русский</option><option value="https://tr.javascript.info/call-apply-decorators">Türkçe</option><option value="https://uk.javascript.info/call-apply-decorators">Українська</option><option value="https://zh.javascript.info/call-apply-decorators">简体中文</option></select></div></div></div><progress class="tutorial-progress" data-sticky value="57" max="93" data-tooltip="Урок 57 из 93"></progress></div><div class="page page_sidebar_on page_inner_padding"><script>if(localStorage.noSidebar){document.querySelector(".page").classList.remove("page_sidebar_on");let e=document.querySelector(".page-wrapper");e&&e.classList.remove("page-wrapper_sidebar_on")}setTimeout(function(){document.querySelector(".page").classList.add("page_sidebar-animation-on")});</script><div class="page__inner"><main class="main main_width-limit"><header class="main__header"><div class="main__header-inner"><div class="main__header-group"><ol class="breadcrumbs"><li class="breadcrumbs__item breadcrumbs__item_home"><a class="breadcrumbs__link" href="https://learn.javascript.ru/"><span class="breadcrumbs__hidden-text">Учебник</span></a></li><li class="breadcrumbs__item" id="breadcrumb-1"><a class="breadcrumbs__link" href="https://learn.javascript.ru/js"><span>Язык JavaScript</span></a></li><li class="breadcrumbs__item" id="breadcrumb-2"><a class="breadcrumbs__link" href="https://learn.javascript.ru/advanced-functions"><span>Продвинутая работа с функциями</span></a></li><script type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Учебник","item":"https://learn.javascript.ru/"},{"@type":"ListItem","position":2,"name":"Язык JavaScript","item":"https://learn.javascript.ru/js"},{"@type":"ListItem","position":3,"name":"Продвинутая работа с функциями","item":"https://learn.javascript.ru/advanced-functions"}]}</script></ol><div class="updated-at" data-tooltip="Последнее обновление: 14-го декабря 2021"><div class="updated-at__content">14-го декабря 2021</div></div></div><h1 class="main__header-title">Декораторы и переадресация вызова, call/apply</h1></div></header><div class="content"><article class="formatted" itemscope itemtype="http://schema.org/TechArticle"><meta itemprop="name" content="Декораторы и переадресация вызова, call/apply"><div itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="email" content="iliakan@gmail.com"><meta itemprop="name" content="Ilya Kantor"></div><div itemprop="articleBody"><p>JavaScript предоставляет исключительно гибкие возможности по работе с функциями: они могут быть переданы в другие функции, использованы как объекты, и сейчас мы рассмотрим, как <em>перенаправлять</em> вызовы между ними и как их декорировать.</p>
<h2><a class="main__anchor" name="prozrachnoe-keshirovanie" href="call-apply-decorators.html#prozrachnoe-keshirovanie">Прозрачное кеширование</a></h2><p>Представим, что у нас есть функция <code>slow(x)</code>, выполняющая ресурсоёмкие вычисления, но возвращающая стабильные результаты. Другими словами, для одного и того же <code>x</code> она всегда возвращает один и тот же результат.</p>
<p>Если функция вызывается часто, то, вероятно, мы захотим кешировать (запоминать) возвращаемые ею результаты, чтобы сэкономить время на повторных вычислениях.</p>
<p>Вместо того, чтобы усложнять <code>slow(x)</code> дополнительной функциональностью, мы заключим её в функцию-обёртку – «wrapper» (от англ. «wrap» – обёртывать), которая добавит кеширование. Далее мы увидим, что в таком подходе масса преимуществ.</p>
<p>Вот код с объяснениями:</p>
<div id="dr7umyqcda" data-trusted="1" class="code-example">
      <div class="codebox code-example__codebox">
        
        <div class="toolbar codebox__toolbar">
          <div class="toolbar__tool">
            <a href="call-apply-decorators.html#" title="выполнить" data-action="run" class="toolbar__button toolbar__button_run"></a>
          </div>
          <div class="toolbar__tool">
            <a href="call-apply-decorators.html#" title="открыть в песочнице" target="_blank" data-action="edit" class="toolbar__button toolbar__button_edit"></a>
          </div>
        </div>
        <div class="codebox__code" data-code="1">
          <pre class="line-numbers language-javascript"><code>function slow(x) {
  // здесь могут быть ресурсоёмкие вычисления
  alert(`Called with ${x}`);
  return x;
}

function cachingDecorator(func) {
  let cache = new Map();

  return function(x) {
    if (cache.has(x)) {    // если кеш содержит такой x,
      return cache.get(x); // читаем из него результат
    }

    let result = func(x); // иначе, вызываем функцию

    cache.set(x, result); // и кешируем (запоминаем) результат
    return result;
  };
}

slow = cachingDecorator(slow);

alert( slow(1) ); // slow(1) кешируем
alert( &quot;Again: &quot; + slow(1) ); // возвращаем из кеша

alert( slow(2) ); // slow(2) кешируем
alert( &quot;Again: &quot; + slow(2) ); // возвращаем из кеша</code></pre>
        </div>
      </div>
      
      </div><p>В коде выше <code>cachingDecorator</code> – это <em>декоратор</em>, специальная функция, которая принимает другую функцию и изменяет её поведение.</p>
<p>Идея состоит в том, что мы можем вызвать <code>cachingDecorator</code> с любой функцией, в результате чего мы получим кеширующую обёртку. Это здорово, т.к. у нас может быть множество функций, использующих такую функциональность, и всё, что нам нужно сделать – это применить к ним <code>cachingDecorator</code>.</p>
<p>Отделяя кеширующий код от основного кода, мы также сохраняем чистоту и простоту последнего.</p>
<p>Результат вызова <code>cachingDecorator(func)</code> является «обёрткой», т.е. <code>function(x)</code> «оборачивает» вызов <code>func(x)</code> в кеширующую логику:</p>
<figure><div class="image" style="width:458px">
      <div class="image__ratio" style="padding-top:56.76855895196506%"></div>
      <object type="image/svg+xml" data="https://learn.javascript.ru/article/call-apply-decorators/decorator-makecaching-wrapper.svg" width="458" height="260" class="image__image" data-use-theme>
        <img src="https://learn.javascript.ru/article/call-apply-decorators/decorator-makecaching-wrapper.svg" alt="" width="458" height="260">
      </object>
      </div></figure><p>С точки зрения внешнего кода, обёрнутая функция <code>slow</code> по-прежнему делает то же самое. Обёртка всего лишь добавляет к её поведению аспект кеширования.</p>
<p>Подводя итог, можно выделить несколько преимуществ использования отдельной <code>cachingDecorator</code> вместо изменения кода самой <code>slow</code>:</p>
<ul>
<li>Функцию <code>cachingDecorator</code> можно использовать повторно. Мы можем применить её к другой функции.</li>
<li>Логика кеширования является отдельной, она не увеличивает сложность самой <code>slow</code> (если таковая была).</li>
<li>При необходимости мы можем объединить несколько декораторов (речь об этом пойдёт позже).</li>
</ul>
<h2><a class="main__anchor" name="primenenie-func-call-dlya-peredachi-konteksta" href="call-apply-decorators.html#primenenie-func-call-dlya-peredachi-konteksta">Применение «func.call» для передачи контекста.</a></h2><p>Упомянутый выше кеширующий декоратор не подходит для работы с методами объектов.</p>
<p>Например, в приведённом ниже коде <code>worker.slow()</code> перестаёт работать после применения декоратора:</p>
<div id="ulj4bjrzlm" data-trusted="1" class="code-example" data-highlight="[{&quot;start&quot;:30,&quot;end&quot;:30},{&quot;start&quot;:20,&quot;end&quot;:20}]">
      <div class="codebox code-example__codebox">
        
        <div class="toolbar codebox__toolbar">
          <div class="toolbar__tool">
            <a href="call-apply-decorators.html#" title="выполнить" data-action="run" class="toolbar__button toolbar__button_run"></a>
          </div>
          <div class="toolbar__tool">
            <a href="call-apply-decorators.html#" title="открыть в песочнице" target="_blank" data-action="edit" class="toolbar__button toolbar__button_edit"></a>
          </div>
        </div>
        <div class="codebox__code" data-code="1">
          <pre class="line-numbers language-javascript"><code>// сделаем worker.slow кеширующим
let worker = {
  someMethod() {
    return 1;
  },

  slow(x) {
    // здесь может быть страшно тяжёлая задача для процессора
    alert(&quot;Called with &quot; + x);
    return x * this.someMethod(); // (*)
  }
};

// тот же код, что и выше
function cachingDecorator(func) {
  let cache = new Map();
  return function(x) {
    if (cache.has(x)) {
      return cache.get(x);
    }
    let result = func(x); // (**)
    cache.set(x, result);
    return result;
  };
}

alert( worker.slow(1) ); // оригинальный метод работает

worker.slow = cachingDecorator(worker.slow); // теперь сделаем его кеширующим

alert( worker.slow(2) ); // Ой! Ошибка: не удаётся прочитать свойство 'someMethod' из 'undefined'</code></pre>
        </div>
      </div>
      
      </div><p>Ошибка возникает в строке <code>(*)</code>. Функция пытается получить доступ к <code>this.someMethod</code> и завершается с ошибкой. Видите почему?</p>
<p>Причина в том, что в строке <code>(**)</code> декоратор вызывает оригинальную функцию как <code>func(x)</code>, и она в данном случае получает <code>this = undefined</code>.</p>
<p>Мы бы наблюдали похожую ситуацию, если бы попытались запустить:</p>
<div id="pg0grskwwt" data-trusted="1" class="code-example">
      <div class="codebox code-example__codebox">
        
        <div class="codebox__code" data-code="1">
          <pre class="line-numbers language-javascript"><code>let func = worker.slow;
func(2);</code></pre>
        </div>
      </div>
      
      </div><p>Т.е. декоратор передаёт вызов оригинальному методу, но без контекста. Следовательно – ошибка.</p>
<p>Давайте это исправим.</p>
<p>Существует специальный встроенный метод функции <a href="https://developer.mozilla.org/ru/docs/Web/JavaScript/Reference/Global_Objects/Function/call">func.call(context, …args)</a>, который позволяет вызывать функцию, явно устанавливая <code>this</code>.</p>
<p>Синтаксис:</p>
<div id="fo6xhx7f0u" data-trusted="1" class="code-example">
      <div class="codebox code-example__codebox">
        
        <div class="codebox__code" data-code="1">
          <pre class="line-numbers language-javascript"><code>func.call(context, arg1, arg2, ...)</code></pre>
        </div>
      </div>
      
      </div><p>Он запускает функцию <code>func</code>, используя первый аргумент как её контекст <code>this</code>, а последующие – как её аргументы.</p>
<p>Проще говоря, эти два вызова делают почти то же самое:</p>
<div id="u3z93dnffu" data-trusted="1" class="code-example">
      <div class="codebox code-example__codebox">
        
        <div class="codebox__code" data-code="1">
          <pre class="line-numbers language-javascript"><code>func(1, 2, 3);
func.call(obj, 1, 2, 3)</code></pre>
        </div>
      </div>
      
      </div><p>Они оба вызывают <code>func</code> с аргументами <code>1</code>, <code>2</code> и <code>3</code>. Единственное отличие состоит в том, что <code>func.call</code> ещё и устанавливает <code>this</code> равным <code>obj</code>.</p>
<p>Например, в приведённом ниже коде мы вызываем <code>sayHi</code> в контексте различных объектов: <code>sayHi.call(user)</code> запускает <code>sayHi</code>, передавая <code>this=user</code>, а следующая строка устанавливает <code>this=admin</code>:</p>
<div id="t0x3vqqorv" data-trusted="1" class="code-example">
      <div class="codebox code-example__codebox">
        
        <div class="toolbar codebox__toolbar">
          <div class="toolbar__tool">
            <a href="call-apply-decorators.html#" title="выполнить" data-action="run" class="toolbar__button toolbar__button_run"></a>
          </div>
          <div class="toolbar__tool">
            <a href="call-apply-decorators.html#" title="открыть в песочнице" target="_blank" data-action="edit" class="toolbar__button toolbar__button_edit"></a>
          </div>
        </div>
        <div class="codebox__code" data-code="1">
          <pre class="line-numbers language-javascript"><code>function sayHi() {
  alert(this.name);
}

let user = { name: &quot;John&quot; };
let admin = { name: &quot;Admin&quot; };

// используем 'call' для передачи различных объектов в качестве 'this'
sayHi.call( user ); // John
sayHi.call( admin ); // Admin</code></pre>
        </div>
      </div>
      
      </div><p>Здесь мы используем <code>call</code> для вызова <code>say</code> с заданным контекстом и фразой:</p>
<div id="pbdyxpt50z" data-trusted="1" class="code-example">
      <div class="codebox code-example__codebox">
        
        <div class="toolbar codebox__toolbar">
          <div class="toolbar__tool">
            <a href="call-apply-decorators.html#" title="выполнить" data-action="run" class="toolbar__button toolbar__button_run"></a>
          </div>
          <div class="toolbar__tool">
            <a href="call-apply-decorators.html#" title="открыть в песочнице" target="_blank" data-action="edit" class="toolbar__button toolbar__button_edit"></a>
          </div>
        </div>
        <div class="codebox__code" data-code="1">
          <pre class="line-numbers language-javascript"><code>function say(phrase) {
  alert(this.name + ': ' + phrase);
}

let user = { name: &quot;John&quot; };

// 'user' становится 'this', и &quot;Hello&quot; становится первым аргументом
say.call( user, &quot;Hello&quot; ); // John: Hello</code></pre>
        </div>
      </div>
      
      </div><p>В нашем случае мы можем использовать <code>call</code> в обёртке для передачи контекста в исходную функцию:</p>
<div id="30gtfpf927" data-trusted="1" class="code-example" data-highlight="[{&quot;start&quot;:17,&quot;end&quot;:17}]">
      <div class="codebox code-example__codebox">
        
        <div class="toolbar codebox__toolbar">
          <div class="toolbar__tool">
            <a href="call-apply-decorators.html#" title="выполнить" data-action="run" class="toolbar__button toolbar__button_run"></a>
          </div>
          <div class="toolbar__tool">
            <a href="call-apply-decorators.html#" title="открыть в песочнице" target="_blank" data-action="edit" class="toolbar__button toolbar__button_edit"></a>
          </div>
        </div>
        <div class="codebox__code" data-code="1">
          <pre class="line-numbers language-javascript"><code>let worker = {
  someMethod() {
    return 1;
  },

  slow(x) {
    alert(&quot;Called with &quot; + x);
    return x * this.someMethod(); // (*)
  }
};

function cachingDecorator(func) {
  let cache = new Map();
  return function(x) {
    if (cache.has(x)) {
      return cache.get(x);
    }
    let result = func.call(this, x); // теперь 'this' передаётся правильно
    cache.set(x, result);
    return result;
  };
}

worker.slow = cachingDecorator(worker.slow); // теперь сделаем её кеширующей

alert( worker.slow(2) ); // работает
alert( worker.slow(2) ); // работает, не вызывая первоначальную функцию (кешируется)</code></pre>
        </div>
      </div>
      
      </div><p>Теперь всё в порядке.</p>
<p>Чтобы всё было понятно, давайте посмотрим глубже, как передаётся <code>this</code>:</p>
<ol>
<li>После <em>декорации</em> <code>worker.slow</code> становится обёрткой <code>function (x) { ... }</code>.</li>
<li>Так что при выполнении <code>worker.slow(2)</code> обёртка получает <code>2</code> в качестве аргумента и <code>this=worker</code> (так как это объект перед точкой).</li>
<li>Внутри обёртки, если результат ещё не кеширован, <code>func.call(this, x)</code> передаёт текущий <code>this</code> (<code>=worker</code>) и текущий аргумент (<code>=2</code>) в оригинальную функцию.</li>
</ol>
<h2><a class="main__anchor" name="perehodim-k-neskolkim-argumentam-s-func-apply" href="call-apply-decorators.html#perehodim-k-neskolkim-argumentam-s-func-apply">Переходим к нескольким аргументам с «func.apply»</a></h2><p>Теперь давайте сделаем <code>cachingDecorator</code> ещё более универсальным. До сих пор он работал только с функциями с одним аргументом.</p>
<p>Как же кешировать метод с несколькими аргументами <code>worker.slow</code>?</p>
<div id="az2a9g87bd" data-trusted="1" class="code-example">
      <div class="codebox code-example__codebox">
        
        <div class="codebox__code" data-code="1">
          <pre class="line-numbers language-javascript"><code>let worker = {
  slow(min, max) {
    return min + max; // здесь может быть тяжёлая задача
  }
};

// будет кешировать вызовы с одинаковыми аргументами
worker.slow = cachingDecorator(worker.slow);</code></pre>
        </div>
      </div>
      
      </div><p>Здесь у нас есть две задачи для решения.</p>
<p>Во-первых, как использовать оба аргумента <code>min</code> и <code>max</code> для ключа в коллекции <code>cache</code>? Ранее для одного аргумента <code>x</code> мы могли просто сохранить результат <code>cache.set(x, result)</code> и вызвать <code>cache.get(x)</code>, чтобы получить его позже. Но теперь нам нужно запомнить результат для <em>комбинации аргументов</em> <code>(min,max)</code>. Встроенный <code>Map</code> принимает только одно значение как ключ.</p>
<p>Есть много возможных решений:</p>
<ol>
<li>Реализовать новую (или использовать стороннюю) структуру данных для коллекции, которая более универсальна, чем встроенный <code>Map</code>, и поддерживает множественные ключи.</li>
<li>Использовать вложенные коллекции: <code>cache.set(min)</code> будет <code>Map</code>, которая хранит пару <code>(max, result)</code>. Тогда получить <code>result</code> мы сможем, вызвав <code>cache.get(min).get(max)</code>.</li>
<li>Соединить два значения в одно. В нашем конкретном случае мы можем просто использовать строку <code>&quot;min,max&quot;</code> как ключ к <code>Map</code>. Для гибкости, мы можем позволить передавать <em>хеширующую функцию</em> в декоратор, которая знает, как сделать одно значение из многих.</li>
</ol>
<p>Для многих практических применений третий вариант достаточно хорош, поэтому мы будем придерживаться его.</p>
<p>Также нам понадобится заменить <code>func.call(this, x)</code> на <code>func.call(this, ...arguments)</code>, чтобы передавать все аргументы обёрнутой функции, а не только первый.</p>
<p>Вот более мощный <code>cachingDecorator</code>:</p>
<div id="0ygpnf39ol" data-trusted="1" class="code-example" data-highlight="[{&quot;start&quot;:15,&quot;end&quot;:15},{&quot;start&quot;:10,&quot;end&quot;:10}]">
      <div class="codebox code-example__codebox">
        
        <div class="toolbar codebox__toolbar">
          <div class="toolbar__tool">
            <a href="call-apply-decorators.html#" title="выполнить" data-action="run" class="toolbar__button toolbar__button_run"></a>
          </div>
          <div class="toolbar__tool">
            <a href="call-apply-decorators.html#" title="открыть в песочнице" target="_blank" data-action="edit" class="toolbar__button toolbar__button_edit"></a>
          </div>
        </div>
        <div class="codebox__code" data-code="1">
          <pre class="line-numbers language-javascript"><code>let worker = {
  slow(min, max) {
    alert(`Called with ${min},${max}`);
    return min + max;
  }
};

function cachingDecorator(func, hash) {
  let cache = new Map();
  return function() {
    let key = hash(arguments); // (*)
    if (cache.has(key)) {
      return cache.get(key);
    }

    let result = func.call(this, ...arguments); // (**)

    cache.set(key, result);
    return result;
  };
}

function hash(args) {
  return args[0] + ',' + args[1];
}

worker.slow = cachingDecorator(worker.slow, hash);

alert( worker.slow(3, 5) ); // работает
alert( &quot;Again &quot; + worker.slow(3, 5) ); // аналогично (из кеша)</code></pre>
        </div>
      </div>
      
      </div><p>Теперь он работает с любым количеством аргументов.</p>
<p>Есть два изменения:</p>
<ul>
<li>В строке <code>(*)</code> вызываем <code>hash</code> для создания одного ключа из <code>arguments</code>. Здесь мы используем простую функцию «объединения», которая превращает аргументы <code>(3, 5)</code> в ключ <code>&quot;3,5&quot;</code>. В более сложных случаях могут потребоваться другие функции хеширования.</li>
<li>Затем в строке <code>(**)</code> используем <code>func.call(this, ...arguments)</code> для передачи как контекста, так и всех аргументов, полученных обёрткой (независимо от их количества), в исходную функцию.</li>
</ul>
<p>Вместо <code>func.call(this, ...arguments)</code> мы могли бы написать <code>func.apply(this, arguments)</code>.</p>
<p>Синтаксис встроенного метода  <a href="https://developer.mozilla.org/ru/docs/Web/JavaScript/Reference/Global_Objects/Function/apply">func.apply</a>:</p>
<div id="sk3ii36r31" data-trusted="1" class="code-example">
      <div class="codebox code-example__codebox">
        
        <div class="codebox__code" data-code="1">
          <pre class="line-numbers language-javascript"><code>func.apply(context, args)</code></pre>
        </div>
      </div>
      
      </div><p>Он выполняет <code>func</code>, устанавливая <code>this=context</code> и принимая в качестве списка аргументов псевдомассив <code>args</code>.</p>
<p>Единственная разница в синтаксисе между <code>call</code> и <code>apply</code> состоит в том, что <code>call</code> ожидает список аргументов, в то время как <code>apply</code> принимает псевдомассив.</p>
<p>Эти два вызова почти эквивалентны:</p>
<div id="rz92c54ors" data-trusted="1" class="code-example">
      <div class="codebox code-example__codebox">
        
        <div class="codebox__code" data-code="1">
          <pre class="line-numbers language-javascript"><code>func.call(context, ...args); // передаёт массив как список с оператором расширения
func.apply(context, args);   // тот же эффект</code></pre>
        </div>
      </div>
      
      </div><p>Есть только одна небольшая разница:</p>
<ul>
<li>Оператор расширения <code>...</code> позволяет передавать <em>перебираемый</em> объект <code>args</code> в виде списка в <code>call</code>.</li>
<li>А <code>apply</code> принимает только <em>псевдомассив</em> <code>args</code>.</li>
</ul>
<p>Так что эти вызовы дополняют друг друга. Для перебираемых объектов сработает <code>call</code>, а где мы ожидаем псевдомассив – <code>apply</code>.</p>
<p>А если у нас объект, который и то, и другое, например, реальный массив, то технически мы могли бы использовать любой метод, но <code>apply</code>, вероятно, будет быстрее, потому что большинство движков JavaScript внутренне оптимизируют его лучше.</p>
<p>Передача всех аргументов вместе с контекстом другой функции называется «перенаправлением вызова» (call forwarding).</p>
<p>Простейший вид такого перенаправления:</p>
<div id="peavt1axs2" data-trusted="1" class="code-example">
      <div class="codebox code-example__codebox">
        
        <div class="codebox__code" data-code="1">
          <pre class="line-numbers language-javascript"><code>let wrapper = function() {
  return func.apply(this, arguments);
};</code></pre>
        </div>
      </div>
      
      </div><p>При вызове <code>wrapper</code> из внешнего кода его не отличить от вызова исходной функции.</p>
<h2><a class="main__anchor" name="method-borrowing" href="call-apply-decorators.html#method-borrowing">Заимствование метода</a></h2><p>Теперь давайте сделаем ещё одно небольшое улучшение функции хеширования:</p>
<div id="t8p1awn2z8" data-trusted="1" class="code-example">
      <div class="codebox code-example__codebox">
        
        <div class="codebox__code" data-code="1">
          <pre class="line-numbers language-javascript"><code>function hash(args) {
  return args[0] + ',' + args[1];
}</code></pre>
        </div>
      </div>
      
      </div><p>На данный момент она работает только для двух аргументов. Было бы лучше, если бы она могла склеить любое количество <code>args</code>.</p>
<p>Естественным решением было бы использовать метод <a href="https://developer.mozilla.org/ru/docs/Web/JavaScript/Reference/Global_Objects/Array/join">arr.join</a>:</p>
<div id="2gy93tz56t" data-trusted="1" class="code-example">
      <div class="codebox code-example__codebox">
        
        <div class="codebox__code" data-code="1">
          <pre class="line-numbers language-javascript"><code>function hash(args) {
  return args.join();
}</code></pre>
        </div>
      </div>
      
      </div><p>…К сожалению, это не сработает, потому что мы вызываем <code>hash(arguments)</code>, а объект <code>arguments</code> является перебираемым и псевдомассивом, но не реальным массивом.</p>
<p>Таким образом, вызов <code>join</code> для него потерпит неудачу, что мы и можем видеть ниже:</p>
<div id="ny80mjjhsi" data-trusted="1" class="code-example" data-highlight="[{&quot;start&quot;:1,&quot;end&quot;:1}]">
      <div class="codebox code-example__codebox">
        
        <div class="toolbar codebox__toolbar">
          <div class="toolbar__tool">
            <a href="call-apply-decorators.html#" title="выполнить" data-action="run" class="toolbar__button toolbar__button_run"></a>
          </div>
          <div class="toolbar__tool">
            <a href="call-apply-decorators.html#" title="открыть в песочнице" target="_blank" data-action="edit" class="toolbar__button toolbar__button_edit"></a>
          </div>
        </div>
        <div class="codebox__code" data-code="1">
          <pre class="line-numbers language-javascript"><code>function hash() {
  alert( arguments.join() ); // Ошибка: arguments.join не является функцией
}

hash(1, 2);</code></pre>
        </div>
      </div>
      
      </div><p>Тем не менее, есть простой способ использовать соединение массива:</p>
<div id="p560bckcz4" data-trusted="1" class="code-example" data-highlight="[{&quot;start&quot;:1,&quot;end&quot;:1}]">
      <div class="codebox code-example__codebox">
        
        <div class="toolbar codebox__toolbar">
          <div class="toolbar__tool">
            <a href="call-apply-decorators.html#" title="выполнить" data-action="run" class="toolbar__button toolbar__button_run"></a>
          </div>
          <div class="toolbar__tool">
            <a href="call-apply-decorators.html#" title="открыть в песочнице" target="_blank" data-action="edit" class="toolbar__button toolbar__button_edit"></a>
          </div>
        </div>
        <div class="codebox__code" data-code="1">
          <pre class="line-numbers language-javascript"><code>function hash() {
  alert( [].join.call(arguments) ); // 1,2
}

hash(1, 2);</code></pre>
        </div>
      </div>
      
      </div><p>Этот трюк называется <em>заимствование метода</em>.</p>
<p>Мы берём (заимствуем) метод <code>join</code> из обычного массива <code>[].join</code>. И используем <code>[].join.call</code>, чтобы выполнить его в контексте <code>arguments</code>.</p>
<p>Почему это работает?</p>
<p>Это связано с тем, что внутренний алгоритм встроенного метода <code>arr.join(glue)</code> очень прост.
Взято из спецификации практически «как есть»:</p>
<ol>
<li>Пускай первым аргументом будет <code>glue</code> или, в случае отсутствия аргументов, им будет запятая <code>&quot;,&quot;</code></li>
<li>Пускай <code>result</code> будет пустой строкой <code>&quot;&quot;</code>.</li>
<li>Добавить <code>this[0]</code> к <code>result</code>.</li>
<li>Добавить <code>glue</code> и <code>this[1]</code>.</li>
<li>Добавить <code>glue</code> и <code>this[2]</code>.</li>
<li>…выполнять до тех пор, пока <code>this.length</code> элементов не будет склеено.</li>
<li>Вернуть <code>result</code>.</li>
</ol>
<p>Таким образом, технически он принимает <code>this</code> и объединяет <code>this[0]</code>, <code>this[1]</code>… и т.д. вместе. Он намеренно написан так, что допускает любой псевдомассив <code>this</code> (не случайно, многие методы следуют этой практике). Вот почему он также работает с <code>this=arguments</code>.</p>
<h2><a class="main__anchor" name="itogo" href="call-apply-decorators.html#itogo">Итого</a></h2><p><em>Декоратор</em> – это обёртка вокруг функции, которая изменяет поведение последней. Основная работа по-прежнему выполняется функцией.</p>
<p>Обычно безопасно заменить функцию или метод декорированным, за исключением одной мелочи. Если исходная функция предоставляет свойства, такие как <code>func.calledCount</code> или типа того, то декорированная функция их не предоставит. Потому что это обёртка. Так что нужно быть осторожным в их использовании. Некоторые декораторы предоставляют свои собственные свойства.</p>
<p>Декораторы можно рассматривать как «дополнительные возможности» или «аспекты», которые можно добавить в функцию. Мы можем добавить один или несколько декораторов. И всё это без изменения кода оригинальной функции!</p>
<p>Для реализации <code>cachingDecorator</code> мы изучили методы:</p>
<ul>
<li><a href="https://developer.mozilla.org/ru/docs/Web/JavaScript/Reference/Global_Objects/Function/call">func.call(context, arg1, arg2…)</a> – вызывает <code>func</code> с данным контекстом и аргументами.</li>
<li><a href="https://developer.mozilla.org/ru/docs/Web/JavaScript/Reference/Global_Objects/Function/apply">func.apply(context, args)</a> – вызывает <code>func</code>, передавая <code>context</code> как <code>this</code> и псевдомассив <code>args</code> как список аргументов.</li>
</ul>
<p>В основном <em>переадресация вызова</em> выполняется с помощью <code>apply</code>:</p>
<div id="sw90j3r6yf" data-trusted="1" class="code-example">
      <div class="codebox code-example__codebox">
        
        <div class="codebox__code" data-code="1">
          <pre class="line-numbers language-javascript"><code>let wrapper = function(original, arguments) {
  return original.apply(this, arguments);
};</code></pre>
        </div>
      </div>
      
      </div><p>Мы также рассмотрели пример <em>заимствования метода</em>, когда мы вызываем метод у объекта в контексте другого объекта. Весьма распространено заимствовать методы массива и применять их к <code>arguments</code>. В качестве альтернативы можно использовать объект с остаточными параметрами <code>...args</code>, который является реальным массивом.</p>
<p>На практике декораторы используются для самых разных задач. Проверьте, насколько хорошо вы их освоили, решая задачи этой главы.</p>
</div></article><div class="tasks formatted"><h2 class="tasks__title" id="tasks"><a class="tasks__title-anchor main__anchor main__anchor main__anchor_noicon" href="call-apply-decorators.html#tasks">Задачи</a></h2><div class="task tasks__task"><div class="task__header"><div class="task__title-wrap"><h3 class="task__title"><a class="main__anchor" href="call-apply-decorators.html#dekorator-shpion" name="dekorator-shpion">Декоратор-шпион</a></h3><a class="task__open-link" href="https://learn.javascript.ru/task/spy-decorator" target="_blank"></a></div><div class="task__header-note"><span class="task__importance" title="Насколько эта задача важна для освоения материала, от 1 до 5">важность: 5</span></div><div class="task__content"><div class="task__formatted"><p>Создайте декоратор <code>spy(func)</code>, который должен возвращать обёртку, которая сохраняет все вызовы функции в своём свойстве <code>calls</code>.</p>
<p>Каждый вызов должен сохраняться как массив аргументов.</p>
<p>Например:</p>
<div id="edzsdxhx8i" data-trusted="1" class="code-example" data-highlight="[{&quot;start&quot;:4,&quot;end&quot;:4}]">
      <div class="codebox code-example__codebox">
        
        <div class="codebox__code" data-code="1">
          <pre class="line-numbers language-javascript"><code>function work(a, b) {
  alert( a + b ); // произвольная функция или метод
}

work = spy(work);

work(1, 2); // 3
work(4, 5); // 9

for (let args of work.calls) {
  alert( 'call:' + args.join() ); // &quot;call:1,2&quot;, &quot;call:4,5&quot;
}</code></pre>
        </div>
      </div>
      
      </div><p>P.S.: Этот декоратор иногда полезен для юнит-тестирования. Его расширенная форма – <code>sinon.spy</code> – содержится в библиотеке <a href="http://sinonjs.org/">Sinon.JS</a>.</p>
<p><a href="https://plnkr.co/edit/qYsh0cYNaxwS0rs2?p=preview" target="_blank" data-plunk-id="qYsh0cYNaxwS0rs2">Открыть песочницу с тестами для задачи.</a></p></div><button class="task__solution" type="button">решение</button><div class="task__answer"><div class="task__answer-content"><div class="formatted"><p>Здесь мы можем использовать <code>call.push(args)</code> для хранения всех аргументов в списке и <code>f.apply(this, args)</code> для переадресации вызова.</p>
<div id="l9s7m4xwfw" data-trusted="1" class="code-example">
      <div class="codebox code-example__codebox">
        
        <div class="codebox__code" data-code="1">
          <pre class="line-numbers language-javascript"><code>function spy(func) {

  function wrapper(...args) {
    wrapper.calls.push(args);
    return func.apply(this, arguments);
  }

  wrapper.calls = [];

  return wrapper;
}</code></pre>
        </div>
      </div>
      
      </div><p><a href="https://plnkr.co/edit/P96JYV3FyDN9x4fJ?p=preview" target="_blank" data-plunk-id="P96JYV3FyDN9x4fJ">Открыть решение с тестами в песочнице.</a></p></div></div><button class="close-button task__answer-close" type="button" title="закрыть"></button></div></div></div></div><div class="task tasks__task"><div class="task__header"><div class="task__title-wrap"><h3 class="task__title"><a class="main__anchor" href="call-apply-decorators.html#zaderzhivayuschiy-dekorator" name="zaderzhivayuschiy-dekorator">Задерживающий декоратор</a></h3><a class="task__open-link" href="https://learn.javascript.ru/task/delay" target="_blank"></a></div><div class="task__header-note"><span class="task__importance" title="Насколько эта задача важна для освоения материала, от 1 до 5">важность: 5</span></div><div class="task__content"><div class="task__formatted"><p>Создайте декоратор <code>delay(f, ms)</code>, который задерживает каждый вызов <code>f</code> на <code>ms</code> миллисекунд.
Например:</p>
<div id="4zcnizrdzv" data-trusted="1" class="code-example">
      <div class="codebox code-example__codebox">
        
        <div class="codebox__code" data-code="1">
          <pre class="line-numbers language-javascript"><code>function f(x) {
  alert(x);
}

// создаём обёртки
let f1000 = delay(f, 1000);
let f1500 = delay(f, 1500);

f1000(&quot;test&quot;); // показывает &quot;test&quot; после 1000 мс
f1500(&quot;test&quot;); // показывает &quot;test&quot; после 1500 мс</code></pre>
        </div>
      </div>
      
      </div><p>Другими словами, <code>delay(f, ms)</code> возвращает вариант <code>f</code> с «задержкой на <code>ms</code> мс».</p>
<p>В приведённом выше коде <code>f</code> – функция с одним аргументом, но ваше решение должно передавать все аргументы и контекст <code>this</code>.</p>
<p><a href="https://plnkr.co/edit/itpSsSraSML7MUSD?p=preview" target="_blank" data-plunk-id="itpSsSraSML7MUSD">Открыть песочницу с тестами для задачи.</a></p></div><button class="task__solution" type="button">решение</button><div class="task__answer"><div class="task__answer-content"><div class="formatted"><p>Решение:</p>
<div id="2vtjolhf1j" data-trusted="1" class="code-example" data-demo="1">
      <div class="codebox code-example__codebox">
        
        <div class="toolbar codebox__toolbar">
          <div class="toolbar__tool">
            <a href="call-apply-decorators.html#" title="выполнить" data-action="run" class="toolbar__button toolbar__button_run"></a>
          </div>
          <div class="toolbar__tool">
            <a href="call-apply-decorators.html#" title="открыть в песочнице" target="_blank" data-action="edit" class="toolbar__button toolbar__button_edit"></a>
          </div>
        </div>
        <div class="codebox__code" data-code="1">
          <pre class="line-numbers language-javascript"><code>function delay(f, ms) {

  return function() {
    setTimeout(() =&gt; f.apply(this, arguments), ms);
  };

}

let f1000 = delay(alert, 1000);

f1000(&quot;test&quot;); // показывает &quot;test&quot; после 1000 мс</code></pre>
        </div>
      </div>
      
      </div><p>Обратите внимание, как здесь используется функция-стрелка. Как мы знаем, функция-стрелка не имеет собственных <code>this</code> и <code>arguments</code>, поэтому <code>f.apply(this, arguments)</code> берет <code>this</code> и <code>arguments</code> из обёртки.</p>
<p>Если мы передадим обычную функцию, <code>setTimeout</code> вызовет её без аргументов и с <code>this=window</code> (при условии, что код выполняется в браузере).</p>
<p>Мы всё ещё можем передать правильный <code>this</code>, используя промежуточную переменную, но это немного громоздко:</p>
<div id="fvn5ucd3xe" data-trusted="1" class="code-example">
      <div class="codebox code-example__codebox">
        
        <div class="codebox__code" data-code="1">
          <pre class="line-numbers language-javascript"><code>function delay(f, ms) {

  return function(...args) {
    let savedThis = this; // сохраняем this в промежуточную переменную
    setTimeout(function() {
      f.apply(savedThis, args); // используем её
    }, ms);
  };

}</code></pre>
        </div>
      </div>
      
      </div><p><a href="https://plnkr.co/edit/txgRdob5MXiCHYic?p=preview" target="_blank" data-plunk-id="txgRdob5MXiCHYic">Открыть решение с тестами в песочнице.</a></p></div></div><button class="close-button task__answer-close" type="button" title="закрыть"></button></div></div></div></div><div class="task tasks__task"><div class="task__header"><div class="task__title-wrap"><h3 class="task__title"><a class="main__anchor" href="call-apply-decorators.html#dekorator-debounce" name="dekorator-debounce">Декоратор debounce</a></h3><a class="task__open-link" href="https://learn.javascript.ru/task/debounce" target="_blank"></a></div><div class="task__header-note"><span class="task__importance" title="Насколько эта задача важна для освоения материала, от 1 до 5">важность: 5</span></div><div class="task__content"><div class="task__formatted"><p>Результатом декоратора <code>debounce(f, ms)</code> должна быть обёртка, которая передаёт вызов <code>f</code> не более одного раза в <code>ms</code> миллисекунд.
Другими словами, когда мы вызываем <code>debounce</code>, это гарантирует, что все остальные вызовы будут игнорироваться в течение <code>ms</code>.</p>
<p>Например:</p>
<div id="6pxdho18h8" data-trusted="1" class="code-example">
      <div class="codebox code-example__codebox">
        
        <div class="codebox__code" data-code="1">
          <pre class="line-numbers language-javascript"><code>let f = debounce(alert, 1000);

f(1); // выполняется немедленно
f(2); // проигнорирован

setTimeout( () =&gt; f(3), 100); // проигнорирован (прошло только 100 мс)
setTimeout( () =&gt; f(4), 1100); // выполняется
setTimeout( () =&gt; f(5), 1500); // проигнорирован (прошло только 400 мс от последнего вызова)</code></pre>
        </div>
      </div>
      
      </div><p>На практике <code>debounce</code> полезен для функций, которые получают/обновляют данные, и мы знаем, что повторный вызов в течение короткого промежутка времени не даст ничего нового. Так что лучше не тратить на него ресурсы.</p>
<p><a href="https://plnkr.co/edit/n6tFb51VqoL8H3Qb?p=preview" target="_blank" data-plunk-id="n6tFb51VqoL8H3Qb">Открыть песочницу с тестами для задачи.</a></p></div><button class="task__solution" type="button">решение</button><div class="task__answer"><div class="task__answer-content"><div class="formatted"><div id="drkj1dergg" data-trusted="1" class="code-example" data-demo="1">
      <div class="codebox code-example__codebox">
        
        <div class="codebox__code" data-code="1">
          <pre class="line-numbers language-javascript"><code>function debounce(f, ms) {

  let isCooldown = false;

  return function() {
    if (isCooldown) return;

    f.apply(this, arguments);

    isCooldown = true;

    setTimeout(() =&gt; isCooldown = false, ms);
  };

}</code></pre>
        </div>
      </div>
      
      </div><p>Вызов <code>debounce</code> возвращает обёртку. Возможны два состояния:</p>
<ul>
<li><code>isCooldown = false</code> – готова к выполнению.</li>
<li><code>isCooldown = true</code> – ожидание окончания тайм-аута.</li>
</ul>
<p>В первом вызове <code>isCoolDown = false</code>, поэтому вызов продолжается, и состояние изменяется на <code>true</code>.</p>
<p>Пока <code>isCoolDown</code> имеет значение <code>true</code>, все остальные вызовы игнорируются.</p>
<p>Затем <code>setTimeout</code> устанавливает его в <code>false</code> после заданной задержки.</p>
<p><a href="https://plnkr.co/edit/AgW9ALdVsX9CabRs?p=preview" target="_blank" data-plunk-id="AgW9ALdVsX9CabRs">Открыть решение с тестами в песочнице.</a></p></div></div><button class="close-button task__answer-close" type="button" title="закрыть"></button></div></div></div></div><div class="task tasks__task"><div class="task__header"><div class="task__title-wrap"><h3 class="task__title"><a class="main__anchor" href="call-apply-decorators.html#tormozyaschiy-throttling-dekorator" name="tormozyaschiy-throttling-dekorator">Тормозящий (throttling) декоратор</a></h3><a class="task__open-link" href="https://learn.javascript.ru/task/throttle" target="_blank"></a></div><div class="task__header-note"><span class="task__importance" title="Насколько эта задача важна для освоения материала, от 1 до 5">важность: 5</span></div><div class="task__content"><div class="task__formatted"><p>Создайте «тормозящий» декоратор <code>throttle(f, ms)</code>, который возвращает обёртку, передавая вызов в <code>f</code> не более одного раза в <code>ms</code> миллисекунд. Те вызовы, которые попадают в период «торможения», игнорируются.</p>
<p><strong>Отличие от <code>debounce</code> – если проигнорированный вызов является последним во время «задержки», то он выполняется в конце.</strong></p>
<p>Давайте рассмотрим реальное применение, чтобы лучше понять это требование и выяснить, откуда оно взято.</p>
<p><strong>Например, мы хотим отслеживать движения мыши.</strong></p>
<p>В браузере мы можем объявить функцию, которая будет запускаться при каждом движении указателя и получать его местоположение. Во время активного использования мыши эта функция запускается очень часто, это может происходить около 100 раз в секунду (каждые 10 мс).</p>
<p><strong>Мы бы хотели обновлять информацию на странице при передвижениях.</strong></p>
<p>…Но функция обновления <code>update()</code> слишком ресурсоёмкая, чтобы делать это при каждом микродвижении. Да и нет смысла делать обновление чаще, чем один раз в 1000 мс.</p>
<p>Поэтому мы обернём вызов в декоратор: будем использовать <code>throttle(update, 1000)</code> как функцию, которая будет запускаться при каждом перемещении указателя вместо оригинальной <code>update()</code>. Декоратор будет вызываться часто, но передавать вызов в <code>update()</code> максимум раз в 1000 мс.</p>
<p>Визуально это будет выглядеть вот так:</p>
<ol>
<li>Для первого движения указателя декорированный вариант сразу передаёт вызов в <code>update</code>. Это важно, т.к. пользователь сразу видит нашу реакцию на его перемещение.</li>
<li>Затем, когда указатель продолжает движение, в течение 1000 мс ничего не происходит. Декорированный вариант игнорирует вызовы.</li>
<li>По истечению 1000 мс происходит ещё один вызов <code>update</code> с последними координатами.</li>
<li>Затем, наконец, указатель где-то останавливается. Декорированный вариант ждёт, пока не истечёт 1000 мс, и затем вызывает <code>update</code> с последними координатами. В итоге окончательные координаты указателя тоже обработаны.</li>
</ol>
<p>Пример кода:</p>
<div id="69fzm59d3k" data-trusted="1" class="code-example">
      <div class="codebox code-example__codebox">
        
        <div class="codebox__code" data-code="1">
          <pre class="line-numbers language-javascript"><code>function f(a) {
  console.log(a)
}

// f1000 передаёт вызовы f максимум раз в 1000 мс
let f1000 = throttle(f, 1000);

f1000(1); // показывает 1
f1000(2); // (ограничение, 1000 мс ещё нет)
f1000(3); // (ограничение, 1000 мс ещё нет)

// когда 1000 мс истекли ...
// ...выводим 3, промежуточное значение 2 было проигнорировано</code></pre>
        </div>
      </div>
      
      </div><p>P.S. Аргументы и контекст <code>this</code>, переданные в <code>f1000</code>, должны быть переданы в оригинальную <code>f</code>.</p>
<p><a href="https://plnkr.co/edit/16I58Uk0GmAG7wNW?p=preview" target="_blank" data-plunk-id="16I58Uk0GmAG7wNW">Открыть песочницу с тестами для задачи.</a></p></div><button class="task__solution" type="button">решение</button><div class="task__answer"><div class="task__answer-content"><div class="formatted"><div id="6ivglkndgz" data-trusted="1" class="code-example" data-demo="1">
      <div class="codebox code-example__codebox">
        
        <div class="codebox__code" data-code="1">
          <pre class="line-numbers language-javascript"><code>function throttle(func, ms) {

  let isThrottled = false,
    savedArgs,
    savedThis;

  function wrapper() {

    if (isThrottled) { // (2)
      savedArgs = arguments;
      savedThis = this;
      return;
    }

    func.apply(this, arguments); // (1)

    isThrottled = true;

    setTimeout(function() {
      isThrottled = false; // (3)
      if (savedArgs) {
        wrapper.apply(savedThis, savedArgs);
        savedArgs = savedThis = null;
      }
    }, ms);
  }

  return wrapper;
}</code></pre>
        </div>
      </div>
      
      </div><p>Вызов <code>throttle(func, ms)</code> возвращает <code>wrapper</code>.</p>
<ol>
<li>Во время первого вызова обёртка просто вызывает <code>func</code> и устанавливает состояние задержки (<code>isThrottled = true</code>).</li>
<li>В этом состоянии все вызовы запоминаются в <code>saveArgs / saveThis</code>. Обратите внимание, что контекст и аргументы одинаково важны и должны быть запомнены. Они нам нужны для того, чтобы воспроизвести вызов позднее.</li>
<li>… Затем по прошествии <code>ms</code> миллисекунд срабатывает <code>setTimeout</code>. Состояние задержки сбрасывается (<code>isThrottled = false</code>). И если мы проигнорировали вызовы, то «обёртка» выполняется с последними запомненными аргументами и контекстом.</li>
</ol>
<p>На третьем шаге выполняется не <code>func</code>, а <code>wrapper</code>, потому что нам нужно не только выполнить <code>func</code>, но и ещё раз установить состояние задержки и таймаут для его сброса.</p>
<p><a href="https://plnkr.co/edit/LpmjA9BinZxHv5fR?p=preview" target="_blank" data-plunk-id="LpmjA9BinZxHv5fR">Открыть решение с тестами в песочнице.</a></p></div></div><button class="close-button task__answer-close" type="button" title="закрыть"></button></div></div></div></div></div></div><div class="page__nav-wrap"><a class="page__nav page__nav_prev" href="https://learn.javascript.ru/settimeout-setinterval" data-tooltip="Планирование: setTimeout и setInterval"><span class="page__nav-text"><span class="page__nav-text-shortcut"></span></span><span class="page__nav-text-alternate">Предыдущий урок</span></a><a class="page__nav page__nav_next" href="https://learn.javascript.ru/bind" data-tooltip="Привязка контекста к функции"><span class="page__nav-text"><span class="page__nav-text-shortcut"></span></span><span class="page__nav-text-alternate">Следующий урок</span></a></div><div class="article-tablet-foot tablet-only"><div class="article-tablet-foot__layout"><div class="share-icons"><span class="share-icons__title">Поделиться</span><a class="share share_tw" href="https://twitter.com/share?url=https%3A%2F%2Flearn.javascript.ru%2Fcall-apply-decorators" rel="nofollow"></a><a class="share share_fb" href="https://www.facebook.com/sharer/sharer.php?s=100&amp;p%5Burl%5D=https%3A%2F%2Flearn.javascript.ru%2Fcall-apply-decorators" rel="nofollow"></a><a class="share share_vk" href="https://vkontakte.ru/share.php?url=https%3A%2F%2Flearn.javascript.ru%2Fcall-apply-decorators" rel="nofollow"></a></div><div class="article-tablet-foot__map"><a class="map" href="https://learn.javascript.ru/tutorial/map" data-action="tutorial-map"><span class="map__text">Карта учебника</span></a></div></div></div><div class="banner-bottom"><div class="banner-bottom__text">Проводим <a href="https://learn.javascript.ru/courses">курсы по JavaScript и фреймворкам</a>.</div><button class="banner-bottom__close" data-banner-close="Courses" data-banner-close-message="Эта информация больше не будет выводиться." title="не показывать"></button></div><script>!!1&&"hideBannerCourses"in localStorage||(document.querySelector(".banner-bottom").style.display="flex");</script><div class="comments formatted" id="comments"><div class="comments__header"><h2 class="comments__header-title"><a href="call-apply-decorators.html#comments" name="comments">Комментарии</a></h2><div class="comments__read-before"><span class="comments__read-before-link">перед тем как писать…</span><div class="comments__read-before-popup"><div class="comments__read-before-popup-i"><ul><li>Если вам кажется, что в статье что-то не так - вместо комментария напишите <a href="https://github.com/javascript-tutorial/ru.javascript.info/issues/new">на GitHub</a>.</li><li>Для одной строки кода используйте тег <code>&lt;code&gt;</code>, для нескольких строк кода&nbsp;&mdash; тег <code>&lt;pre&gt;</code>, если больше 10 строк&nbsp;&mdash; ссылку на песочницу (<a href='https://plnkr.co/edit/?p=preview'>plnkr</a>, <a href='http://jsbin.com'>JSBin</a>, <a href='http://codepen.io'>codepen</a>…)</li><li>Если что-то непонятно в статье&nbsp;&mdash; пишите, что именно и с какого места.</li></ul></div></div></div></div><div id="disqus_thread"></div><script>var disqus_config = function() { if (!this.page) this.page = {}; Object.assign(this.page, {"url":"https:\/\/learn.javascript.ru\/call-apply-decorators","identifier":"\/call-apply-decorators"}); };</script><script>var disqus_shortname = "learnjavascriptru";</script><script>var disqus_enabled = true;</script></div></main></div><div class="sidebar page__sidebar sidebar sidebar_sticky-footer"><button class="sidebar__toggle" data-sidebar-toggle></button><a class="map" href="https://learn.javascript.ru/tutorial/map" data-action="tutorial-map" data-tooltip="Карта учебника"></a><div class="sidebar__inner"><div class="sidebar__content"><div class="sidebar__section"><h4 class="sidebar__section-title">Раздел</h4><nav class="sidebar__navigation"><ul class="sidebar__navigation-links"><li class="sidebar__navigation-link"><a class="sidebar__link" href="https://learn.javascript.ru/advanced-functions">Продвинутая работа с функциями</a></li></ul></nav></div><div class="sidebar__section"><h4 class="sidebar__section-title">Навигация по уроку</h4><nav class="sidebar__navigation"><ul class="sidebar__navigation-links"><li class="sidebar__navigation-link"><a class="sidebar__link" href="call-apply-decorators.html#prozrachnoe-keshirovanie">Прозрачное кеширование</a></li><li class="sidebar__navigation-link"><a class="sidebar__link" href="call-apply-decorators.html#primenenie-func-call-dlya-peredachi-konteksta">Применение «func.call» для передачи контекста.</a></li><li class="sidebar__navigation-link"><a class="sidebar__link" href="call-apply-decorators.html#perehodim-k-neskolkim-argumentam-s-func-apply">Переходим к нескольким аргументам с «func.apply»</a></li><li class="sidebar__navigation-link"><a class="sidebar__link" href="call-apply-decorators.html#method-borrowing">Заимствование метода</a></li><li class="sidebar__navigation-link"><a class="sidebar__link" href="call-apply-decorators.html#itogo">Итого</a></li></ul></nav></div><div class="sidebar__section"><nav class="sidebar__navigation"><ul class="sidebar__navigation-links"><li class="sidebar__navigation-link"><a class="sidebar__link" href="call-apply-decorators.html#tasks">Задачи (4)</a></li><li class="sidebar__navigation-link"><a class="sidebar__link" href="call-apply-decorators.html#comments">Комментарии</a></li></ul></nav></div><div class="sidebar__section"><div class="sidebar__section-title">Поделиться</div><a class="share share_tw sidebar__share" href="https://twitter.com/share?url=https%3A%2F%2Flearn.javascript.ru%2Fcall-apply-decorators" rel="nofollow"></a><a class="share share_fb sidebar__share" href="https://www.facebook.com/sharer/sharer.php?s=100&amp;p[url]=https%3A%2F%2Flearn.javascript.ru%2Fcall-apply-decorators" rel="nofollow"></a></div><div class="sidebar__section"><a class="sidebar__link" href="https://github.com/javascript-tutorial/ru.javascript.info/blob/master/1-js/06-advanced-functions/09-call-apply-decorators" rel="nofollow">Редактировать на GitHub</a></div></div></div></div></div></div><div class="page-footer"><ul class="page-footer__list"><li class="page-footer__item page-footer__item_copy">©&nbsp;2007—2022&nbsp; Илья Кантор</li><li class="page-footer__item page-footer__item_about"><a class="page-footer__link" href="https://learn.javascript.ru/about">о проекте</a></li><li class="page-footer__item page-footer__item_contact"><a class="page-footer__link" href="https://learn.javascript.ru/about#contact-us">связаться с нами</a></li><li class="page-footer__item page-footer__item_terms"><a class="page-footer__link" href="https://learn.javascript.ru/terms">пользовательское соглашение</a></li><li class="page-footer__item page-footer__item_privacy"><a class="page-footer__link" href="https://learn.javascript.ru/privacy">политика конфиденциальности</a></li><li class="page-footer__item page-footer__item_slack"><a class="page-footer__slack" href="http://slack.javascript.ru">slack-чат</a></li></ul></div></body></html>