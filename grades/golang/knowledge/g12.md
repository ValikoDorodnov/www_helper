# Grade 12

## Kafka

Основы кластера Kafka — это продюсер, брокер и консумер. Продюсер пишет сообщения в лог брокера, а консумер его читает.

Лог — это упорядоченный поток событий во времени. Событие происходит, попадает в конец лога и остаётся там неизменным.

Хорошая практика — когда количество консюмеров в рамках 1 консюмер группы равно количеству партиций.

### Устройство брокеров

Топики в Kafka разделены на партиции. Увеличение партиций увеличивает параллелизм чтения и записи. 
Партиции находятся на одном или нескольких брокерах, что позволяет кластеру масштабироваться.

Партиции хранятся на локальных дисках брокеров и представлены набором лог-файлов — сегментов. Запись в них идёт в  
конец, а уже сохранённые события неизменны.

Каждое сообщение в таком логе определяется порядковым номером — оффсетом. Этот номер монотонно увеличивается при  
записи для каждой партиции.

Лог-файлы на диске устаревают по времени или размеру. Настроить это можно глобально или индивидуально в каждом топике.

Для отказоустойчивости, партиции могут реплицироваться. Число реплик или фактор репликации настраивается как  
глобально по умолчанию, так и отдельно в каждом топике.

Реплики партициий могут быть лидерами или фолловерами. Традиционно консумеры и продюсеры работают с лидерами,  
а фолловеры только догоняют лидера.

Репликация данных
Если одна партиция будет существовать на одном брокере, в случае сбоя часть данных станет недоступной.  
Такая система будет хрупкой и ненадёжной. Для решения проблемы Kafka представляет механизм репликации  
партиций между брокерами.


### Гарантии доставки
0 (at-most once) - Kafka-кластер не должен нам отвечать, получил ли он сообщение. Это самый быстрый вариант.
при доставке сообщений нас устраивают потери сообщений,  
но не их дубликаты. Это самая слабая гарантия, которую реализуют брокерами очередей

1 (at-least once) - Leader - сервер в кластере, к которому мы обращаемся - должен подтвердить получение.
мы не хотим терять сообщения, но нас устраивают возможные дубликаты

All (exactly-once) - Leader присылает подтверждение после того, как сообщение получили все реплики. Это необходимо  
на случай внезапной остановки Leader. Фактически, это 100% гарантия, что сообщение будет получено и не  
потеряется, но одновременно это и самый медленный способ отправки.

### Настройки конфигурации Брокера Kafka

default.replication.factor — количество реплик для каждого топика (в том числе и партиции).  
Данный параметр по сути задает степень отказоустойчивости данных для вашего топика.

min.insync.replicas — мин. количество реплик в синхронизированном состоянии. Этот параметр устанавливает  
минимального количество успешных репликаций данных для подтверждения записи сообщения, отправленного Продюсером.  
Этот параметр нужно ставить максимум на 1 меньше чем общее количество реплик (можно еще меньше делать данный параметр),  
иначе ваш брокер будет работать так, словно репликации в нем никакой нет, поскольку после падения хотя бы одного узла  
Кафка уже будет недоступна для записи — в таком случае весь толк от репликации теряется.

message.max.bytes — макс. разрешенный размер сообщения (в байтах)

num.partitions — количество партиций по умолчанию для новых топиков.

retention.ms — срок жизни сообщения в Кафка (TTL). Сообщение хранится не больше данного времени, после чего  
удаляется, причем стоит обратить внимание, что значение данного параметра задается в миллисекундах.

retention.bytes — макс. размер данных в топике. Суммарный вес всех сообщений в рамках одного топика не может  
превышать заданного значения, если при добавлении нового сообщения оно будет превышено, то самое раннее сообщение  
будет удалено из топика, чтобы появилось место для нового.